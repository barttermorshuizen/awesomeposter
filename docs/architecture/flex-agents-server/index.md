# Flex Agents Server — Architecture Specification

## Table of Contents

- [Flex Agents Server — Architecture Specification](#table-of-contents)
  - [1. Scope & Goals](./1-scope-goals.md)
  - [2. Non-Goals](./2-non-goals.md)
  - [3. Key Architectural Decisions (Proposed)](./3-key-architectural-decisions-proposed.md)
  - [4. High-Level Architecture](./4-high-level-architecture.md)
  - [5. Core Concepts](./5-core-concepts.md)
    - [5.1 TaskEnvelope](./5-core-concepts.md#51-taskenvelope)
    - [5.2 OutputContract](./5-core-concepts.md#52-outputcontract)
    - [5.3 TaskPolicies](./5-core-concepts.md#53-taskpolicies)
      - [PlannerPolicy](./5-core-concepts.md#plannerpolicy)
      - [RuntimePolicy](./5-core-concepts.md#runtimepolicy)
    - [5.4 PlanGraph](./5-core-concepts.md#54-plangraph)
    - [5.5 ContextBundle](./5-core-concepts.md#55-contextbundle)
    - [5.6 AgentCapability](./5-core-concepts.md#56-agentcapability)
      - [Facet Definition](./5-core-concepts.md#facet-definition)
      - [Facet-Aligned Capabilities](./5-core-concepts.md#facet-aligned-capabilities)
    - [5.6.1 Capability Registration](./5-core-concepts.md#561-capability-registration)
    - [5.6.2 Registration Payload](./5-core-concepts.md#562-registration-payload)
    - [5.7 Facet-Based Plan Assembly](./5-core-concepts.md#57-facet-based-plan-assembly)
      - [Planning Steps](./5-core-concepts.md#planning-steps)
      - [Story 8.8 Dynamic Assembly Details](./5-core-concepts.md#story-88-dynamic-assembly-details)
      - [Execution Runtime](./5-core-concepts.md#execution-runtime)
    - [5.8 Planner vs Orchestrator: Hybrid Collaboration](./5-core-concepts.md#58-planner-vs-orchestrator-hybrid-collaboration)
      - [Roles & Responsibilities](./5-core-concepts.md#roles-responsibilities)
      - [Interaction Sequence](./5-core-concepts.md#interaction-sequence)
      - [Collaboration Patterns](./5-core-concepts.md#collaboration-patterns)
      - [Derived Capability Handling](./5-core-concepts.md#derived-capability-handling)
      - [Failure Modes & Recovery](./5-core-concepts.md#failure-modes-recovery)
      - [Why the Hybrid Model Matters](./5-core-concepts.md#why-the-hybrid-model-matters)
      - [Planner ↔ Orchestrator Sequence (Mermaid)](./5-core-concepts.md#planner-orchestrator-sequence-mermaid)
  - [5.9 Output Contracts, Planner Validation, and Policy Semantics](./59-output-contracts-planner-validation-and-policy-semantics.md)
    - [5.9.1 OutputContract Specification](./59-output-contracts-planner-validation-and-policy-semantics.md#591-outputcontract-specification)
    - [5.9.2 Planner Validation and Feedback Loop](./59-output-contracts-planner-validation-and-policy-semantics.md#592-planner-validation-and-feedback-loop)
    - [5.9.3 Validator Orchestration, Diagnostics, and Scoring](./59-output-contracts-planner-validation-and-policy-semantics.md#593-validator-orchestration-diagnostics-and-scoring)
    - [5.9.4 Feedback Payloads and Telemetry](./59-output-contracts-planner-validation-and-policy-semantics.md#594-feedback-payloads-and-telemetry)
    - [5.9.5 Constraints vs. Policies Separation](./59-output-contracts-planner-validation-and-policy-semantics.md#595-constraints-vs-policies-separation)
    - [5.9.6 Role Separation and Collaboration](./59-output-contracts-planner-validation-and-policy-semantics.md#596-role-separation-and-collaboration)
    - [5.9.7 Policies as Orthogonal Guardrails](./59-output-contracts-planner-validation-and-policy-semantics.md#597-policies-as-orthogonal-guardrails)
    - [5.9.8 Conceptual Flow Summary](./59-output-contracts-planner-validation-and-policy-semantics.md#598-conceptual-flow-summary)
  - [5.10 Policy Simplification (Remove Flow-Control Actions)](./510-policy-simplification-remove-flow-control-actions.md)
    - [Background](./510-policy-simplification-remove-flow-control-actions.md#background)
    - [Deprecated Elements](./510-policy-simplification-remove-flow-control-actions.md#deprecated-elements)
    - [Updated RuntimePolicy Action Union](./510-policy-simplification-remove-flow-control-actions.md#updated-runtimepolicy-action-union)
    - [Policy Purpose (Post-cleanup)](./510-policy-simplification-remove-flow-control-actions.md#policy-purpose-post-cleanup)
    - [Execution Engine Behavior Change](./510-policy-simplification-remove-flow-control-actions.md#execution-engine-behavior-change)
    - [Rationale](./510-policy-simplification-remove-flow-control-actions.md#rationale)
  - [5.11 Reference capability registry](./511-reference-capability-registry.md)
  - [5.12 Reference facet catalog](#512-reference-facet-catalog)
  - [6. Component Responsibilities](./6-component-responsibilities.md)
    - [Telemetry & Metrics Parity](./6-component-responsibilities.md#telemetry-metrics-parity)
  - [7. Execution Flow](./7-execution-flow.md)
  - [8. HITL and Rehydration Strategy](./8-hitl-and-rehydration-strategy.md)
  - [9. Data Model & Persistence](./9-data-model-persistence.md)
  - [9.1 Capability Registration Flow](./91-capability-registration-flow.md)
  - [10. API Surface (Initial)](./10-api-surface-initial.md)
    - [10.0.1 Flex Run Streaming Contract](./10-api-surface-initial.md#1001-flex-run-streaming-contract)
    - [10.1 Flex Run Debugging](./10-api-surface-initial.md#101-flex-run-debugging)
    - [10.1 Sample TaskEnvelope](./10-api-surface-initial.md#101-sample-taskenvelope)
  - [11. Capability Registry & Agent Contracts](./11-capability-registry-agent-contracts.md)
    - [Facet Catalog](./11-capability-registry-agent-contracts.md#facet-catalog)
    - [Current Inventory](./11-capability-registry-agent-contracts.md#current-inventory)
      - [Contract Compiler & Validation Helpers](./11-capability-registry-agent-contracts.md#contract-compiler-validation-helpers)
    - [Supporting Utilities](./11-capability-registry-agent-contracts.md#supporting-utilities)
    - [Developer Sandbox](./11-capability-registry-agent-contracts.md#developer-sandbox)
    - [Maintenance Checklist](./11-capability-registry-agent-contracts.md#maintenance-checklist)
  - [12. UI & Client Integration](./12-ui-client-integration.md)
  - [13. Migration & Rollout Strategy](./13-migration-rollout-strategy.md)
  - [13. Verification](./13-verification.md)
  - [14. Risks & Open Questions](./14-risks-open-questions.md)
  - [15. Supporting Human Agents (to be implemented)](./15-supporting-human-agents-to-be-implemented.md)
    - [15.1 Concept Overview](./15-supporting-human-agents-to-be-implemented.md#151-concept-overview)
    - [15.x HITL Clarify Extension](./15-supporting-human-agents-to-be-implemented.md#15x-hitl-clarify-extension)
    - [15.2 Design Principles](./15-supporting-human-agents-to-be-implemented.md#152-design-principles)
    - [15.3 Implementation Alignment](./15-supporting-human-agents-to-be-implemented.md#153-implementation-alignment)
    - [15.4 Facet-Driven Task Surfaces](./15-supporting-human-agents-to-be-implemented.md#154-facet-driven-task-surfaces)
    - [15.5 Notification and Assignment Model](./15-supporting-human-agents-to-be-implemented.md#155-notification-and-assignment-model)
    - [15.6 Planner Behavior](./15-supporting-human-agents-to-be-implemented.md#156-planner-behavior)
    - [15.7 Benefits and Alignment](./15-supporting-human-agents-to-be-implemented.md#157-benefits-and-alignment)
    - [15.8 Example](./15-supporting-human-agents-to-be-implemented.md#158-example)
    - [15.9 Offline and Notification Semantics](./15-supporting-human-agents-to-be-implemented.md#159-offline-and-notification-semantics)
    - [15.10 Registration & Governance Notes](./15-supporting-human-agents-to-be-implemented.md#1510-registration-governance-notes)
    - [15.11 Post Visual R2 Endpoint Patterns](./1511-post-visual-r2-endpoint-patterns.md)
