# 16. Retrieval Knowledge Stores

- **Strategist corpus source**: Snippets are persisted in Postgres (`flex_capability_snippets`) via pgvector, defined in `packages/db/src/schema.ts`. Each record stores the chunk text, metadata, and a 1,536‑dimension embedding generated with the `text-embedding-3-small` model.
- **Refresh cadence**: Marketing operations rebuilds the corpus monthly. Updated embeddings are imported through the ingestion tooling that upserts into the pgvector table—no application restart is required beyond a standard deploy.
- **Runtime wiring**: `FlexPlanner.buildContextBundle` delegates to `StrategistRetrievalService`, which embeds the current envelope objective/context and queries pgvector for nearest snippets. The retrieved snippets populate `ContextBundle.knowledge` so downstream orchestration consumes a consistent contract.
- **Fallback expectations**: If embeddings cannot be generated or the repository returns no matches, the bundle is marked `status="fallback"` and includes the shared fallback snippet. When the embedding client cannot initialise (for example, missing OpenAI credentials), the bundle reports `status="unavailable"`. Capability metadata advertises the associated health signals so registry snapshots surface degraded behaviour.
- **Observability**: Retrieval errors emit `strategist_retrieval_*` warnings through the shared logger. SSE telemetry carries the `ContextBundle.knowledge.status` value, letting dashboards track ready/fallback/unavailable rates alongside strategist throughput.
- **Seeding the corpus**: Convert Markdown guidance into snippets with `node scripts/seed-strategist-corpus.mjs <file.md>`. Set both `OPENAI_API_KEY` (or `FLEX_OPENAI_API_KEY`) *and* `DATABASE_URL` in the environment before running so the script can call OpenAI for embeddings and connect to Postgres. Update the script inputs whenever the curated strategist corpus changes.
