# Story 12.1: Social Strategist Retrieval Foundation

## Status
Ready for Review

## Story
**As a** flex marketing orchestration lead,  
**I want** the social strategist agent wired to a curated retrieval corpus with guardrailed fallbacks,  
**so that** social content briefs consistently blend best-practice guidance, past exemplars, and brand context without manual prompting.

**Dependencies:** None; first story in the social strategist enhancement epic.

## References
- `docs/prd/epic-flex-social-strategist-enhancement.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`
- `docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/9.1-capability-registration-flow.md#91-capability-registration-flow`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#supporting-utilities`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist`
- `docs/architecture/flex-agents-server/13-verification.md`
- `docs/architecture/flex-agents-server/index.md`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/source-tree.md#4-agents-server`

## Acceptance Criteria
1. Curate and persist a retrieval knowledge corpus covering social heuristics, tone guides, and exemplar briefs using the existing marketing agent knowledge store patterns so the strategist can query authoritative content during planning, with documented refresh and fallback behaviour. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`)
2. Integrate a retrieval pipeline into the `strategist.SocialPosting` capability so `ContextBuilder` attaches knowledge snippets to the node’s `ContextBundle` without altering planner or execution contracts, and ensure runs proceed cleanly when the corpus is unavailable. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
3. Update the strategist capability module and registration metadata to surface retrieval-enabled behaviour (configuration hooks, health signals) while honouring compatibility requirements that prohibit external API changes and keep enhancements confined to `packages/flex-agents-server`. (`docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`, `docs/architecture/flex-agents-server/9.1-capability-registration-flow.md#91-capability-registration-flow`)
4. Add automated verification that exercises retrieval-enabled strategist runs (happy path and fallback) and documents required telemetry/observability signals so regressions are caught by existing Vitest suites. (`docs/prd/epic-flex-social-strategist-enhancement.md#success-criteria`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist`, `docs/architecture/flex-agents-server/13-verification.md#13-verification`)
5. Extend the flex agents architecture documentation with a retrieval/RAG section that standardizes how agents integrate curated knowledge stores, covering configuration hooks, data refresh cadence, fallback expectations, and telemetry. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/index.md`)

## Tasks / Subtasks
- [x] Design the curated strategist knowledge corpus (scope, storage layout, refresh cadence) and document fallback handling for stale or missing entries. (AC 1) (`docs/prd/epic-flex-social-strategist-enhancement.md`)
- [x] Implement retrieval helpers within the agents server workspace that load the corpus using existing marketing knowledge store/config patterns, including configuration toggles for enabling/disabling queries. (AC 1) (`docs/prd/epic-flex-social-strategist-enhancement.md`)
- [x] Extend the `strategist.SocialPosting` module to invoke retrieval helpers during context assembly, merging results into the agent prompt while preserving existing facet contracts. (AC 2, AC 3) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
- [x] Update capability registration payloads and health instrumentation so registry snapshots and telemetry reflect retrieval readiness without changing external APIs. (AC 3) (`docs/architecture/flex-agents-server/9.1-capability-registration-flow.md#91-capability-registration-flow`, `docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements`)
- [x] Create Vitest coverage that validates strategist runs include retrieved knowledge when enabled, gracefully degrade when disabled, and emit expected telemetry records. (AC 4) (`docs/architecture/flex-agents-server/13-verification.md#13-verification`, `docs/prd/epic-flex-social-strategist-enhancement.md#success-criteria`)
- [x] Document the retrieval blueprint in the flex agents architecture, outlining storage layout, configuration flags, telemetry, and fallback patterns for future agents. (AC 5) (`docs/architecture/flex-agents-server/index.md`)

## Story Context
- Epic objective is to augment the social strategist agent with curated knowledge, analytics signals, and asset awareness while keeping planner orchestration untouched. (`docs/prd/epic-flex-social-strategist-enhancement.md`)
- Existing marketing capabilities (including `strategist.SocialPosting`) already depend on facet-driven contracts; retrieval outputs must align with those existing schemas. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
- Enhancements must live entirely inside the flex agents server workspace so downstream consumers remain compatible. (`docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements`)

## Dev Notes
- **Previous Story Insights:** No specific guidance found in architecture docs.
- **Data Models:** Retrieval needs to respect the `ContextBundle` payload that packages knowledge snippets alongside envelopes for each node invocation, ensuring strategist runs receive merged context. [Source: architecture/flex-agents-server/5-core-concepts.md#55-contextbundle]
- **API Specifications:** Capability registration continues to flow through `POST /api/v1/flex/capabilities/register`; retrieval metadata and health flags must be conveyed via the standard registration payload without modifying the endpoint contract. [Source: architecture/flex-agents-server/9.1-capability-registration-flow.md#91-capability-registration-flow]
- **Component Specifications:** `ContextBuilder` assembles invocation payloads, `CapabilityRegistry` advertises strategist metadata, and `ExecutionEngine` dispatches nodes—retrieval helpers must plug into this pipeline without altering control flow. [Source: architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- **File Locations:** Strategist capability modules and supporting utilities reside under `packages/flex-agents-server/src/agents/marketing/`, while shared catalog helpers stay within `packages/shared/src/flex/`. [Source: architecture/source-tree.md#4-agents-server] [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory]
- **Testing Requirements:** Use Vitest suites under `packages/flex-agents-server/__tests__/` to validate retrieval behaviour and telemetry, extending existing verification coverage as directed by the maintenance checklist. [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist] [Source: architecture/flex-agents-server/13-verification.md]
- **Technical Constraints:** Implement enhancements in TypeScript within the agents server workspace, following established coding standards (strict typing, Zod validation, Winston logging) and keeping changes confined to the agents server per epic compatibility rules. [Source: architecture/tech-stack.md#1-core-runtime-components] [Source: architecture/coding-standards.md#4-agents-server-standards] [Source: docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements]
- **Documentation Requirements:** Update the flex agents architecture documentation with a retrieval/RAG section covering storage layout, enablement flags, telemetry, and fallback expectations to guide future agent teams. [Source: docs/prd/epic-flex-social-strategist-enhancement.md]
- **Runtime Practices:** Apply the existing OpenAI Agents SDK orchestration patterns when injecting retrieval context (context assembly, capability dispatch, telemetry) so enhancements remain consistent with current agent flows. [Source: architecture/tech-stack.md#1-core-runtime-components]

## Project Structure Notes
- Place retrieval helpers and strategist updates in `packages/flex-agents-server/src/` and only touch shared packages when schema updates are required. [Source: architecture/source-tree.md#4-agents-server]

## Testing
- Execute the flex agents server verification suites (Vitest) covering capability coordination and retrieval fallbacks once implementation lands. `npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts` (add retrieval-specific cases as needed). [Source: architecture/flex-agents-server/13-verification.md#13-verification]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 0.1 | Draft story defining strategist retrieval corpus scope, integration tasks, and verification expectations. | Scrum Master |

## Dev Agent Record

### Agent Model Used
gpt-5.1-codex (James)

### Debug Log References
- npm run test:unit -- packages/flex-agents-server/__tests__/marketing-strategist-retrieval.spec.ts

### Completion Notes List
- Added pgvector-backed strategist knowledge schema, repository, and OpenAI embedding integration for corpus retrieval.
- Planner now attaches `ContextBundle.knowledge` sourced from Postgres and surfaces fallback/unavailable states with structured telemetry.
- Updated strategist capability metadata and architecture docs to reflect vector-store retrieval and maintenance practices.

### File List
- packages/shared/src/flex/types.ts
- packages/db/src/schema.ts
- packages/db/migrations/20251022_add_flex_capability_snippets.sql
- packages/flex-agents-server/src/services/strategist-knowledge-repository.ts
- packages/flex-agents-server/src/services/strategist-retrieval-service.ts
- packages/flex-agents-server/src/services/flex-planner.ts
- packages/flex-agents-server/src/agents/marketing/strategist-social-posting.ts
- packages/flex-agents-server/__tests__/marketing-strategist-retrieval.spec.ts
- docs/architecture/flex-agents-server/index.md

## QA Results
- 2025-11-07 – Quinn (QA): Recorded risk profile at `docs/qa/assessments/12.1-risk-20251107.md`. Critical gaps: ContextBuilder still lacks automated knowledge bundle injection (service only exposed via strategist tool) and embedding prompts leak PII to OpenAI without redaction, so gate recommendation set to **FAIL** until mitigations/tests land.
