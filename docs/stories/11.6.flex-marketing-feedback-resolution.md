# Story 11.6: Feedback Facet Resolution Loop

## Status
Done

## Story
**As a** flex marketing operations lead,  
**I want** strategist, copywriter, and designer capabilities to output structured feedback entries and mark addressed items directly in their prompts,  
**so that** replanning cycles and human reviewers can see when revision requests have been satisfied without leaving the run context.

**Dependencies:** Builds on Stories 11.1 through 11.5 so the curated marketing capability set, multi-direction briefs, and planner fixtures already exist before tightening the feedback loop. (`docs/stories/11.5.flex-marketing-multi-directional-briefs.md`)

## References
- `docs/prd/epic-flex-marketing-agency-capabilities.md`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`
- `docs/architecture/flex-agents-server/511-reference-capability-registry.md`
- `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`
- `docs/architecture/flex-agents-server/1512-facet-widget-surfaces.md#widget-registry--decorators`
- `docs/architecture/flex-agents-server/59-output-contracts-planner-validation-and-policy-semantics.md#594-feedback-payloads-and-telemetry`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/coding-standards.md#4-agents-server-standards`

## Acceptance Criteria
1. `strategist.SocialPosting` capability registration, prompt assets, and fixtures include the `feedback` facet in the `outputContract`, ensuring strategist revisions update the structured entry (same facet/path) with `resolution = "addressed"` + note when they act on reviewer notes tied to `creative_brief` or `strategic_rationale`. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`)
2. `copywriter.SocialpostDrafting` capability output contract adds the `feedback` facet, and both app/chat prompts explicitly instruct the copywriter agent to locate unresolved `post_copy` feedback entries, update the copy, and edit that entry to `resolution = "addressed"` plus a concise `note`. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)
3. `designer.VisualDesign` capability outputs the `feedback` facet alongside `post_visual`, and its human-facing instructions explain how to mark addressed visual feedback items via the inline decorator so replans stop targeting already-fixed nodes. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/1512-facet-widget-surfaces.md#widget-registry--decorators`)
4. Prompt directives for all three capabilities detail the workflow for consuming `feedback` entries (`facet`, `path`, `message`, `resolution`) and require setting `resolution` to `"addressed"` whenever the referenced deliverable is updated, covering both HITL-pause and automated runs. (`docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`, `docs/architecture/flex-agents-server/59-output-contracts-planner-validation-and-policy-semantics.md#594-feedback-payloads-and-telemetry`)
5. The shared feedback facet widget/decorator in the flex sandbox UI gains inline controls (simple resolve/undo icons with tooltips) so operators can mark an existing entry’s `resolution` directly from the panel without editing raw JSON, persisting through the existing decorator pipeline. (`docs/architecture/flex-agents-server/1512-facet-widget-surfaces.md#widget-registry--decorators`, `docs/architecture/source-tree.md#2-spa`)
6. Shared facet catalog helpers, Ajv builders, sample payloads, and planner validation tests cover the updated output contracts so any capability missing `feedback` is rejected at registration time, and regression suites document the expected telemetry when feedback items flip from `open` to `addressed`. (`docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`, `docs/architecture/flex-agents-server/13-verification.md`)
7. Documentation (capability registry appendix + rollout guidance in the epic) captures the contract change, migration expectations, UI behaviour, and operator instructions so sandbox metadata, HITL cues, and planner snapshots stay aligned with the new feedback workflow. (`docs/prd/epic-flex-marketing-agency-capabilities.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`)

## Tasks / Subtasks
- [x] Update `packages/flex-agents-server/src/agents/marketing/strategist-social-posting.ts` to append `feedback` to the output contract, adjust the FEEDBACK directive text, and refresh any sample payloads/fixtures used by the registry. (AC 1, AC 4) (`docs/architecture/source-tree.md#4-agents-server`)
- [x] Modify `packages/flex-agents-server/src/agents/marketing/copywriter-socialpost-drafting.ts` to emit `feedback`, incorporating explicit instructions for marking addressed entries tied to `post_copy`. (AC 2, AC 4)
- [x] Extend `packages/flex-agents-server/src/agents/marketing/designer-visual-design.ts` so human assignments emit `feedback` updates and explain how to use the inline decorator before submitting new visuals. (AC 3, AC 4)
- [x] Regenerate shared catalog types/fixtures (`packages/shared/src/flex/facets/catalog.ts` + corresponding tests) so the Ajv validators enforce the new contracts. (AC 6)
- [x] Add or update planner/registry verification tests that fail when `feedback` is missing from these capabilities or when addressed entries omit `resolution = "addressed"`. (AC 6)
- [x] Enhance the feedback facet widget/decorator (`src/components/flex-tasks/widgets` + decorator registry) with resolve/dismiss icons, tooltips, and persistence logic so operators can flip states without editing JSON. (AC 5)
- [x] Document the rollout + operator guidance inside the capability registry appendix and PRD epic, including how planner telemetry and UI controls reflect addressed feedback. (AC 7)

## Story Context
- Feedback currently originates from director capabilities, but strategist/copywriter/designer agents cannot publish their own resolution notes, leaving planners unsure which nodes still need work; adding the facet closes the loop without bespoke code. (`docs/prd/epic-flex-marketing-agency-capabilities.md`)
- Planner diagnostics reuse structured feedback payloads during replans, so mutation rights must match the capabilities’ output contracts for deterministic graph updates. (`docs/architecture/flex-agents-server/59-output-contracts-planner-validation-and-policy-semantics.md#594-feedback-payloads-and-telemetry`)

## Dev Notes
- **Previous Story Insights:** The curated marketing catalog already routes strategist → copywriter → designer handoffs, so contract changes must keep those capability IDs stable while expanding facet coverage. [Source: architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry]
- **Data Models:** `feedback` is a bidirectional facet with required `author`, `facet`, and `message`, plus `resolution` enum (`open`, `addressed`, `dismissed`) and optional `note` for responders; resolution must be set to `"addressed"` when agents complete a change. [Source: architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback]
- **Component Specifications:** Each capability module co-locates prompt directives and registry payloads, so updating contracts + instructions happens within the same TypeScript file registered at startup. [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts]
- **File Locations:** Marketing agents live under `packages/flex-agents-server/src/agents/marketing/**`; shared facet schemas sit in `packages/shared/src/flex/facets/catalog.ts`; facet widgets/decorators live under `src/components/flex-tasks/widgets/**`. [Source: architecture/source-tree.md#2-spa]
- **Testing Requirements:** Regression suites must cover facet registration and planner validation so Ajv builders reject missing `feedback` entries, aligning with existing verification patterns. [Source: architecture/flex-agents-server/13-verification.md]
- **Technical Constraints:** Inline facet decorators rely solely on declared contracts, so enabling `feedback` output automatically activates the UI composer for these capabilities; prompts must instruct agents to use it rather than bespoke commands, and the UI controls must reuse the decorator registry (no bespoke modal). [Source: architecture/flex-agents-server/1512-facet-widget-surfaces.md#widget-registry--decorators]

## Testing
- Update shared facet Ajv/Vitest suites to confirm strategist, copywriter, and designer registrations include `feedback` outputs and that resolver helpers enforce the schema. (`docs/architecture/flex-agents-server/13-verification.md`)
- Extend marketing agent tests to simulate feedback resolution flows (open → addressed) and assert planner telemetry mirrors the state change. (`docs/architecture/flex-agents-server/59-output-contracts-planner-validation-and-policy-semantics.md#594-feedback-payloads-and-telemetry`)
- Add component/unit coverage for the feedback widget/decorator so resolve/undo icon clicks flip the `resolution` field and persist via the existing submission pipeline. (`docs/architecture/flex-agents-server/1512-facet-widget-surfaces.md#widget-registry--decorators`)

## Risks / Mitigations
- **Risk:** Adding `feedback` outputs could break consumers expecting the older schema. **Mitigation:** version the capability payloads, document migration steps, and keep fallback fixtures until sandbox metadata consumers confirm compatibility. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`)
- **Risk:** Agents might forget to update `resolution`, causing endless replans. **Mitigation:** bake the directive into prompts/tests and fail registry validation when addressed entries omit the enum. (`docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)
