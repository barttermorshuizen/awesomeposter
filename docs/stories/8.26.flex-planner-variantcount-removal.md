# Story 8.26: Flex Planner VariantCount Policy Removal

## Status
Readu for Dev

## Story
**As a** flex orchestrator maintainer,  
**I want** to retire the `planner.topology.variantCount` field from TaskEnvelope policies,  
**so that** variant expectations are sourced from envelope inputs and plan knob facets without legacy policy plumbing.

## Acceptance Criteria
1. `@awesomeposter/shared` removes `planner.topology.variantCount` from TaskPolicies types/Zod schemas, rejects payloads that still include the field, and refreshes the architecture reference so the canonical policy definition no longer advertises it. (`docs/architecture/flex-agents-server.md#53-taskpolicies`, `docs/architecture/tech-stack.md#1-core-runtime-components`)
2. Policy normalization surfaces actionable validation errors when callers send `policies.variantCount` or `policies.planner.topology.variantCount`, guiding them to envelope inputs/plan knobs, and only persists canonical policies drawn from the remaining planner directives. (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#51-taskenvelope`)
3. Planner, context builder, and planner service derive variant counts from TaskEnvelope inputs (including plan knob facets) so planning prompts, node metadata, and telemetry stay aligned without referencing the removed policy field. (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
4. Automated tests and architecture samples confirm no code path reads `planner.topology.variantCount`, while coverage ensures variant handling still follows documented testing expectations. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server.md#10-1-sample-taskenvelope`)

## Tasks / Subtasks
- [ ] Update `@awesomeposter/shared` TaskPolicies interfaces and validators to drop `planner.topology.variantCount` and document the change. (AC 1) (`docs/architecture/flex-agents-server.md#53-taskpolicies`)
- [ ] Adjust `PolicyNormalizer` (and related validation messaging) to reject or remap legacy variant count fields while preserving canonical planner directives. (AC 2) (`docs/architecture/flex-agents-server.md#6-component-responsibilities`)
- [ ] Revise planner/context builder services to read variant expectations from TaskEnvelope inputs or plan knob facets, keeping prompts and node metadata consistent. (AC 3) (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- [ ] Refresh Vitest suites and docs to assert the removed field is unused and variant handling remains covered. (AC 4) (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Dev Notes
- **Previous Story Insights:** Story 8.25 remains in Draft; no Dev Agent Record updates are available.
- **Data Models:** `flex_runs` stores variant-related metadata, so removing the policy field must leave run persistence aligned with the documented schema. `[Source: docs/architecture/flex-agents-server.md#9-data-model--persistence]`
- **API Specifications:** Variant expectations are supplied via `POST /api/v1/flex/run.stream` envelopes; policy validation happens during the documented controller/normalizer flow. `[Source: docs/architecture/flex-agents-server.md#7-execution-flow]`
- **Component Specifications:** `PolicyNormalizer`, `PlannerService`, and `ContextBuilder` coordinate policy ingestion, planning prompts, and derived metadata. `[Source: docs/architecture/flex-agents-server.md#6-component-responsibilities]`
- **File Locations:** Shared contracts live in `packages/shared/src/`, while planner and normalization services reside under `packages/flex-agents-server/src/services`. `[Source: docs/architecture/source-tree.md#5-shared-libraries]` `[Source: docs/architecture/source-tree.md#4-agents-server]`
- **Testing Requirements:** Follow Vitest coverage expectations when updating shared schemas and planner services. `[Source: docs/architecture/coding-standards.md#7-testing-expectations]`
- **Technical Constraints:** Maintain the documented TypeScript stack and module patterns while adjusting planner/normalizer logic. `[Source: docs/architecture/tech-stack.md#1-core-runtime-components]`

## Project Structure Notes
- Keep shared schema updates in `packages/shared`, planner/context adjustments in `packages/flex-agents-server/src/services`, and documentation updates in `docs/architecture` to remain aligned with the source tree guide. `[Source: docs/architecture/source-tree.md#5-shared-libraries]` `[Source: docs/architecture/source-tree.md#4-agents-server]`
