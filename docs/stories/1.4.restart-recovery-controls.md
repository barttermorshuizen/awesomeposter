# Story 1.4: Restart Recovery Controls

## Status
Approved

## Story
**As an** internal operator,
**I want** reliable controls to resume or remove in-progress runs after service restarts,
**so that** stale orchestration states can be resolved without manual cleanup.

## Acceptance Criteria
1. UI surfaces "Resume creating post" and "Remove running create post" actions with clear status messaging when a briefing has a suspended orchestration thread (e.g., after restart).
2. Resuming a run reloads the persisted orchestrator state (plan artifacts, HITL context, runner metadata) and restarts from the last completed step without duplicating prior work.
3. Removing a run clears persisted plan/HITL records, unlocks the briefing for new runs, and records the operator identity and timestamp.
4. Operators receive confirmation indicators (toast or inline status) that the stale state has been successfully resumed or removed.

## Tasks / Subtasks
- [x] Detect suspended orchestration threads via Story 1.2 APIs/store and expose resume/remove actions inside `src/components/AgentResultsPopup.vue` (create-post popup) and any supporting Pinia store under `src/stores/hitl.ts` (AC 1).
  - [x] Ensure actions are visible only to authorized operators and when suspended state exists, reflecting backend status codes accurately (Must-fix linkage) (AC 1).
- [x] Implement resume action flow calling the existing Nitro endpoint `POST /api/hitl/resume` to rehydrate orchestrator state and trigger plan continuation (AC 2).
  - [x] Update UI state in the HITL store/popup to reflect resumed status, clear suspended indicators, and close the panel once the backend clears `pendingRequestId` (AC 2).
- [x] Implement remove action flow invoking `POST /api/hitl/remove`, clearing local state, and marking run as removed with audit metadata (AC 3).
  - [x] Confirm backend response includes acknowledgement so UI can display confirmation and update audit messaging, including handling 404/409 responses from the API (AC 3, AC 4).
- [x] Add toasts or inline banners for success/failure of resume/remove, and provide retry guidance on errors using backend status codes/messages (AC 4).
  - [x] Document operator instructions (e.g., help tooltip) explaining when to resume vs remove (supports AC 1-4).

## Dev Notes
- UI integration anchors in `src/components/AgentResultsPopup.vue`; add a HITL recovery section beneath the existing run progress pane. If a dedicated HITL store does not yet exist, define `src/stores/hitl.ts` to wrap pending-run state exposed by Story 1.2 (`GET /api/hitl/pending`).
- Resume/remove actions must call Nitro endpoints shipped with Story 1.2: `POST /api/hitl/resume` to submit operator responses and `POST /api/hitl/remove` to cancel. Payloads follow the runbook (`docs/orchestrator-hitl-runbook.md#resume-a-paused-run` / `#cancelremove-a-pending-request`): include `runId` or `threadId`, `requestId`, operator metadata, and an optional note. Successful responses clear `pendingRequestId`; 404 means the run/request no longer exists and 409 indicates another request is activeâ€”surface these in inline messaging.
- For suspended-state detection, reuse the persistence APIs from Story 1.2 (`GET /api/hitl/pending`) and keep the single-active-run invariant. Cache the last seen pending record in the Pinia store so the popup can reconcile after resume/remove.
- Stick to Vuetify button, banner, and tooltip components already present in the popup. Disable actions while awaiting API completion and guard them behind the existing authentication checks used for create-post operations.
- Coordinate with orchestrator pause semantics noted in `docs/orchestrator_requirements.md#4-streaming--sse-frames-contract`; once resume succeeds, ensure the SSE stream or polling loop restarts and progress elements in the popup return to active state.

### Testing
- Component/unit tests verifying buttons appear only when suspended state detected and trigger correct handlers in `AgentResultsPopup` with the Pinia store mocked (Vitest + Vue Test Utils).
- Integration test covering `POST /api/hitl/resume` and `POST /api/hitl/remove` flows using mocked API adapters to ensure state updates, audit messaging, and status-code-specific toasts render.
- Simulate the orchestrator restart path by mocking a pending record from `GET /api/hitl/pending` to confirm the popup hydrates, handles 404/409 responses gracefully, and resumes the SSE stream once the backend clears the suspension.
- Manual smoke after orchestrator restart to confirm suspended runs appear, can be resumed or removed cleanly, and the popup re-enters the standard create-post flow.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | 0.1 | Initial draft of Story 1.4 from Epic HITL-1. | PO |

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Developer persona)

### Debug Log References
- None

### Completion Notes List
- Expanded `useHitlStore` with suspended-run detection, operator profile persistence, and remove-run helper posting to `/api/hitl/remove`.
- Added recovery controls in `AgentResultsPopup.vue` with operator guidance, resume/remove actions, and inline status messaging for success/error paths.
- Persisted operator identity inputs locally and wired removal button to require identity and reason before cancelling runs.
- Updated store unit tests to cover forced hydration and removal payloads.
- Deferred SSE restart until after operators submit pending HITL responses so resuming no longer duplicates requests and UI guides the flow.

### File List
- src/stores/hitl.ts
- src/components/AgentResultsPopup.vue
- src/__tests__/hitl-store.spec.ts

## QA Results
- `npm run test:unit -- src/__tests__/hitl-store.spec.ts`
