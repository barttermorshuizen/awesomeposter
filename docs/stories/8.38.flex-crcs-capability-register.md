# Story 8.38: Flex Planner Comprehensive Relevant Capability Set (CRCS)

## Status
Ready for Dev

## Story
**As a** flex orchestrator maintainer,  
**I want** the planner prompt to render a Comprehensive Relevant Capability Set (CRCS) derived from live registry, policy, and goal-condition context,  
**so that** the LLM receives every capability it might realistically invoke while keeping prompt size and planning latency within performance thresholds.

**Dependencies:** Story 8.30 introduced the semantic capability registry summaries inside the planner prompt, and Story 8.37 added goal-condition rationale to replans; CRCS must extend both behaviors without regressions. (`docs/stories/8.30.flex-planner-prompt-optimization.md`, `docs/stories/8.37.flex-goal-condition-replan.md`)

## References
- `docs/prd/epic-flex-agents-server.md`
- `docs/stories/8.30.flex-planner-prompt-optimization.md`
- `docs/stories/8.37.flex-goal-condition-replan.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`
- `docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies`
- `docs/architecture/flex-agents-server/5-core-concepts.md#plannerpolicy`
- `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`
- `docs/architecture/flex-agents-server/5-core-concepts.md#57-facet-based-plan-assembly`
- `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/discovery-agent-backend.md#testing-strategy`
- `docs/architecture/tech-stack.md#1-core-runtime-components`

## Acceptance Criteria
1. `PlannerService` computes a Comprehensive Relevant Capability Set (CRCS) before every `plan_requested` event: it begins with the Minimal Relevant Capability Set (MRCS) derived via facet reachability between TaskEnvelope inputs, intermediate facets, and required outputs, then unions (a) every capability whose `inputContract` or `outputContract` share a facet with any MRCS entry, (b) any capability whose facet contracts match an MRCS capability exactly, (c) capabilities linked by registry preconditions/applicability metadata/policy tags to facets surfaced in MRCS, and (d) every capability referenced by planner/runtime policies, routing rules, or `goal_condition` clauses. Each capability is tagged with `reasonCodes` that justify its inclusion. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/flex-agents-server/5-core-concepts.md#plannerpolicy`, `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`, `docs/architecture/flex-agents-server/5-core-concepts.md#57-facet-based-plan-assembly`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`)
2. The planner prompt’s `CAPABILITY REGISTRY SUMMARY` section renders only the CRCS table, ordering MRCS members first (original registry order preserved) followed by the remaining inclusion reasons; each row lists `capabilityId`, display name, facet coverage, and the `reasonCodes`. A configurable cap keeps this table within the semantic contract blueprint budget while telemetry (`flex.planner.prompt.*`) records prompt token counts improving by ≥20% compared to the pre-CRCS baseline. (`docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/tech-stack.md#1-core-runtime-components`)
3. `plan_requested`, `plan_generated`, and `plan_updated` SSE frames include a `crcs` payload summarizing total rows, MRCS size, and counts per `reasonCode`, while `TelemetryService` emits matching counters/histograms so Grafana dashboards can monitor CRCS density versus planner latency. (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
4. Capabilities referenced by planner/runtime policies, routing rules, or `goal_condition` repairs remain pinned in CRCS even if they fall outside MRCS reachability; `PolicyNormalizer`, `PlannerValidationService`, and `ContextBuilder` flag missing pinned capabilities as hard errors and request replans or operator escalation using the existing interaction flow. (`docs/architecture/flex-agents-server/5-core-concepts.md#plannerpolicy`, `docs/architecture/flex-agents-server/5-core-concepts.md#interaction-sequence`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`)
5. Automated coverage (unit + integration) proves each CRCS rule (reachability, facet overlap, identical contracts, policy/tag references, goal-condition references) produces the expected set, that the prompt table ordering and SSE payloads reflect the computed metadata, and that planner prompt size reductions do not change `plan_rejected` rates. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)
6. Architecture shards describing the capability registry, planner prompt blueprint, and flex API streaming contract document CRCS semantics, inclusion reasons, telemetry fields, and operator guidance. (`docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`)

## Tasks / Subtasks
- [ ] Implement `computeCrcsSnapshot()` within `packages/flex-agents-server/src/services/flex-capability-registry.ts` (or a sibling helper) to derive MRCS, expand per the CRCS union rules, attach `reasonCodes`, and expose typed responses via `packages/shared/src/flex/types.ts`. (AC 1) (`docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`)
- [ ] Update `packages/flex-agents-server/src/services/planner-service.ts` to hydrate CRCS snapshots, render the MRCS-first capability table with inclusion reasons, and emit `plannerPromptSize` alongside a new `flex.planner.crcs.rows` metric tied to env-configurable row caps. (AC 2) (`docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`)
- [ ] Extend `packages/flex-agents-server/src/services/telemetry-service.ts` and `packages/flex-agents-server/src/services/flex-run-coordinator.ts` so `plan_requested` / `plan_generated` / `plan_updated` frames and structured logs include CRCS counts plus MRCS deltas, keeping the SSE contract documented in the API shard. (AC 3) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
- [ ] Teach `packages/flex-agents-server/src/services/policy-normalizer.ts` and `packages/flex-agents-server/src/services/planner-validation-service.ts` to pin policy- or goal-condition-referenced capability IDs, raise validation errors when pinned capabilities are missing, and signal `ContextBuilder` / replans when heartbeat status changes mid-run. (AC 4) (`docs/architecture/flex-agents-server/5-core-concepts.md#plannerpolicy`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
- [ ] Add Vitest suites (`packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts`, `packages/flex-agents-server/__tests__/telemetry-crcs.spec.ts`) plus regression harnesses that compare prompt size metrics before/after CRCS to guarantee coverage of every union rule and SSE payload. (AC 5) (`docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Update `docs/architecture/flex-agents-server/5-core-concepts.md`, `docs/architecture/flex-agents-server/10-api-surface-initial.md`, and `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md` with CRCS definitions, telemetry guidance, and operator troubleshooting steps. (AC 6) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist`)

## Previous Story Insights
- Story 8.30 proved that trimming planner prompt tables to semantic capability summaries preserves validation success rates; CRCS should reuse the same semantic schema so the prompt blueprint stays consistent. (`docs/stories/8.30.flex-planner-prompt-optimization.md`)
- Story 8.37 added `goalConditionFailures` metadata to planner prompts and replans; CRCS metadata must coexist with that section so operators can correlate failed predicates with the broadened capability set. (`docs/stories/8.37.flex-goal-condition-replan.md`)

## Project Structure Notes
- Runtime changes live under `packages/flex-agents-server/src/services/**`, while shared CRCS metadata belongs in `packages/shared/src/flex/**`; follow the documented ownership boundaries to avoid scattering registry logic. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#5-shared-libraries`)

## Testing
- Follow the repository’s Vitest standards (unit + integration) and reuse existing flex orchestration harnesses to benchmark prompt size and CRCS coverage. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- Mirror the backend testing strategy expectations by covering registry-level unit tests plus end-to-end SSE verification so QA can trust CRCS telemetry. (`docs/architecture/discovery-agent-backend.md#testing-strategy`)

## Future Considerations
- Consider exposing CRCS diagnostics to the Flex Sandbox UI so operators can inspect inclusion reasons directly once backend telemetry stabilizes.
- Explore caching CRCS snapshots per run objective to further reduce planner latency after this foundational work ships.

## Dev Notes

### Previous Story Insights
- No specific guidance found in architecture docs.

### Data Models
- `flex_capabilities` persists capability metadata, heartbeat status, and facet coverage hints—CRCS snapshots should reuse these persisted signals rather than duplicating registry state. `[Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]`

### API Specifications
- `/api/v1/flex/run.stream` streams `plan_requested`, `plan_generated`, and `plan_updated` events; CRCS metadata must extend these payloads while honoring the documented SSE contract. `[Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]`

### Component Specifications
- `CapabilityRegistry`, `PlannerService`, `PolicyNormalizer`, `ContextBuilder`, and `TelemetryService` own registry hydration, plan synthesis, policy pinning, and lifecycle metrics, so CRCS logic must integrate with those components. `[Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities]`

### File Locations
- Planner/orchestrator services live under `packages/flex-agents-server/src/services/**`, and shared type definitions reside in `packages/shared/src/flex/**`, guiding where CRCS helpers and contracts should be committed. `[Source: docs/architecture/source-tree.md#4-agents-server]` `[Source: docs/architecture/source-tree.md#5-shared-libraries]`

### Testing Requirements
- Vitest is the required framework for both unit and integration coverage, and suites should reuse the existing in-memory harnesses noted for backend flows. `[Source: docs/architecture/coding-standards.md#7-testing-expectations]` `[Source: docs/architecture/discovery-agent-backend.md#testing-strategy]`

### Technical Constraints
- The flex stack runs on TypeScript + Nitro/OpenAI runtimes, and the planner prompt blueprint already limits system/user sections, so CRCS serialization must stay within those runtime and prompt constraints. `[Source: docs/architecture/tech-stack.md#1-core-runtime-components]` `[Source: docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-??-?? | v0.1 | Initial draft defining CRCS requirements, acceptance criteria, and tasks. | Bob (Scrum Master) |
