# Story 5.3: Bulk Promote & Archive

## Status
Approved

## Executive Summary
- Extends the discovery dashboard so reviewers can multi-select items and apply promote or archive actions in batches with clear confirmation safeguards.
- Coordinates frontend Pinia state, Vuetify dialogs, backend transactional batch endpoints, and SSE updates so actions stay resilient under concurrent usage.
- Ensures audit logging (Story 5.4) and telemetry counters capture every irreversible bulk action, enabling analytics and compliance follow-up.

## Story
**As a** reviewer,  
**I want** to apply bulk status changes with clear confirmation safeguards,  
**so that** I can manage high-volume discovery items efficiently without accidental mistakes.

## Dependencies
- Story 5.0 `Discovery Dashboard Foundation` provides shell, routing, SSE wiring, feature flag guard (`discovery.filters.v1`), and base service helpers.
- Story 5.1 `Discovery Item Listing & Filtering` supplies list virtualization, filter syncing, and selection scaffolding this story extends.
- Story 5.2 `Discovery Item Detail` ensures promoted items show updated status/history in the drawer after bulk actions fire.
- Story 5.4 `Bulk Discovery Item Audit Logging Contract` defines the audit schema and SSE messaging this implementation must emit.
- Story 5.5 `Discovery Search API & Highlighting` delivers the search endpoint the selection store relies on when refreshing after bulk operations.

## Estimate
- Size: Large (8 SP) — spans coordinated frontend Pinia/v-dialog work, two transactional batch endpoints, optimistic/conflict handling, telemetry/audit integration, and regression coverage tied to existing selection infrastructure.

## Supported Status Changes
- `scored` (Spotted) → `promoted` (Approved brief created)
- `scored` (Spotted) → `archived`
- `promoted` → `archived` (revoking brief without returning to Spotted)

## Acceptance Criteria
1. `DiscoveryDashboardView.vue` exposes a multi-select tray backed by `useDiscoveryListStore` + new `useBulkSelectionStore`; selections persist across pagination, virtualization, and filter changes until cleared by the reviewer, with a hard cap of 100 items.
2. Promote/archive dialogs reuse Vuetify `v-dialog` per architecture styling guidance, display selected count/action summary, require note input, and block submission until reviewers confirm the irreversible warning (“Are you sure? This action cannot be undone.”).
3. Backend provides transactional endpoints `POST /api/discovery/bulk/promote` and `POST /api/discovery/bulk/archive` that accept `{ actionId, clientId, itemIds[], note, actorId, filtersSnapshot }`, return per-item statuses (`success`, `conflict`, `failed`), and never partially apply without recording conflicts.
4. Conflicts (e.g., item promoted elsewhere) surface inline chips + toast messages identifying the specific items and reasons; successful items update in place, and conflicts remain selected for follow-up without clearing the rest of the batch.
5. Telemetry increments `bulk.promote.count` and `bulk.archive.count`, captures batch size + duration, and audit log writes follow Story 5.4 contract. Feature flag or permission failures hide bulk controls entirely.

## Tasks / Subtasks
- [ ] Extend selection persistence: create `src/stores/discovery/bulkSelection.ts` with metadata snapshot (filters, search term, client) and enforce 100-item cap + feature flag gating (AC 1).
- [ ] Implement Vuetify bulk action modals, selection tray UI, and Pinia actions that compose request payloads, invoke service helpers, show irreversible warning, and apply optimistic updates (AC 1-2).
- [ ] Add backend batch endpoints under `apps/server/src/routes/discovery/bulk.ts` (or equivalent module) with transactional safeguards, per-item result payloads, audit logging, and telemetry hooks (AC 3, AC 5).
- [ ] Surface conflict UX (inline chips + toast), selection preservation, reload-on-failure, and SSE fallback when offline (AC 4).
- [ ] Wire telemetry client and audit publisher to emit Story 5.4-compliant entries for promote/archive actions, including conflict annotations (AC 5).
- [ ] Write unit/integration/API/E2E tests covering selection persistence, irreversible confirmation, endpoint contracts (promote/archive), conflicts, telemetry, and SSE updates (AC 1-5).

## Dev Notes
- Batch limit: 100 items. Backend rejects larger requests with `422 limit_exceeded`; frontend shows inline warning while keeping selection so reviewers can deselect.
- `useBulkSelectionStore` snapshots filters/search term so batch payloads indicate context; store also tracks `bulkActionId` for telemetry correlation.
- Service layer additions (`src/services/discovery/bulkActions.ts`) centralize API calls, DTO typing, error normalization, and confirmation prompt state.
- Audit entries include irreversible indicator and action (`promote`, `archive`) for downstream analytics.
- Optimistic UI: mark selected cards as “Processing…” with skeleton overlay; rollback to prior state if API fails, retaining selection for retrial.
- Telemetry additions extend `TelemetryClient` with helpers for bulk metrics and durations; coordinate naming with analytics.

## Assumptions & Edge Cases
- Feature flag `discovery.filters.v1` remains the guard; hide bulk controls unless flag on and user role is reviewer.
- Switching client context prompts confirmation and clears any pending bulk selection/action queue to avoid cross-client mutations.
- Filters removing selected items keep them in a “Saved selection” tray with indicator that they’re outside current filter.
- Conflicts include: item promoted/archived elsewhere, already archived, brief already created, notes mismatched. Backend returns `conflictReason` strings for display.
- SSE disconnect fallback: when offline, show banner that action completed but list refresh awaits reconnection; manual refresh button stays available.

## References
- Epic context, scope, and risk mitigations: `docs/prd/epic-discovery-brief-dashboard.md#scope-in` and `docs/prd/epic-discovery-brief-dashboard.md#risks--mitigations`.
- UI structure, Pinia architecture, and styling conventions: `docs/architecture/discovery-agent-frontend.md#component-architecture` and `docs/architecture/discovery_agent_frontend/styling-guidelines.md`.
- Bulk testing expectations: `docs/architecture/discovery_agent_frontend/testing-requirements.md`.
- Audit logging schema to align with: `docs/stories/5.4.dashboard-audit-log-contract.md`.

## Testing
- Unit: stores (selection), bulk action service, telemetry emitters, confirmation dialog logic.
- Integration/API: supertest coverage for promote/archive endpoints validating transaction boundaries, conflict payloads, batch limit enforcement, audit + telemetry side effects.
- Frontend integration: Vue Test Utils scenarios for selection persistence across filters/pagination, optimistic state, irreversible warning confirmation, conflict chip display, SSE reconciliation.
- Playwright E2E: promote three items, accept irreversible warning, verify status updates; archive two items and confirm status; simulate conflict via fixture; attempt batch >100 to confirm inline warning; test offline fallback by dropping SSE connection mid-action.
- Concurrency: API/spec test to ensure overlapping promotes/archives resolve with per-item conflict statuses and do not block other successes.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Brief Management Dashboard. | PM |
| 2025-03-31 | 0.2 | Added dependencies, detailed technical guidance, references, and expanded testing scope. | SM |
| 2025-03-31 | 0.3 | Removed bulk delete scope; kept promote/archive batch flow with confirmation safeguards and telemetry. | SM |

## Dev Agent Record
_Not yet worked._
