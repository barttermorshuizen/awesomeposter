# Story 8.30: Planner Prompt Optimization – Semantic Contract Injection

## Status
Draft

## Story
**As a** PlannerService developer,  
**I want** the planner prompt to include semantic contract summaries instead of full JSON Schemas,  
**so that** the model can reason about plan topology efficiently while the orchestrator still validates structure deterministically.

## Acceptance Criteria
1. The PlannerService no longer injects full Ajv/Zod JSON Schemas into the system prompt.  
2. Each planner prompt includes a `facetCatalog` block with `{ name, direction, semantics }` entries for all relevant facets in the current run.  
3. Each planner prompt includes a `capabilities` block with `{ capabilityId, inputs[], outputs[], summary }` for all active capabilities in the `CapabilityRegistry`.  
4. Planner prompts remain ≤ 2.5k tokens (excluding user objective/input sections).  
5. Generated plans remain semantically valid and pass `PlannerValidationService` (no increase in `plan_rejected` rate).  
6. Existing Ajv/Zod validation pipeline continues to enforce structural correctness — no schema enforcement logic is moved into the planner.  
7. Logging/telemetry on `plan_requested` includes a `plannerPromptSize` metric for future tuning.  
8. Documentation is updated under `docs/flex/planner.md` explaining the semantic contract model and reasoning expectations.

## Tasks / Subtasks
- [ ] Implement `serializePlannerContracts()` in `packages/flex-agents-server/src/utils/flex-planner-contracts.ts` to emit `{ facets[], capabilities[] }` summaries sourced from the registry and catalog (AC 1-3,6).  
- [ ] Update the PlannerService prompt builder to replace schema payloads with serialized summaries and gate verbose schema mode behind `FLEX_PLANNER_VERBOSE_SCHEMAS` (AC 1-3,6).  
- [ ] Emit `plannerPromptSize` from `TelemetryService.plan_requested`, derived from the assembled prompt token count (AC 4,7).  
- [ ] Benchmark ~50 sandbox runs covering varied objectives to compare `plan_rejected` rate before/after the change (AC 4-5).  
- [ ] Refresh `docs/flex/planner.md` with semantic vs structural contract guidance and prompt expectations (AC 8).  
- [ ] Archive the legacy full-schema prompt template while retaining a debug fallback flag for operators (AC 1,6).

## Dev Notes

### Previous Story Insights
- No downstream implementation notes from Story 8.29 directly impact planner prompt structure; baseline validation/telemetry flows remain authoritative.

### Data & Contract Sources
- Facet semantics, directionality, and schema fragments live in the shared `FacetCatalog`; use `getFacetCatalog()` so planner summaries stay aligned with orchestrator contract compilation. `[Source: docs/architecture/flex-agents-server.md#facet-definition]`
- Capability metadata (inputs, outputs, summaries, heartbeat state) is surfaced through the in-memory `CapabilityRegistry`; consumer utilities should pull via `listActive` / `getCapabilityById` instead of reading persistence layers directly. `[Source: docs/architecture/flex-agents-server.md#11-capability-registry-agent-contracts]`
- Plans remain validated and compiled by the orchestrator after the planner returns a draft, so semantic summaries must preserve enough intent for `PlannerValidationService` to enforce structural contracts. `[Source: docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration]`

### Prompt Assembly & Validation
- Current planner prompts hydrate capability snapshots and facet catalog details so draft plans only reference available contracts; new summaries must continue to encode derivation hints for downstream validation. `[Source: docs/architecture/flex-agents-server.md#story-8-8-dynamic-assembly-details]`
- Planner lifecycle events (`plan_requested`, `plan_rejected`, `plan_generated`) already emit capability/facet metadata; ensure telemetry remains consistent when prompt payload changes. `[Source: docs/architecture/flex-agents-server.md#planner-lifecycle-events]`

### File Locations & Implementation Notes
- Flex agents server utilities live under `packages/flex-agents-server/src`; keep planner helpers near existing orchestration utilities for discoverability. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- Shared facet definitions reside in `packages/shared/src/flex/facets`; avoid duplicating semantics inside planner code paths. `[Source: docs/architecture/source-tree.md#5-shared-libraries]`
- Maintain TypeScript-first implementations with strict typing and shared Zod schemas per workspace coding standards. `[Source: docs/architecture/coding-standards.md#1-language--module-conventions]`

### Telemetry & Observability
- `TelemetryService` streams normalized planner lifecycle frames; extend payloads rather than inventing new events when attaching the `plannerPromptSize` metric. `[Source: docs/architecture/flex-agents-server.md#11-capability-registry-agent-contracts]`
- Structured logs mirror SSE events (`flex_plan_requested`, etc.); update logging helpers concurrently so Grafana queries continue to function. `[Source: docs/architecture/flex-agents-server.md#planner-lifecycle-events]`

### Testing
- Add Vitest coverage around the new serialization utility and prompt builder to confirm schema fallback gating and semantic payload shape. `[Source: docs/architecture/coding-standards.md#7-testing-expectations]`
- Re-run the flex maintenance suites for facet/catalog alignment and capability registry contracts after updating prompt logic. `[Source: docs/architecture/flex-agents-server.md#maintenance-checklist]`
- Ensure QA benchmarking for sandbox runs captures `plan_rejected` deltas and planner latency metrics before closing the story. `[Source: docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration]`

## Non-Goals
- Changes to orchestrator-side validation logic or output schema enforcement.
- Introducing new planner endpoints or planner runtime models beyond telemetry instrumentation.

## Definition of Done
- Planner prompt size reduced by ≥ 70% relative to baseline.
- No increase in invalid or rejected plan graphs across 50+ sandbox validations.
- Benchmarked planner latency improves by ≥ 35% on average.
- All documentation and telemetry updates merged and reviewed.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| - | - | - | - |
