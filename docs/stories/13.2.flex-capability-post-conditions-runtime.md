# Story 13.2: Capability Post-Condition Runtime Enforcement

## Status
Draft

## Story
**As a** flex orchestrator runtime engineer,  
**I want** capability-level post-condition metadata to flow through planning, execution, and policy controls,  
**so that** every capability proves it satisfied its guarded facets before nodes complete and operators receive trustworthy telemetry.

**Dependencies:** Story 13.1 – Capability Post-Condition Metadata & Persistence (`docs/stories/13.1.flex-capability-post-conditions-metadata.md`)

## References
- `docs/prd/epic-flex-capability-post-conditions.md#stories`
- `docs/stories/13.1.flex-capability-post-conditions-metadata.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`
- `docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`
- `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/coding-standards.md#7-testing-expectations`

## Acceptance Criteria
1. **Planner surfaces capability post-condition guards.** `CapabilityRegistryService` exposes the compiled `postConditions` payload and summarised `postConditionGuards`, and `PlannerService` injects that data into CRCS snapshots, plan prompts, and `PlanGraph` nodes so SSE `plan_generated/plan_updated` frames enumerate the facets each node enforces. (AC Source: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`, `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
2. **Execution engine evaluates capability post conditions before node completion.** `ExecutionEngine` compiles each capability’s `postConditions` with the shared Condition DSL helper, evaluates them against the node’s facet snapshot prior to emitting `node_complete`, blocks completion when any predicate fails, and triggers the same automatic replan semantics described for `goal_condition` arrays (including retries capped by a configuration flag). (AC Source: `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
3. **Runtime policy controls and retry budgets guard failures.** Capability post-condition failures raise deterministic `RuntimePolicy` triggers that honour env defaults (for example `FLEX_CAPABILITY_POST_CONDITION_MAX_RETRIES`) and optional per-capability overrides, emitting `policy_triggered`, `goal_condition_failed`, or `hitl_request` frames that describe the action taken (`replan`, `hitl`, `fail`, etc.). (AC Source: `docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
4. **Persistence and telemetry capture per-capability predicate results.** `flex_plan_nodes`, `flex_plan_snapshots`, and `flex_run_outputs` persist both the submitted DSL and evaluated JSON-Logic results for every capability, and SSE `node_complete`, `plan_updated`, `goal_condition_failed`, and final `complete` frames surface `{ facet, path, satisfied, error }` entries so operators/UIs can replay condition outcomes without replaying executions. (AC Source: `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
5. **Regression coverage protects planner propagation, evaluation, and policy flows.** Unit/integration suites in `packages/flex-agents-server` and `@awesomeposter/shared` validate planner propagation of `postConditions`, runtime evaluation outcomes (pass/fail/error), policy trigger sequencing, and telemetry payloads, satisfying the project’s testing standards. (AC Source: `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server/13-verification.md`)

## Tasks / Subtasks
- [ ] Extend `CapabilityRegistryService`, CRCS generation, and `PlannerService` so compiled `postConditions` accompany each capability row, node, and SSE planner payload, including provenance strings the prompt can reuse. (AC1) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`, `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`)
- [ ] Persist post-condition metadata on plan snapshots and node persistence models so downstream resumes/HITL flows reload guard details without re-querying the registry. (AC1, AC4) (`docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`)
- [ ] Implement capability-level predicate evaluation inside `ExecutionEngine`: compile via the Condition DSL helper, evaluate before `node_complete`, and reuse the existing goal-condition failure/replan pipeline when predicates fail or error. (AC2) (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
- [ ] Wire runtime policy + retry controls so capability predicate failures consult env defaults/per-capability overrides, trigger canonical `RuntimePolicy` actions, and stream `policy_triggered` / `goal_condition_failed` events with rationale. (AC3) (`docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
- [ ] Enrich SSE payloads (`node_complete`, `plan_updated`, `complete`) and telemetry logs with the evaluated predicate array, and document the new fields inside the architecture shard. (AC4) (`docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
- [ ] Add Vitest coverage in `packages/flex-agents-server/__tests__/` plus shared contract tests to assert planner propagation, predicate evaluation, policy retries, and telemetry output; keep suites wired into `npm run test:unit`. (AC5) (`docs/architecture/flex-agents-server/13-verification.md`, `docs/architecture/coding-standards.md#7-testing-expectations`)

## Story Context
- Epic FLEX-CAP-PC-1 expects capability-level post conditions to drive automatic retries, replans, and operator visibility; this story delivers the planner/runtime enforcement layer that sits between metadata (Story 13.1) and UI tooling (Story 13.3). (`docs/prd/epic-flex-capability-post-conditions.md#stories`)
- Planner prompts and CRCS tables already highlight goal-condition-driven provenance; extending them with capability `postConditionGuards` keeps the planner, runtime, and operator tooling aligned. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`)
- Automatic retries and escalations reuse the existing goal-condition failure semantics, preventing duplicate policy implementations while keeping latency predictable. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`)

## Dev Notes
- **Previous Story Insights:** Story 13.1 introduced the optional `postConditions: FacetCondition[]` field on capability registrations and persisted the compiled DSL/JSON-Logic metadata so runtime code can consume a canonical contract without revalidating inputs. [Source: docs/stories/13.1.flex-capability-post-conditions-metadata.md]
- **Data Models:** Store evaluated predicate payloads (raw DSL, canonical JSON-Logic, `satisfied`, `error`, guarded facets) on `flex_plan_nodes`, plan snapshots, and `flex_run_outputs` so resumptions, audits, and operators can reconstruct node state. [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]
- **API Specifications:** `/api/v1/flex/run.stream` events (`plan_generated`, `plan_updated`, `node_complete`, `policy_triggered`, `goal_condition_failed`, `complete`) already deliver planner metadata and goal-condition results; extend those payloads with capability-level predicate arrays while keeping the existing SSE contract stable. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
- **Component Specifications:** `CapabilityRegistry`, `PlannerService`, `ContextBuilder`, `ExecutionEngine`, `PolicyNormalizer`, and `TelemetryService` coordinate capability selection, node execution, and event streaming—predicate enforcement must integrate with these components without bypassing their responsibilities. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph]
- **File Locations:** Planner/runtime changes belong in `packages/flex-agents-server/src/services/**`, shared type updates in `packages/shared/src/flex/**`, persistence adjustments in `packages/db/**`, and documentation in `docs/architecture/flex-agents-server/**`, matching the source-tree guidance. [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/source-tree.md#5-shared-libraries] [Source: docs/architecture/source-tree.md#6-documentation-assets]
- **Testing Requirements:** Follow repository expectations by expanding Vitest suites (`packages/flex-agents-server/__tests__`, `packages/shared/__tests__/condition-dsl.spec.ts`) and ensuring `npm run test:unit`, `npm run lint`, and `npm run type-check` pass—there is no separate testing-strategy document beyond these standards. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/flex-agents-server/13-verification.md]
- **Technical Constraints:** Implement runtime checks in TypeScript, reuse the shared Condition DSL compiler/evaluator to normalize predicates, and honour the existing goal-condition replan limits so runtime behaviour stays deterministic. [Source: docs/architecture/tech-stack.md#1-core-runtime-components] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope]

## Testing
- `npm run test:unit -- packages/shared packages/flex-agents-server` – shared predicate compiler + runtime evaluation coverage. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run lint` – enforce TypeScript/Vue lint gates before handoff. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run type-check` – validate strict typing for planner/runtime services. (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Project Structure Notes
- Keep planner/runtime logic under `packages/flex-agents-server/src/services/**` and Capability Registry helpers within the same workspace to maintain the documented agents-server layout. (`docs/architecture/source-tree.md#4-agents-server`)
- Shared contract additions (FacetCondition helpers, predicate result types) belong in `packages/shared/src/flex/**`, and any DB schema updates stay scoped to `packages/db/src` plus forward-only migrations. (`docs/architecture/source-tree.md#5-shared-libraries`)
- Architecture docs reflecting the new SSE payloads and enforcement model live under `docs/architecture/flex-agents-server/**`; avoid scattering requirements elsewhere. (`docs/architecture/source-tree.md#6-documentation-assets`)

## Change Log
| Date       | Version | Description                                                          | Author        |
|------------|---------|----------------------------------------------------------------------|---------------|
| 2025-11-14 | 0.1     | Initial draft covering runtime enforcement, planner propagation, and policy scope for capability post conditions. | Scrum Master |
