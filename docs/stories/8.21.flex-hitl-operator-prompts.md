# Story 8.21: Flex HITL Operator Prompt Payloads

## Status
Draft

## Story
**As a** HITL operator,  
**I want** flex HITL requests to carry the pending node contract and an orchestration-recommended prompt,  
**so that** I can approve or correct runs with full context and the system can rehydrate accurately after my decision.

## Acceptance Criteria
1. `FlexExecutionEngine` (and supporting repositories) persist HITL request metadata that includes the pending node ID, compiled facet contract summary, and a recommended operator instruction string alongside existing HITL tables, ensuring the data survives rehydration. (`docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
2. `hitl_request` SSE frames and resume payloads surface the serialized contract metadata and operator prompt so the SPA approval modal can display precise instructions without extra lookups. (`docs/architecture/flex-agents-server.md#10-0-1-flex-run-streaming-contract`, `docs/architecture/flex-agents-server.md#12-ui-client-integration`)
3. Resumed runs reload the stored HITL metadata (node contract + prompt) via `FlexRunCoordinator`, repopulate context bundles, and continue execution without manual reconstruction, with automated tests covering approval, rejection, and stale snapshot cases. (`docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`, `docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
4. Architecture documentation and operator guidance are updated to describe the enriched HITL payloads, including how UI surfaces the recommendation and how snapshots capture the metadata. (`docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`, `docs/architecture/flex-agents-server.md#12-ui-client-integration`)

## Tasks / Subtasks
- [ ] Extend `hitl_requests` persistence (Drizzle schema + migration) to store pending node ID, compiled contract JSON, and recommended operator prompt for flex runs, and wire repository helpers to read/write the metadata. (AC 1) (`docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- [ ] Update `FlexExecutionEngine` / HITL adapter to serialize node contract details and author prompt guidance before raising HITL, ensuring snapshots and resume flows include this metadata. (AC 1, AC 3) (`docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`)
- [ ] Enrich `hitl_request` SSE payloads and resume responses with contract + prompt fields, and adjust `useHitlStore` (or equivalent UI store) to render the guidance in the approval modal. (AC 2) (`docs/architecture/flex-agents-server.md#10-0-1-flex-run-streaming-contract`, `docs/architecture/flex-agents-server.md#12-ui-client-integration`)
- [ ] Add Vitest coverage for HITL persistence/resume (agents server + DB) and SPA store/component tests asserting the prompt/contract display, including stale snapshot and rejection scenarios. (AC 2, AC 3) (`docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
- [ ] Document the new HITL payload fields in `flex-agents-server.md` and any operator-facing runbooks, highlighting approval guidance and rehydration expectations. (AC 4) (`docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`)

## Dev Notes
- **Previous Story Insights**: HITL pause/resume wiring exists from Story 8.10, but operators currently see limited context; the architecture calls for bundling node contracts and recommended prompts with HITL requests. `[Source: docs/stories/8.10.flex-planner-phase-2.md#story-context]` `[Source: architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy]`
- **Data Models**: `hitl_requests`, `hitl_events`, and `flex_plan_snapshot` store run state; extend the Drizzle schema to persist contract metadata and prompts without breaking existing records. `[Source: architecture/flex-agents-server.md#9-data-model--persistence]`
- **API Specifications**: `hitl_request` SSE frames and resume payloads must expose the enriched metadata while keeping the documented event signature stable. `[Source: architecture/flex-agents-server.md#10-0-1-flex-run-streaming-contract]`
- **Component Specifications**: `FlexExecutionEngine`, `FlexRunCoordinator`, HITL adapters, and the SPA approval modal coordinate HITL flows; enrich these components with the new metadata. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]` `[Source: architecture/flex-agents-server.md#12-ui-client-integration]`
- **File Locations**: Agents server code lives under `packages/flex-agents-server/src/`, persistence in `packages/db`, and SPA HITL UI within `src/stores` + `src/views`. `[Source: architecture/source-tree.md#4-agents-server]` `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#2-spa-src]`
- **Testing Requirements**: Follow Vitest strategy for agents server, DB migrations, and SPA components when adding coverage for HITL metadata serialization and UI rendering. `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`
- **Technical Constraints**: Maintain TypeScript-first implementation with strict typing, reuse Zod validation, and follow existing logging/auth patterns when emitting HITL events. `[Source: architecture/coding-standards.md#1-language--module-conventions]` `[Source: architecture/coding-standards.md#4-agents-server-standards]`

## Project Structure Notes
- Persist HITL metadata via `packages/db` migrations and repositories, keep orchestrator logic in `packages/flex-agents-server/src`, and update SPA HITL views/stores under `src/` per the source tree guide. `[Source: architecture/source-tree.md#4-agents-server]` `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#2-spa-src]`

## Testing
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-hitl-prompts.spec.ts packages/db/__tests__/hitl-request-metadata.spec.ts src/stores/__tests__/useHitlStore.flex-hitl.spec.ts` `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-27 | 0.1 | Initial draft capturing HITL prompt/contract payload requirements. | Scrum Master |
