# Story 5.5: Discovery Search API & Highlighting

## Status
Draft

## Story
**As a** backend engineer,
**I want** to expose a search endpoint that powers the discovery dashboard filters and highlights,
**so that** the frontend can list and paginate discovery items with accurate metadata and performance guarantees.

## Context & Rationale
- Story 5.1 requires filters, keyword search, highlighting, and pagination for ≥1,000 items, but no Nitro handler or repository query currently exists.
- SSE telemetry events are available, yet there is no reconciliation endpoint to refresh filtered lists or queue mismatched payloads.
- This story delivers the `/api/discovery/search` contract, persistence queries, and performance instrumentation that downstream UI and telemetry stories rely upon.

## Acceptance Criteria
1. `GET /api/discovery/search` accepts query params for source IDs, topics, statuses, date range, page, page size (25/50/100), and search term; invalid params return structured 400 errors.
2. Response payload includes `{ items, total, page, pageSize, latencyMs }` where each item carries highlight metadata `{ field, snippets[] }` derived from indexed data and is safe for HTML rendering.
3. Queries are backed by indexes/cursors to support ≥1,000 item pagination within 400ms P95 under seeded load; virtualization fallback guidance is documented.
4. Endpoint respects feature flags and client scoping, and emits telemetry events for search latency, filter usage, and SSE degrade triggers (`discovery.search.requested`, `discovery.search.completed`).
5. Load/perf test script seeds sample data, exercises the endpoint at target throughput (50 RPS), and records results in `docs/qa/perf/discovery-filters.md`; rollback/disable playbook is updated.

## Tasks / Subtasks
- [ ] Define Zod schemas and validation utilities shared with the frontend for filters/search parameters (AC 1).
- [ ] Implement repository query using Drizzle with appropriate indexes (status, score, createdAt, text/TS vector) and deterministic cursor ordering (AC 2, AC 3).
- [ ] Add Nitro handler `server/api/discovery/search.get.ts` with auth, feature-flag, and client gating (AC 1, AC 4).
- [ ] Generate highlight snippets server-side leveraging existing normalization fields, escaping output to avoid XSS (AC 2).
- [ ] Emit telemetry events/metrics for latency, filter usage, and SSE degrade fallback readiness (AC 4).
- [ ] Write integration/unit tests covering validation errors, pagination boundaries, highlight payloads, and latency instrumentation (AC 1-4).
- [ ] Create or update load/perf script (e.g., `scripts/discovery-search-benchmark.mjs`) and document baseline metrics + rollback plan (AC 5).
- [ ] Update architecture docs and runbooks with new endpoint contract, indexes, and monitoring expectations (AC 3, AC 4, AC 5).

## Dependencies
- Requires ingestion pipeline to have populated `discovery_items` with normalized text + metadata (stories 3.x).
- Telemetry infrastructure from Epic 6 should be available to persist search metrics.

## Open Questions
- Confirm final index strategy (Postgres tsvector vs trigram). Selection impacts highlight implementation and load targets.
- Determine if search should support `Approved` briefs or remain `Spotted` only for MVP.

## Testing
- Unit/integration tests in `tests/api/discovery/search.spec.ts` with seeded data for filter combinations, highlight fields, and pagination edge cases.
- Load testing using `k6`/`autocannon` running seeded dataset (1k items) to confirm performance budget and record metrics in QA doc.
- Contract tests ensuring telemetry events fire with expected schema for downstream dashboards.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-31 | 0.1 | Draft search API story created after sprint change proposal. | SM |

## Dev Agent Record
_Not yet worked._
