# Story 8.33: Flex TaskEnvelope Goal Condition Schema

## Status
Draft

## Story
**As a** flex orchestrator contract owner,  
**I want** the TaskEnvelope to capture an optional goal condition anchored to facet data,  
**so that** callers can express the desired completion predicate without waiting for downstream planner changes.

## Acceptance Criteria
1. `TaskEnvelope` in `@awesomeposter/shared/flex` includes an optional `goal_condition` object matching `{ facet: string; path: string; condition: string }` with `additionalProperties: false`, keeping existing fields untouched. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope] [Source: docs/architecture/source-tree.md#5-shared-libraries]
2. The shared module exports a documented `GoalCondition` type/Zod schema and updates TaskEnvelope comments to explain how the field references facet state and Condition DSL expressions. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
3. Architecture documentation for the TaskEnvelope and API example payloads describe and demonstrate the optional `goal_condition`, aligning callers on structure and intent. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope] [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
4. Vitest coverage guards the new schema: valid `goal_condition` objects pass, missing required keys or unknown properties fail, and envelopes lacking the field still validate. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Extend `packages/shared/src/flex/types.ts` so the TaskEnvelope Zod schema and TypeScript type include the optional `goal_condition` and expose a `GoalCondition` helper. (AC 1, AC 2) [Source: docs/architecture/source-tree.md#5-shared-libraries] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope]
- [ ] Refresh TaskEnvelope narrative in `docs/architecture/flex-agents-server/5-core-concepts.md` to call out `goal_condition` purpose, tying it to facet-driven goals and Condition DSL usage. (AC 2, AC 3) [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
- [ ] Update sample envelope(s) in `docs/architecture/flex-agents-server/10-api-surface-initial.md` so callers see `goal_condition` in context with existing fields. (AC 3) [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
- [ ] Add Vitest tests under the shared package validating acceptance and rejection cases for `goal_condition`. (AC 4) [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Dev Notes

### Previous Story Insights
- Story 8.32 (Flex Policy RunContext Condition Evaluation) remains in Ready for Dev, introducing runtime predicate handling; this story only adds the envelope field and does not implement evaluation logic yet. [Source: docs/stories/8.32.flex-policy-runcontext-conditions.md]

### Data Models
- TaskEnvelope is the canonical request payload shared by planner, runtime, and UI; `@awesomeposter/shared/flex` hosts the TypeScript/Zod definitions that must remain authoritative. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope]
- Facet definitions underpin goal targeting, so `goal_condition.facet` should align with catalogued facet names while `path` drills into the facet payload schema. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition]
- Condition expressions reuse the existing Condition DSL infrastructure; the schema should accept DSL strings without triggering evaluation in this story. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]

### API Specifications
- `POST /api/v1/flex/run.stream` accepts TaskEnvelope payloads and streams run lifecycle events; sample bodies should illustrate the optional `goal_condition` for callers. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]

### Component Responsibilities
- Shared flex contract exports keep planner, orchestrator, and UI aligned; extending the TaskEnvelope schema here propagates the field across services consuming the module. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope]

### File Locations
- Update `packages/shared/src/flex/types.ts` (and related index exports) for schema changes; keep documentation changes under `docs/architecture/flex-agents-server/*.md`. [Source: docs/architecture/source-tree.md#5-shared-libraries]

### Technical Constraints
- Implement the schema additions in TypeScript using the existing Zod validators per repository standards; avoid introducing new dependencies. [Source: docs/architecture/coding-standards.md#1-language--module-conventions]

### Project Structure Notes
- No new packages or directories neededâ€”extend the shared flex types module and documentation shards already described in the architecture tree. [Source: docs/architecture/source-tree.md#5-shared-libraries]

### Testing
- Add or extend Vitest suites under `packages/shared/__tests__` to assert valid/invalid `goal_condition` envelopes while keeping regression coverage for envelopes without the field. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| - | - | - | - |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
