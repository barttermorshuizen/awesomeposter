# Story 13.4: Capability Post-Conditions – Marketing Catalog Adoption

## Status
Draft

## Story
**As a** flex capability catalog maintainer,  
**I want** every curated marketing capability to publish the same `postConditions` metadata introduced in Stories 13.1–13.3,  
**so that** planner/runtime enforcement covers production-ready strategist, copywriter, and designer agents and operators can trust their outputs without bolting on per-capability overrides.

**Dependencies:**  
- Story 13.1 – Capability Post-Condition Metadata & Persistence (`docs/stories/13.1.flex-capability-post-conditions-metadata.md`)  
- Story 13.2 – Capability Post-Condition Runtime Enforcement (`docs/stories/13.2.flex-capability-post-conditions-runtime.md`)  
- Story 13.3 – Capability Post-Condition Tooling & Observability (`docs/stories/13.3.flex-capability-post-conditions-tooling.md`)

## References
- `docs/prd/epic-flex-capability-post-conditions.md#stories`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`
- `docs/architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry`
- `docs/architecture/flex-agents-server/5-core-concepts.md#561-capability-registration`
- `docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/source-tree.md#6-documentation-assets`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#7-testing-expectations`

## Acceptance Criteria
1. **Marketing catalog publishes canonical post conditions.** `packages/shared/src/flex/marketing-catalog.ts` (and any mirrored fixtures) define `postConditions: FacetCondition[]` for every curated capability, covering the `strategist.SocialPosting`, `strategist.Positioning`, `copywriter.SocialpostDrafting`, `copywriter.Messaging`, `designer.VisualDesign`, `director.SocialPostingReview`, and `director.PositioningReview` records. Each predicate aligns with a documented output facet/path (for example `post_copy/value[0].status == "ready_for_review"` or `feedback/value[*].resolution != "open"`), includes DSL + compiled JSON-Logic metadata, and defaults to monitor-only when a capability legitimately cannot express a guard. (Sources: `docs/architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
2. **Agent modules self-register with the new guards.** Nitro bootstrap modules (`packages/flex-agents-server/src/agents/**`) import the updated catalog data (or explicitly set matching post conditions) so `/api/v1/flex/capabilities/register` receives the compiled predicates, and `listActive/getCapabilityById` returns them via the registry cache, ensuring planner CRCS rows and runtime enforcement reuse the shared metadata without divergence. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`, `docs/architecture/flex-agents-server/5-core-concepts.md#561-capability-registration`)
3. **Documentation enumerates marketing post-condition guards.** `docs/architecture/flex-agents-server/511-reference-capability-registry.md` (and linked rollout notes) call out each capability’s guarded facets, pointer, and predicate intent so downstream teams know how enforcement behaves. Rollback guidance explains how to disable the guards (e.g., remove `postConditions` entries) without deleting the rest of the marketing catalog. (Sources: `docs/architecture/source-tree.md#6-documentation-assets`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`)
4. **Regression coverage locks the payload contract.** Existing suites that snapshot capability registrations (`packages/shared/__tests__/flex/capability-registration.spec.ts`, `packages/flex-agents-server/__tests__/flex-capability-register.route.spec.ts`, `packages/flex-agents-server/__tests__/flex-capability-registry.spec.ts`, `packages/flex-agents-server/__tests__/marketing-strategy-smoke.spec.ts`) assert the `postConditions` arrays, DSL canonicalisation, and summary metadata so future catalog edits can’t regress enforcement inadvertently. (Sources: `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
5. **Planner/runtime consumers degrade gracefully.** When a marketing capability lacks a relevant predicate (e.g., purely human approvals), the catalog explicitly sets `postConditions = []` with rationale documented; acceptance includes verifying runtime enforcement treats such entries as no-op while still surfacing guard summaries in SSE payloads and debug endpoints added in Story 13.3. (Sources: `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/stories/13.3.flex-capability-post-conditions-tooling.md`)

## Tasks / Subtasks
- [ ] Extend `packages/shared/src/flex/marketing-catalog.ts` (plus regression fixtures) to add per-capability `postConditions` entries that reference the correct facet/path combinations and reuse the shared Condition DSL helper for canonical metadata. (AC1) (`docs/architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
- [ ] Update every marketing agent module under `packages/flex-agents-server/src/agents/marketing/**` to import the new catalog payload (or mirror the exact `postConditions`) so registry self-registration emits matching metadata and avoids drift between shared contracts and runtime registrations. (AC2) (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`)
- [ ] Refresh architecture docs (reference registry plus rollout guidance) to document the post-condition guards, how they map to operator expectations, and the rollback switch for disabling marketing enforcement if regressions surface. (AC3) (`docs/architecture/source-tree.md#6-documentation-assets`)
- [ ] Expand Vitest suites to snapshot `postConditions` for marketing registrations and ensure planner/runtime fixtures read them (registry route, catalog exports, marketing smoke tests). (AC4) (`docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Validate that planner/runtime/telemetry payloads reflect the new guard metadata even when some capabilities keep an empty array, and note any edge cases (e.g., human-only reviewers) in the architecture doc so operators know why a guard is absent. (AC5) (`docs/stories/13.3.flex-capability-post-conditions-tooling.md`)

## Story Context
- Epic FLEX-CAP-PC-1’s final story delivers enforcement parity for the marketing catalog, ensuring the runtime + UI work from Stories 13.2/13.3 applies to production capabilities rather than remaining theoretical. (`docs/prd/epic-flex-capability-post-conditions.md#stories`)
- The curated marketing catalog already centralises capability metadata and feeds both registry self-registration and sandbox metadata, making it the canonical place to author `postConditions`. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`)
- Planner and runtime layers now surface `postConditionGuards` and `postConditionResults`; this story focuses on populating those arrays for live capabilities rather than altering runtime behaviour. (`docs/stories/13.2.flex-capability-post-conditions-runtime.md`, `docs/stories/13.3.flex-capability-post-conditions-tooling.md`)

## Dev Notes
- **Previous Story Insights:** Story 13.2 wired registry → planner → runtime guard propagation, while Story 13.3 added operator tooling; both assume capabilities actually publish `postConditions`, so this story must fill in the marketing catalog gaps without changing enforcement logic. [Source: docs/stories/13.2.flex-capability-post-conditions-runtime.md; docs/stories/13.3.flex-capability-post-conditions-tooling.md]
- **Data Models:** Shared capability records live in `packages/shared/src/flex/types.ts` and `packages/shared/src/flex/marketing-catalog.ts`, and runtime persistence stores the compiled predicate metadata, so code should reuse the same TypeScript types and keep schema changes additive. [Source: docs/architecture/source-tree.md#5-shared-libraries; docs/architecture/flex-agents-server/5-core-concepts.md#561-capability-registration]
- **API / Registry Behaviour:** `/api/v1/flex/capabilities/register` already validates `postConditions` via the Condition DSL helper; ensure new entries pass validation and persist through `flex_capabilities.post_conditions_*` columns so CRCS rows and SSE payloads stay in sync. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract; docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
- **Component Responsibilities:** Agent modules under `packages/flex-agents-server/src/agents/marketing/**` act as the source of truth for registry payloads—keep their metadata aligned with the shared catalog exports to avoid drift that would confuse planner prompts or sandbox metadata. [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#supporting-utilities]
- **Documentation:** `docs/architecture/flex-agents-server/511-reference-capability-registry.md` must enumerate each guard so operations teams can troubleshoot failing predicates, and rollout instructions should mention how to temporarily remove or override catalog guards if regressions appear. [Source: docs/architecture/source-tree.md#6-documentation-assets]
- **Testing Requirements:** Follow repo standards (`npm run test:unit`, `npm run lint`, `npm run type-check`) and extend existing registry/catalog suites to cover the new metadata; ensure fixtures (e.g., JSON snapshots) include `postConditions`. [Source: docs/architecture/coding-standards.md#7-testing-expectations]

## Testing
- `npm run test:unit -- packages/shared/__tests__/flex/capability-registration.spec.ts packages/flex-agents-server/__tests__/flex-capability-register.route.spec.ts packages/flex-agents-server/__tests__/flex-capability-registry.spec.ts packages/flex-agents-server/__tests__/marketing-strategy-smoke.spec.ts` – validates shared catalog exports, registry endpoints, and marketing smoke paths cover the new `postConditions`. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run lint` – ensures shared packages and agents server metadata continue to satisfy lint gates. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run type-check` – verifies strict TypeScript types across shared catalog and agents server modules. (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Project Structure Notes
- Shared capability metadata (including new `postConditions`) belongs in `packages/shared/src/flex/marketing-catalog.ts` plus related fixtures/tests. (`docs/architecture/source-tree.md#5-shared-libraries`)
- Agents server modules that self-register capabilities live under `packages/flex-agents-server/src/agents/marketing/**`; keep their payloads synchronized with the catalog. (`docs/architecture/source-tree.md#4-agents-server`)
- Architecture documentation updates reside in `docs/architecture/flex-agents-server/511-reference-capability-registry.md` (and related rollout sections). (`docs/architecture/source-tree.md#6-documentation-assets`)

## Change Log
| Date       | Version | Description                                                                                       | Author        |
|------------|---------|---------------------------------------------------------------------------------------------------|---------------|
| 2025-11-14 | 0.1     | Draft defining marketing catalog adoption of capability post conditions and related test/doc work | Scrum Master |
