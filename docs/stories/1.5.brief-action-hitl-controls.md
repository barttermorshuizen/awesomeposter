# Story 1.5: Brief Action HITL Recovery Controls - Brownfield Addition

## Status
In Progress

## Story
**As an** internal operator,
**I want** to resume or remove an in-progress create-post run directly from the briefing action menu,
**so that** I can recover or clean up stalled HITL runs without opening the create-post popup.

## Story Context
**Existing System Integration:**

- Integrates with: Brief action menu (list and detail views), create-post popup recovery flows, orchestrator HITL persistence APIs
- Technology: Vue 3 + Vuetify UI, Pinia stores (`useHitlStore`), Nitro endpoints for HITL recovery
- Follows pattern: Story 1.3 HITL prompt handling, Story 1.4 resume/remove orchestration controls
- Touch points: `AgentResultsPopup.vue`, brief card/detail action menu components, `src/stores/hitl.ts`, `/api/hitl/resume`, `/api/hitl/remove`

## Acceptance Criteria
**Functional Requirements:**
1. Brief action menu surfaces "Resume creating post" whenever the associated briefing has an active pending orchestration/HITL request and hides the standard "Create post" option while the pending run exists.
2. Brief action menu surfaces "Remove running create post" when a briefing has a suspended or pending run, presenting a simple confirmation dialog before executing.
3. The create-post popup no longer shows a dedicated recovery panel; resume/remove actions are decoupled from the popup and rely on the action menu triggers.

**Integration Requirements:**
4. Existing create-post popup HITL prompt experience from Story 1.3 continues to function unchanged aside from the removed recovery panel.
5. New action menu controls reuse the existing `useHitlStore` (or equivalent) and Nitro endpoints (`POST /api/hitl/resume`, `POST /api/hitl/remove`) to preserve the single-active-run invariant.
6. Availability of action menu options stays in sync with backend state via the same polling/SSE mechanisms already used for HITL status, avoiding duplicate resume/remove attempts.

**Quality Requirements:**
7. Unit/component tests cover action visibility rules, confirmation flow, and successful resume/remove outcomes (including error states).
8. Operator-facing documentation or tooltips are updated to reflect the new recovery entry point.
9. Regression testing confirms other action menu items and popup workflows remain unaffected.

## Technical Notes
- **Integration Approach:** Extend the brief action menu components to consume suspended-run state from `useHitlStore`, invoking existing resume/remove actions and handling confirmations inline.
- **Existing Pattern Reference:** Mirror the orchestration recovery flows implemented for Story 1.4 inside `AgentResultsPopup.vue`, reusing shared store methods and toasts.
- **Key Constraints:** Ensure confirm dialog is lightweight (single "Are you sure?" prompt), guard actions for authorized operators only, and maintain consistent telemetry/audit metadata when invoking backend APIs.

## Definition of Done
- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested
- [x] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [x] Documentation updated if applicable

## Risk and Compatibility Check
**Minimal Risk Assessment:**
- **Primary Risk:** Action menu state desync leading to duplicate resume/remove attempts or missing options.
- **Mitigation:** Source availability from the centralized HITL store with SSE/polling updates and disable buttons while requests are in flight.
- **Rollback:** Re-enable the create-post popup recovery panel and hide new action menu items.

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
**Scope Validation:**
- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required

**Clarity Check:**
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Developer persona)

### Debug Log References
- None

### Completion Notes List
- Added brief action menu controls for resuming and removing suspended create-post runs with confirmation prompts, hiding the standard create option while a run is pending.
- Menu state now refreshes from `/api/hitl/pending` per brief open, so only the impacted brief shows recovery actions.
- Removed the create-post popup recovery panel in favor of streamlined alerts and automatic resume handling.
- Extended the HITL store with brief matching helpers and broadened coverage with new unit tests, plus Vue spec for menu behaviors.
- Documented pending-run context in alerts to direct operators toward the action menu.

### File List
- src/views/BriefsView.vue
- src/components/AgentResultsPopup.vue
- src/stores/hitl.ts
- src/__tests__/BriefsView.spec.ts
- src/__tests__/hitl-store.spec.ts

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-01 | 0.2 | Implemented brief action HITL recovery controls and updated testing. | Dev |
