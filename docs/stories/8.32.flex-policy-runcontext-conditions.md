# Story 8.32: Flex Policy RunContext Condition Evaluation

## Status
Ready for Dev

## Story
**As a** flex orchestrator maintainer,  
**I want** every runtime policy trigger to evaluate predicates on the run context compiled from caller-supplied conditions,  
**so that** guardrail actions only fire when the complete execution state satisfies the callerâ€™s conditions.

**Dependencies:** Story 8.22 (Flex Policy Conditional Triggers) provides predicate-aware policy scaffolding, and Story 8.23 (Flex Policy Action Execution) supplies canonical action dispatching that this story must continue to honor. [Source: docs/stories/8.22.flex-policy-conditional-triggers.md] [Source: docs/stories/8.23.flex-policy-action-execution.md]

## Acceptance Criteria
1. The shared `PolicyTrigger` schema allows an optional `condition` on every trigger kind (`onStart`, `onNodeComplete`, `onValidationFail`, `onTimeout`, `onMetricBelow`, `manual`), accepting DSL or JSON-Logic expressions and emitting descriptive validation errors when unsupported variables or operators are referenced. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
2. `PolicyNormalizer` compiles each supplied `condition` using the shared Condition DSL utilities, resolves run context variable references (facets, metrics, HITL state), and persists the canonical JSON-Logic payload alongside policy metadata; missing data results in validation failures surfaced to callers. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]
3. Runtime evaluation applies the compiled predicate to the live run context for every trigger kind, ensuring actions only execute when the predicate returns truthy; evaluation failures log structured diagnostics and skip triggering. [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle]
4. `policy_triggered` telemetry and logs include the predicate payload, evaluation result (`matched`, `skipped`, `invalid`), the run context snapshot/version used, and continue to stream over SSE without breaking existing clients. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity] [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
5. Vitest suites cover predicate validation and evaluation across all trigger kinds (truthy, falsy, invalid) while guarding legacy behavior when no `condition` is provided. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
6. Architecture documentation for TaskPolicies and the Condition DSL reflects condition support across all triggers with updated examples and troubleshooting guidance. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]

## Tasks / Subtasks
- [ ] Extend `@awesomeposter/shared` policy trigger types and Zod validators to accept `condition` on every trigger, wiring new error messaging for unsupported variables/operators. (AC 1) [Source: docs/architecture/source-tree.md#5-shared-libraries] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies]
- [ ] Enhance `PolicyNormalizer` to parse DSL/JSON-Logic via shared utilities, resolve run context variables, and persist compiled predicates with actionable validation feedback. (AC 2) [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
- [ ] Implement unified predicate evaluation within the runtime policy loop covering all trigger kinds and wiring structured failure handling. (AC 3) [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies]
- [ ] Update telemetry/log emission to include predicate details, evaluation results, and run context snapshot metadata while preserving existing SSE consumers. (AC 4) [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity] [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
- [ ] Add Vitest coverage exercising predicate validation/evaluation for each trigger kind, including regressions for policies without conditions. (AC 5) [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
- [ ] Refresh architecture documentation (TaskPolicies, Condition DSL) with full-trigger predicate support and examples. (AC 6) [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]

## Story Context
- **Existing Integration:** Runtime policies execute inside `packages/flex-agents-server`, consuming shared TaskEnvelope definitions and interacting with execution flow/telemetry. [Source: docs/architecture/source-tree.md#4-agents-server]
- **Technology Stack:** TypeScript Nitro workspace with shared packages for schema validation and orchestrator logic. [Source: docs/architecture/tech-stack.md#1-core-runtime-components]
- **Patterns to Follow:** Policy normalization, execution, and telemetry responsibilities documented for the flex agents server. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- **Run Context Persistence:** `flex_runs` records maintain run context state leveraged during predicate evaluation. [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]

## Acceptance Criteria (Detailed)

### Functional Requirements
1. All trigger kinds accept optional predicates using the shared Condition DSL/JSON-Logic format and surface validation errors with variable/operator hints. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
2. Predicate evaluation operates on the full run context (facets, metrics, node history, HITL state) assembled by the execution engine. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle] [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
3. Policies without predicates continue to trigger on raw events, preserving existing behavior. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies]

### Integration Requirements
4. SSE `policy_triggered` frames include predicate metadata and evaluation outcome while maintaining backward-compatible shapes for existing clients. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
5. Telemetry/logging records predicate evaluation results for analytics parity with legacy orchestrator metrics. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity]
6. Validation failures during normalization return structured HTTP 400 responses consistent with existing policy validation behavior. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]

### Quality Requirements
7. Unit and integration tests cover predicate compilation/evaluation across all trigger kinds, including invalid references and false branches. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
8. Structured logs capture run ID, trigger kind, predicate identifier, evaluation result, and action metadata for auditability. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity]
9. Documentation updates land with code changes to keep policy consumers aligned. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#53-taskpolicies]

## Definition of Done
- [ ] Functional requirements satisfied
- [ ] Integration behavior verified against SSE/telemetry contracts
- [ ] Tests passing (unit/integration)
- [ ] Documentation updated
- [ ] No regressions in existing policy behavior

## Risk and Compatibility Check
- **Risk:** Predicate evaluation could reference missing or high-volume context causing runtime errors or latency. Mitigate with strict validation, guarded evaluation, and logging fallbacks. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity]
- **Compatibility:** Changes must remain backward compatible with existing TaskEnvelope payloads and SSE consumers. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]

## Validation Checklist
- [ ] Requirements are self-contained and testable
- [ ] Integration points are explicit
- [ ] Rollback strategy (feature flag or schema gating) considered
- [ ] Story can be delivered within a focused development cycle

## Dev Notes

### Previous Story Insights
- Story 8.22 introduces predicate scaffolding for `when` blocks; reuse its validation patterns while extending coverage to all trigger kinds. [Source: docs/stories/8.22.flex-policy-conditional-triggers.md]
- Story 8.23 centralizes canonical action dispatch; runtime evaluation should invoke the same dispatcher after predicate checks. [Source: docs/stories/8.23.flex-policy-action-execution.md]

### Data Models
- Persist compiled predicates and evaluation attempts alongside policy metadata within `flex_runs` and plan snapshots for replay/debugging. [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]

### API Specifications
- Runtime policies are submitted through `/api/v1/flex/run.stream`; responses and telemetry must stay compatible with documented SSE frames. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]

### Component Specifications
- `PolicyNormalizer`, execution engine loops, and telemetry services coordinate predicate handling; keep responsibilities aligned with documented component boundaries. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- Reuse the Condition DSL parser and validation utilities delivered in Epic 9 (`packages/shared/src/condition-dsl/`) when compiling predicates to avoid introducing duplicate parsing logic. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]

### File Locations
- Shared schema updates live under `packages/shared/src/flex`, runtime evaluation resides in `packages/flex-agents-server/src`, and related utilities or docs updates should remain colocated per the source tree guide. [Source: docs/architecture/source-tree.md#5-shared-libraries] [Source: docs/architecture/source-tree.md#4-agents-server]

### Testing Requirements
- Add Vitest suites in the agents server package (and shared utilities if needed) following the documented backend testing strategy. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

### Technical Constraints
- Maintain the documented TypeScript/Nitro stack and reuse shared utilities instead of introducing new runtime dependencies. [Source: docs/architecture/tech-stack.md#1-core-runtime-components]

## Project Structure Notes
- Keep shared predicate schemas in `packages/shared/src/flex`, normalization/evaluation logic in `packages/flex-agents-server/src/orchestrator` or adjacent services, and telemetry updates within the existing streaming utilities. [Source: docs/architecture/source-tree.md#5-shared-libraries] [Source: docs/architecture/source-tree.md#4-agents-server]
