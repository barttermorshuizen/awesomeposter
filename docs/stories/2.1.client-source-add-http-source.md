# Story 2.1: Client Source HTTP Configuration

## Status
Ready for Review

## Context & Dependencies
- Epic alignment: `docs/prd/epic-discovery-client-source-config/index.md` (scope, success metrics).
- Depends on feature flag plumbing from Story 7.1/7.2 so discovery routes stay dark for non-pilot clients.
- Feeds the health status follow-up in Story 2.3 and ingestion readiness checks in Epic `docs/prd/epic-discovery-ingestion-normalization/functional-requirements.md`.
- Data model reference: `docs/architecture/discovery_agent_backend/data-model-additions.md` (`discovery_sources`, `discovery_keywords`).

## Story
**As a** content marketing operator,
**I want** to add and manage client-specific HTTP sources with immediate validation,
**so that** the discovery agent ingests only approved feeds without engineering help.

## Acceptance Criteria
1. Source form accepts only `http://` or `https://` URLs and rejects other protocols with inline error messaging.
2. Form auto-detects RSS feeds and YouTube channels/playlists, storing canonical source type and identifier for downstream fetchers.
3. Duplicate sources (case-insensitive, including normalized RSS/YouTube IDs) are blocked and surfaced to the user before save.
4. Successful creation persists immediately and emits an SSE `source.created` event scoped to the client with payload matching `packages/shared/src/discovery-events.ts` (`type: 'source-created'`, `version`, `payload`).
5. UI shows optimistic success state; rollback occurs if backend persistence fails (with error toast).

## Tasks / Subtasks
- [x] Implement backend endpoint to create/delete/list client sources with validation and source-type detection (AC 1, AC 2).
  - `POST /api/discovery/sources` accepts `{ url, clientId, notes? }`, normalizes URL, derives `source_type` (`rss`, `youtube-channel`, `youtube-playlist`, `web-page`) and persists to `discovery_sources` (see `docs/architecture/discovery_agent_backend/api-contracts-services.md`).
- [x] Add frontend form with inline validation errors, RSS/YouTube detection helpers, and optimistic update pattern (AC 1, AC 5).
  - Surface duplicate conflicts inline using canonical identifier comparison (lowercase host, strip tracking params, collapse trailing slash, normalize YouTube IDs per `docs/prd/epic-discovery-client-source-config/functional-requirements.md`).
- [x] Emit SSE event `source.created` with payload `{ id, url, clientId, createdAt, sourceType }` (AC 4).
- [x] Write integration tests covering valid/invalid URLs, RSS/YouTube detection, and duplicate submissions (AC 1, AC 3).
- [x] Update configuration documentation/runbook for pilot onboarding, including RSS and YouTube setup steps (AC 2, AC 5).

## Dev Notes
- Backend extends existing Nitro API under `server/api/clients/[id]/sources` with Drizzle models and discovery repository helpers (`server/utils/discovery-repository.ts`).
- Reuse shared validation utilities; add server-side guards even if frontend validates. Extend schemas defined in `packages/shared/src/schemas/discovery.ts`.
- Ensure SSE channel uses telemetry epic schema versioning (coordinate with Story TR-1) and matches event contract in `docs/architecture/discovery_agent_backend/api-contracts-services.md` / `docs/architecture/discovery_agent_frontend/realtime-telemetry-sse.md`.

## Assumptions & Edge Cases
- Canonicalization rules:
  - Lowercase scheme + host, strip default ports, remove trailing `/`.
  - Drop query parameters except `list` for YouTube playlists; store canonical identifier separately in `config_json`.
  - Treat `http://example.com` and `https://example.com/` as duplicate.
- Block unsupported protocols like `ftp://`, `file://`, or bare domains without scheme.
- When persistence fails after optimistic update, revert form state and surface toast using existing notification composable (`src/stores/notifications.ts`).
- Story assumes pilot client context is resolved via auth middleware; multi-tenant scoping handled upstream.

## Configuration
- Environment: `DISCOVERY_ENABLE=true` locally when testing; keep disabled in production until pilot rollout.
- Nitro requires `DISCOVERY_API_KEY`; add instructions to `.env.discovery.local` following `docs/discovery-agent-dev-setup.md`.
- Feature flag toggles managed through Story 7.x scripts; document flag name `discovery.sources.enabled`.

### Testing
- Backend
  - Vitest integration: create/update/delete happy path, protocol rejection, duplicate rejection, canonicalization matches, SSE envelope shape.
  - Repository unit tests verifying `discovery_sources` constraints (unique per client/type/identifier) with fixtures.
- Frontend
  - Component test for form validation states (invalid protocol, duplicate warning, optimistic success -> rollback).
  - Playwright smoke covering add source -> SSE update displayed in list.
- End-to-end
  - Simulate feature flag disabled path (API returns 404/403) to confirm UI hides entry points.
  - Verify audit trail entry created when documentation task updates runbook (coordination with Story 7.3).

## References
- `docs/prd/epic-discovery-client-source-config/functional-requirements.md`
- `docs/prd/epic-discovery-client-source-config/risks-mitigations.md`
- `docs/architecture/discovery_agent_backend/api-contracts-services.md`
- `docs/architecture/discovery_agent_backend/data-model-additions.md`
- `docs/architecture/discovery_agent_frontend/realtime-telemetry-sse.md`
- `docs/discovery-agent-pilot-onboarding.md`

## Change Log
| Date | Version | Description | Author |
| 2025-03-29 | 0.1 | Initial draft aligned with Epic: Client Source Configuration. | PM |
| 2025-09-24 | 0.2 | Added context, references, canonicalization guidance, and test scenarios. | SM |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit

### Completion Notes List
- Added `discovery_sources` persistence, normalization, duplicate enforcement, and SSE emission for client HTTP sources.
- Introduced shared discovery utilities/event schemas plus REST endpoints for listing, creating, and removing sources.
- Built discovery sources Vue workflow with inline validation, YouTube/RSS detection, optimistic updates, and SSE live refresh.
- Updated pilot onboarding runbook with detailed source entry procedure covering RSS and YouTube nuances.

### File List
- docs/discovery-agent-pilot-onboarding.md
- packages/db/drizzle/0009_discovery_sources.sql
- packages/db/drizzle/meta/_journal.json
- packages/db/drizzle/relations.ts
- packages/db/drizzle/schema.ts
- packages/db/src/index.ts
- packages/db/src/schema.ts
- packages/shared/__tests__/discovery.spec.ts
- packages/shared/src/discovery-events.ts
- packages/shared/src/discovery.ts
- packages/shared/src/index.ts
- server/api/clients/[id]/sources/[sourceId].delete.ts
- server/api/clients/[id]/sources/index.get.ts
- server/api/clients/[id]/sources/index.post.ts
- server/api/discovery/events.stream.ts
- server/utils/discovery-events.ts
- server/utils/discovery-repository.ts
- src/__tests__/ClientSourcesView.spec.ts
- src/router/index.ts
- src/views/ClientSourcesView.vue
- src/views/ClientsView.vue
