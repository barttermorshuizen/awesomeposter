# Story 14.2: Capability Pre-Condition Runtime Gating & Policies

## Status
Ready for Dev

## Story
**As a** flex orchestrator runtime engineer,  
**I want** capability-level pre-condition metadata to flow through planning, execution, and policy controls,  
**so that** every capability proves prerequisites are satisfied before invocation, replans trigger by default when guards fail, and operators get trustworthy telemetry.

**Dependencies:** Story 14.1 – Capability Pre-Condition Metadata & Persistence (`docs/stories/14.1.flex-capability-pre-conditions-metadata.md`)

## References
- `docs/prd/epic-flex-capability-pre-conditions.md#stories`
- `docs/stories/14.1.flex-capability-pre-conditions-metadata.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`
- `docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`
- `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/coding-standards.md#7-testing-expectations`

## Acceptance Criteria
1. **Planner surfaces capability pre-condition guards.** `CapabilityRegistryService` exposes the compiled `preConditions` payload and summarised `preConditionGuards`, and `PlannerService` injects that data into CRCS snapshots, plan prompts, and `PlanGraph` nodes so SSE `plan_generated/plan_updated` frames enumerate the facets each node requires before dispatch. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`, `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
2. **Execution engine evaluates capability pre-conditions before node dispatch.** `ExecutionEngine` compiles each capability’s `preConditions` with the shared Condition DSL helper, evaluates them against the node’s facet snapshot prior to dispatch, and if any predicate fails it blocks invocation, emits structured `preConditionResults` describing which facet/path failed, and requests a default replan unless a runtime policy override applies. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
3. **Runtime policy controls and retry/replan actions guard failures.** Pre-condition failures raise deterministic `RuntimePolicy` triggers (e.g., `onPreConditionFailed`) that support configured actions (`replan` default, plus retry/skip/hitl/fail-fast) and optional retry budgets. Triggers emit `policy_triggered`, `plan_updated`, or `hitl_request` frames describing the chosen action while keeping the runtime-policy documentation updated with the new trigger semantics and defaults. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
4. **Persistence and telemetry capture predicate results.** `flex_plan_nodes`, `flex_plan_snapshots`, and `flex_run_outputs` persist both the submitted DSL and evaluated JSON-Logic results for every capability’s pre-conditions, and SSE frames (`plan_updated`, `node_status`, `policy_triggered`) surface `{ facet, path, satisfied, error }` entries so operators/UIs can replay guard outcomes without replaying executions. (Sources: `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
5. **Regression coverage protects planner propagation, evaluation, and policy handling.** Automated tests cover registry → planner propagation, DSL compilation, evaluation gating, policy overrides, retry/replan behaviors, SSE payloads, and persistence so future changes cannot regress the enforcement pipeline. (Sources: `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/source-tree.md#4-agents-server`)

## Tasks / Subtasks
- [ ] Propagate `preConditions` + `preConditionGuards` into planner prompts, CRCS snapshots, and `PlanGraph` node DTOs; add regression tests for SSE payloads. (AC1) (`docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
- [ ] Implement pre-dispatch evaluation in `ExecutionEngine`, injecting `preConditionResults` into run state and blocking dispatch when predicates fail, defaulting to replan. (AC2) (`docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
- [ ] Add runtime-policy trigger wiring (e.g., `onPreConditionFailed`) with configurable actions/retry budgets, emitting structured telemetry/SSE frames. (AC3) (`docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`)
- [ ] Persist pre-condition DSL + evaluation outcomes to plan nodes/snapshots/output blobs; expose via `node_status`/`plan_updated` SSE and debug endpoints. (AC4) (`docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
- [ ] Expand unit/integration suites for planner, runtime, and repository layers to cover guard propagation, policy actions, retries/replans, and SSE contracts. (AC5) (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Edge Cases & Behavior Contracts
- Missing vs empty pre-conditions: `preConditions` absent behaves as legacy (no gating), while `preConditions: []` is an explicit empty set that must not block dispatch.
- Evaluator errors: malformed predicates should raise structured errors, skip dispatch, and route through the same policy trigger path as failed predicates.
- Policy defaults: `onPreConditionFailed` defaults to `replan` unless overridden; retry budgets must short-circuit to the configured terminal action when exhausted.

## Testing Guidance
- Planner propagation: registry → plan graph → CRCS → SSE (`plan_generated/plan_updated`) include `preConditions/preConditionGuards` with guarded facets.
- Execution gating: predicates pass vs fail, missing/empty preConditions, and evaluator error cases emit `preConditionResults` and block dispatch accordingly.
- Policy actions: default replan vs retry/skip/HITL/fail-fast, retry budget exhaustion, and emitted `policy_triggered/plan_updated/hitl_request` frames with chosen action.
- Persistence: DSL + evaluated results round-trip via `flex_plan_nodes`, `flex_plan_snapshots`, and `flex_run_outputs`.
- SSE/telemetry shape: `node_status`/`plan_updated` frames surface `{ facet, path, satisfied, error }` entries; ensure backward compatibility when preConditions are absent.
- Regression coverage: unit/integration across planner, runtime, policy, and repositories to pin the enforcement pipeline end-to-end.

## Story Context
- Epic FLEX-CAP-PRE-1 calls for default replans when pre-conditions fail, with policy-driven overrides; this story brings parity with post-condition runtime enforcement from Story 13.2 but applied before dispatch. (`docs/prd/epic-flex-capability-pre-conditions.md#stories`)
- Planner/runtime/telemetry updates must stay additive and backward compatible for capabilities that do not declare pre-conditions.
