# Story 1.2: Persistence and Resume Support

## Status
Draft

## Story
**As a** platform operator,
**I want** HITL requests and full orchestrator state stored durably with resume/cancel hooks,
**so that** in-progress runs survive restarts and can be explicitly resumed or removed.

## Acceptance Criteria
1. New Drizzle migrations add tables for HITL requests/responses and link them to briefs and orchestration threads.
2. Persisted orchestration state (plan artifacts, HITL records, execution context, runner metadata) loads correctly after restart and exposes pending tasks via API.
3. API endpoints allow clients to resume an orchestration thread or mark it as removed/cancelled with audit metadata.
4. Automated smoke test confirms resume/cancel endpoints leave database in consistent state.

## Tasks / Subtasks
- [ ] Design and implement Drizzle models & migrations for HITL requests/responses and orchestration plan snapshots, keeping persistence logic centralized in shared repositories (Must-fix) (AC 1).
  - [ ] Ensure foreign keys reference existing briefs/runs tables with additive schema only (AC 1).
- [ ] Extend persistence layer/service to write and read full orchestrator state (plan, HITL artifacts, execution context, agent notes) atomically via a single persistence module reused across services (Must-fix) (AC 2).
  - [ ] Implement repository methods used by orchestrator to rehydrate the Agents SDK runner context and fetch pending tasks on startup, mapping backend status codes to UI expectations (Must-fix) (AC 2, AC 3).
- [ ] Add Nitro API routes (e.g., `POST /api/hitl/resume`, `POST /api/hitl/remove`) with validation, audit metadata, and consistent status code contract for UI alignment (AC 3).
  - [ ] Protect endpoints with existing auth guards and emit SSE/telemetry updates (AC 3).
- [ ] Create integration smoke test covering resume/remove cycle against test database (AC 4).
  - [ ] Document runbook notes for operators describing resume/remove behavior (supports AC 4).

## Dev Notes
- Database definitions live in `packages/db`; coordinate with existing migrations pattern (versions, drizzle-kit config).
- Persistence services likely under `packages/agents-server/src/server/persistence` (confirm actual path); ensure writes wrap plan + HITL entries transactionally and include runner metadata needed for rehydration.
- Nitro API routes should sit in `server/api/hitl/*`; reuse existing middleware for auth/logging.
- Align resume/remove semantics with orchestrator logic from Story 1.1 (response structures, feature flag support) and follow OpenAI Agents SDK recommended APIs for plan persistence/rehydration. Confirm a single persistence module is the source of truth (Must-fix), and expose metrics (e.g., outstanding HITL count) via existing telemetry sinks (Should-fix).

### Testing
- Validate migrations via Drizzle tooling (`npm run db:migrate` or project-standard command) to confirm schema integrity.
- Add Vitest integration tests hitting new Nitro endpoints and verifying database state transitions, including status code contracts used by UI.
- Manual smoke: restart agents server with pending HITL tasks and confirm they reappear via API/UI mocks, including full runner rehydration via OpenAI Agents SDK helpers.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | 0.1 | Initial draft of Story 1.2 from Epic HITL-1. | PO |
