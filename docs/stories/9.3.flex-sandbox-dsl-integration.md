# Story 9.3: Flex Sandbox DSL Integration

## Status
Draft

## Story
**As a** Flex orchestrator maintainer,  
**I want** the Flex Sandbox to use the new condition DSL editor backed by server validation,  
**so that** operators can author policy triggers safely without touching raw JSON-Logic.  

**Dependencies:** Story 9.1 (pilot playground) and Story 9.2 (shared parser + validation) must be complete. (`docs/prd/epic-9-condition-management.md:18`)

## Acceptance Criteria
1. Flex Sandbox policy forms replace the raw JSON editor with the DSL editor, powered by the shared parser/registry, while still exposing a JSON-Logic preview for transparency. (`docs/prd/epic-9-condition-management.md:20`)
2. Policy save flows send both DSL and JSON-Logic payloads to Nitro; server validation rejects invalid DSL with precise error messaging surfaced in the UI. (`docs/prd/epic-9-condition-management.md:15`)
3. Existing policies without DSL metadata continue to load, edit, and save using legacy JSON fields; the editor supports migrating them by generating the equivalent DSL on first load. (`docs/prd/epic-9-condition-management.md:24`)
4. A feature flag gates the DSL editor; fallback to the previous JSON-only experience remains available until rollout complete. (`docs/prd/epic-9-condition-management.md:32`)
5. Migration/backfill script documented to populate DSL strings for current policies and regression tests verifying round-trip correctness are added. (`docs/prd/epic-9-condition-management.md:39`)

## Tasks / Subtasks
- [ ] Integrate the shared DSL editor component into `FlexSandboxView` and related dialogs, including JSON preview and error display. (AC 1)
- [ ] Adjust Pinia stores and policy serialization to include DSL + JSON fields and handle legacy data gracefully. (AC 2,3)
- [ ] Update Nitro policy endpoints to accept DSL input, invoke validation helper, and persist JSON-Logic canonical payloads. (AC 2)
- [ ] Implement feature flag wiring and fallback rendering to old JSON editor when disabled. (AC 4)
- [ ] Create migration/backfill utility + documentation and add regression tests for representative policies. (AC 5)

## Story Context

**Existing System Integration:**
- Integrates with: `src/views/FlexSandboxView.vue`, `src/components/FlexCreatePostDialog.vue`, policy Pinia stores, Nitro endpoints (`server/api/flex/*`), shared parser package.
- Technology: Vue 3, TypeScript, Nitro server, shared packages, existing feature flag infrastructure.
- Patterns: Mirrors previous feature-flagged UI rollouts (e.g., Story 8.19 sandbox enhancements).

## Acceptance Criteria (Detailed)

### Functional Requirements
1. DSL editor shows autocomplete, inline errors, and synced JSON-Logic preview using shared registry.
2. Saving invalid DSL blocks request and surfaces error toast + inline message.
3. Loading a legacy JSON-only policy auto-generates DSL, but users can still view raw JSON on demand.

### Integration Requirements
4. Nitro persists DSL string alongside JSON-Logic (metadata field or annotation) without altering existing schema.
5. Feature flag (`flex.dslPolicies`) defaults off in production; toggling off reverts UI + payload to legacy behavior.
6. Migration script produces audit output listing converted policies and failed expressions.

### Quality Requirements
7. Unit/integration tests cover legacy policy load/save, new DSL save, error handling, and flag behavior.
8. End-to-end sandbox test ensures JSON-Logic executed by orchestrator matches DSL intent.
9. Documentation updated (policy authoring guide, admin runbook) with DSL usage guidance.

## Technical Notes
- Ensure JSON-Logic preview uses the same shared conversion utilities to avoid drift.
- Consider storing DSL string in policy metadata for future UI displays; schema change must remain additive.
- Coordinate rollout with QA to verify policy execution remains unchanged in staging.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Tests pass (unit, integration, e2e where applicable)
- [ ] Documentation updated (authoring guide + migration steps)
- [ ] Feature flag defaults handled per environment

## Risk and Compatibility Check
- **Primary Risk:** Regressing existing policy editing or execution due to DSL errors.
- **Mitigation:** Feature flag fallback, regression tests, manual validation with real policies.
- **Rollback:** Disable feature flag to restore JSON-only experience.

**Compatibility Verification**
- [x] No breaking API changes; payload additive only
- [x] Database untouched or additive metadata only
- [x] UI changes follow established patterns
- [x] Performance impact minimal (parsing on edit/save)

## Validation Checklist
- [x] Story scoped to single integration goal
- [x] Dependencies satisfied before start
- [x] Acceptance criteria testable end-to-end
- [x] Rollback straightforward via feature flag
