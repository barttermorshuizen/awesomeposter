# Story 8.31: Flex HITL Clarify Extension

## Status
Draft

## Story
**As a** flex orchestrator engineer,  
**I want** capability nodes to initiate human clarifications through `hitl.clarify()` with deterministic resume handling,  
**so that** the runtime pauses for missing inputs and resumes the same node with operator answers without altering the active plan.  

## Acceptance Criteria
1. When a node invokes `hitl.clarify(question)`, the execution engine emits a `hitl_request` SSE frame with `kind: "clarify"`, persists the paused snapshot, marks the run as awaiting human input, and does so without creating a new plan version. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]
2. `/api/v1/flex/run.resume` accepts a textual clarification answer, validates it, appends a new entry to `runContext.hitlClarifications[]`, reruns the same node that requested clarification, and keeps the existing `PlanGraph` version intact. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]
3. Clarification history is persisted using the `ClarificationEntry` structure (`nodeId`, `capabilityId?`, `questionId`, `question`, `answer`, timestamps) in the run context and stored on the `flex_runs` record so downstream executions and analytics can map answers back to the originating questions. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/flex-agents-server.md#9-data-model--persistence]
4. Resume rehydration delivers the accumulated `hitlClarifications` back into the rerun nodeâ€™s context bundle and exposes the latest clarify dialogue in SSE telemetry so UI listeners and metrics can distinguish clarify pauses from approval flows. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy]
5. The SPA renders a clarify dialog (mirroring the approve/reject workflow) when a `hitl_request` frame with `kind: "clarify"` arrives, allowing operators to review the question, submit a textual answer, and trigger the flex resume call with loading/error states handled per existing HITL UX contracts. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/hitl/7-front-end-state--ux-contract.md]
6. Automated tests cover clarify request/resume cycles (request emitted, snapshot persisted, answer appended, node rerun) and guard against regressions in existing approval HITL flows, including front-end component/store behaviour for clarify dialogs. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Extend the `ExecutionEngine` / HITL gateway to surface `hitl_request` events with `kind: "clarify"` and pause runs without mutating the active `PlanGraph`. (AC 1) [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]
- [ ] Update persistence so `runContext.hitlClarifications[]` and `flex_runs.hitlClarifications` capture `ClarificationEntry` metadata for each question/answer cycle. (AC 2,3) [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/flex-agents-server.md#9-data-model--persistence]
- [ ] Enhance `/api/v1/flex/run.resume` handling to validate clarify answers, append them to the run context, and rerun the originating node with the enriched bundle. (AC 2,4) [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/hitl/6-api-surface.md#6-api-surface]
- [ ] Ensure SSE telemetry and metrics (e.g., `flex.hitl.requests`, `flex.hitl.resolved`) distinguish clarify interruptions and stream the updated clarification history to clients. (AC 4) [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/flex-agents-server.md#6-component-responsibilities]
- [ ] Update the SPA HITL panel/dialog components to render clarify requests, capture answers, and invoke the flex resume handler with proper loading/error handling. (AC 5) [Source: architecture/hitl/7-front-end-state--ux-contract.md] [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]
- [ ] Add Vitest coverage for clarify request/resume flows and regression cases where approval HITL continues to function unchanged, covering backend orchestration and front-end UI/store behaviour. (AC 6) [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
- [ ] Refresh operator/developer documentation as needed to describe clarify prompts, resume payloads, telemetry fields, and UI interactions. (AC 1-5) [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension] [Source: architecture/hitl/7-front-end-state--ux-contract.md]

## Dev Notes

### Previous Story Insights
- Story 8.30 remains in Draft and offers no completed Dev Agent Record; review Story 8.28 (Flex HITL Multi-Turn Clarification Support) for context on resume payload expectations and dependencies on existing HITL flows. [Source: docs/stories/8.28.flex-hitl-multiturn-clarifications.md]

### Data Models
- `flex_runs` records must persist `hitlClarifications` so clarify history survives restarts and analytics queries. [Source: architecture/flex-agents-server.md#9-data-model--persistence]
- `ClarificationEntry` objects (`nodeId`, `capabilityId?`, `questionId`, `question`, `answer?`, `createdAt`, `answeredAt?`) define the stored metadata for each clarification exchange. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]

### API Specifications
- `/api/v1/flex/run.resume` receives clarification answers and must validate textual payloads before resuming the paused node. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]
- Legacy HITL endpoints (`/api/hitl/resume`, `/api/hitl/pending`) share validation semantics and error codes; keep behaviour consistent while flex-specific runs flow through the flex resume handler. [Source: architecture/hitl/6-api-surface.md#6-api-surface]

### Component Responsibilities
- `ExecutionEngine` issues clarify requests, pauses execution, and reruns the originating node once answered. [Source: architecture/flex-agents-server.md#1511-hitl-clarify-extension]
- `TelemetryService` streams `hitl_request` and resume frames; ensure clarify metadata is included for UI parity. [Source: architecture/flex-agents-server.md#6-component-responsibilities]
- `HumanAgent.clarifyBrief` capability handles human-side clarify prompts and should continue to register under `agentType: "human"`. [Source: architecture/flex-agents-server.md#current-inventory]
- HITL front-end store/components (`src/stores/hitl.ts`, `HitlPanel.vue`, `HitlResponseForm.vue`) must detect clarify requests and render the new dialog while maintaining accessibility and error handling patterns. [Source: architecture/hitl/7-front-end-state--ux-contract.md]

### File Locations
- Orchestrator logic lives under `packages/flex-agents-server/src/orchestrator/` (controller, execution engine, policy handling). [Source: architecture/source-tree.md#4-agents-server]
- Shared types such as `ClarificationEntry` belong in `packages/shared/src/flex/`. [Source: architecture/source-tree.md#5-shared-libraries]

### Technical Constraints
- Implementations must stay in TypeScript, follow existing logging patterns, and reuse Zod validation per repository coding standards. [Source: architecture/coding-standards.md#1-language--module-conventions]
- Feature remains behind the existing HITL gating; do not introduce new environment or feature flag requirements beyond those already defined. [Source: architecture/hitl/8-configuration-feature-flagging.md]

### Project Structure Notes
- No structural deviations required; continue extending the flex agents server package and reuse existing HITL persistence tables per the architecture guide. [Source: architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy]

### Testing
- Add Vitest suites under `packages/flex-agents-server/__tests__` (or colocated orchestrator tests) exercising clarify request/resume flows and regression cases for approval HITL, plus SPA unit/component tests for the clarify dialog workflow. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy] [Source: architecture/hitl/7-front-end-state--ux-contract.md]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| - | - | - | - |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
