# Story 8.15: Capability Registration Default Contract Removal

## Status
Draft

## Story
**As a** flex capability registry steward,  
**I want** to retire the legacy `defaultContract` field from capability registration flows,  
**so that** the planner and orchestration layers rely exclusively on facet-based input/output contracts.

## Acceptance Criteria
1. `CapabilityRegistrationSchema` in `@awesomeposter/shared` removes the `defaultContract` field and requires registrations to supply explicit facet-based `outputContract` data, matching the documented registration payload. (`docs/architecture/flex-agents-server.md#5-6-2-registration-payload`)
2. Flex capability registry services, persistence, and API routes operate solely on `inputContract` / `outputContract`, removing stored `defaultContract` fallbacks while still compiling facet-driven JSON schemas. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
3. Planner, execution engine, and validation flows consume the explicit output contract without referencing `defaultContract`, with automated tests covering registration, plan compilation, and SSE telemetry using the facet contract model. (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`)
4. Architecture documentation and capability inventory reference only the facet-based contract fields, eliminating residual `defaultContract` terminology. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)

## Tasks / Subtasks
- [ ] Update `CapabilityRegistrationSchema`, related types, and contract normalization helpers in `@awesomeposter/shared` to drop `defaultContract` while enforcing explicit facet-backed `outputContract` payloads. (AC 1, AC 3) (`docs/architecture/flex-agents-server.md#5-6-2-registration-payload`)
- [ ] Refactor flex capability registry registration pipeline, repository mapping, and persistence so only `inputContract` / `outputContract` are stored and returned, including migrations or data backfills that remove `defaultContract`. (AC 2) (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- [ ] Update planner validation, execution engine contract resolution, and capability selection logic to rely solely on explicit output contracts, removing any `defaultContract` fallbacks. (AC 3) (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`)
- [ ] Refresh agent self-registration exports and tests to ensure capability metadata publishes only facet-derived output contracts, adding or updating Vitest coverage to confirm registration, plan compilation, and SSE telemetry operate without `defaultContract`. (AC 1, AC 3) (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`)
- [ ] Revise architecture documentation and capability inventory tables to describe the facet-only contract model, excising `defaultContract` references and highlighting facet provenance. (AC 4) (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)

## Dev Notes
- Capability registrations must provide facet-based `inputContract` / `outputContract` payloads; legacy JSON schema payloads are deprecated in favor of compiled facet contracts produced by the registry. (`docs/architecture/flex-agents-server.md#5-6-2-registration-payload`)
- The capability registry persists metadata to `flex_capabilities`, validates facet coverage, caches active entries, and surfaces capability data via `listActive` / `getCapabilityById`—all of which expect the facet-derived contract fields. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- Planner assembly merges facet-derived schemas into plan nodes, propagating explicit output contracts through validation and execution; removing `defaultContract` ensures the compiled contracts remain authoritative. (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`)
- Shared types for capabilities live under `packages/shared/src/`, and flex server services reside in `packages/flex-agents-server/src/`, per the workspace guide. (`docs/architecture/source-tree.md#5-shared-libraries`)

### Testing
- Follow Vitest-based testing patterns defined in the coding standards; maintain `.spec.ts` suites alongside source or under `__tests__`. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- Extend existing capability registry, planner, and SSE integration tests to assert behavior without `defaultContract`, using the repo’s TypeScript-first testing approach. (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-10 | 0.1 | Initial draft retiring `defaultContract` from capability registration flows. | Scrum Master |
