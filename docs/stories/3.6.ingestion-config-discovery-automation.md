# Story 3.6: List Configuration Discovery API - Brownfield Addition

## Status
Draft

## Story
**As the** ingestion operator,
**I want** an API endpoint that suggests `webList` configuration candidates for a given list page,
**so that** I can populate source configurations from the UI without manually reverse-engineering selectors.

## Story Context
**Existing System Integration**
- Integrates with: Nitro API server (`server/api`), configuration services (`packages/shared/src/discovery.ts`), and future UI workflows consuming the endpoint.
- Technology: Node.js/Nitro REST endpoint using `got` + `cheerio` for HTML analysis.
- Follows pattern: authenticated internal APIs that operate on ingestion configuration artifacts.
- Touch points: API authentication middleware, configuration validation helpers, documentation for operator tooling, and UI clients that render the suggestions.
- Epic reference: `docs/prd/epic-discovery-ingestion-normalization.md` (extends ingestion automation with configuration discovery support).

## Acceptance Criteria
**Functional Requirements**
1. Provide an authenticated POST endpoint (e.g., `POST /api/discovery/config-suggestions`) accepting `{ url: string }` and returning candidate `webList` selectors: `list_container_selector`, `item_selector`, and field mappings (`title`, `excerpt`, `url`, `timestamp`) aligned with current runtime capabilities.
2. Response payload includes a JSON snippet ready for insertion into a source configuration plus a `metadata` object with confidence levels, warnings, notes on multiple candidates when applicable, and an explicit reminder that pagination suggestions are not currently provided.
3. Endpoint validates suggested selectors against the fetched DOM prior to response, marking low-confidence matches and omitting invalid selectors.

**Integration Requirements**
4. Endpoint reuses existing configuration schema validation to ensure the generated `webList` block passes current rules before returning data.
5. API is protected behind existing operator authentication (e.g., API key/bearer token) and adheres to established rate limiting/error response formats.
6. Documentation and UI API contract updates describe how the UI should consume the endpoint, including handling warnings and manual confirmation.

**Quality Requirements**
7. Unit and integration tests cover DOM analysis heuristics, schema validation, authentication enforcement, and error handling for unreachable pages or unsupported markup.
8. Operator/UX documentation updated with endpoint usage examples, expected response structure, and verification checklist.
9. Example response fixture added for UI developers to build against and for regression testing.

## Tasks / Subtasks
- [ ] Implement `server/api/discovery/config-suggestions.post.ts` hooking into the configuration discovery service so it fetches the target URL, derives selectors, and returns structured suggestions per architecture guidance (AC 1, AC 2, AC 3).
- [ ] Integrate schema validation and confidence scoring via helpers in `packages/shared/src/discovery.ts` (extend zod schemas and scoring utilities as needed) before shaping the response payload (AC 3, AC 4).
- [ ] Ensure the route applies `requireApiAuth` from `server/utils/api-auth.ts` and emits standard error objects/rate-limit headers consistent with the existing discovery admin APIs (AC 5).
- [ ] Add automated tests covering heuristics and contract responses in `tests/api/discovery/config-suggestions.spec.ts` plus unit coverage for selector scoring in `packages/shared/src/discovery/__tests__/config-suggestions.spec.ts` (AC 7).
- [ ] Update documentation and shared assets: extend `docs/architecture/discovery_agent_backend/configuration-discovery-api.md`, add API contract details to `docs/architecture/discovery_agent_backend/api-contracts-services.md#configuration-discovery-service` and `docs/architecture/discovery_agent_frontend/api-integration.md#config-suggestions-helper`, and provide a response fixture at `tests/api/discovery/__fixtures__/config-suggestions-response.json`, all explicitly noting pagination suggestions are deferred (AC 6, AC 8, AC 9).

## Technical Notes
- **Integration Approach:** Leverage existing `got`/`cheerio` stack; consider caching to avoid repeated fetches during UI retries while respecting source robots.txt in future work.
- **Existing Pattern Reference:** Mirror API structure from other ingestion support endpoints (e.g., configuration preview APIs) for request/response envelopes.
- **Key Constraints:** Endpoint must not persist configurations or make mutating changes; it only suggests selectors. Clearly signal low-confidence results to prevent accidental promotion.
- **Pagination scope:** Runtime list ingestion currently stops after the first page, so the suggestion payload must omit `pagination` hints and include metadata clarifying that pagination recommendations are deferred.

## Definition of Done
- [ ] Functional requirements satisfied with deployed endpoint.
- [ ] Integration requirements validated, including auth and schema checks.
- [ ] Documentation and API contract updates reviewed with UI and ingestion teams.
- [ ] Automated tests pass (unit, integration, lint, type-check).
- [ ] Response fixtures shared with UI for integration.
- [ ] Endpoint verified in a staging environment against representative list pages.

## Risk and Compatibility
**Minimal Risk Assessment**
- **Primary Risk:** Heuristic suggestions may be inaccurate, leading to poor configurations if blindly applied.
- **Mitigation:** Provide explicit confidence scores/warnings, require UI confirmation, and document manual verification steps.
- **Rollback:** Disable or hide the endpoint; no runtime ingestion impact because endpoint does not alter stored configurations.

**Compatibility Verification**
- [ ] No runtime ingestion changes; endpoint is additive.
- [ ] Utilizes existing auth and rate-limit infrastructure.
- [ ] Output conforms to `webList` schema expected by Story 3.4.
- [ ] Performance impact limited to ad-hoc operator usage; ensure request timeouts to prevent long-running calls.

## Validation Checklist
**Scope Validation**
- [ ] Work confined to API addition and supporting helpers.
- [ ] Reuses existing parsing utilities and schema validators.
- [ ] Fit for a single development session with defined heuristics.
- [ ] No architectural redesign required.

**Clarity Check**
- [ ] Endpoint behaviour and payload documented.
- [ ] Auth and error handling requirements explicit.
- [ ] Risks and manual verification processes described.
- [ ] Rollback path is straightforward (disable endpoint).

## Dev Notes
- **Route & Service Wiring:** Follow backend architecture guidance in `docs/architecture/discovery_agent_backend/configuration-discovery-api.md` and `docs/architecture/discovery-agent-backend.md#route-handler` to implement `server/api/discovery/config-suggestions.post.ts` backed by `server/services/discovery-config-suggestions.ts`. The service encapsulates DOM fetching via `got`, selector scoring, and confidence metadata so the handler remains thin.
- **Schema & Validation:** Extend the discovery configuration schemas in `packages/shared/src/discovery.ts` to describe the `webList` suggestion payload and reuse those zod validators inside the service. This ensures AC4’s schema reuse and keeps the response JSON ready for operators without duplicate definitions (see `docs/architecture/discovery_agent_backend/api-contracts-services.md#configuration-discovery-service`).
- **Authentication & Error Envelope:** Apply `requireApiAuth` from `server/utils/api-auth.ts` and return errors in the `{ error: { code, message, details } }` format shared by other discovery admin APIs. Rate limiting and cache hints should mirror the patterns documented in `docs/architecture/discovery_agent_backend/responsibilities-by-layer.md`.
- **Caching & Timeouts:** Honor the 8-second timeout and Nitro fetch cache expectations noted in `docs/architecture/discovery_agent_backend/configuration-discovery-api.md` to avoid hammering upstream sites. Ensure results remain ephemeral—no persistence beyond the response payload.
- **Frontend Contract Alignment:** Coordinate with the frontend helper described in `docs/architecture/discovery-agent-frontend.md#configsuggestionsrequest` so confidence levels, warnings, and alternative candidates map cleanly to UI states.
- **Documentation & Operator Guidance:** After implementation, update the walkthrough and operator steps in `docs/architecture/discovery_agent_backend/configuration-discovery-api.md`, capture response structure notes in `docs/architecture/discovery_agent_backend/api-contracts-services.md#configuration-discovery-service`, and refresh UI consumption guidance in `docs/architecture/discovery_agent_frontend/api-integration.md#config-suggestions-helper` so operators and frontend developers share a consistent contract (AC 6 & AC 8).

### Testing
- Add integration coverage to `tests/api/discovery/config-suggestions.spec.ts`, exercising happy paths, low-confidence selector flags, authentication failures, and network error fallbacks. Use the fixture at `tests/api/discovery/__fixtures__/config-suggestions-response.json` to lock the contract shape.
- Unit-test selector heuristics and schema validation within `packages/shared/src/discovery/__tests__/config-suggestions.spec.ts`, including DOM samples with multiple list patterns and invalid selectors while asserting pagination is not suggested.
- Follow backend testing standards from `docs/architecture/discovery_agent_backend/testing-strategy.md` for Vitest configuration, and ensure mocks respect Nitro `fetch` timeouts so regression runs remain deterministic.

## Dev Agent Record

### Agent Model Used
- _To be completed by the development agent._

### Debug Log References
- _To be completed by the development agent._

### Completion Notes List
- _To be completed by the development agent._

### File List
- _To be completed by the development agent._

## QA Results
- _To be completed by the QA agent._

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Drafted automation story for API-based web list configuration suggestions. | John |
| 2025-10-06 | 0.2 | Updated story to specify API endpoint instead of CLI tooling per product direction. | John |
| 2025-10-08 | 0.3 | Removed pagination suggestion scope and aligned metadata, documentation, and testing guidance. | Bob |
