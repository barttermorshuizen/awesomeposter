# Story 11.5: Multi-directional Social Brief Contracts

## Status
Draft

## Story
**As a** flex marketing capability architect,  
**I want** strategist and copywriter contracts to support multiple strategic directions with linked briefs and copy variants,  
**so that** social programs can explore and compare several creative approaches in a single Flex run without duplicating planner graphs.

**Dependencies:** Stories 11.1 through 11.4 established the curated capability/facet set and company information contract. (`docs/stories/11.1.flex-marketing-capability-taxonomy.md`, `docs/stories/11.2.flex-marketing-capability-catalog.md`, `docs/stories/11.3.flex-marketing-sandbox-validation.md`, `docs/stories/11.4.flex-marketing-company-information-facet.md`)

## References
- `docs/prd/epic-flex-marketing-agency-capabilities.md`
- `docs/architecture/flex-agents-server/511-reference-capability-registry.md`
- `docs/architecture/flex-agents-server/512-reference-facet-catalog.md`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#facet-catalog`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`
- `docs/architecture/flex-agents-server/13-verification.md`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/coding-standards.md#4-agents-server-standards`

## Acceptance Criteria
1. `strategist.SocialPosting` capability registration (architecture spec + shared registry modules) replaces the single `strategic_rationale` output facet with a new `strategic_directions` facet whose schema captures an array of directions (`id`, `name`, `rationale`, optional `audience_focus`, `key_moment`, `priority`, `confidence`). Contract metadata and sample payloads illustrate at least two directions linked to the same `post_context`. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-strategic_directions`)
2. The existing `creative_brief` facet definition is superseded by a plural `creative_briefs` facet: an array whose items include `direction_ref` (matching a `strategic_directions[].id`) plus the current brief fields (`core_message`, `supporting_points`, `structure`, `tone`, `audience`, `cta`, `distribution_notes`, `assets`). Strategist capability outputs `creative_briefs` while designer/copywriter capabilities consume it, and all documentation/tests stop referencing the singular facet. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-creative_briefs`)
3. `copywriter.SocialpostDrafting` input contracts accept both `strategic_directions` and `creative_briefs`, and its output facet `post_copy` is redefined as an array of objects each containing `direction_ref`, `variant_label`, `body`, `channel_hint`, and optional `cta`. Architecture spec, shared TypeScript types, fixtures, and planner validation code are updated so downstream capabilities can address copy per direction. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-post_copy`)
4. Shared facet catalog (`packages/shared/src/flex/facets/catalog.ts`) gains JSON Schema coverage, builder helpers, and Ajv tests for the new/updated facets, including referential integrity checks (e.g., validator ensures every `creative_briefs[].direction_ref` maps to an existing direction id inside the same payload). (`docs/architecture/flex-agents-server/512-reference-facet-catalog.md`, `docs/architecture/flex-agents-server/13-verification.md`)
5. Migration guidance documents how sandbox metadata, planner fixtures, and regression snapshots transition from single-direction contracts to multi-direction arrays, including rollout toggles/feature flags and downgrade steps. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`, `docs/prd/epic-flex-marketing-agency-capabilities.md`)
6. Flex sandbox facet widgets (strategist brief authoring, copywriter preview panes, reviewer read-only cards) are updated to display and edit `strategic_directions`, `creative_briefs`, and multi-variant `post_copy`, including UX affordances for selecting a direction, adding/removing briefs, and mapping copy variants; validation states mirror the shared schema rules. (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`)

## Tasks / Subtasks
- [ ] Update `strategist.SocialPosting` registry entry, TypeScript definition, and JSON fixtures to emit `strategic_directions` + `creative_briefs` arrays, removing the deprecated `strategic_rationale` + singular brief wiring. (AC 1, AC 2)
- [ ] Define the new `strategic_directions` facet and plural `creative_briefs` facet in the shared catalog (schema, metadata, examples) and regenerate downstream TypeScript types. (AC 1, AC 2, AC 4)
- [ ] Redefine the `post_copy` facet as an array with `direction_ref` metadata, and update copywriter capability inputs/outputs plus associated prompts/tests. (AC 3)
- [ ] Extend planner + registry validation tests to cover referential integrity between directions, briefs, and copy variants, failing fast on orphaned references or empty arrays. (AC 4)
- [ ] Document rollout/rollback steps, including feature flag naming, sandbox metadata change notes, and how to down-convert multi-direction payloads if a consumer still expects the legacy single variant. (AC 5)
- [ ] Update flex sandbox facet widgets (strategist inputs, copywriter outputs, reviewer cards) so users can author, navigate, and validate multiple strategic directions/briefs/copy variants, including direction selection UX and schema-aligned validation. (AC 6)

## Story Context
- Multi-direction planning lets producers compare two or more strategic bets in a single envelope, reducing repeated strategist/copywriter runs while surfacing richer options for human review. (`docs/prd/epic-flex-marketing-agency-capabilities.md`)
- Contract changes must remain backward-compatible at the transport level (same capability IDs) but require strict versioning in the facet catalog to ensure downstream tooling regenerates types. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#facet-catalog`)
- Planner + sandbox clients rely on shared facet schemas; adding referential integrity rules in the shared builders prevents inconsistent payloads from reaching downstream reviewers. (`docs/architecture/flex-agents-server/13-verification.md`)

## Dev Notes
- Coordinate with Story 12.x social strategist enhancements to keep retrieval prompts aligned with the new `strategic_directions` summary block. (`docs/stories/12.1.flex-social-strategist-rag-foundation.md`)
- Ensure any sample JSON/YAML in the architecture appendix mirrors the new structure so docs, shared fixtures, and telemetry dashboards stay synchronized. (`docs/architecture/source-tree.md#4-agents-server`)

## Testing
- Shared facet Ajv suite exercises: min two directions, correct referential mapping, schema rejection for legacy payloads. (`packages/shared/src/flex/__tests__/facets.test.ts`)
- Strategist + copywriter Vitest specs assert planner nodes emit/consume multiple creative briefs and copy variants without raising runtime fallback paths. (`packages/flex-agents-server/__tests__/marketing/*.test.ts`)

## Risks / Mitigations
- **Risk:** Downstream consumers (designer, director) may crash if they still expect single `creative_brief` or string `post_copy`. **Mitigation:** provide feature flag/backfill step plus README updates to perform directional selection until they are upgraded. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`)
- **Risk:** Larger payloads could exceed planner/sandbox size ceilings. **Mitigation:** document guardrails (max directions, max briefs per direction) and enforce them via schema `maxItems` + validator hooks.
