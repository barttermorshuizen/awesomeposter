# Story 3.7: Manage Web List Configuration

## Status
Done

## Context & Dependencies
- Epic alignment: `docs/prd/epic-discovery-ingestion-normalization.md` (ingestion pipeline scope and success metrics).
- Builds on Story 3.4 (configuration schema), Story 3.5 (runtime processing), and Story 3.6 (configuration discovery API) to complete the operator-facing configuration loop.
- Frontend architecture reference: `docs/architecture/discovery-agent-frontend.md#project-structure`, `docs/architecture/discovery_agent_frontend/component-architecture.md#sources-management-flow`, and `docs/architecture/discovery_agent_frontend/state-management.md#state-management`.
- Backend contract reference: `docs/architecture/discovery_agent_backend/data-model-additions.md#configuration-schema--storage` and `docs/architecture/discovery_agent_backend/configuration-discovery-api.md`.

## Story
**As an** ingestion operator,  
**I want** to launch a dedicated configuration dialog for list-enabled web sources with inline validation and preview,  
**so that** the shared ingestion pipeline can harvest list pages without manual code/database updates and I can confirm selectors before saving.

## Acceptance Criteria
**Functional Requirements**
1. Web sources display a gear `Configure` icon to the left of the delete action; activating it opens a modal that hosts the `Web List` form (toggle, selectors, field mappings, pagination input) with Save and Cancel controls, all validated through shared schemas. [Source: docs/architecture/discovery_agent_frontend/component-architecture.md#sources-management-flow][Source: docs/architecture/discovery_agent_frontend/developer-standards.md#developer-standards][Source: docs/architecture/discovery_agent_backend/data-model-additions.md#configuration-schema--storage]
2. The modal exposes a `Check` action that runs the configuration against the source URL and renders the first extracted list item (title, URL, timestamp, plus warnings) so operators can verify selector accuracy before saving. [Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]
3. Saving serializes the `webList` block via shared helpers, persists it to `discovery_sources.config_json`, and returns the updated record so the UI reflects list extraction status; Cancel closes without persisting, and optimistic updates roll back on failure. [Source: docs/architecture/discovery_agent_backend/data-model-additions.md#configuration-schema--storage][Source: docs/architecture/discovery-agent-backend.md#ingestion-pipeline]
4. Applying a suggestion from the configuration discovery dialog merges the proposed selectors into the modal form, preserves warning/confidence metadata until acknowledged, and allows operators to discard suggestions to restore manual values. [Source: docs/architecture/discovery_agent_backend/configuration-discovery-api.md][Source: docs/architecture/discovery-agent-frontend.md#component-architecture]

**Integration Requirements**
4. Sources without `webList` continue to follow single-item ingestion; disabling the toggle removes the block from payloads and ensures telemetry/SSE consumers still receive consistent events. [Source: docs/architecture/discovery-agent-backend.md#ingestion-pipeline][Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]
5. The `discoverySources` store keeps `webList` state in sync with SSE updates and highlights list-enabled sources in the UI without duplicating server logic. [Source: docs/architecture/discovery_agent_frontend/state-management.md#state-management][Source: docs/architecture/discovery-agent-frontend.md#project-structure]

**Quality Requirements**
6. Pinia store/composable unit tests cover toggle flows, suggestion merge/discard, preview request lifecycle, schema validation errors, and payload serialization. [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
7. Component tests exercise the dialog + form for required selectors, optional fields, preview result rendering, error displays, and suggestion acceptance/rollback. [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
8. Operator guidance is updated to document the `Web List` workflow, including validation expectations, preview usage, and the pagination limitation. [Source: docs/stories/3.5.ingestion-web-list-processing.md][Source: docs/architecture/discovery_agent_frontend/developer-standards.md#developer-standards]

## Tasks / Subtasks
- [x] Add a gear-shaped `Configure` control to the discovery sources list UI for web sources, wiring it to open the configuration modal and disabling it for non-web types. [AC 1]
- [x] Implement `src/components/discovery/SourceListConfigDialog.vue` hosting `SourceListConfigForm` with Save/Cancel actions and schema-driven validation for selectors, fields, and pagination. [AC 1, AC 3, AC 4]
- [x] Build/extend `src/components/discovery/SourceListConfigForm.vue` plus `src/composables/discovery/useListConfig.ts` to expose defaults, schema validation, suggestion merge/discard helpers, and preview binding. [AC 1, AC 2, AC 4, AC 6]
- [x] Extend `src/stores/discoverySources.ts` to manage modal state, nested `webList` payloads, optimistic persistence, and SSE `source.updated` frames so gear state reflects backend truth. [AC 3, AC 4, AC 5, AC 6]
- [x] Add a `checkWebListConfig` service call (`src/services/discovery/sources.ts`) that invokes a backend preview endpoint and normalizes preview results/warnings for the dialog. [AC 2, AC 5]
- [x] Implement backend endpoints: augment `server/api/clients/[id]/sources/[sourceId].patch.ts` to persist `webList`, and add `server/api/clients/[id]/sources/[sourceId]/web-list/preview.post.ts` to run selector previews against the ingestion adapter. [AC 2, AC 3]
- [x] Update documentation (e.g., `docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md`) with gear icon usage, preview expectations, and pagination limitations; ensure UI exposes suggestion warnings via dialog messaging. [AC 4, AC 8]
- [x] Add Vitest suites for the composable/store/services (`tests/discovery/useListConfig.spec.ts`, `tests/discovery/discoverySources.store.spec.ts`, `tests/discovery/discoverySources.services.spec.ts`) and Vue Test Utils coverage for dialog + preview states (`tests/discovery/SourceListConfigDialog.spec.ts`). [AC 6, AC 7]

## Dev Notes
- Reuse shared config helpers instead of manual JSON transforms so Nitro and the SPA share validation logic. [Source: packages/shared/src/discovery/config.ts]
- Drive selector validation/errors from `discoverySourceWebListConfigInputSchema` via the composable; do not hand-roll regex checks in the component. [Source: docs/architecture/discovery_agent_frontend/developer-standards.md#developer-standards]
- Pagination selectors remain optional but should be gated behind the advisory copy that runtime pagination is deferred. [Source: docs/stories/3.5.ingestion-web-list-processing.md]
- When merging suggestions, keep warning/confidence metadata in the store so it can be surfaced in toast/tooltips even after the dialog closes. [Source: docs/architecture/discovery-agent-frontend.md#component-architecture]
- Preview endpoint should reuse existing ingestion helpers (`packages/shared/src/discovery/ingestion.ts`) to fetch the source, apply selectors once, and return normalized item data plus telemetry-style warnings without mutating persisted state. [Source: docs/architecture/discovery-agent-backend.md#ingestion-pipeline][Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]
- Gear icon placement must mirror existing action button spacing—use Vuetify button groups to keep alignment consistent with delete/edit actions. [Source: docs/architecture/discovery-agent-frontend.md#component-architecture]

## Assumptions & Edge Cases
- Discovery sources CRUD, feature flag enforcement, and SSE scaffolding from Stories 2.1–2.3 remain in place (`discovery.sources.enabled` flag still controls UI access). [Source: docs/stories/2.1.client-source-add-http-source.md]
- `source.updated` SSE frames are added in this story to broadcast `webList` changes; consumers must handle absent frames gracefully until rollout completes. [Source: docs/architecture/discovery_agent_frontend/state-management.md#state-management]
- Pagination is still disabled in runtime ingestion; form messaging must clarify that `next_page` selectors are advisory only. [Source: docs/stories/3.5.ingestion-web-list-processing.md]
- Preview requests use the same 8-second timeout and rate-limit guidance documented for config suggestions to avoid hammering upstream sites. [Source: docs/architecture/discovery_agent_backend/configuration-discovery-api.md]

## Project Structure Notes
- UI updates live under `src/components/discovery`, `src/composables/discovery`, and `src/stores` in line with the documented source tree. [Source: docs/architecture/source-tree.md#2-spa-src]
- Backend validation persists in Nitro handlers and shared packages, matching the separation defined in architecture references. [Source: docs/architecture/discovery-agent-backend.md#ingestion-pipeline]
- No structural conflicts identified.

## Testing
- Unit: Pinia store/composable tests covering toggle, merge/discard, preview request lifecycle (loading/success/error), serialization, and error mapping. [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
- Component: Vue Test Utils suites validating field rendering, required-selector enforcement, suggestion workflows, preview dialog states (including sample result rendering), and warning badges. [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
- Integration: API handler tests ensuring `webList` persistence, preview endpoint behaviour (success/error/timeouts), and fallback behaviour when disabled; SSE contract coverage verifying `source.updated` events reflect `webListApplied`. [Source: docs/architecture/discovery_agent_backend/data-model-additions.md#configuration-schema--storage][Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]

## References
- `docs/prd/epic-discovery-ingestion-normalization.md`
- `docs/stories/3.4.ingestion-configurable-web-list-extraction.md`
- `docs/stories/3.5.ingestion-web-list-processing.md`
- `docs/stories/3.6.ingestion-config-discovery-automation.md`
- `docs/stories/2.1.client-source-add-http-source.md`
- `docs/architecture/discovery-agent-frontend.md`
- `docs/architecture/discovery_agent_frontend/component-architecture.md`
- `docs/architecture/discovery_agent_frontend/state-management.md`
- `docs/architecture/discovery_agent_frontend/testing-requirements.md`
- `docs/architecture/discovery_agent_backend/data-model-additions.md`
- `docs/architecture/discovery_agent_backend/configuration-discovery-api.md`
- `packages/shared/src/discovery/config.ts`

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (default)

### Debug Log References
- Tests: `npm run test:unit`

### Completion Notes List
- Added configurable Web List dialog with validation, preview, and suggestion lifecycle integrated into the discovery sources UI.
- Introduced Pinia store and composable for web list state, optimistic persistence, and SSE `source.updated` synchronization.
- Delivered persistence + preview endpoints, shared telemetry schema updates, and refreshed operator guidance for the Web List workflow.

### File List
- src/components/clients/ClientDiscoverySourcesPanel.vue
- src/components/discovery/SourceListConfigDialog.vue
- src/components/discovery/SourceListConfigForm.vue
- src/composables/discovery/useListConfig.ts
- src/stores/discoverySources.ts
- src/services/discovery/sources.ts
- server/api/clients/[id]/sources/[sourceId].patch.ts
- server/api/clients/[id]/sources/[sourceId]/web-list/preview.post.ts
- server/utils/discovery-repository.ts
- packages/shared/src/discovery-events.ts
- packages/shared/src/discovery/config.ts
- docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md
- tests/discovery/useListConfig.spec.ts
- tests/discovery/discoverySources.store.spec.ts
- tests/discovery/discoverySources.services.spec.ts
- tests/discovery/SourceListConfigDialog.spec.ts

## QA Results
- _To be completed by the QA agent._

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-09 | 0.1 | Initial draft defining UI/UX and persistence work for web list configuration management. | Bob |
