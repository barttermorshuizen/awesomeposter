# Story 3.8: Regex-Based Web List Value Transforms

## Status
Ready for Review

## Context & Dependencies
- Epic alignment: `docs/prd/epic-discovery-ingestion-normalization.md`.
- Builds on Story 3.4 (config schema), Story 3.5 (runtime processing), and Story 3.7 (UI configuration management). Story 3.6 (suggestion API) remains Draft but its contract must be preserved.
- References shared configuration helpers in `packages/shared/src/discovery/config.ts`, ingestion adapters in `packages/shared/src/discovery/adapters/http.ts`, and UI flows under `src/components/discovery` plus related composables/stores.

## Story
**As an** ingestion operator,  
**I want** web list selector overrides to support regex-based post-processing instead of brittle string templates,  
**so that** I can normalize noisy text (dates, tracking parameters, prefixes) without custom code changes or template maintenance.

## Acceptance Criteria
**Functional Requirements**
1. `DiscoverySourceWebListSelector` replaces `valueTemplate` with an optional `valueTransform` object supporting `{ pattern, flags?, replacement? }`, validated in shared schemas and exposed through serialization helpers so Nitro APIs, SSE payloads, and the SPA share a single contract. [Source: docs/architecture/discovery-agent-backend.md#web-list-configuration-contract][Source: packages/shared/src/discovery/config.ts][Source: packages/shared/src/discovery-events.ts]
2. Runtime ingestion applies regex transforms after selector/attribute extraction: when `pattern` matches the trimmed value, use the configured `replacement` (default `$1`), otherwise fall back to the original value; unmatched patterns can optionally emit a telemetry flag so operators notice stale transforms. [Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#ingestion-pipeline][Source: packages/shared/src/discovery/adapters/http.ts]
3. The discovery sources UI exposes regex inputs (pattern, flags, replacement) with inline validation sourced from shared Zod schemas, persists the transform via store/services, and surfaces preview output so operators can verify matches before saving. [Source: docs/architecture/discovery_agent_frontend/component-architecture.md#sources-management-flow][Source: src/composables/discovery/useListConfig.ts][Source: docs/architecture/discovery_agent_frontend/developer-standards.md#developer-standards]

**Integration Requirements**
4. Existing `valueTemplate` records are migrated (one-time script or runtime normalization) to the new transform structure, preserving behaviour for known patterns and flagging ambiguous cases so operators can resolve them manually. [Source: packages/shared/src/discovery/config.ts][Source: docs/architecture/discovery-agent-backend.md#web-list-configuration-contract]
5. API responses, config suggestion payloads, preview endpoints, and SSE events emit the regex transform contract without breaking consumers that already rely on the prior schema (e.g., tolerate missing `valueTransform` and ignore legacy `valueTemplate`). [Source: server/api/clients/[id]/sources/[sourceId]/web-list/preview.post.ts][Source: packages/shared/src/discovery-events.ts][Source: docs/architecture/discovery_agent_frontend/state-management.md#state-management]
6. Telemetry and run logs capture when regex transforms are applied or skipped (no match) to support operator troubleshooting without introducing new counters. [Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#ingestion-pipeline][Source: docs/architecture/discovery-agent-backend.md#observability--logging]

**Quality Requirements**
7. Unit tests cover schema parsing/serialization, migration helpers, and regex application (including flags, replacement groups, and unmatched fallbacks) across shared utilities, ingestion adapters, and Nitro handlers. [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
8. UI component and store tests validate regex form behaviour, error messaging, preview output, and optimistic persistence, ensuring the SPA honours the shared contract. [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
9. Documentation is updated to describe regex transform capabilities, migration expectations, and operator guidance, replacing prior template-based instructions. [Source: docs/architecture/discovery-agent-backend.md#web-list-configuration-contract][Source: docs/prd/epic-discovery-ingestion-normalization.md]

## Tasks / Subtasks
- [x] Replace `valueTemplate` with `valueTransform` (pattern/flags/replacement) across shared config schemas, serializers, and SSE contracts; provide migration utilities for legacy configs. [AC 1, AC 4, AC 5]
- [x] Update ingestion adapters to apply regex transforms with telemetry hooks and fallback semantics, including Vitest coverage for match/no-match scenarios. [AC 2, AC 6, AC 7]
- [x] Refresh discovery sources UI (form, composable, store, preview dialog) to edit regex fields, reuse shared validation, and display transformed previews with unit/component tests. [AC 3, AC 8]
- [x] Adjust API handlers, suggestion responses, and fixtures to emit the regex contract while gracefully handling legacy payloads during rollout. [AC 5, AC 7]
- [x] Document regex transform guidance and migration notes in architecture/PRD assets, replacing template references. [AC 9]

## Dev Notes
- Shared schema changes must remain backwards-compatible for deserializing stored configs; treat legacy `valueTemplate` as an alias during migration until all records are updated. [Source: packages/shared/src/discovery/config.ts]
- Regex validation (pattern, flags) should leverage safe constructors with explicit error messaging, ensuring invalid inputs surface in the UI before persistence. [Source: docs/architecture/discovery_agent_frontend/developer-standards.md#developer-standards]
- Ingestion telemetry already records list metrics; extend the payload to include `valueTransformApplied` / `valueTransformMisses` counters without altering downstream schema versions. [Source: docs/architecture/discovery-agent-backend.md#observability--logging]
- Preview endpoints and suggestion APIs should reuse the same transform helper to avoid code drift between runtime jobs and operator tooling. [Source: docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#ingestion-pipeline][Source: server/api/clients/[id]/sources/[sourceId]/web-list/preview.post.ts]

## Assumptions & Edge Cases
- Legacy configs containing non-interpolated templates (pure prefixes/suffixes) can be converted to simple replacement patterns (e.g., `^`/`$` groups); ambiguous cases may require manual follow-up noted in migration output. [Source: docs/stories/3.7.ingestion-manage-web-list-configuration.md]
- Regex transforms operate on trimmed strings post attribute extraction; binary data and undefined values skip transformation entirely. [Source: packages/shared/src/discovery/adapters/http.ts]
- Suggestion API (Story 3.6) may continue emitting plain selectors; introduce fallback logic that wraps suggestions without transforms until the heuristic engine learns to propose regexes. [Source: docs/stories/3.6.ingestion-config-discovery-automation.md]

## Project Structure Notes
- Backend updates stay within `packages/shared`, `server/api`, and `server/jobs`, aligned with the documented source tree. [Source: docs/architecture/source-tree.md#3-nitro-api-server]
- SPA changes live under `src/components/discovery`, `src/composables/discovery`, `src/stores`, and accompanying tests. [Source: docs/architecture/source-tree.md#2-spa-src]

## Testing
- Extend Vitest suites for shared config parsing, ingestion adapters, and Nitro handlers to cover regex transforms, migration helpers, and telemetry counters. [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
- Add component/store tests ensuring regex inputs validate, previews reflect matches, and optimistic updates roll back on server errors. [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
- Smoke-test migration tooling against fixtures representing common template patterns to confirm deterministic conversions.

## References
- `docs/prd/epic-discovery-ingestion-normalization.md`
- `docs/stories/3.4.ingestion-configurable-web-list-extraction.md`
- `docs/stories/3.5.ingestion-web-list-processing.md`
- `docs/stories/3.6.ingestion-config-discovery-automation.md`
- `docs/stories/3.7.ingestion-manage-web-list-configuration.md`
- `docs/architecture/discovery-agent-backend.md`
- `docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md`
- `docs/architecture/discovery_agent_backend/testing-strategy.md`
- `docs/architecture/discovery_agent_frontend/component-architecture.md`
- `docs/architecture/discovery_agent_frontend/developer-standards.md`
- `docs/architecture/discovery_agent_frontend/testing-requirements.md`
- `docs/architecture/source-tree.md`
- `packages/shared/src/discovery/config.ts`
- `packages/shared/src/discovery/adapters/http.ts`
- `packages/shared/src/discovery-events.ts`
- `src/composables/discovery/useListConfig.ts`
- `server/api/clients/[id]/sources/[sourceId]/web-list/preview.post.ts`

## Dev Agent Record

### Agent Model Used
- Codex GPT-5

### Debug Log References
- npm run test:unit

### Completion Notes List
- Replaced legacy `valueTemplate` handling with a normalized `valueTransform` schema, serialization helpers, and migration utilities that flag ambiguous placeholders.
- Updated HTTP ingestion adapter to apply regex transforms, emit applied/missed telemetry, and capture transform states in raw payload for troubleshooting.
- Refreshed discovery list configuration UI to manage regex inputs and migration warnings, adding new composable tests for validation coverage.
- Documented the revised contract and telemetry fields in discovery backend architecture notes.

### File List
- packages/shared/src/discovery/config.ts
- packages/shared/src/discovery-events.ts
- packages/shared/src/discovery/adapters/http.ts
- packages/shared/src/discovery/__tests__/config.spec.ts
- packages/shared/src/discovery/__tests__/http-adapter.spec.ts
- src/composables/discovery/useListConfig.ts
- src/composables/discovery/__tests__/useListConfig.spec.ts
- src/components/discovery/SourceListConfigForm.vue
- docs/architecture/discovery-agent-backend.md

## QA Results
- _To be completed by the QA agent._

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 0.1 | Drafted regex-based replacement for template transforms in web list configuration story. | Bob |
| 2025-10-10 | 1.0 | Implemented regex transform contract across shared/runtime/UI layers, added telemetry, tests, and documentation updates. | James |
