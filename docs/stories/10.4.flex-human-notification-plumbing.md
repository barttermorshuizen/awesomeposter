# Story 10.4: Flex Human Notification & Assignment Plumbing

## Status
Ready for Dev

## Story
**As a** flex operations platform engineer,  
**I want** notification and assignment plumbing for human-operated flex tasks,  
**so that** operators reliably receive pending work, escalations, and backlog recovery signals without disrupting legacy HITL flows.

**Dependencies:** Completion of Story 10.3 (flex human task surfaces). (`docs/stories/10.3.flex-human-task-surfaces.md`)

## Acceptance Criteria
1. `GET /api/v1/flex/tasks` returns pending human assignments with `capabilityId`, `kind`, `inputFacets`, `outputFacets`, `rationale`, `dueAt`, and status derived from persisted `flex_plan_nodes`, matching the payload emitted in `node_start` frames with `executorType: "human"`; filters for `status` and `capabilityId` behave as documented. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
2. Notification routing hooks subscribe to `node_start/node_complete/node_error` events and drive in-app/async notifications so SPA state, `/api/v1/flex/tasks`, and legacy `/api/hitl/pending` remain synchronized during reconnects and offline recovery. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`, `docs/architecture/hitl/5-key-data-flows.md#51-specialist-raises-hitl-request`)
3. Decline and timeout handling for flex human tasks invoke `/api/v1/flex/tasks/:taskId/decline`, persist SLA breaches using `FLEX_HUMAN_ASSIGNMENT_TIMEOUT_SECONDS`, and surface policy-triggered escalations without touching `/api/hitl/*` endpoints. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#1510-registration--governance-notes`, `docs/architecture/hitl/8-configuration-feature-flagging.md#81-flex-task-panel-configuration`)
4. Vitest suites cover notification service hooks, flex task API filters, decline flows, and timeout enforcement, running via `npm run test:unit` as defined in coding standards. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)

## Tasks / Subtasks
- [ ] Extend `packages/flex-agents-server/routes/api/v1/flex/tasks.get.ts` and related services to emit assignment metadata aligned with `node_start` frames and persisted `flex_plan_nodes`, including filter coverage. (AC 1) (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- [ ] Implement notification routing hooks (in-app and async) that subscribe to SSE lifecycle events and reconcile SPA stores/backlog APIs after reconnect. (AC 2) (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- [ ] Ensure decline and timeout flows update persistence, invoke policy triggers, and keep flex endpoints isolated from legacy `/api/hitl/*` surfaces. (AC 3) (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#1510-registration--governance-notes`, `docs/architecture/hitl/8-configuration-feature-flagging.md#81-flex-task-panel-configuration`)
- [ ] Add Vitest coverage for assignment API filters, notification hook reconciliation, and timeout enforcement, wired into `npm run test:unit`. (AC 4) (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Update operator documentation and feature flag notes covering notification routing, SLA expectations, and fallback behavior. (AC 3) (`docs/architecture/hitl/8-configuration-feature-flagging.md#81-flex-task-panel-configuration`, `docs/architecture/flex-agents-server.md#1510-registration--governance-notes`)

## Story Context
- Human nodes now emit assignment metadata and facet contracts via `node_start` frames, requiring notification services to surface routed work without reusing legacy HITL state machines. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- Offline recovery depends on persisted `flex_plan_nodes` snapshots and `/api/v1/flex/tasks` to rebuild operator queues when SSE listeners reconnect. (`docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)
- Legacy HITL approvals continue to rely on `/api/hitl/pending`; flex assignments must remain isolated while still honoring shared toast/error handling patterns. (`docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- Single-notification policy and SLA timeout require orchestration metrics to record missed assignments and trigger policy-driven escalations. (`docs/architecture/flex-agents-server.md#1510-registration--governance-notes`)
- Planner outputs capability-aligned metadata (`capabilityId`, `kind`, `inputFacets`, `outputFacets`, `rationale`) for human nodes rather than concrete operator identities; notification plumbing should use these fields for routing and filtering. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)

## Dev Notes
- **Previous Story Insights:** Story 10.3 delivered `flexTasks` Pinia store, widget registry, and panel components consuming `/api/v1/flex/tasks` and `/api/v1/flex/run.resume`; notification plumbing must integrate with these surfaces without regressing the UI contracts. (`docs/stories/10.3.flex-human-task-surfaces.md`)
- **Data Models:** Assignment state persists in `flex_plan_nodes` and related tables, capturing assignment metadata (`capabilityId`, `kind`, facets, rationale, due dates) and pending status for deterministic resume and backlog hydration. (`docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- **API Specifications:** Flex task APIs include list (`GET /api/v1/flex/tasks`), decline routes, and SSE streams delivering lifecycle events; they must remain isolated from `/api/hitl/*` endpoints. (`docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- **Component Specifications:** Notification routing hooks live within the agents server (for async channels) and SPA SSE bridge; they consume `node_start/node_complete/node_error` events, surface capability metadata, and update Pinia stores or downstream integrations. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- **File Locations:** Backend logic belongs in `packages/flex-agents-server/src` with routes under `routes/api/v1/flex`, shared contracts in `packages/shared/src/flex`, and SPA notification listeners within `src/lib` / `src/stores`. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#2-spa`)
- **Testing Requirements:** Add Vitest suites for notification services, API filters, and timeout enforcement, executed via `npm run test:unit`. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)
- **Technical Constraints:** Maintain TypeScript with strict typing, reuse existing Zod validators, and follow coding standards for module structure and error handling. (`docs/architecture/coding-standards.md#1-language--module-conventions`)
- **Project Structure Notes:** Planned updates align with documented SPA, agents server, and shared library directories; no deviations required. (`docs/architecture/source-tree.md#2-spa`, `docs/architecture/source-tree.md#4-agents-server`)


## Dev Notes
- **Previous Story Insights:** Story 10.3 delivered `flexTasks` Pinia store, widget registry, and panel components consuming `/api/v1/flex/tasks` and `/api/v1/flex/run.resume`; notification plumbing must integrate with these surfaces without regressing the UI contracts. (`docs/stories/10.3.flex-human-task-surfaces.md`)
- **Data Models:** Assignment state persists in `flex_plan_nodes` and related tables, capturing assignment metadata and pending status for deterministic resume and backlog hydration. (`docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- **API Specifications:** Flex task APIs include list (`GET /api/v1/flex/tasks`), decline routes, and SSE streams delivering lifecycle events; they must remain isolated from `/api/hitl/*` endpoints. (`docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- **Component Specifications:** Notification routing hooks live within the agents server (for async channels) and SPA SSE bridge; they consume `node_start/node_complete/node_error` events and update Pinia stores or downstream integrations. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- **File Locations:** Backend logic belongs in `packages/flex-agents-server/src` with routes under `routes/api/v1/flex`, shared contracts in `packages/shared/src/flex`, and SPA notification listeners within `src/lib` / `src/stores`. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#2-spa`)
- **Testing Requirements:** Add Vitest suites for notification services, API filters, and timeout enforcement, executed via `npm run test:unit`. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)
- **Technical Constraints:** Maintain TypeScript with strict typing, reuse existing Zod validators, and follow coding standards for module structure and error handling. (`docs/architecture/coding-standards.md#1-language--module-conventions`)
- **Project Structure Notes:** Planned updates align with documented SPA, agents server, and shared library directories; no deviations required. (`docs/architecture/source-tree.md#2-spa`, `docs/architecture/source-tree.md#4-agents-server`)

## Testing
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-human-notifications.spec.ts packages/flex-agents-server/__tests__/flex-tasks-api.spec.ts src/stores/__tests__/flexTasks.notifications.spec.ts`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-04-02 | 0.1 | Initial draft defining flex human notification and assignment plumbing scope. | Scrum Master |

## QA Results

_Not yet reviewed. QA to update this section only._
