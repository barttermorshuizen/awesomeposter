# Story 5.1: Discovery Item Listing & Filtering

## Status
Approved

## Executive Summary
- Project type: Brownfield with UI layer.
- Blocking issues: No rollback/risk plan, missing dependency sequencing, unclear backend/search contract, absent deployment strategy, no documentation plan.
- Sections with most risk: 2 (Infrastructure), 6 (Feature sequencing), 7 (Risk management), 9 (Documentation), 10 (Post-MVP).

## Story
**As a** reviewer,
**I want** to browse `Spotted` discovery items (nuggets) with rich filtering and search,
**so that** I can quickly find nuggets relevant to my campaign.

## Project-Specific Analysis (Brownfield)
- Integration risk: High—search endpoint + SSE updates lack migration, rollback, and compatibility guidance.
- Existing system impact: Underspecified; story must confirm preservation of current discovery dashboards and Pinia stores.
- Rollback readiness: None documented.
- User disruption: Medium—filters/search touch core reviewer workflow without mitigation details.

## Acceptance Criteria
1. List view supports filters for source, topic keyword, status, and date range; filters are combinable and reflected in query params.
2. Keyword search matches against title and extracted body (case-insensitive) with highlighting in results; highlight spans are provided by backend metadata.
3. Pagination handles at least 1,000 discovery items with stable navigation (page size selectable: 25/50/100) and documents virtualization trigger thresholds and fallback behavior if virtualization is not applied.
4. Default view shows last 48 hours of `Spotted` discovery items sorted by score descending and respects feature flag defaults.
5. Empty results, backend errors, and SSE disconnects surface dedicated UI states with retry guidance; loading states remain accessible.
6. SSE incremental updates honor active filters/search terms, queue mismatched payloads, and fall back to scheduled polling if SSE fails.
7. UI meets accessibility (keyboard navigation, ARIA labelling) and responsive breakpoints (desktop ≥1280px, tablet 768–1279px, mobile ≤767px) for filters and list.
8. Feature is gated by `discovery.filters.v1` flag, includes documented rollback steps, and ships with monitoring hooks for search latency and filter usage.

## Tasks / Subtasks
- [ ] Define search endpoint contract (request/response schema, highlighting fields, pagination semantics) and align sequencing with backend readiness (AC 2, AC 3).
- [ ] Build filter components and wire them to router query params while persisting state to existing Pinia stores (AC 1).
- [ ] Implement search backend endpoint with pagination, highlighting metadata, caching/index notes, and SSE compatibility (AC 2, AC 6).
- [ ] Add default filter preset applied on initial load with feature flag guard (AC 4, AC 8).
- [ ] Ensure SSE events update the list incrementally and degrade to polling path with alerting on failure (AC 5, AC 6).
- [ ] Flesh out empty/error/loading UX, accessibility checks, and responsive layouts (AC 5, AC 7).
- [ ] Create rollback + deployment checklist including feature flag toggle, data migration plan, and documentation updates (AC 8).
- [ ] Instrument analytics/telemetry for filter usage, latency, and SSE error rate; expose dashboards/alerts (AC 8).
- [ ] Plan and execute load test for 1k item pagination with highlight rendering to validate performance budgets (AC 3).
- [ ] Update docs (architecture appendix + README snippet) covering backend contract, monitoring, and operational runbooks.

## Risk Assessment
- Missing rollback/feature flag plan for new filters/search (critical).
- Backend pagination/search contract undefined—risk of API/DB regressions.
- SSE incremental update behavior lacks failure handling.
- Performance requirements (1k items + highlighting) lack plan for load testing.
- No monitoring/analytics hooks to detect regressions post-launch; mitigations required before sprint start.

## MVP Completeness
- Core goals (rich filtering, keyword highlighting, pagination) captured at a high level.
- Edge cases (empty results, query errors, SSE disconnects) now tracked in Acceptance Criteria and tasks.
- Accessibility and responsive expectations added to Acceptance Criteria.
- Scope creep risk low—story stays focused on listing; backend effort flagged as potentially larger than a single story without sequencing safeguards.

## Implementation Readiness
- Developer clarity score: 4/10—UI intent clear, backend/infra previously vague; contract section below reduces ambiguity but requires review.
- Ambiguous items: highlight implementation specifics, pagination data contract, SSE flow on filter changes, index requirements—all captured in Technical Specifications and tasks for follow-up.
- Missing technical details: API schema, DB query strategy, caching/indexing notes, error/empty states—documented below but pending confirmation.
- Integration clarity: Partial; architecture docs cover stack reuse (`docs/architecture/discovery-agent-frontend.md`), but story now references Nitro handlers/Pinia stores that must be validated.

## Technical Specifications
### Backend Search Endpoint Contract
- **Route**: `GET /api/discovery/search`
- **Query params**: `source[]`, `topic[]`, `status[]`, `dateFrom`, `dateTo`, `page`, `pageSize`, `searchTerm`.
- **Response**: `{ items: DiscoveryItemWithHighlights[], total, page, pageSize, latencyMs }`.
- **Highlighting**: Each item includes `{ field: "title" | "body", snippets: string[] }` and is escaped for HTML rendering.
- **Pagination**: Stable ordering by score desc, deterministic cursor derived from `_id` + score to avoid duplicates.
- **Indexes**: Ensure compound index on `(status, score, createdAt)` plus text/TS vector index for search fields.

### SSE Update Flow
- SSE channel `discovery/updates` emits `{ type, payload }` events.
- Client queues events when filters do not match, requests reconciliation via `/api/discovery/search` on filter change.
- Fallback polling every 30s when SSE connection fails twice within 5 minutes; logs telemetry event `discovery.sse.degraded`.

### State Management & UI
- Use existing Pinia store `discoveryListStore` for filter state to preserve current dashboard behavior.
- Router query params mirror store state for shareable URLs.
- Virtualization kicks in when item count >250; fallback gracefully if virtualization library regresses by showing paginated table only.

## Deployment & Monitoring Strategy
- Roll out behind `discovery.filters.v1` flag with documented toggle procedure and rollback checklist (disable flag, revert Pinia changes, clear cache).
- Pre-deploy load test: seed 1k items with highlighting to capture baseline metrics; store results in `docs/qa/perf/discovery-filters.md`.
- Monitoring: add search latency + filter usage charts to Grafana dashboard; set alert for >5% SSE degrade rate over 15 minutes.
- Documentation: update `docs/architecture/discovery-agent-frontend.md` and team runbook with new endpoints, feature flag, and telemetry expectations.

## Recommendations
### Must-fix before dev
1. Define backend search endpoint contract (request/response, highlighting fields, indices) and sequencing vs. UI build.
2. Add rollback + feature flag plan and regression expectations (unit/integration coverage, SSE fallbacks).
3. Document deployment/monitoring strategy, including performance validation for 1k item pagination.
4. Capture risk assessment + mitigation (Section 7) with clear owner actions.

### Should-fix for quality
1. Flesh out error/empty/loading UX, accessibility acceptance criteria, and responsive behavior.
2. Specify how SSE updates interact with active filters.
3. Call out dependency on existing discovery Pinia stores and required adjustments.

### Consider for improvement
1. Note analytics/telemetry needed to monitor filter usage and search latency.
2. Clarify virtualization trigger thresholds and fallback plan if not implemented.

### Post-MVP deferrals
1. Advanced sorting/saved filters if out of scope—mark explicitly to avoid scope creep.

## Dev Notes
- Reuse existing Vue/Vuetify table patterns for consistency; ensure accessible form controls with Vuetify props.
- Highlight rendering should use shared utility `highlightSnippets` to avoid XSS.
- Coordinate with backend team on index creation scripts before UI QA.
- Document Pinia store changes and router interactions in `docs/architecture/source-tree.md` appendices.

### Testing
- Frontend unit/integration tests for filter logic, accessibility snapshots, and SSE degrade fallback.
- API tests asserting search results order, pagination, highlight payload, and latency budget (<400 ms at P95 with 1k items).
- Load tests capturing throughput under concurrent reviewers (target 50 RPS sustained).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Brief Management Dashboard. | PM |

## Dev Agent Record
_Not yet worked._
