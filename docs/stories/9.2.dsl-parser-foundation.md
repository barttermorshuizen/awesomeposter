# Story 9.2: Shared DSL Parser and Validation

## Status
Draft

## Story
**As an** architect ensuring policy safety,  
**I want** a shared condition DSL parser and validation module,  
**so that** we can convert human-readable expressions into JSON-Logic consistently across clients and servers.  

**Dependencies:** Playground pilot (Story 9.1) to validate UX inputs; epic guardrails for shared module design (`docs/prd/epic-9-condition-management.md:14`).

## Acceptance Criteria
1. A new shared TypeScript package (or module inside `@awesomeposter/shared`) exposes `parseDsl(expression, catalog)` and `toDsl(jsonLogic, catalog)` functions that round-trip DSL â†” JSON-Logic. (`docs/prd/epic-9-condition-management.md:15`)
2. Variable catalog definition is centralized with metadata (name, path, type, description, allowed operators) and consumed by both parser and UI. (`docs/prd/epic-9-condition-management.md:15`)
3. Parser validates identifiers/operators against the catalog, returning structured error objects with line/column info for UI display. (`docs/prd/epic-9-condition-management.md:16`)
4. Unit tests cover supported operators (comparison, logical, grouping), error handling (unknown variable, type mismatch), and JSON-Logic parity using golden fixtures. (`docs/prd/epic-9-condition-management.md:30`)
5. Nitro server helper validates DSL inputs on save, producing HTTP-safe error responses, while existing JSON-only payloads continue to work unchanged. (`docs/prd/epic-9-condition-management.md:24`)

## Tasks / Subtasks
- [ ] Define the variable registry schema and seed entries for current QA/policy metrics. (AC 2)
- [ ] Implement tokenizer + parser (Chevrotain or agreed library) producing AST aligned with JSON-Logic constructs. (AC 1,3)
- [ ] Implement transpilers `ast -> jsonLogic` and `jsonLogic -> dsl` with round-trip guarantees. (AC 1)
- [ ] Add Nitro validation helper that reuses the shared parser and maps errors to HTTP responses. (AC 5)
- [ ] Create comprehensive unit tests (AST fixtures, golden JSON files, error cases) and documentation. (AC 4)

## Story Context

**Existing System Integration:**
- Integrates with: `@awesomeposter/shared` packages, Nitro policy endpoints, pilot playground (Story 9.1), upcoming Flex Sandbox integration (Story 9.3).
- Technology: TypeScript, Chevrotain (recommended), JSON-Logic compatibility, Node-friendly module bundling.
- Patterns: Shared package publishing as used for other Flex utilities.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Supported grammar includes identifiers, dotted paths, numeric literals, booleans, comparisons (`<`, `<=`, `>`, `>=`, `==`, `!=`), logical `&&`/`||`, and parentheses.
2. Registry-driven type coercion determines valid operators (e.g., booleans allow `==`, numbers allow comparisons).
3. DSL rendering compresses whitespace but preserves canonical formatting for round-trip stability.

### Integration Requirements
4. Module exports are tree-shakeable and ESM/CJS compatible to match existing package patterns.
5. Server helper returns consistent error shapes for UI consumption (code, message, field).
6. Existing JSON-Logic payloads bypass DSL parsing to preserve backward compatibility.

### Quality Requirements
7. Tests achieve >95% coverage on parser and transpiler paths.
8. Golden fixtures stored under `tests/fixtures/condition-dsl` guard against regressions.
9. Documentation details registry updates, testing strategy, and error handling contract.

## Technical Notes
- Prefer Chevrotain to align with recommended parser toolkit; fall back to custom Pratt parser only if bundle size requires.
- Consider building minimal AST interfaces to share between client and server.
- Provide helper to serialize error paths for UI overlays.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Tests pass locally and in CI
- [ ] Documentation updated (README + API reference)
- [ ] Package published/linked for Story 9.3 consumption

## Risk and Compatibility Check
- **Primary Risk:** Parser bugs generating wrong JSON-Logic.
- **Mitigation:** Golden tests, manual review of critical expressions, fallback to raw JSON editing if issues found.
- **Rollback:** Revert to JSON-only processing by disabling DSL helpers; pilot playground can remain mock-only.

**Compatibility Verification**
- [x] No breaking API changes
- [x] Database untouched
- [x] UI unaffected in production until Story 9.3
- [x] Performance acceptable (parser runs on-demand)

## Validation Checklist
- [x] Parser scope limited and testable
- [x] Integration touchpoints clear
- [x] Success criteria objectively verifiable
- [x] Rollback strategy trivial (disable DSL helpers)
