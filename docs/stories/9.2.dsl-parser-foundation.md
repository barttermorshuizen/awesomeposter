# Story 9.2: Shared DSL Parser and Validation

## Status
Done

## Story
**As an** architect ensuring policy safety,  
**I want** a shared condition DSL parser and validation module,  
**so that** we can convert human-readable expressions into JSON-Logic consistently across clients and servers.  

**Dependencies:** Playground pilot (Story 9.1) to validate UX inputs; epic guardrails for shared module design (`docs/prd/epic-9-condition-management.md:14`).

## Acceptance Criteria
1. A new shared TypeScript package (or module inside `@awesomeposter/shared`) exposes `parseDsl(expression, catalog)` and `toDsl(jsonLogic, catalog)` functions that round-trip DSL ↔ JSON-Logic. (`docs/prd/epic-9-condition-management.md:15`)
2. Variable catalog definition is centralized with metadata (name, path, type, description, allowed operators) and consumed by both parser and UI. (`docs/prd/epic-9-condition-management.md:15`)
3. Parser validates identifiers/operators against the catalog, returning structured error objects with line/column info for UI display. (`docs/prd/epic-9-condition-management.md:16`)
4. Unit tests cover supported operators (comparison, logical, grouping), error handling (unknown variable, type mismatch), and JSON-Logic parity using golden fixtures. (`docs/prd/epic-9-condition-management.md:30`)
5. Nitro server helper validates DSL inputs on save, producing HTTP-safe error responses, while existing JSON-only payloads continue to work unchanged. (`docs/prd/epic-9-condition-management.md:24`)

## Tasks / Subtasks
- [x] Define the variable registry schema and seed entries for current QA/policy metrics. (AC 2)
- [x] Implement tokenizer + parser (Chevrotain or agreed library) producing AST aligned with JSON-Logic constructs. (AC 1,3)
- [x] Implement transpilers `ast -> jsonLogic` and `jsonLogic -> dsl` with round-trip guarantees. (AC 1)
- [x] Add Nitro validation helper that reuses the shared parser and maps errors to HTTP responses. (AC 5)
- [x] Create comprehensive unit tests (AST fixtures, golden JSON files, error cases) and documentation. (AC 4)

## Story Context

**Existing System Integration:**
- Integrates with: `@awesomeposter/shared` packages, Nitro policy endpoints, pilot playground (Story 9.1), upcoming Flex Sandbox integration (Story 9.3).
- Technology: TypeScript, Chevrotain (recommended), JSON-Logic compatibility, Node-friendly module bundling.
- Patterns: Shared package publishing as used for other Flex utilities.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Supported grammar includes identifiers, dotted paths, numeric literals, booleans, comparisons (`<`, `<=`, `>`, `>=`, `==`, `!=`), logical `&&`/`||`, and parentheses.
2. Registry-driven type coercion determines valid operators (e.g., booleans allow `==`, numbers allow comparisons).
3. DSL rendering compresses whitespace but preserves canonical formatting for round-trip stability.

### Integration Requirements
4. Module exports are tree-shakeable and ESM/CJS compatible to match existing package patterns.
5. Server helper returns consistent error shapes for UI consumption (code, message, field).
6. Existing JSON-Logic payloads bypass DSL parsing to preserve backward compatibility.

### Quality Requirements
7. Tests achieve >95% coverage on parser and transpiler paths.
8. Golden fixtures stored under `tests/fixtures/condition-dsl` guard against regressions.
9. Documentation details registry updates, testing strategy, and error handling contract.

## Technical Notes
- Prefer Chevrotain to align with recommended parser toolkit; fall back to custom Pratt parser only if bundle size requires.
- Consider building minimal AST interfaces to share between client and server.
- Provide helper to serialize error paths for UI overlays.

## Definition of Done
- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Tests pass locally and in CI
- [x] Documentation updated (README + API reference)
- [ ] Package published/linked for Story 9.3 consumption

## Risk and Compatibility Check
- **Primary Risk:** Parser bugs generating wrong JSON-Logic.
- **Mitigation:** Golden tests, manual review of critical expressions, fallback to raw JSON editing if issues found.
- **Rollback:** Revert to JSON-only processing by disabling DSL helpers; pilot playground can remain mock-only.

**Compatibility Verification**
- [x] No breaking API changes
- [x] Database untouched
- [x] UI unaffected in production until Story 9.3
- [x] Performance acceptable (parser runs on-demand)

## Validation Checklist
- [x] Parser scope limited and testable
- [x] Integration touchpoints clear
- [x] Success criteria objectively verifiable
- [x] Rollback strategy trivial (disable DSL helpers)

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Developer persona)

### Debug Log References
- None

### Completion Notes List
- Replaced the mock transpiler with a shared parser/renderer rooted in a Pratt-style expression evaluator, producing canonical DSL, JSON-Logic, and catalog-aware validation errors.
- Centralized the variable registry in `@awesomeposter/shared`, exposing full metadata (grouping, descriptions, allowed operators) and reusing it inside the Vue playground.
- Added the Nitro `validateConditionInput` helper to translate parser failures into HTTP 400 responses with structured error ranges while preserving legacy JSON-Logic payload flows.
- Authored golden fixtures plus Vitest suites covering round-trip parsing, rendering, evaluator behaviour, and server helper error contracts; refreshed playground catalog tests.
- Documented the module contract in `docs/architecture/condition-dsl.md` and updated the UI to surface allowed operators per variable.
- Validated via `npx vitest run packages/shared/__tests__/condition-dsl.spec.ts server/utils/__tests__/condition-dsl-helper.spec.ts src/lib/__tests__/conditionPlaygroundCatalog.spec.ts`.
- Hardened the canonical renderer to respect logical precedence, added catalog-driven type mismatch diagnostics, and relaxed playground typing so vue-tsc no longer flags the DSL tooling.

### File List
- docs/architecture/condition-dsl.md
- docs/stories/9.2.dsl-parser-foundation.md
- docs/qa/gates/9.2-dsl-parser-foundation.yml
- packages/shared/src/condition-dsl/catalog.ts
- packages/shared/src/condition-dsl/engine.ts
- packages/shared/src/condition-dsl/index.ts
- packages/shared/src/condition-dsl/types.ts
- packages/shared/src/index.ts
- packages/shared/__tests__/condition-dsl.spec.ts
- server/utils/condition-dsl.ts
- server/utils/__tests__/condition-dsl-helper.spec.ts
- src/lib/conditionPlayground/catalog.ts
- src/lib/__tests__/conditionPlaygroundCatalog.spec.ts
- src/views/ConditionPlaygroundView.vue
- tests/fixtures/condition-dsl/basic-roundtrip.dsl
- tests/fixtures/condition-dsl/basic-roundtrip.json
- tests/fixtures/condition-dsl/grouped-roundtrip.dsl
- tests/fixtures/condition-dsl/grouped-roundtrip.json

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 0.2 | Replaced mock DSL transpiler with shared parser/catalog, Nitro helper, fixtures, and documentation. | Dev |
| 2025-10-21 | 0.3 | Restored DSL round-trip correctness, enforced catalog type mismatches, refreshed playground typing/tests. | Dev |

## QA Results

### Review Date: 2025-10-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Core parser structure and fixtures look well organised, but two critical regressions block sign-off: the JSON-Logic back-transpiler drops required parentheses when mixing `&&`/`||`, changing expression semantics, and the catalog-driven validator never enforces literal type compatibility (e.g. numbers vs strings), leaving a key acceptance criterion unmet.

### Refactoring Performed

None.

### Compliance Check

- Coding Standards: ✗ — Canonical renderer violates functional correctness when normalising parentheses.
- Project Structure: ✓ — Shared package and Nitro helper land in expected locations.
- Testing Strategy: ✗ — Type-mismatch validation lacks both implementation and automated coverage demanded by AC4.
- All ACs Met: ✗ — Round-trip guarantee and catalog type enforcement both fail.

### Improvements Checklist

- [ ] Fix `renderNode` in `packages/shared/src/condition-dsl/engine.ts` so `toDsl` preserves grouping when combining logical operators (currently `foo && (bar || baz)` round-trips to `foo && bar || baz`).
- [ ] Enforce catalog type compatibility in `parseDsl` (reject comparing number fields to string literals, etc.) and add explicit tests.
- [ ] Relax or default the `group` field in `src/views/ConditionPlaygroundView.vue` so vue-tsc no longer flags `string | undefined` assignments.

### Security Review

No new security exposures identified; defects are correctness/validation related.

### Performance Considerations

No performance regressions observed; pending fixes should not materially change runtime costs.

### Files Modified During Review

None.

### Test Coverage & Validation

- `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts server/utils/__tests__/condition-dsl-helper.spec.ts src/lib/__tests__/conditionPlaygroundCatalog.spec.ts` ✅ (all suites green).
- `pnpm type-check` ❌ — fails globally; notable new error from this story: `VariableOption.group` rejects `string | undefined`.

### Gate Status

Gate: FAIL → docs/qa/gates/9.2-dsl-parser-foundation.yml

### Recommended Status

[✗ Changes Required - See unchecked items above]

### Review Date: 2025-10-21 (Retest)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Renderer precedence, catalog validation, and playground typings are now fixed; round-trips preserve semantics, type mismatches are rejected with precise diagnostics, and UI typings align with runtime data.

### Refactoring Performed

- None by QA; verified developer updates across shared engine, tests, and playground typing.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [x] Fix `renderNode` in `packages/shared/src/condition-dsl/engine.ts` so `toDsl` preserves grouping when combining logical operators (currently `foo && (bar || baz)` round-trips to `foo && bar || baz`).
- [x] Enforce catalog type compatibility in `parseDsl` (reject comparing number fields to string literals, etc.) and add explicit tests.
- [x] Relax or default the `group` field in `src/views/ConditionPlaygroundView.vue` so vue-tsc no longer flags `string | undefined` assignments.

### Security Review

No new concerns; validation hardening reduces incorrect policy execution risk.

### Performance Considerations

No regressions; added checks are O(n) alongside existing traversal.

### Files Modified During Review

- docs/qa/gates/9.2-dsl-parser-foundation.yml

### Test Coverage & Validation

- `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts server/utils/__tests__/condition-dsl-helper.spec.ts src/lib/__tests__/conditionPlaygroundCatalog.spec.ts` ✅
- `pnpm type-check` ❌ — still blocked by existing repo-wide issues (Flex SSE typing, discovery dashboard enums, etc.); DSL playground warnings resolved.

### Gate Status

Gate: PASS → docs/qa/gates/9.2-dsl-parser-foundation.yml

### Recommended Status

[✓ Ready for Done]
