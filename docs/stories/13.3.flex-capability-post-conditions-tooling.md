# Story 13.3: Capability Post-Condition Tooling & Observability

## Status
Done

## Story
**As a** flex operator experience engineer,  
**I want** capability post-condition guards and evaluation results streamed by the runtime to be visible in the Flex Sandbox UI and observability stack,  
**so that** operators can triage failing capabilities, trigger runbook actions, and prove compliance without replaying executions.

**Dependencies:** Story 13.2 – Capability Post-Condition Runtime Enforcement (`docs/stories/13.2.flex-capability-post-conditions-runtime.md`)

## References
- `docs/prd/epic-flex-capability-post-conditions.md#stories`
- `docs/stories/13.2.flex-capability-post-conditions-runtime.md`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#101-flex-run-debugging`
- `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#2-spa`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#6-documentation-assets`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy`
- `docs/architecture/flex-agents-server/13-verification.md#13-verification`

## Acceptance Criteria
1. **Plan inspector visualizes node-level guard status.** `FlexSandboxPlanInspector` (and related Pinia stores) renders each plan node’s `postConditionGuards` plus streaming `postConditionResults`, showing pass/pending/fail chips, facet/path metadata, and tooltips sourced from the SSE `plan_generated`, `plan_updated`, `node_complete`, `goal_condition_failed`, and `complete` frames without mutating the event contract. (AC Source: `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`)
2. **Run-level views highlight guard health for sandbox operators.** Flex Sandbox views gated by `USE_FLEX_DEV_SANDBOX` surface aggregated guard summaries (counts per status, latest failing facet, retry budget) beside the existing run timeline and mirror the same state inside resume/HITL flows, degrading gracefully when no post conditions exist. (AC Source: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`, `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`, `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`)
3. **Telemetry captures capability-condition failures.** `TelemetryService` emits structured logs plus counters `flex.capability_condition_failed` and `flex.capability_condition_error`, tagging each entry with `runId`, `nodeId`, `capabilityId`, `{ facet, path }`, retry metadata, and DSL canonicalization so Grafana dashboards and alerts can track failure/error rates without reprocessing raw SSE streams. (AC Source: `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
4. **Debug endpoints expose condition summaries.** `GET /api/v1/flex/runs/:id` and the associated support logs include the persisted `postConditionResults` arrays and guard summaries pulled from `flex_plan_nodes`, `flex_plan_snapshots`, and `flex_run_outputs`, enabling operators to export failure evidence without replaying nodes. (AC Source: `docs/architecture/flex-agents-server/10-api-surface-initial.md#101-flex-run-debugging`, `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`)
5. **Documentation, rollout guidance, and regression tests cover the feature.** Architecture shards (UI integration, API surface, telemetry/runbook) describe the new UI indicators, counters, and operator workflows, rollout notes call out feature-flag steps, and Vitest suites cover UI parsing plus telemetry/log serialization in line with repo testing standards. (AC Source: `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`, `docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy`, `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server/13-verification.md#13-verification`)

## Tasks / Subtasks
- [x] Extend the Flex event store/Pinia modules to persist `postConditionGuards` and `postConditionResults` from SSE `plan_generated/plan_updated/node_complete/goal_condition_failed/complete` frames, normalizing Condition DSL metadata for downstream consumers. (AC1, AC2) (`docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
- [x] Update `FlexSandboxPlanInspector.vue`, summary chips, and related Vuetify components to display guard state, retry hints, and failure tooltips while respecting the SPA composition/Vuetify guidance. (AC1) (`docs/architecture/tech-stack.md#1-core-runtime-components`, `docs/architecture/source-tree.md#2-spa`)
- [x] Enhance sandbox run-level views (timeline, HITL modal, resume banners) to show aggregated guard counts and latest failing predicates when the sandbox flag is enabled; hide indicators when the feature is disabled. (AC2) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`, `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`)
- [x] Instrument `TelemetryService` and structured logging so capability-condition failures raise the new counters/fields, and document the metrics/alerts alignment in the telemetry shard. (AC3) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
- [x] Expand `GET /api/v1/flex/runs/:id` plus associated debug logging to return the persisted guard results alongside plan snapshots, referencing the shared data-model contract. (AC4) (`docs/architecture/flex-agents-server/10-api-surface-initial.md#101-flex-run-debugging`, `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`)
- [x] Update architecture shards (UI, API surface, telemetry, rollout) and add Vitest coverage for the SSE parsers, UI renderers, and telemetry serialization following repo testing standards. (AC5) (`docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`, `docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy`, `docs/architecture/coding-standards.md#7-testing-expectations`)

## Story Context
- Story 3 of Epic FLEX-CAP-PC-1 delivers the UI/observability slice after metadata (Story 13.1) and runtime enforcement (Story 13.2), ensuring the end-to-end capability guard signal is actionable for operators. (`docs/prd/epic-flex-capability-post-conditions.md#stories`)
- Story 13.2 already streams/persists `postConditionResults` for every node, so this story focuses on consuming that data in client/telemetry layers without redefining runtime behaviours. (`docs/stories/13.2.flex-capability-post-conditions-runtime.md`)
- Flex Sandbox remains gated behind the documented feature flags, so the new indicators must follow the existing developer sandbox lifecycle and reuse its metadata APIs. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`)

## Dev Notes
- **Previous Story Insights:** Runtime enforcement (Story 13.2) now injects `postConditionGuards` into CRCS rows and streams evaluated `postConditionResults` before nodes complete, so UI/telemetry work can treat those arrays as authoritative. [Source: docs/stories/13.2.flex-capability-post-conditions-runtime.md]
- **Data Models:** Guard metadata and evaluations are persisted on `flex_plan_nodes`, `flex_plan_snapshots`, and `flex_run_outputs`, which the debug endpoint should reuse instead of recomputing. [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]
- **API Specifications:** `/api/v1/flex/run.stream` SSE frames already enumerate planner, node, policy, HITL, and completion events; extend client parsing without changing the canonical envelope and document any new descriptive fields. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
- **Component Specifications:** The sandbox popup, `FlexSandboxPlanInspector`, and approval modal consume SSE data while honoring existing validation banners, so guard indicators must integrate with those surfaces and respect flag gating. [Source: docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration] [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox]
- **Telemetry Responsibilities:** `TelemetryService` already streams structured planner/policy/node events and metrics; reuse that service for guard counters/logs instead of building ad-hoc emitters. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity]
- **Plan Graph Context:** Guard annotations belong to the nodes produced by `PlanGraph`, so UI bindings should key status displays off `nodeId`/`capabilityId` to stay aligned with planner output. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph]
- **Condition DSL Handling:** Displayed metadata must use the canonical DSL/json-logic payload compiled by the shared helper to avoid drifting from runtime validation semantics. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
- **File Locations:** SPA updates live under `src/components`, `src/views`, and related Pinia stores; telemetry/logging changes belong in `packages/flex-agents-server/src/services/**`; documentation edits stay under `docs/architecture/**`. [Source: docs/architecture/source-tree.md#2-spa] [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/source-tree.md#6-documentation-assets]
- **Testing Requirements:** Follow the repo mandate to cover new UI parsing helpers and telemetry serialization with Vitest, keep lint/type-check green, and reference the verification shard for existing suite locations. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/flex-agents-server/13-verification.md#13-verification]
- **Technical Constraints & Rollout:** Implement everything in TypeScript/Vue per the tech stack, and update migration/runbook notes so operators know how to read the new indicators during phased rollout. [Source: docs/architecture/tech-stack.md#1-core-runtime-components] [Source: docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy]

## Testing
- `npm run test:unit -- src/components/FlexSandboxPlanInspector.spec.ts src/views/__tests__/FlexSandboxView.spec.ts packages/flex-agents-server/__tests__/telemetry/post-conditions.spec.ts` – UI parsing/rendering plus telemetry serialization coverage. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server/13-verification.md#13-verification`)
- `npm run lint` – enforce Vue/TypeScript lint gates before handoff. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run type-check` – verify strict typings for SPA and agents-server surfaces. (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Project Structure Notes
- UI and Pinia updates belong under `src/components`, `src/views`, and `src/stores`, matching the documented SPA layout. (`docs/architecture/source-tree.md#2-spa`)
- Telemetry/logging enhancements live in `packages/flex-agents-server/src/services/**`, with supporting shared typings in `packages/shared` if needed. (`docs/architecture/source-tree.md#4-agents-server`)
- Documentation/runbook edits should remain in `docs/architecture/flex-agents-server/**` so future stories inherit a single source of truth. (`docs/architecture/source-tree.md#6-documentation-assets`)

## Dev Agent Record

### Agent Model Used
- GPT-5 (Codex CLI)

### Debug Log References
- `npm run test:unit -- src/components/FlexSandboxPlanInspector.spec.ts src/views/__tests__/FlexSandboxView.spec.ts packages/flex-agents-server/__tests__/telemetry/post-conditions.spec.ts`

### Completion Notes
- Added post-condition guard persistence/normalization on sandbox plan streams with guard summaries and latest failure surfacing.
- Rendered guard chips and run-level guard health summary in Flex Sandbox UI with feature-flag gating.
- Emitted telemetry counters/logs for capability guard failures/errors and exposed guard snapshots via flex run debug API responses.

## File List
- src/lib/flexSandboxTypes.ts
- src/lib/flexSandboxPlan.ts
- src/lib/postConditionUtils.ts
- src/components/FlexSandboxPlanInspector.vue
- src/components/__tests__/FlexSandboxPlanInspector.spec.ts
- src/views/FlexSandboxView.vue
- packages/flex-agents-server/src/services/telemetry-service.ts
- packages/flex-agents-server/src/services/orchestrator-persistence.ts
- packages/flex-agents-server/routes/api/v1/flex/runs/[id].get.ts
- packages/flex-agents-server/__tests__/telemetry/post-conditions.spec.ts
- packages/flex-agents-server/__tests__/flex-run-routes.spec.ts
- docs/architecture/flex-agents-server/10-api-surface-initial.md
- docs/architecture/flex-agents-server/12-ui-client-integration.md
- docs/architecture/flex-agents-server/13-migration-rollout-strategy.md

## Change Log
| Date       | Version | Description                                                                                                  | Author        |
|------------|---------|--------------------------------------------------------------------------------------------------------------|---------------|
| 2025-11-15 | 0.2     | Surfaced post-condition guard UI, telemetry counters, debug API snapshots, and regression tests.             | Dev Agent     |
| 2025-11-14 | 0.1     | Initial draft outlining Flex Sandbox UI updates, telemetry/logging, debug endpoints, and rollout guidance. | Scrum Master |

## QA Results

### Review Date: 2025-11-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Sandbox plan updates now merge the runtime `post_condition_results` payload emitted on completion frames so guard chips and summaries reflect the authoritative post-condition evaluations (AC1).
- Guard Health highlights remaining retry budget by tracking the post-condition policy `attempt` / `maxRetries` metadata, keeping operators informed across HITL/resume flows (AC2).
- TelemetryService parses both camelCase and snake_case guard payloads and annotates the `flex.capability_condition_*` counters/logs with attempt/maxRetries labels, satisfying observability requirements (AC3).

### Refactoring Performed
- Added guard retry tracking helpers in the SPA and consolidated aggregated-result merging for plan nodes.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (`npm run test:unit -- src/views/__tests__/FlexSandboxView.spec.ts packages/flex-agents-server/__tests__/telemetry/post-conditions.spec.ts`)
- All ACs Met: ✓

### Improvements Checklist
- [x] Parse completion-frame guard results into the sandbox plan store so chips/summaries reflect runtime truth.
- [x] Surface retry attempt/budget metadata inside Guard Health for sandbox operators.
- [x] Extend telemetry parsing/tests for aggregated guard payloads plus attempt labels.

### Security Review
- No new security concerns introduced by the guard/telemetry bookkeeping.

### Performance Considerations
- Guard bookkeeping is constant-time; no regressions observed.

### Files Modified During Review
- docs/stories/13.3.flex-capability-post-conditions-tooling.md
- docs/qa/gates/13.3-flex-capability-post-conditions-tooling.yml

### Gate Status
Gate: PASS → docs/qa/gates/13.3-flex-capability-post-conditions-tooling.yml  
Risk profile: not generated  
NFR assessment: not generated

### Recommended Status
✓ Ready for Done
