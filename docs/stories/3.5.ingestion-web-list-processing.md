# Story 3.5: Web List Processing Runtime - Brownfield Addition

## Status
Draft

## Story
**As the** ingestion operator,
**I want** the web ingestion job to apply list-page extraction rules when configured,
**so that** each article from a configured list source becomes its own discovery item automatically.

## Story Context
**Existing System Integration**
- Integrates with: discovery ingestion job (`server/jobs/discovery/ingest-sources.ts`), shared list extraction helpers in `packages/shared/src/discovery/ingestion.ts`, and configuration schema extensions in `packages/shared/src/discovery-config.ts`.
- Technology: Node.js job executed by Nitro background workers using `got` and `cheerio` for HTTP/DOM processing.
- Follows pattern: pluggable ingestion adapters that emit normalized payloads to the discovery queue.
- Touch points: web fetcher, item extraction loop, telemetry, backoff handling, and queue emission patterns established in Story 3.3.

## Acceptance Criteria
**Functional Requirements**
1. When a source configuration includes a `webList` block, the ingestion job uses `list_container_selector` and `item_selector` to iterate article candidates instead of relying on page-level title/description.
2. Each extracted item leverages the configured `fields` mapping (e.g., `title`, `excerpt`, `url`, `timestamp`) to populate discovery items, defaulting to existing heuristics when a field mapping is absent.
3. Pagination is supported by following the optional `pagination.next_page` selector/attribute until exhausted or a safety limit is reached (configurable default of 5 pages).

**Integration Requirements**
4. Sources without `webList` continue to use existing single-item extraction without behavioural change.
5. Telemetry and SSE events include counts of processed list items and pagination depth for traceability while maintaining backward-compatible payload schemas.
6. Retry, error handling, and health reporting paths from Story 3.3 apply to list extraction (e.g., transient fetch failure retries per page, permanent failure reporting).

**Quality Requirements**
7. Unit tests cover list extraction, field mapping fallbacks, pagination termination, and regression of the default single-item path.
8. Integration tests (or fixtures) simulate a multi-page list source to verify item emission and telemetry reporting.
9. Runbook documentation updated to describe enabling and troubleshooting list extraction, including pagination safeguards.

## Tasks / Subtasks
- [ ] Update the web ingestion adapter to branch on `webList` configuration, iterating list items and mapping configured fields (AC 1, AC 2).
- [ ] Implement pagination support honoring `pagination.next_page` selector/attribute with cycle and depth guards (AC 3, AC 6).
- [ ] Extend telemetry emitters to record list item counts, pagination depth, and configuration usage while keeping schema compatibility (AC 5, AC 6).
- [ ] Add unit and integration tests covering list extraction and pagination scenarios (AC 7, AC 8).
- [ ] Refresh runbook/documentation with list extraction operational guidance, cross-linking updates in `docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md#31-source-entry-procedure` (AC 9).

## Dev Notes
- **List extraction flow:** `ingest-sources.ts` branches when a source includes `webList`, invoking helper routines in `packages/shared/src/discovery/ingestion.ts` that accept `list_container_selector`, `item_selector`, and field mappings (`title`, `excerpt`, `url`, `timestamp`). Missing field selectors must fall back to legacy heuristics so sources without overrides keep working (AC 1, AC 4). Architecture reference: `docs/architecture/discovery-agent-backend.md#ingestion-pipeline`.
- **Pagination safeguards:** Architecture mandates honoring the optional `webList.pagination.next_page` selector while enforcing the shared safety ceiling of 5 pages and deduplicating URLs per page to avoid loops. Reuse the retry/backoff wiring from Story 3.3 for each paged request (AC 3, AC 6). See `docs/architecture/discovery-agent-backend.md#ingestion-pipeline`.
- **Telemetry & metrics:** Emit item counts, pagination depth, and selector usage into the existing telemetry pipeline fed by `discovery_ingest_runs.metrics_json`. SSE events follow the `signalAgentEvent` pattern to keep dashboards consistent (AC 5). Refer to `docs/architecture/discovery-agent-backend.md#observability--logging`.
- **Schema & config expectations:** `packages/shared/src/discovery-config.ts` stores the optional `webList` block inside `discovery_sources.config_json`. Validation must enforce selector presence when the block exists and default to current heuristics otherwise, keeping single-item ingestion untouched (AC 2, AC 4). Details in `docs/architecture/discovery-agent-backend.md#configuration-schema--storage`.
- **Operator documentation:** Update the pilot onboarding runbook with selector troubleshooting steps, pagination limits, and telemetry interpretations so operators can validate configuration changes quickly (AC 9). Use `docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md#31-source-entry-procedure`.
- **Shared utilities:** Prefer the existing selector helper utilities under `packages/shared/src/discovery/ingestion.ts` when introducing additional parsing helpers; document any new helper paths in this storyâ€™s File List after implementation to keep the source tree discoverable.

## Testing
- Unit: add Vitest coverage under `packages/shared/__tests__/discovery` to exercise list extraction, field fallback, pagination termination, and default single-item regression cases.
- Integration: extend the discovery ingestion fixture suite (see `tests/api/discovery/*.spec.ts`) with a multi-page list source to assert telemetry counters and queue emission; align with telemetry requirements in `docs/architecture/discovery-agent-backend.md#testing-strategy`.
- Tooling: follow the shared Drizzle in-memory harness for data assertions and reuse the existing ingestion regression script before flagging ready for QA (`scripts/discovery-seed.mjs`).

## Definition of Done
- [ ] Functional requirements met.
- [ ] Integration requirements validated through tests and local runs.
- [ ] Default web ingestion regression suite passes.
- [ ] Telemetry dashboards reflect new list metrics without breaking existing panels.
- [ ] Documentation/runbook sections updated and linked.
- [ ] Tests (unit + integration) and lint/type checks pass locally.

## Risk and Compatibility
**Minimal Risk Assessment**
- **Primary Risk:** Misconfigured selectors could lead to missed or duplicated items, or pagination loops.
- **Mitigation:** Enforce max pagination depth, log selector mismatches with actionable guidance, and document validation steps.
- **Rollback:** Disable the `webList` block in affected source configurations to revert to default behaviour; code path automatically falls back.

**Compatibility Verification**
- [ ] No breaking changes to external APIs or contracts.
- [ ] No database schema changes required; discovery items reuse existing tables.
- [ ] Scheduler integration unaffected; same job queue and cadence.
- [ ] Performance impact negligible; pagination depth guard prevents runaway fetches.

## Validation Checklist
**Scope Validation**
- [ ] Story limited to adapting ingestion runtime logic; no new services introduced.
- [ ] Utilizes existing parsing utilities and retry mechanisms.
- [ ] Workload scoped for a single development session.
- [ ] No architectural design work beyond configuration handling.

**Clarity Check**
- [ ] Behaviour differences documented for configured vs. default sources.
- [ ] Pagination and selector safeguards articulated.
- [ ] Telemetry expectations described for monitoring teams.
- [ ] Rollback path clearly stated.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Drafted brownfield story ensuring ingestion runtime honors web list configuration. | John |
| 2025-10-07 | 0.2 | Added template-required sections, corrected integration references, and captured architecture-driven guidance for list extraction. | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
