# Story 3.5: Web List Processing Runtime - Brownfield Addition

## Status
Approved

## Story
**As the** ingestion operator,
**I want** the web ingestion job to apply list-page extraction rules when configured,
**so that** each article from a configured list source becomes its own discovery item automatically.

## Story Context
**Existing System Integration**
- Integrates with: discovery ingestion job (`server/jobs/discovery/ingest-sources.ts`), shared list extraction helpers in `packages/shared/src/discovery/ingestion.ts`, and configuration schema extensions in `packages/shared/src/discovery-config.ts`.
- Technology: Node.js job executed by Nitro background workers using `got` and `cheerio` for HTTP/DOM processing.
- Follows pattern: pluggable ingestion adapters that emit normalized payloads to the discovery queue.
- Touch points: web fetcher, item extraction loop, telemetry, backoff handling, and queue emission patterns established in Story 3.3.

## Acceptance Criteria
**Functional Requirements**
1. When a source configuration includes a `webList` block, the ingestion job uses `list_container_selector` and `item_selector` to iterate article candidates instead of relying on page-level title/description.
2. Each extracted item leverages the configured `fields` mapping (e.g., `title`, `excerpt`, `url`, `timestamp`) to populate discovery items, defaulting to existing heuristics when a field mapping is absent.

**Integration Requirements**
4. Sources without `webList` continue to use existing single-item extraction without behavioural change.
5. Telemetry and SSE events include counts of processed list items for traceability while maintaining backward-compatible payload schemas.
6. Retry, error handling, and health reporting paths from Story 3.3 apply to list extraction (e.g., transient fetch failure retries per request, permanent failure reporting).

**Quality Requirements**
7. Unit tests cover list extraction, field mapping fallbacks, and regression of the default single-item path.
8. Integration tests (or fixtures) simulate a list source to verify item emission and telemetry reporting.
9. Runbook documentation updated to describe enabling and troubleshooting list extraction, including the current pagination limitation.

## Tasks / Subtasks
- [x] Update the web ingestion adapter to branch on `webList` configuration, iterating list items and mapping configured fields (AC 1, AC 2).
- [x] Extend telemetry emitters to record list item counts and configuration usage while keeping schema compatibility (AC 5, AC 6).
- [x] Add unit and integration tests covering list extraction scenarios (AC 7, AC 8).
- [x] Refresh runbook/documentation with list extraction operational guidance, noting pagination is currently disabled at runtime and cross-linking updates in `docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md#31-source-entry-procedure` (AC 9).

## Dev Notes
- **List extraction flow:** `ingest-sources.ts` branches when a source includes `webList`, invoking helper routines in `packages/shared/src/discovery/ingestion.ts` that accept `list_container_selector`, `item_selector`, and field mappings (`title`, `excerpt`, `url`, `timestamp`). Missing field selectors must fall back to legacy heuristics so sources without overrides keep working (AC 1, AC 4). Architecture reference: `docs/architecture/discovery-agent-backend.md#ingestion-pipeline`.
- **Pagination scope:** The runtime currently processes only the first page even when `pagination.next_page` selectors are configured. Preserve the configuration field for future enhancement but ensure operators understand pagination is deferred. Reuse the retry/backoff wiring from Story 3.3 for each request (AC 6). See `docs/architecture/discovery-agent-backend.md#ingestion-pipeline`.
- **Telemetry & metrics:** Emit item counts and selector usage into the existing telemetry pipeline fed by `discovery_ingest_runs.metrics_json`. SSE events follow the `signalAgentEvent` pattern to keep dashboards consistent (AC 5). Refer to `docs/architecture/discovery-agent-backend.md#observability--logging`.
- **Schema & config expectations:** `packages/shared/src/discovery-config.ts` stores the optional `webList` block inside `discovery_sources.config_json`. Validation must enforce selector presence when the block exists and default to current heuristics otherwise, keeping single-item ingestion untouched (AC 2, AC 4). Details in `docs/architecture/discovery-agent-backend.md#configuration-schema--storage`.
- **Operator documentation:** Update the pilot onboarding runbook with selector troubleshooting steps, the current pagination limitation, and telemetry interpretations so operators can validate configuration changes quickly (AC 9). Use `docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md#31-source-entry-procedure`.
- **Shared utilities:** Prefer the existing selector helper utilities under `packages/shared/src/discovery/ingestion.ts` when introducing additional parsing helpers; document any new helper paths in this storyâ€™s File List after implementation to keep the source tree discoverable.

## Testing
- Unit: add Vitest coverage under `packages/shared/__tests__/discovery` to exercise list extraction, field fallback, and default single-item regression cases.
- Integration: extend the discovery ingestion fixture suite (see `tests/api/discovery/*.spec.ts`) with a list source to assert telemetry counters and queue emission; align with telemetry requirements in `docs/architecture/discovery-agent-backend.md#testing-strategy`.
- Tooling: follow the shared Drizzle in-memory harness for data assertions and reuse the existing ingestion regression script before flagging ready for QA (`scripts/discovery-seed.mjs`).

## Definition of Done
- [x] Functional requirements met.
- [x] Integration requirements validated through tests and local runs.
- [x] Default web ingestion regression suite passes.
- [x] Telemetry dashboards reflect new list metrics without breaking existing panels.
- [x] Documentation/runbook sections updated and linked.
- [x] Tests (unit + integration) and lint/type checks pass locally.

## Risk and Compatibility
**Minimal Risk Assessment**
- **Primary Risk:** Misconfigured selectors could lead to missed or duplicated items, and the absence of pagination means older entries beyond the first page are skipped until the enhancement returns.
- **Mitigation:** Log selector mismatches with actionable guidance, document validation steps, and communicate pagination limitations to operators.
- **Rollback:** Disable the `webList` block in affected source configurations to revert to default behaviour; code path automatically falls back.

**Compatibility Verification**
- [ ] No breaking changes to external APIs or contracts.
- [ ] No database schema changes required; discovery items reuse existing tables.
- [ ] Scheduler integration unaffected; same job queue and cadence.
- [ ] Performance impact negligible; list extraction runs reuse existing request safeguards.

## Validation Checklist
**Scope Validation**
- [ ] Story limited to adapting ingestion runtime logic; no new services introduced.
- [ ] Utilizes existing parsing utilities and retry mechanisms.
- [ ] Workload scoped for a single development session.
- [ ] No architectural design work beyond configuration handling.

**Clarity Check**
- [ ] Behaviour differences documented for configured vs. default sources.
- [ ] Pagination limitation and selector expectations articulated.
- [ ] Telemetry expectations described for monitoring teams.
- [ ] Rollback path clearly stated.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Drafted brownfield story ensuring ingestion runtime honors web list configuration. | John |
| 2025-10-07 | 0.2 | Added template-required sections, corrected integration references, and captured architecture-driven guidance for list extraction. | Bob |
| 2025-10-08 | 0.3 | De-scoped pagination runtime handling and aligned tasks, testing, and risk notes. | Bob |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex

### Debug Log References
- Tests: `npm run test:unit`

### Completion Notes List
- Added web list extraction flow in `fetchHttpSource`, including selector fallbacks, metadata, and absolute URL handling.
- Introduced unit and ingestion job integration tests covering list extraction, fallback behaviour, and telemetry counts.
- Documented list extraction operator steps in the pilot onboarding runbook and hoisted the `cheerio` dependency for shared utilities.

### File List
- packages/shared/src/discovery/adapters/http.ts
- packages/shared/src/discovery/__tests__/http-adapter.spec.ts
- server/jobs/__tests__/discovery-ingest-sources.spec.ts
- docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md
- packages/shared/package.json
- package-lock.json
- packages/shared/package-lock.json (removed)

## QA Results
