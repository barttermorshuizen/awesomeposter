# Story 8.35: Resume-Ready Planner State

## Status
Ready for Review

## Story
**As a** flex planner orchestration engineer,  
**I want** resume flows to preserve the validated plan graph, node statuses, and version semantics end-to-end,  
**so that** HITL restarts and replans remain deterministic for both the planner service and the sandbox UI.  

## Acceptance Criteria
1. Planner resume requests render the existing plan (nodes with statuses) inside the prompt context, instruct the model to leave completed nodes unchanged, only modify pending nodes, and increment the plan version on replans. (`packages/flex-agents-server/src/services/planner-service.ts`, `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/7-execution-flow.md`)
2. Planner draft schema/types require each node to include an explicit status (`pending | running | completed | awaiting_hitl | error` at minimum), and planner validation rejects malformed status values before emitting `plan_generated`. (`packages/flex-agents-server/src/services/flex-planner.ts`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/9-data-model-persistence.md`)
3. `/api/v1/flex/run.resume` emits an initial `plan_generated` frame containing the full plan snapshot (all nodes, statuses, version) without downgrading completed nodes, and parole ensures the persisted version increments whenever replanning occurs. (`packages/flex-agents-server/src/services/flex-run-coordinator.ts`, `docs/architecture/flex-agents-server/7-execution-flow.md`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
4. Persistence updates store status and version fields in `flex_plan_nodes` / `flex_plan_snapshots`, guaranteeing resume snapshots reload exact node states across runs. (`packages/flex-agents-server/src/services/orchestrator-persistence.ts`, `docs/architecture/flex-agents-server/8-hitl-and-rehydration-strategy.md`, `docs/architecture/flex-agents-server/9-data-model-persistence.md`)
5. `extractPlanPayload` rejects plan payloads missing required status/version fields, the sandbox surfaces a visible error banner instead of defaulting to `pending`, and operators see an actionable retry message. (`src/lib/flexSandboxPlan.ts`, `src/views/FlexSandboxView.vue`, `docs/architecture/discovery_agent_frontend/developer-standards.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`)
6. Automated tests cover resume snapshots (planner + persistence + SSE) and sandbox parsing behaviour; manual QA confirms the scenario of resuming after completing nodes preserves statuses in the inspector. (`packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`, `src/lib/__tests__/flexSandboxPlan.spec.ts`, `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery_agent_frontend/testing-requirements.md`, `docs/architecture/flex-agents-server/13-verification.md`)
7. Documentation and internal comms explain the resume contract (status requirements, version rules, error handling), and stakeholders consuming the sandbox/planner streams are notified of the stricter validation. (`docs/architecture/source-tree.md#6-documentation-assets`, `docs/architecture/flex-agents-server/8-hitl-and-rehydration-strategy.md`, `docs/architecture/flex-agents-server/12-ui-client-integration.md`)

## Tasks / Subtasks
- [x] Extend planner prompt serialization to embed the current plan JSON (node ids, statuses, version) and instructions for preserving completed work on resume. (AC 1) [Source: docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2] [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- [x] Update planner draft schema/types and validation logic to require node statuses and reject invalid values before emitting telemetry. (AC 2) [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry--metrics-parity] [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]
- [x] Adjust resume coordinator flow so the first `plan_generated` SSE payload returns the complete persisted plan snapshot without downgrading statuses, and bump versions on replans. (AC 3) [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract] [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- [x] Persist node status/version fields across `flex_plan_nodes` and `flex_plan_snapshots` updates to guarantee deterministic resume. (AC 4) [Source: docs/architecture/flex-agents-server/8-hitl-and-rehydration-strategy.md#8-hitl-and-rehydration-strategy] [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]
- [x] Harden sandbox plan parsing to fail fast on malformed status/version fields and surface user-facing errors with guidance. (AC 5) [Source: docs/architecture/discovery_agent_frontend/developer-standards.md#developer-standards] [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox]
- [x] Add regression coverage for backend resume snapshots and front-end parsing, plus document manual QA of the resume scenario. (AC 6) [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
- [x] Update developer documentation and notify dependent teams about the resume contract and validation changes. (AC 7) [Source: docs/architecture/source-tree.md#6-documentation-assets] [Source: docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration]

## Dev Notes

### Previous Story Insights
- Story 8.34 delivered the prompt blueprint alignment and telemetry wiring for planner prompts; reuse those prompt builders when embedding the persisted plan context. [Source: docs/stories/8.34.flex-planner-prompt-restructure.md]

### Data Models
- Resume flows rely on `flex_plan_snapshots` and `flex_plan_nodes` retaining node status, provenance, and pending IDs so rehydration reconstructs the validated graph. [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence]

### API Specifications
- `/api/v1/flex/run.resume` rebuilds the plan snapshot, validates the expected plan version, and emits lifecycle events (`plan_generated`, `plan_updated`) before resuming execution; responses must now include status fields for every node. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]

### Component Responsibilities
- `FlexRunCoordinator`, `PlannerService`, and `TelemetryService` collaborate to emit plan version telemetry, enforce resume semantics, and stream lifecycle events with node status metadata. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry--metrics-parity]
- Execution flow enforces deterministic resume by replaying persisted nodes before policies request replans. [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]

### Component Specifications
- Flex sandbox tooling renders planner telemetry through `FlexSandboxPlanInspector.vue`, consuming node statuses and provenance for visualization. [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox]
- The SPA streams flex events via the sandbox view, preserving HITL resume semantics alongside planner updates. [Source: docs/flex-agentic-architecture201025.md#flex-ui]

### File Locations
- Planner prompt logic and resume orchestration live in `packages/flex-agents-server/src/services`, while documentation updates belong under `docs/architecture/flex-agents-server/`. [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/source-tree.md#6-documentation-assets]
- Sandbox plan parsing and UI error handling reside in `src/lib/flexSandboxPlan.ts` and `src/views/FlexSandboxView.vue`. [Source: docs/architecture/source-tree.md#2-spa]

### Technical Constraints
- Implement changes in TypeScript across agents server and SPA layers, adhering to strict typing and shared schema usage per project standards. [Source: docs/architecture/coding-standards.md#1-language--module-conventions]
- Stay within the documented tech stack (Vue 3, Nitro, OpenAI SDK, Drizzle) when extending resume behaviour. [Source: docs/architecture/tech-stack.md#1-core-runtime-components]
- No additional resume-specific constraints beyond the core coding standards were documented; follow established patterns from prior planner stories. [Source: docs/architecture/coding-standards.md#1-language--module-conventions]

### Project Structure Notes
- Work stays inside existing agents server, shared schema, and SPA directories; no new packages or top-level folders are required. [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/source-tree.md#2-spa]

### Testing
- Add Vitest coverage for resume coordinator logic and sandbox parsing, following repository expectations for unit tests on agents and front-end layers. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_frontend/testing-requirements.md#testing-requirements]
- Leverage existing resume-focused suites (`flex-run-coordinator.spec.ts`) to validate snapshot integrity and policy interactions. [Source: docs/architecture/flex-agents-server/13-verification.md#13-verification]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| - | - | - | - |

## Dev Agent Record

### Agent Model Used
GPT-5 (Codex)

### Debug Log References
- `npm run test:unit -- src/lib/__tests__/flexSandboxPlan.spec.ts`
- `npm run test:unit -- packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts`
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-sandbox-run.spec.ts`
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-routes.spec.ts`

### Completion Notes List
- Embedded plan snapshot (version + node statuses) in planner prompts and enforced status-aware instructions.
- Propagated status/version through planner types, coordinator resume path, and persistence snapshots.
- Hardened sandbox plan parsing with error banner messaging and refreshed docs describing the stricter contract.

### File List
- docs/architecture/flex-agents-server/8-hitl-and-rehydration-strategy.md
- docs/architecture/flex-agents-server/12-ui-client-integration.md
- packages/flex-agents-server/src/planner/planner-types.ts
- packages/flex-agents-server/src/services/planner-service.ts
- packages/flex-agents-server/src/services/flex-planner.ts
- packages/flex-agents-server/src/services/flex-run-coordinator.ts
- packages/flex-agents-server/src/services/orchestrator-persistence.ts
- src/lib/flexSandboxPlan.ts
- src/lib/flexSandboxTypes.ts
- src/views/FlexSandboxView.vue
- packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts
- packages/flex-agents-server/__tests__/flex-sandbox-run.spec.ts
- packages/flex-agents-server/__tests__/flex-run-routes.spec.ts
- src/lib/__tests__/flexSandboxPlan.spec.ts

## QA Results
