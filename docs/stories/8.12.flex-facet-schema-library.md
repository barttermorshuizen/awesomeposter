# Story 8.12: Flex Facet Schema Library & Contract Compiler

## Status
Approved

## Story
**As a** flex platform architect,  
**I want** a shared facet schema library and contract compiler service,  
**so that** the planner and execution engine can assemble validated input/output schemas deterministically from facet metadata.

## Acceptance Criteria
1. Introduce a shared `FacetCatalog` module that loads all facet definitions (name, description, schema, semantics, metadata) from a single source and exposes typed lookup APIs. (`docs/architecture/flex-agents-server.md:60`)
2. Provide a `FacetContractCompiler` utility that merges facet schemas into executable `inputSchema` / `outputSchema` objects for nodes, preserving provenance for logging and telemetry. (`docs/architecture/flex-agents-server.md:150`)
3. Provide integration hooks (helper functions + sample harness) that `PlannerService` can adopt to consume the catalog/compiler when assembling nodes; include a fixture demonstrating compiled facet schemas stored on a mock node. (handoff for Story 8.8) (`docs/architecture/flex-agents-server.md:138`)
4. Ship reference validation helpers so `ExecutionEngine` / `OutputValidator` can consume compiled schemas, including error objects that carry facet provenance; verify via tests rather than modifying runtime services. (handoff for Stories 8.8/8.4) (`docs/architecture/flex-agents-server.md:159`)
5. Add automated tests covering facet lookup, schema merge edge cases (overlapping properties, conflicting enums), and planner/execution integration using sample facets (`toneOfVoice`, `writerBrief`, `copyVariants`). (`docs/architecture/flex-agents-server.md:460`)
6. Document the library in the architecture spec (facet section) with guidance on adding new facets and validating schema snippets. (`docs/architecture/flex-agents-server.md:460`)

## Tasks / Subtasks
- [ ] Scaffold `packages/shared/src/flex/facets` (or equivalent) with a typed catalog definition and export hooks (AC 1, AC 6).
  - [ ] Model facet metadata interfaces (`FacetDefinition`, `FacetDirection`, `FacetSemantics`) using existing JSON snippets (AC 1).
- [ ] Implement `FacetContractCompiler` with merge, provenance tracking, and Ajv/Zod compilation helpers (AC 2, AC 5).
  - [ ] Handle conflicts (type mismatch, enum overlaps) with descriptive error objects consumed by planner (AC 2, AC 5).
- [ ] Create planner integration helpers (e.g., `buildFacetAwareNodeContracts`) plus a fixture demonstrating compiled schemas/provenance attached to a mock plan node (AC 3).
- [ ] Provide validation helper functions and error structures for execution/validation callers, confirming facet provenance is preserved in failures (AC 4).
- [ ] Write unit/integration tests for catalog lookups, compiler merge cases, and helper usage with sample facets (`toneOfVoice`, `writerBrief`, `copyVariants`) (AC 5).
- [ ] Refresh `docs/architecture/flex-agents-server.md` facet section with catalog usage instructions and schema validation guidance (AC 6).

## Dev Notes
- **Architecture references:** `docs/architecture/flex-agents-server.md` sections 5.6 (Facet Definition), 5.7 (Facet-Based Plan Assembly), 5.8 (Hybrid Collaboration), and the facet catalog/table (section 11) describe required metadata and runtime behavior.
- **Shared types:** Current flex types live in `packages/shared/src/flex/types.ts`; the facet catalog should live alongside or extend that module.
- **Planner integration points:** Provide helper(s) and fixture here; Story 8.8 will wire them into `packages/flex-agents-server/src/services/flex-planner.ts`.
- **Execution touch points:** Supply validation helper mocks now; runtime adoption occurs in 8.8/8.4 when execution/persistence stories integrate compiled schemas.
- **Configuration:** Ensure catalog initialization occurs during server startup (Nitro plugin or shared singleton) so both planner and execution layers reference the same instance.
- **Telemetry:** When merging schemas, attach provenance data so `TelemetryService` events and debug logs surface facets contributing to each contract (align with sequence diagram expectations).

### Testing
- Use Vitest (existing project standard) for unit tests under `packages/shared/__tests__/flex/` and `packages/flex-agents-server/__tests__/`.
- Add contract compiler tests (e.g., `packages/shared/__tests__/flex/facet-contract-compiler.spec.ts`) covering merge success/failure cases.
- Extend helper-level tests (`packages/flex-agents-server/__tests__/facet-compiler-helpers.spec.ts` or similar) to assert compiled schema usage and provenance logging; Story 8.8 will add full planner/execution integration tests.
- Run `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/flex-planner.spec.ts packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-10 | 0.1 | Initial draft aligning facet catalog and contract compiler with updated architecture spec. | Scrum Master |
