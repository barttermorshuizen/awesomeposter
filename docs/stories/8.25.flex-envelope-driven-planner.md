# Story 8.25: Flex Planner Envelope-Driven Context

## Status
Draft

## Story
**As a** flex orchestrator maintainer,  
**I want** the planner to derive all contextual cues from TaskEnvelope data instead of hard-coded scenario definitions,  
**so that** plan generation stays domain-agnostic and the codebase remains free of embedded marketing knowledge.

**Dependencies:** Story 8.9 (TaskPolicies schema foundation) must be complete; coordinate with Story 8.23 (action execution) for shared metadata when planner annotations reference runtime behavior. Keep Story 8.24 aligned so conditional action nodes reuse the canonical action definitions.

## Acceptance Criteria
1. `FlexPlanner` no longer declares or reads `SCENARIO_DEFINITIONS`; planner inputs flow exclusively from the TaskEnvelope and normalized `TaskPolicies.planner` data, keeping the runtime aligned with the “no hard-coded workflows” goal. (`docs/architecture/flex-agents-server.md#1-scope--goals`, `docs/architecture/flex-agents-server.md#3-key-architectural-decisions`, `docs/architecture/flex-agents-server.md#51-taskenvelope`, `docs/architecture/flex-agents-server.md#5.3-taskpolicies`)
2. `PlannerService` composes prompts using structured envelope-derived hints (objective, channel/platform, policies, variant expectations, optional planning hints) sourced from the canonical planner policy, and the resulting drafts validate under existing PlannerValidation rules without scenario tags. (`docs/architecture/flex-agents-server.md#51-taskenvelope`, `docs/architecture/flex-agents-server.md#5.3-taskpolicies`, `docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration`)
3. Planner fallback paths, telemetry, and persistence continue to function after scenario removal; regression tests confirm plan generation, validation, and SSE frames succeed for representative envelopes (variants, language, policy constraints). (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#10-001-flex-run-streaming-contract`, `docs/architecture/coding-standards.md#7-testing-expectations`)
4. Architecture documentation and developer references are refreshed to note envelope-driven planning guidance, replacing any references to scenario enums. (`docs/architecture/flex-agents-server.md#1-scope--goals`, `docs/architecture/tech-stack.md#1-core-runtime-components`)

## Tasks / Subtasks
- [ ] Remove `SCENARIO_DEFINITIONS` and associated branching in `packages/flex-agents-server/src/services/flex-planner.ts`, ensuring planner inputs rely solely on TaskEnvelope data. (AC 1) (`docs/architecture/flex-agents-server.md#3-key-architectural-decisions`, `docs/architecture/source-tree.md#4-agents-server`)
- [ ] Enhance `PlannerService.composeUserPrompt` (and related typing) to surface envelope-driven hints—channel, format, policies, variant counts—without scenario IDs, updating Zod schemas as needed. (AC 2) (`docs/architecture/flex-agents-server.md#51-taskenvelope`, `docs/architecture/tech-stack.md#1-core-runtime-components`)
- [ ] Update planner fallback builder, persistence snapshots, and telemetry logging to remove scenario references while preserving metadata compatibility; adjust Vitest suites to cover multi-envelope regressions. (AC 3) (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Refresh architecture docs and internal developer notes to describe envelope-driven planning cues and guidance for providing domain best practices via documents instead of code constants. (AC 4) (`docs/architecture/flex-agents-server.md#1-scope--goals`)

## Story Context

**Existing System Integration:**
- Flex planner, planner service prompts, fallback planner, telemetry, and persistence all live in `packages/flex-agents-server` per the agents-server layout. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- Planner goals emphasize dynamic, runtime-driven decomposition instead of code-defined flows. `[Source: docs/architecture/flex-agents-server.md#1-scope--goals]`
- TaskEnvelope fields (objective, inputs, policies, output contract) are the canonical source of planning context, with planner directives encoded in `TaskPolicies.planner`. `[Source: docs/architecture/flex-agents-server.md#51-taskenvelope]`
- Planner/orchestrator collaboration must keep validation and execution deterministic even when planner cues change. `[Source: docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration]`

## Dev Notes
- **Previous Story Insights:** Story 8.24 remains in Draft; no Dev Agent Record updates are available.  
- **Data Models:** No additional data model updates required; planner continues to consume existing TaskEnvelope schemas alongside the canonical planner policy structure. `[Source: docs/architecture/flex-agents-server.md#51-taskenvelope]`
- **API Specifications:** No new HTTP surfaces; existing `/api/v1/flex/run.stream` behavior must remain unchanged. `[Source: docs/architecture/flex-agents-server.md#4-high-level-architecture]`
- **Component Specifications:** Planner modifications affect backend services only; no SPA component changes identified. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- **File Locations:** Core changes occur under `packages/flex-agents-server/src/services` (planner, planner-service, telemetry/persistence) with shared type adjustments under `packages/shared/src/flex`. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- **Testing Requirements:** Follow Vitest standards; cover planner prompt composition, fallback generation, and SSE framing regressions. `[Source: docs/architecture/coding-standards.md#7-testing-expectations]`
- **Technical Constraints:** Maintain TypeScript + Nitro patterns already defined for the agents server stack. `[Source: docs/architecture/tech-stack.md#1-core-runtime-components]`

## Project Structure Notes
- Align changes with the documented agents server layout to keep planner/service logic in `packages/flex-agents-server/src/services`. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- Ensure shared schema updates remain in `@awesomeposter/shared` under the flex namespace for downstream consumers. `[Source: docs/architecture/source-tree.md#5-shared-libraries]`
