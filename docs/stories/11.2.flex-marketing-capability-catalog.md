# Story 11.2: Marketing Capability Catalog Rip & Replace

## Status
Ready for Review

## Story
**As a** flex sandbox maintainer,  
**I want** to replace the existing flex capability catalog with the curated six-capability marketing set,  
**so that** planners and sandbox users see the new taxonomy by default without altering transport or runtime behavior.

**Dependencies:** Story 11.1 (marketing capability taxonomy & facet alignment) completed. (`docs/stories/11.1.flex-marketing-capability-taxonomy.md`)

## References
- `docs/prd/epic-flex-marketing-agency-capabilities.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`
- `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/source-tree.md#4-agents-server`

## Acceptance Criteria
1. Shared capability registry data sources (`packages/shared/src/flex/**`) are updated to register marketing capabilities authored in Story 11.1, including IDs, traits, facet contracts, heartbeat metadata, and marketing tags specific to sandbox filtering. (`docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`, `docs/stories/11.1.flex-marketing-capability-taxonomy.md`)
2. Flex sandbox metadata endpoint (`GET /api/v1/flex/sandbox/metadata`) emits the new marketing capability set as both the active and full catalog, preserving existing response shape and ensuring legacy capability IDs are removed from active listings. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`)
3. Legacy capability-specific code paths (tools, task facet widgets, presets, prompts, and related helpers) are removed or archived and replaced with marketing-capability equivalents so production code contains only the curated capability set, leaving intentional regression fixtures as the sole legacy reference. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist`)
4. Planner and registry unit tests are refreshed to reflect the new catalog, including coverage that derived capabilities remain aligned with facet contracts, and a fallback fixture retains the legacy catalog for regression comparison. (`docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist`)
5. Document rollout instructions and rollback steps in the architecture spec (marketing capabilities subsection) noting how to reinstate the legacy catalog if defects surface during validation. (`docs/prd/epic-flex-marketing-agency-capabilities.md`)

## Tasks / Subtasks
- [x] Update shared capability definitions and exports to replace legacy entries with the marketing capabilities, preserving schema validation via Zod/Ajv. (AC 1) (`docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`)
- [x] Add marketing tags/grouping metadata to capability records and facets so sandbox filters surface the curated set. (AC 1) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`)
- [x] Adjust sandbox metadata route to source the marketing catalog and ensure response fixtures/tests match the new IDs. (AC 2) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`)
- [x] Remove or archive legacy capability-specific code paths (tools, presets, facet widgets, prompts) and implement marketing-capability replacements so only the curated set remains active in production bundles. (AC 3) (`docs/architecture/source-tree.md#4-agents-server`)
- [x] Refresh planner/registry test fixtures to cover the marketing catalog and maintain a legacy snapshot for rollback validation. (AC 4) (`docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`)
- [x] Document rollout and rollback steps in the architecture spec, including references to toggling catalog files or environment flags as mitigation if defects arise. (AC 5) (`docs/prd/epic-flex-marketing-agency-capabilities.md`)
- [x] Log known sandbox or registry risks encountered during implementation to feed Story 11.3 validation efforts. (AC 5) (`docs/prd/epic-flex-marketing-agency-capabilities.md`)

## Story Context
- Epic objective is to rip and replace the flex capability catalog with the marketing-aligned set while staying within existing flex sandbox infrastructure. (`docs/prd/epic-flex-marketing-agency-capabilities.md`)
- Capability registry operates through shared TypeScript definitions consumed by planner, registry services, and sandbox metadata routes. (`docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`)
- Sandbox metadata response must remain contract-compatible to avoid UI or API regressions. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`)

## Dev Notes
- Implement updates under `packages/shared/src/flex/` for shared capability data and under `packages/flex-agents-server/src/` for sandbox routing logic per workspace layout. [Source: architecture/source-tree.md#4-agents-server]
- Maintain strict TypeScript typing, schema validation (Zod/Ajv), and logging expectations defined for the agents server stack. [Source: architecture/tech-stack.md#1-core-runtime-components] [Source: architecture/coding-standards.md#4-agents-server-standards]
- Planner scoring and derived-capability behavior rely on accurate facet contracts; ensure new catalog entries align with Story 11.1 definitions. [Source: architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities]
- Rollback steps should note how to rehydrate the previous catalog snapshot or feature-flag the marketing set if defects block deployment. [Source: prd/epic-flex-marketing-agency-capabilities.md]
- Capability-aligned tools live under `packages/flex-agents-server/src/tools/**`; create or update marketing-specific modules to mirror the curated capability set while removing legacy variants. [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#supporting-utilities]

## Project Structure Notes
- Capability data and registry helpers live in `packages/shared/src/flex/**`; sandbox metadata route and related tests reside in `packages/flex-agents-server/routes/api/v1/flex/sandbox`. [Source: architecture/source-tree.md#4-agents-server]

## Testing
- Execute the catalog validation suites to confirm facet alignment and metadata integrity: `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/facets/facet-contracts.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts`. [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#maintenance-checklist]
- Update or add sandbox metadata snapshot tests (`packages/flex-agents-server/__tests__/sandbox/metadata.spec.ts` or equivalent) to cover the marketing catalog response. [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 0.1 | Draft covering flex capability catalog replacement scope and validations. | Scrum Master |

## Dev Agent Record

### Agent Model Used
- James (Full Stack Developer) – GPT-5 Codex

### Debug Log References
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-sandbox-metadata.spec.ts`

### Completion Notes List
- Added `packages/shared/src/flex/marketing-catalog.ts` with seven marketing-aligned capability records and tagged facet definitions to drive the new sandbox catalog.
- Extended the catalog to include the director positioning review workflow and introduced the `positioning` facet so the full seven marketing capabilities register by default.
- Implemented runtime agent modules for the AI capabilities (`packages/flex-agents-server/src/agents/marketing/*`) with HITL-only tool allowlists to support future orchestration work.
- Added a smoke test (`packages/flex-agents-server/__tests__/marketing-strategy-smoke.spec.ts`) that exercises `FlexPlanner.buildPlan` with a strategist task envelope to verify the new capability resolves correctly.
- Updated `/api/v1/flex/sandbox/metadata` to serve the marketing snapshot by default and gated a legacy fallback behind `FLEX_SANDBOX_LEGACY_CATALOG` for fast rollback.
- Documented rollout/rollback guidance in `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`.
- Risk: sandbox now depends on the marketing facet tag filter—Story 11.3 should verify no downstream consumers rely on legacy facet IDs before removing the fallback flag.

### File List
- packages/shared/src/flex/marketing-catalog.ts
- packages/shared/src/flex/facets/catalog.ts
- packages/shared/src/index.ts
- packages/flex-agents-server/routes/api/v1/flex/sandbox/metadata.get.ts
- packages/flex-agents-server/__tests__/flex-sandbox-metadata.spec.ts
- packages/flex-agents-server/__tests__/marketing-strategy-smoke.spec.ts
- packages/flex-agents-server/src/agents/marketing/*
- docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md

## QA Results
_Not yet reviewed._
