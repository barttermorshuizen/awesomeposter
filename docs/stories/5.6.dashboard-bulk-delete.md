# Story 5.6: Bulk Delete & Removal Safeguards

## Status
Draft

## Executive Summary
- Introduces irreversible bulk deletion for discovery items so reviewers (with elevated permissions) can remove outdated or erroneous nuggets in batches.
- Extends the bulk action infrastructure delivered in Story 5.3 by adding delete affordances, backend soft-delete handling, audit/SSE propagation, and telemetry.
- Ensures deletion stays permission-gated, clearly communicated in UI copy, and observable through audit logs and dashboards.

## Story
**As a** lead reviewer with delete privileges,  
**I want** to permanently remove multiple discovery items in one action,  
**so that** we can keep the dashboard free of obsolete or incorrect nuggets without repetitive single-item work.

## Dependencies
- Story 5.0 `Discovery Dashboard Foundation` (feature flag, routing, SSE plumbing).
- Story 5.1 `Discovery Item Listing & Filtering` (list/selection scaffolding).
- Story 5.3 `Dashboard Bulk Promote/Archive` (selection tray, Pinia store, modal patterns).
- Story 5.4 `Bulk Discovery Item Audit Logging Contract` (audit schema and SSE expectations).

## Estimate
- Size: Medium (5 SP) — builds on existing bulk action infrastructure but introduces new dialog flow, permission gating, single endpoint with soft-delete migration, and focused telemetry/audit updates.

## Acceptance Criteria
1. Bulk selection tray surfaces a delete action only when user has `discovery:delete` permission; action respects the same 100-item cap as promote/archive.
2. Delete dialog uses Vuetify `v-dialog`, shows selected count, requires a reason code and optional note, and forces reviewers to acknowledge irreversible copy (“Are you sure? This action cannot be undone.”).
3. Backend exposes `POST /api/discovery/bulk/delete` accepting `{ actionId, clientId, itemIds[], reasonCode, note?, actorId, filtersSnapshot }`, returns per-item statuses (`success`, `conflict`, `failed`), and writes audit entries flagged as `deleted`.
4. Delete operation performs a soft delete: sets `status=deleted`, populates `deleted_at`, prunes items from subsequent list responses and SSE feeds, and prevents deleted items from being re-selected.
5. Telemetry increments `bulk.delete.count`, records batch size/duration, and emits failure/conflict metrics; SSE broadcasts `discovery.item.deleted` events so detail drawers refresh when open.
6. Conflict handling covers items already deleted or mutated elsewhere; conflicts remain in the selection tray with explanatory chips and do not block successful deletions.

## Tasks / Subtasks
- [ ] Extend `useBulkSelectionStore` and selection tray UI to show delete option based on permission and to preserve selection metadata for delete payloads (AC 1).
- [ ] Implement delete dialog component, confirmation checkbox, reason picker, and irreversible warning copy aligned with design guidelines (AC 2).
- [ ] Add `POST /api/discovery/bulk/delete` route + service with transactional soft delete (`status`, `deleted_at`), per-item result payloads, audit log emission, and telemetry instrumentation (AC 3-5).
- [ ] Update repositories, DTOs, and SSE publishers to drop deleted items from list queries and emit `discovery.item.deleted` frames (AC 4-5).
- [ ] Enhance frontend stores to remove deleted items from local caches, handle conflict statuses, and guard against re-selection (AC 4-6).
- [ ] Write unit/integration/API/E2E tests covering permission gating, dialog validation, delete endpoint contract, list refresh, telemetry/audit side effects, and conflict messaging (AC 1-6).

## Dev Notes
- Extend `discovery_items` schema with `status` enum value `deleted` and nullable `deleted_at`; apply migration and update Drizzle models.
- Reason codes live in shared constants (e.g., `duplicate`, `spam`, `outdated`); include in audit payload for downstream analytics.
- Service should reuse shared bulk action transaction helpers from Story 5.3; ensure metadata stored with `actionId` for potential reconciliation.
- Frontend should show a brief success toast summarising deleted count and remind users deletion is permanent.
- Audit entries must include irreversible indicator, reason, actor, and affected IDs; follow Story 5.4 output format.
- Telemetry client gains `incrementBulkDelete` helper; coordinate metric naming with analytics (“discovery.bulk.delete.count”, “discovery.bulk.delete.conflict”).

## Assumptions & Edge Cases
- Feature flag `discovery.filters.v1` and `discovery:delete` permission must be active; otherwise delete controls stay hidden.
- Deleted items should disappear from current selection tray immediately after success; conflicts remain highlighted until reviewer deselects or retries.
- Undo is intentionally out of scope; deletion is permanent after confirmation.
- Attempts to delete promoted items should either be blocked up-front with clear messaging or require confirmation that downstream briefs will persist (confirm final policy with product before implementation).
- Deleting items currently open in detail drawers should close the drawer or show “Item deleted” state to avoid stale interaction.
- SSE disconnect fallback: show banner that deletion completed but list will refresh when connection resumes; provide manual refresh control.

## References
- Epic scope and risk notes: `docs/prd/epic-discovery-brief-dashboard.md#scope-in`.
- Architecture data model baseline: `docs/architecture/discovery-agent-backend.md#data-model-additions`.
- Frontend component patterns: `docs/architecture/discovery-agent-frontend.md#component-architecture`.
- Bulk testing guidance: `docs/architecture/discovery_agent_frontend/testing-requirements.md`.
- Audit logging contract: `docs/stories/5.4.dashboard-audit-log-contract.md`.

## Testing
- Unit: selection store permission gating, delete dialog validation, bulk action service request builder, telemetry emitter for delete.
- Integration/API: supertest coverage of `bulk/delete` endpoint verifying transaction, soft delete, conflict payloads, audit/telemetry hooks, and permission enforcement.
- Frontend integration: Vue Test Utils scenarios for delete dialog flow, reason validation, list removal, conflict chip display, SSE removal handling.
- Playwright E2E: select items with delete permission, execute bulk delete, verify toast + list removal; simulate conflict via fixture; confirm delete action hidden without permission; attempt >100 selection to validate cap.
- Concurrency: API/spec test ensuring overlapping delete + promote actions produce correct per-item statuses without interfering transactions.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-31 | 0.1 | Initial draft introducing bulk delete scope, endpoints, and safeguards. | SM |
