# Story 4.5: Ingestion Scoring Utility Hook

## Status
Ready for Review

## Story
**As the** discovery ingestion scheduler,
**I want** to invoke the shared relevance scoring utility right after persisting new items,
**so that** ingestion delivers fresh scores without relying on a separate scoring agent.

## Acceptance Criteria
1. `server/jobs/discovery/ingest-sources.ts` collects the IDs returned from `saveDiscoveryItems` and, when scoring is enabled, calls `scoreDiscoveryItems(ids)` from `server/utils/discovery/scoring.ts` to compute relevance scores for the fresh batch.
2. The ingestion job gates each call through `isFeatureEnabled(clientId, "discovery-agent")`, gracefully skipping scoring when the flag is disabled or the helper reports an error, and records a consistent skip log/telemetry entry.
3. Successful scoring persists each result into `discovery_scores` (per migrations `20250403_create_discovery_scores.sql` and `20250404_discovery_scores_constraints.sql`) using the existing repository helpers, emits the usual `discovery.score.complete`/`discovery.queue.updated` AgentEvents, and logs/telemeters a summary without delaying ingestion retries or releases.
4. When `scoreDiscoveryItems` returns structured errors for any ID, ingestion resets those IDs to `pending_scoring`, emits a `discovery.scoring.failed` event, and records the failure so the periodic batch runner can retry them.
5. The backlog guard remains intact: if `pending_scoring` exceeds the configured threshold, ingestion defers the synchronous scoring call and leaves the items queued for the periodic runner.
6. Automated tests cover enabled, disabled, backlog-deferred, error-reset, and score-persistence flows, and assert that ingestion delegates to the scoring utility with the expected ID batches and writes to `discovery_scores`.

## Tasks / Subtasks
- [x] Wire `server/jobs/discovery/ingest-sources.ts` to collect `saveDiscoveryItems` inserts, evaluate backlog/feature-flag state, and call `scoreDiscoveryItems(ids)` when enabled (AC 1, AC 2, AC 5).
- [x] Ensure the ingestion job propagates scoring summaries, emits `discovery.scoring.failed` on structured errors, and resets failing IDs to `pending_scoring` without blocking retries (AC 3, AC 4).
- [x] Update ingestion telemetry/logging to differentiate between scored, skipped (disabled/error), and deferred (backlog) batches using the existing observability helpers and confirm score persistence metrics (`discovery_scores`) are emitted (AC 2, AC 3, AC 5).
- [x] Refresh `docs/discovery-scoring-implementation-notes.md` (and related runbook) with the synchronous utility call flow, failure-handling guidance, and the persistence step into `discovery_scores` (AC 3, AC 4).
- [x] Document rollout/rollback, feature-flag expectations, and monitoring hooks in `docs/internal/scoring-sync-rollout.md`, linking the doc from the change log, and reference `discovery_scores` storage schema (AC 2, AC 4).
- [x] Update `docs/discovery-agent-dev-setup.md` with local prerequisites/env vars for testing the ingestion scoring hook (AC 1, AC 6).
- [x] Extend operator guidance (e.g., `docs/discovery-scoring-reviewer-guide.md`) with instructions for interpreting the new telemetry and flipping the feature flag when needed (AC 3, AC 4).
- [x] Add automated coverage: unit tests for ingestion scoring integration (enabled, disabled, backlog guard, error reset) and integration tests confirming IDs flow through and telemetry fires (AC 6).

## Dev Notes
- **Previous Story Insights**: Story 4.1 delivers the shared `scoreDiscoveryItem`/`scoreDiscoveryItems` utility under `server/utils/discovery/scoring.ts`; ingestion must delegate to that module rather than reimplement scoring (`docs/stories/4.1.scoring-relevance-model.md`).
- **Utility Location**: Keep all weighting math and normalization inside the utility. Ingestion should only prepare inputs, handle responses, and surface telemetry (`architecture/discovery_agent_backend/responsibilities-by-layer.md#api-layer`).
- **Ingestion Trigger Context**: The ingestion job batches sources in `server/jobs/discovery/ingest-sources.ts`, persists items via `saveDiscoveryItems`, and currently relies on periodic scoring sweepsâ€”insert the utility call immediately after persistence while honouring retry/backlog guards and writing to `discovery_scores` (`architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#ingestion-pipeline`).
- **Feature Flag Coordination**: Honour `isFeatureEnabled` from `server/utils/client-config/feature-flags.ts` so configuration changes propagate consistently across services (`docs/architecture/config-management.md`).
- **Telemetry Expectations**: Agent events still flow through `signalAgentEvent`; add structured logs/metrics for scored, skipped, and deferred paths per `architecture/discovery_agent_backend/observability-logging.md` and surface persistence stats for `discovery_scores` writes.
- **Operational Rollout & Backout**: Retain the existing discovery scoring feature flag and document rollout/rollback in `docs/internal/scoring-sync-rollout.md`.
- **Local Environment**: Update `docs/discovery-agent-dev-setup.md` with the env vars and process orchestration required to validate the synchronous utility path locally.
- **Project Structure Notes**: Keep ingestion updates within `server/jobs/discovery/**` and observability changes aligned with the source tree guide (`architecture/source-tree.md`).
- **Technical Constraints**: Maintain TypeScript strictness, shared config handling, and avoid introducing agent-specific dependencies into the ingestion layer (`architecture/coding-standards.md`).

### Testing
- Follow the backend testing plan: Vitest unit suites belong under `server/jobs/__tests__/discovery` (or equivalent ingestion harness) with mocks for the scoring utility, plus an integration path that exercises `ingest-sources` end-to-end (`architecture/discovery_agent_backend/testing-strategy.md`). Ensure coverage asserts utility invocation, feature-flag gating, backlog deferral, and error resets.
- Reuse the in-memory Drizzle harness and existing job scaffolding; assert telemetry via spies on logging/event helpers and verify that periodic batch scoring remains untouched for deferred items (`architecture/discovery_agent_backend/testing-strategy.md`).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-04-05 | 0.1 | Draft for Epic: Scoring & Deduplication. | SM |
| 2025-04-06 | 0.2 | Incorporated rollout/rollback, monitoring, and regression readiness requirements (link: docs/internal/scoring-sync-rollout.md). | SM |
| 2025-04-08 | 0.3 | Reworked to integrate the shared scoring utility and retire the dedicated agent path. | SM |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit -- --run server/jobs/__tests__/discovery-ingest-sources.spec.ts

### Completion Notes List
- Added inline scoring orchestration in `server/jobs/discovery/ingest-sources.ts`, including feature-flag gating, backlog threshold deferral, structured failure handling, and run metrics for scored/skipped batches.
- Persisted scoring outcomes through new repository helpers (`persistDiscoveryScores`, `countPendingDiscoveryItemsForClient`, `resetDiscoveryItemsToPending`) and expanded discovery event schemas/telemetry to cover `discovery.score.complete`, `discovery.queue.updated`, and `discovery.scoring.failed` payloads.
- Updated documentation (implementation notes, rollout runbook, dev setup, reviewer guide) to reflect synchronous scoring flow, configuration knobs, and operator guidance.
- Boosted keyword component weighting so early matches have higher influence on the overall score while still respecting coverage across the configured keyword list.

### File List
- packages/db/src/discovery/index.ts
- server/utils/discovery-repository.ts
- packages/shared/src/discovery-events.ts
- server/utils/discovery-telemetry.ts
- server/jobs/discovery/ingest-sources.ts
- server/jobs/__tests__/discovery-ingest-sources.spec.ts
- docs/discovery-scoring-implementation-notes.md
- docs/internal/scoring-sync-rollout.md
- docs/discovery-agent-dev-setup.md
- docs/discovery-scoring-reviewer-guide.md
- docs/stories/4.5.scoring-ingestion-trigger.md

## QA Results
_Not yet reviewed._
