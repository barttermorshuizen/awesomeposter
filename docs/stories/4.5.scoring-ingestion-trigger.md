# Story 4.5: Synchronous Ingestion Scoring Trigger

## Status
Draft

## Story
**As the** discovery ingestion scheduler,
**I want** to trigger relevance scoring for freshly ingested items immediately after each batch,
**so that** reviewers see updated scores without waiting for deferred sweeps.

## Acceptance Criteria
1. `DiscoveryScoringAgent` exposes a `processItems(ids: string[])` entry point that reuses the existing scoring logic, honours the feature toggle, returns a processed/scored/suppressed/skipped summary, and gracefully no-ops when invoked with an empty list.
2. After `ingest-sources` persists a batch, it synchronously calls `processItems` with the inserted item IDs (when scoring is enabled) and logs/telemeters the summary without delaying ingestion retries or releases.
3. Synchronous scoring emits the same `discovery.score.complete`/`discovery.queue.updated` AgentEvents produced by `processBatch`, ensuring downstream SSE consumers stay in sync.
4. If scoring any of the forwarded IDs fails, the ingestion job resets those items to `pending_scoring`, raises a structured warning event (e.g., `discovery.scoring.failed`), and records the failure in ingestion telemetry so nightly/backfill runs can recover them.
5. The ingestion job respects the existing backlog guard: when `pending_scoring` exceeds the configured threshold or scoring is disabled, it defers the sync call and leaves items in `pending_scoring` for the periodic batch runner.
6. Unit/integration tests cover `processItems` success/disabled/error flows and verify the ingestion job forwards IDs, handles failure resets, and records telemetry.
7. Operational readiness doc articulates rollout/rollback sequencing, feature-flag guardrails, and monitoring hooks for the synchronous scoring trigger and is linked in the change log.

## Tasks / Subtasks
- [ ] Extend `DiscoveryScoringAgent` with `processItems(ids)` that loads targeted records via the repository, reuses weighting logic, and shares telemetry with `processBatch` (AC 1, AC 3).
  - [ ] Refactor internal scoring loop so both batch methods reuse a common private helper, keeping nightly backfill behaviour intact (AC 1).
- [ ] Update `DiscoveryRepository` (agents server) with helpers to fetch and reset explicit item IDs, exposing granular failure handling for the new API (AC 1, AC 4).
- [ ] Wire `server/jobs/discovery/ingest-sources.ts` to collect `saveDiscoveryItems` inserts, check backlog/feature-flag conditions, invoke `processItems`, and log/emit telemetry with the returned summary (AC 2, AC 5).
- [ ] Emit a `discovery.scoring.failed` AgentEvent + ingestion log when synchronous scoring throws, then reset the affected IDs back to `pending_scoring` so periodic jobs can retry (AC 3, AC 4).
- [ ] Update `docs/discovery-scoring-implementation-notes.md` (and runbook if needed) with the new synchronous trigger flow and failure-handling guidance (AC 2, AC 4).
- [ ] Capture rollout + rollback steps, CI/CD toggle expectations, and monitoring responsibilities in `docs/internal/scoring-sync-rollout.md`, linking the document from the change log (AC 7).
- [ ] Refresh `docs/discovery-agent-dev-setup.md` with any new environment variables, local ingestion job prerequisites, and guidance for validating synchronous scoring locally (AC 2, AC 7).
- [ ] Extend `docs/discovery-scoring-reviewer-guide.md` (or create a companion operator note) with callouts for on-call/ops communication, including how to interpret the new telemetry and when to flip the feature flag (AC 2, AC 7).
- [ ] Add Vitest coverage: unit tests for `processItems` (enabled, disabled, partial failure) and integration test for ingestion job path ensuring IDs flow through and resets/telemetry fire (AC 6).
- [ ] Add regression test coverage ensuring existing `processBatch` behaviour remains unchanged when reusing the shared helper and nightly batch scoring still emits prior telemetry (AC 3, AC 6).

## Dev Notes
- **Previous Story Insights**: Story 4.1 delivered `DiscoveryScoringAgent.processBatch`, repository persistence, SSE emissions, and queue cleanup—`processItems` must reuse that infrastructure to avoid divergence (`docs/stories/4.1.scoring-relevance-model.md`).
- **Scoring Agent Location**: Scoring capabilities live under `packages/agents-server/src/agents/discovery-scoring.ts`, sharing persistence/services defined in the agents server package; extend within that module (`architecture/discovery_agent_backend/responsibilities-by-layer.md#agents-server`).
- **Ingestion Trigger Context**: The ingestion job batches sources in `server/jobs/discovery/ingest-sources.ts`, persists items via `saveDiscoveryItems`, and currently relies on the agents server poller; hook the synchronous scoring right after persistence (`architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#ingestion-pipeline`).
- **Backlog Guard**: Ingestion already pauses when `pending_scoring` exceeds thresholds—mirror that guard before invoking synchronous scoring to preserve throughput protections (`architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput`).
- **Telemetry Expectations**: Agent events (`discovery.score.complete`, queue updates) flow through `signalAgentEvent`, and ingestion emits health telemetry/logs; ensure new success/failure events follow the structured logging guidance (`architecture/discovery_agent_backend/observability-logging.md`). Define concrete alert thresholds for backlog growth and synchronous failure rates, wiring them into the observability configuration called out in that doc.
- **Operational Rollout & Backout**: Synchronous scoring ships behind the existing feature toggle; document blue/green expectations, flag flip order, and rollback playbook in `docs/internal/scoring-sync-rollout.md`, including cues for when to abort and fall back to batch-only processing.
- **Local Environment**: Developers must run the agents server and ingestion job together; update `docs/discovery-agent-dev-setup.md` with required env vars (e.g., `DISCOVERY_SCORING_SYNC_ENABLED`) and seed data/setup scripts so teams can validate the synchronous path before shipping.
- **Operator Support**: Coordinate with the reviewer guide to spell out how on-call interprets the new telemetry, acknowledges alerts, and communicates scoring pauses to stakeholders.
- **Project Structure Notes**: Keep scoring changes under `packages/agents-server/src/**` and ingestion updates under `server/jobs/discovery/**` in line with the source tree guide (`architecture/source-tree.md`).
- **Technical Constraints**: Maintain TypeScript strictness, ESM imports, and centralized env/config handling per coding standards (`architecture/coding-standards.md`).

### Testing
- Follow the backend testing plan: Vitest unit suites belong under `packages/agents-server/__tests__/discovery` and ingestion integration coverage should live alongside the Nitro job harness (`architecture/discovery_agent_backend/testing-strategy.md`). Include regression assertions that nightly `processBatch` continues to emit historical telemetry and that queue backlog guards still trigger when synchronous scoring is disabled.
- Reuse the in-memory Drizzle harness for scoring tests and the existing job test scaffolding; ensure new cases assert SSE emissions or logging via spies as needed (`architecture/discovery_agent_backend/testing-strategy.md`).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-04-05 | 0.1 | Draft for Epic: Scoring & Deduplication. | SM |
| 2025-04-06 | 0.2 | Incorporated rollout/rollback, monitoring, and regression readiness requirements (link: docs/internal/scoring-sync-rollout.md). | SM |

## Dev Agent Record
_Not yet worked._

## QA Results
_Not yet reviewed._
