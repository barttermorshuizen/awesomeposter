# Story 8.39: Flex Capability Kind Metadata

## Status
Done

## Story
**As a** flex capability registry steward,  
**I want** the `kind` of every capability to be declared and persisted as part of the registry contract instead of being inferred from naming heuristics,  
**so that** CRCS metadata, planner prompts, telemetry, and operator tooling all share a single, explicit classification without leaking domain-specific keywords.

**Dependencies:** Story 8.7 cataloged the shared capability inventory and Story 8.38 added CRCS rows to planner prompts/SSE payloads; both behaviors rely on consistent capability metadata and must keep working once `kind` becomes a required field. (`docs/stories/8.7.flex-capability-inventory.md`, `docs/stories/8.38.flex-crcs-capability-register.md`)

## References
- `docs/prd/epic-flex-agents-server.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`
- `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#capability-registry`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/discovery-agent-backend.md#testing-strategy`

## Acceptance Criteria
1. Capability registration contracts (`CapabilityRegistration`, `CapabilityRecord`, shared marketing catalogs, fixture agents) require a `kind` field whose value is one of `structuring | execution | validation | transformation | routing`. Missing or invalid kinds cause registry validation errors with actionable messages, and the shared TypeScript types expose the same union so downstream services cannot omit the property. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`, `docs/architecture/source-tree.md#5-shared-libraries`)
2. The `flex_capabilities` table and persistence layer gain a normalized `kind` column plus a migration/backfill that copies the existing inferred values exactly once. `listActive`, `getCapabilityById`, snapshot caches, and marketing catalog exports all retrieve the stored `kind` without recomputing it. (Sources: `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`, `docs/architecture/source-tree.md#4-agents-server`)
3. `FlexCapabilityRegistryService` and CRCS helpers no longer call `inferCapabilityKind`; `computeCrcsSnapshot`, planner prompt rendering, SSE payloads, and telemetry simply echo the persisted kind for every capability row. Heuristic checks for strings like “strategy”, “planner”, “brief”, or “review” are removed to eliminate domain leakage. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#capability-registry`)
4. All capability definitions (agent modules, marketing catalog, sandbox metadata) declare an explicit `kind`, and CRCS/plan metadata continues to surface the same five-value union across `flex-run-coordinator`, shared `FlexEvent` contracts, and SSE clients without changing payload shape. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
5. Documentation shards describing capability metadata, CRCS, and planner prompt semantics clearly state that `kind` is mandatory, enumerate the allowed values, and remove references to heuristic inference so operator and developer guides stay accurate. (Sources: `docs/prd/epic-flex-agents-server.md`, `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`)
6. Automated coverage includes unit tests for capability registration validation (accepts valid kinds, rejects invalid/missing kinds), migration/backfill verification, and CRCS/planner prompt snapshots that assert the persisted kind is propagated end-to-end with no heuristic fallback. (Sources: `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)

## Tasks / Subtasks
- [x] Add the `kind` column + migration in `packages/db` (Drizzle schema + SQL), including a one-time script that reads the previous inferred value and persists it so no capability loses classification. (AC 2) (`packages/db/src/schema.ts`, `packages/db/migrations/**`)
- [x] Update shared contracts (`packages/shared/src/flex/types.ts`, marketing catalogs, sandbox metadata DTOs) so `kind` is required everywhere a capability is declared or transported. (AC 1, AC 4) (`packages/shared/src/flex/**`, `packages/flex-agents-server/src/agents/**`)
- [x] Remove `inferCapabilityKind` from `FlexCapabilityRegistryService`, enforce server-side validation during registration, and ensure CRCS rows/planner prompts/SSE payloads thread the stored kind. (AC 1, AC 3, AC 4) (`packages/flex-agents-server/src/services/flex-capability-registry.ts`, `packages/flex-agents-server/src/services/flex-run-coordinator.ts`)
- [x] Update all registered capability definitions (e.g., strategist/copywriter/designer/director agents) and the capability registry reference doc (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`) so each catalog entry lists its explicit kind (`strategist.SocialPosting/Positioning → structuring`, `copywriter.SocialpostDrafting/Messaging → execution`, `designer.VisualDesign → execution`, `director.SocialPostingReview/PositioningReview → validation`). (AC 1, AC 4, AC 5)
- [x] Extend Vitest suites to cover registration validation, migration/backfill behavior, and CRCS/planner prompt rendering with explicit kinds; update fixtures to declare the new field. (AC 6) (`packages/flex-agents-server/__tests__/**`, `packages/shared/__tests__/**`)
- [x] Refresh documentation (architecture shards, PRD sections, onboarding guides) to describe the explicit `kind` requirement and remove legacy heuristic wording. (AC 5) (`docs/prd/epic-flex-agents-server.md`, `docs/architecture/flex-agents-server/{5,10,11}-*.md`)

## Project Structure Notes
- Capability metadata and registry logic live under `packages/flex-agents-server/src/services/**`, while shared DTOs/marketing catalogs belong in `packages/shared/src/flex/**`; keep schema and runtime code changes scoped to these owners. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#5-shared-libraries`)

## Testing
- Follow the Vitest + in-memory registry harness patterns documented in the backend testing strategy to validate registration failures, migration integrity, and CRCS propagation under deterministic fixtures. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)

## Future Considerations
- Once explicit kinds are persisted, consider exposing them through the Flex Sandbox UI filters so operators can pivot between structuring/execution/validation views without additional backend joins.

## Dev Agent Record

### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- `npm run test:unit -- packages/shared/__tests__/flex/capability-registration.spec.ts packages/db/__tests__/flex-capabilities-kind-migration.spec.ts packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts`

### Completion Notes List
- Added a first-class `kind` field to capability registrations/records, updated the shared contracts, marketing catalog, and every capability definition (AI + human) so the metadata is explicit instead of inferred.
- Introduced a `flex_capabilities.kind` column plus a backfill migration that mirrors the former heuristics once before enforcing the new NOT NULL + CHECK constraint, and wired the repository to persist/read the value.
- Removed all planner/registry heuristics (`inferCapabilityKind` + prompt guidance), taught CRCS + planner prompts to echo the stored kind, and refreshed docs to describe the new contract and SSE payload shape.
- Updated the end-to-end/unit tests and fixtures to declare kinds, refreshed the capability reference doc, and ran targeted Vitest suites to guard the schema + CRCS changes.
- Reconciled QA feedback by updating the planner prompt expectation (no duplicate `SYSTEM:` heading) and adding AC6-required tests covering capability kind validation, migration heuristics, and CRCS/planner propagation.

### File List
- packages/shared/src/flex/types.ts
- packages/shared/src/flex/marketing-catalog.ts
- packages/shared/__tests__/flex/capability-registration.spec.ts
- packages/db/src/schema.ts
- packages/db/migrations/20251026_add_flex_capability_kind.sql
- packages/db/__tests__/flex-capabilities-kind-migration.spec.ts
- packages/flex-agents-server/src/services/flex-capability-repository.ts
- packages/flex-agents-server/src/services/flex-capability-registry.ts
- packages/flex-agents-server/src/services/planner-service.ts
- packages/flex-agents-server/src/agents/marketing/strategist-social-posting.ts
- packages/flex-agents-server/src/agents/marketing/strategist-positioning.ts
- packages/flex-agents-server/src/agents/marketing/copywriter-socialpost-drafting.ts
- packages/flex-agents-server/src/agents/marketing/copywriter-messaging.ts
- packages/flex-agents-server/src/agents/marketing/designer-visual-design.ts
- packages/flex-agents-server/src/agents/marketing/director-social-review.ts
- packages/flex-agents-server/src/agents/marketing/director-positioning-review.ts
- packages/flex-agents-server/src/agents/human-clarify-brief.ts
- packages/flex-agents-server/__tests__/flex-capability-register.route.spec.ts
- packages/flex-agents-server/__tests__/flex-capability-registry.spec.ts
- packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts
- packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts
- packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts
- packages/flex-agents-server/__tests__/flex-planner.crcs.spec.ts
- packages/flex-agents-server/__tests__/marketing-strategy-smoke.spec.ts
- src/components/__tests__/FlexSandboxPlanInspector.spec.ts
- docs/architecture/flex-agents-server/511-reference-capability-registry.md
- docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md
- docs/architecture/flex-agents-server/5-core-concepts.md
- docs/architecture/flex-agents-server/10-api-surface-initial.md
- docs/stories/8.39.flex-capability-kind-metadata.md

### QA Results

### Review Date: 2025-11-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Contracts, schema, and docs now surface the explicit `CapabilityKind`, but `buildPlannerSystemPrompt` (packages/flex-agents-server/src/services/planner-service.ts:148-170) no longer emits the `"SYSTEM:"` preface that downstream automation expects, so planner-service.prompts.spec.ts now fails and the prompt builder is regressed.
- Persistence/CRCS wiring threads the stored kind through, yet AC6-required guardrails (registration validation + migration/backfill tests) never landed, so we lack evidence that the contract holds under negative paths.

### Refactoring Performed

- None – review only.

### Compliance Check

- Coding Standards: ✗ – planner prompt unit test is red because the system message lost its `"SYSTEM:"` prefix (`packages/flex-agents-server/src/services/planner-service.ts:148-170` vs `packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts:150-168`).
- Project Structure: ✓ – DB column, shared contracts, and docs live in their proper owners.
- Testing Strategy: ✗ – capability registration validation/migration/backfill/CRCS snapshot tests promised in AC6 were not added (`packages/shared/__tests__/flex/capability-registration.spec.ts:17-67`, `packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts:27-118`, no new DB migration spec).
- All ACs Met: ✗ – AC6 remains open because required coverage is missing and the prompt regression blocks sign-off.

### Improvements Checklist

- [ ] Restore the `"SYSTEM:"` preamble (or update spec expectations) so `packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts` passes again.
- [ ] Add Zod contract tests that assert capability registration rejects missing/invalid `kind` values (AC6).
- [ ] Add migration/backfill verification plus CRCS/planner prompt assertions proving persisted kinds flow end-to-end (AC6).

### Security Review

- No new security concerns introduced by this change set.

### Performance Considerations

- No performance regressions observed; changes are schema/metadata only.

### Testing & Validation

- `npm run test:unit -- packages/shared/__tests__/flex/capability-registration.spec.ts packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts` ✅
- `npm run test:unit -- packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts` ❌ (fails because `"SYSTEM:"` is missing from the system prompt output)

### Files Modified During Review

- `docs/stories/8.39.flex-capability-kind-metadata.md` (QA Results)
- `docs/qa/gates/8.39-flex-capability-kind-metadata.yml` (quality gate)

### Gate Status

Gate: FAIL → `docs/qa/gates/8.39-flex-capability-kind-metadata.yml`  
Risk profile: not produced this cycle  
NFR assessment: not produced this cycle

### Recommended Status

✗ Changes Required – see checklist above.

### Review Date: 2025-11-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Planner prompt suite now expects the updated intro (single `You are the Flex PlannerService` stanza) and passes (`packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts:150-331`), resolving the earlier regression.
- AC6 coverage is in place: shared validation fails when `kind` is missing/invalid (`packages/shared/__tests__/flex/capability-registration.spec.ts:75-90`), the migration heuristics/constraints are asserted (`packages/db/__tests__/flex-capabilities-kind-migration.spec.ts:1-21`), and CRCS + planner prompts prove they echo stored kinds without heuristics (`packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts:227-299`, `packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts:280-331`).

### Refactoring Performed

- None required during this QA pass.

### Compliance Check

- Coding Standards: ✓ – Prompt/test alignment restored (`packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts`)
- Project Structure: ✓ – New migration test lives under `packages/db/__tests__`
- Testing Strategy: ✓ – AC6 scenarios now covered across shared/db/server suites
- All ACs Met: ✓ – Functional + documentation requirements satisfied with automated coverage

### Improvements Checklist

- [x] Ensure planner prompt “SYSTEM” duplication issue resolved
- [x] Add negative-path tests covering capability kind validation/migration/CRCS propagation

### Security Review

- No new attack surface; all changes are tests and prompt copy expectations.

### Performance Considerations

- No runtime impact introduced.

### Testing & Validation

- `npm run test:unit -- packages/shared/__tests__/flex/capability-registration.spec.ts packages/db/__tests__/flex-capabilities-kind-migration.spec.ts packages/flex-agents-server/__tests__/planner-service.crcs.spec.ts packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts`

### Files Modified During Review

- `docs/stories/8.39.flex-capability-kind-metadata.md`
- `docs/qa/gates/8.39-flex-capability-kind-metadata.yml`

### Gate Status

Gate: PASS → `docs/qa/gates/8.39-flex-capability-kind-metadata.yml`  
Risk profile: not generated this cycle  
NFR assessment: not generated this cycle

### Recommended Status

✓ Ready for Done
