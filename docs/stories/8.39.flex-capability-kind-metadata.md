# Story 8.39: Flex Capability Kind Metadata

## Status
Ready for Dev

## Story
**As a** flex capability registry steward,  
**I want** the `kind` of every capability to be declared and persisted as part of the registry contract instead of being inferred from naming heuristics,  
**so that** CRCS metadata, planner prompts, telemetry, and operator tooling all share a single, explicit classification without leaking domain-specific keywords.

**Dependencies:** Story 8.7 cataloged the shared capability inventory and Story 8.38 added CRCS rows to planner prompts/SSE payloads; both behaviors rely on consistent capability metadata and must keep working once `kind` becomes a required field. (`docs/stories/8.7.flex-capability-inventory.md`, `docs/stories/8.38.flex-crcs-capability-register.md`)

## References
- `docs/prd/epic-flex-agents-server.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`
- `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#capability-registry`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/discovery-agent-backend.md#testing-strategy`

## Acceptance Criteria
1. Capability registration contracts (`CapabilityRegistration`, `CapabilityRecord`, shared marketing catalogs, fixture agents) require a `kind` field whose value is one of `structuring | execution | validation | transformation | routing`. Missing or invalid kinds cause registry validation errors with actionable messages, and the shared TypeScript types expose the same union so downstream services cannot omit the property. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`, `docs/architecture/source-tree.md#5-shared-libraries`)
2. The `flex_capabilities` table and persistence layer gain a normalized `kind` column plus a migration/backfill that copies the existing inferred values exactly once. `listActive`, `getCapabilityById`, snapshot caches, and marketing catalog exports all retrieve the stored `kind` without recomputing it. (Sources: `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`, `docs/architecture/source-tree.md#4-agents-server`)
3. `FlexCapabilityRegistryService` and CRCS helpers no longer call `inferCapabilityKind`; `computeCrcsSnapshot`, planner prompt rendering, SSE payloads, and telemetry simply echo the persisted kind for every capability row. Heuristic checks for strings like “strategy”, “planner”, “brief”, or “review” are removed to eliminate domain leakage. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#capability-registry`)
4. All capability definitions (agent modules, marketing catalog, sandbox metadata) declare an explicit `kind`, and CRCS/plan metadata continues to surface the same five-value union across `flex-run-coordinator`, shared `FlexEvent` contracts, and SSE clients without changing payload shape. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#facet-aligned-capabilities`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
5. Documentation shards describing capability metadata, CRCS, and planner prompt semantics clearly state that `kind` is mandatory, enumerate the allowed values, and remove references to heuristic inference so operator and developer guides stay accurate. (Sources: `docs/prd/epic-flex-agents-server.md`, `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#11-capability-registry-agent-contracts`)
6. Automated coverage includes unit tests for capability registration validation (accepts valid kinds, rejects invalid/missing kinds), migration/backfill verification, and CRCS/planner prompt snapshots that assert the persisted kind is propagated end-to-end with no heuristic fallback. (Sources: `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)

## Tasks / Subtasks
- [ ] Add the `kind` column + migration in `packages/db` (Drizzle schema + SQL), including a one-time script that reads the previous inferred value and persists it so no capability loses classification. (AC 2) (`packages/db/src/schema.ts`, `packages/db/migrations/**`)
- [ ] Update shared contracts (`packages/shared/src/flex/types.ts`, marketing catalogs, sandbox metadata DTOs) so `kind` is required everywhere a capability is declared or transported. (AC 1, AC 4) (`packages/shared/src/flex/**`, `packages/flex-agents-server/src/agents/**`)
- [ ] Remove `inferCapabilityKind` from `FlexCapabilityRegistryService`, enforce server-side validation during registration, and ensure CRCS rows/planner prompts/SSE payloads thread the stored kind. (AC 1, AC 3, AC 4) (`packages/flex-agents-server/src/services/flex-capability-registry.ts`, `packages/flex-agents-server/src/services/flex-run-coordinator.ts`)
- [ ] Update all registered capability definitions (e.g., strategist/copywriter/designer/director agents) and the capability registry reference doc (`docs/architecture/flex-agents-server/511-reference-capability-registry.md`) so each catalog entry lists its explicit kind (`strategist.SocialPosting/Positioning → structuring`, `copywriter.SocialpostDrafting/Messaging → execution`, `designer.VisualDesign → execution`, `director.SocialPostingReview/PositioningReview → validation`). (AC 1, AC 4, AC 5)
- [ ] Extend Vitest suites to cover registration validation, migration/backfill behavior, and CRCS/planner prompt rendering with explicit kinds; update fixtures to declare the new field. (AC 6) (`packages/flex-agents-server/__tests__/**`, `packages/shared/__tests__/**`)
- [ ] Refresh documentation (architecture shards, PRD sections, onboarding guides) to describe the explicit `kind` requirement and remove legacy heuristic wording. (AC 5) (`docs/prd/epic-flex-agents-server.md`, `docs/architecture/flex-agents-server/{5,10,11}-*.md`)

## Project Structure Notes
- Capability metadata and registry logic live under `packages/flex-agents-server/src/services/**`, while shared DTOs/marketing catalogs belong in `packages/shared/src/flex/**`; keep schema and runtime code changes scoped to these owners. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#5-shared-libraries`)

## Testing
- Follow the Vitest + in-memory registry harness patterns documented in the backend testing strategy to validate registration failures, migration integrity, and CRCS propagation under deterministic fixtures. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)

## Future Considerations
- Once explicit kinds are persisted, consider exposing them through the Flex Sandbox UI filters so operators can pivot between structuring/execution/validation views without additional backend joins.
