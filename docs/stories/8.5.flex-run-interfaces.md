# Story 8.5: Flex Run Resume & Debug Interfaces

## Status
Draft

## Story
**As a** support engineer,  
**I want** flex run resume and inspection endpoints,  
**so that** operators can restart paused runs and inspect historical data without touching the database directly.

## Acceptance Criteria
1. `POST /api/v1/flex/run.resume` accepts run ID plus operator payload, rehydrates plan state, and resumes execution using shared resume logic.
2. `GET /api/v1/flex/runs/:id` returns run metadata, final output (if available), latest snapshot, and capability allocations for debugging.
3. Endpoints reuse existing auth/permission middleware and respond with structured error codes for invalid states (already completed, missing snapshot, etc.).
4. API documentation or README includes examples for both endpoints, including sample curl commands.

## Tasks / Subtasks
- [ ] Implement resume controller wiring to shared execution engine resume method (AC 1).
- [ ] Implement debug retrieval controller querying `flex_runs`, `flex_run_outputs`, and snapshots (AC 2).
- [ ] Ensure endpoints check operator permissions (reuse existing HITL auth guard) (AC 3).
- [ ] Add integration tests covering successful resume, invalid run state, and debug output retrieval (AC 1-3).
- [ ] Update architecture spec / README with endpoint descriptions and curl examples (AC 4).
- [ ] Coordinate with UI team to ensure `useHitlStore` points to new resume endpoint when flex run flag is enabled (AC 1).

## Story Context

**Existing System Integration:**
- Integrates with: Flex execution engine, persistence tables from Story 8.4, existing HITL resume flows.
- Technology: Nitro routes, Drizzle repositories, shared auth middleware.
- Follows pattern: Legacy `run.resume` API semantics.
- Touch points: SPA HITL actions, support tools hitting debugging endpoint.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Resume endpoint validates run status (`paused`, `hitl_pending`) before restarting; returns SSE stream URL or success acknowledgement.
2. Debug endpoint aggregates run info: envelope, policies, plan summary, latest events, final payload.
3. Error responses include structured JSON with `code`, `message`, and `details` for operator tooling.

### Integration Requirements
4. Endpoints share auth/role checks with legacy HITL endpoints to maintain consistent controls.
5. Resume flow updates `flex_runs` status and clears pending HITL flag when run restarts.
6. Debug endpoint respects sensitive data handling (redact secrets as per policies).

### Quality Requirements
7. Integration tests simulate resume success/failure and validate response payloads.
8. Logging includes run ID, operator ID, and action type for auditing.
9. Documentation maintained in architecture spec and server README.

## Technical Notes
- **Integration Approach:** Reuse existing Nitro action handlers; map new routes under `/api/v1/flex`.
- **Existing Pattern Reference:** Legacy resume logic in `packages/agents-server/routes/api/v1/agent/run.resume.post.ts` (or equivalent).
- **Key Constraints:** Must interact with run snapshots persisted in Story 8.4; ensure concurrency protection when multiple resume requests occur.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested (legacy resume unaffected)
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (integration/unit)
- [ ] Documentation updated (endpoints + UI flag note)

## Risk and Compatibility Check
- **Primary Risk:** Mishandled resume states causing duplicate execution or lost context.
- **Mitigation:** Leverage plan snapshots and status checks; add tests for error paths.
- **Rollback:** Disable endpoints (feature flag) and route operators back to legacy resume flow.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Operators resume flex runs through the same HITL UI controls.
2. Support staff can retrieve detailed run records via API for troubleshooting.
3. Legacy orchestrator resume behavior remains unchanged.

## Important Notes
- Coordinate with QA for regression coverage on HITL flows once flex resume is wired.
- Consider rate limiting debug endpoint to prevent abuse; future enhancement if needed.
