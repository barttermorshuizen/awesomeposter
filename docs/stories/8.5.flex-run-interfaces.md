# Story 8.5: Flex Run Resume & Debug Interfaces

## Status
Done

## Story
**As a** support engineer,  
**I want** flex run resume and inspection endpoints,  
**so that** operators can restart paused runs and inspect historical data without touching the database directly.

## Acceptance Criteria
1. `POST /api/v1/flex/run.resume` accepts run ID plus operator payload, reloads the latest plan version (facet arrays + compiled schemas), and resumes execution while emitting planner lifecycle SSE events (`plan_updated`, `policy_triggered`). (`docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`)
2. `GET /api/v1/flex/runs/:id` returns run metadata, plan version history, facet provenance, final output (if available), and latest snapshot for debugging. (`docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
3. Endpoints reuse existing auth/permission middleware and respond with structured error codes for invalid states (already completed, missing snapshot, stale plan version). (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`)
4. SSE and API documentation list planner lifecycle events (`plan_requested`, `plan_generated`, `plan_rejected`, `plan_updated`, `policy_triggered`) with resume/debug examples. (`docs/architecture/flex-agents-server.md#10-0-1-flex-run-streaming-contract`)

## Tasks / Subtasks
- [x] Implement resume controller wiring that reloads latest plan version + facet metadata before handing off to execution engine (AC 1). Touch `packages/flex-agents-server/routes/api/v1/flex/run.resume.post.ts` and `packages/flex-agents-server/src/services/flex-run-coordinator.ts`.
- [x] Extend SSE emission to broadcast planner lifecycle events during resume and replanning (`plan_updated`, `policy_triggered`) (AC 1, AC 4). Update `packages/flex-agents-server/src/services/flex-run-coordinator.ts` and related telemetry helpers.
- [x] Implement debug retrieval controller joining `flex_runs`, `flex_run_outputs`, plan version history, and snapshots with facet provenance (AC 2). Add `packages/flex-agents-server/routes/api/v1/flex/runs/[id].get.ts` and query via `packages/flex-agents-server/src/services/orchestrator-persistence.ts`.
- [x] Ensure endpoints enforce operator permissions (reuse HITL auth guard) and validate plan version freshness (AC 3). Reuse middleware from `packages/flex-agents-server/routes/api/v1/flex/run.stream.post.ts`.
- [x] Add integration tests covering successful resume, stale plan rejection, invalid run state, and debug output retrieval (AC 1-3).
- [x] Update architecture spec / README with planner lifecycle SSE docs, resume/debug examples, and curl commands (AC 4).
- [x] Coordinate with UI team to wire `useHitlStore` to new SSE events/resume flow when the flex flag is enabled (AC 1, AC 4).

## Story Context

**Existing System Integration:**
- Integrates with: Flex execution engine, persistence tables from Story 8.4 (facet snapshots), facet catalog/contract compiler outputs (Story 8.12), hybrid planner loop/policy engine (Stories 8.14/8.9), existing HITL resume flows.
- Technology: Nitro routes, Drizzle repositories, shared auth middleware, SSE streaming.
- Follows pattern: Legacy `run.resume` API semantics augmented with planner lifecycle handshake.
- Touch points: SPA HITL actions, planner SSE consumers, support tools hitting debugging endpoint.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Resume endpoint validates run status (`paused`, `hitl_pending`), reloads latest plan version/facet metadata, and returns SSE reconnection info plus lifecycle events.
2. Debug endpoint aggregates run info: envelope, policies, plan version history with facet provenance, latest events, and final payload.
3. Error responses include structured JSON with `code`, `message`, `details`, and expected plan version when applicable for operator tooling.

### Integration Requirements
4. Endpoints share auth/role checks with legacy HITL endpoints to maintain consistent controls.
5. Resume flow updates `flex_runs` status, plan version, and clears pending HITL flag when run restarts.
6. Debug endpoint respects sensitive data handling (redact secrets) while exposing facet provenance and planner rationale.

### Quality Requirements
7. Integration tests simulate resume success/failure, stale plan rejection, and validate response payloads/SSE events.
8. Logging includes run ID, operator ID, plan version, and action type for auditing.
9. Documentation maintained in architecture spec and server README (planner lifecycle section + API appendix).

## Technical Notes
- **Integration Approach:** Reuse Nitro action handlers; reload plan versions/facet metadata from persistence before invoking execution; surface planner lifecycle events over SSE.
- **Implementation Targets:** Add Nitro handlers under `packages/flex-agents-server/routes/api/v1/flex/run.resume.post.ts` and `packages/flex-agents-server/routes/api/v1/flex/runs/[id].get.ts`, delegating to `packages/flex-agents-server/src/services/flex-run-coordinator.ts` and `packages/flex-agents-server/src/services/orchestrator-persistence.ts`.
- **Existing Pattern Reference:** Legacy resume logic in `packages/agents-server/routes/api/v1/agent/run.resume.post.ts` plus new hybrid planner workflow in Story 8.14.
- **Key Constraints:** Ensure concurrency protection when multiple resume requests occur; reconcile planner deltas with resume workflow and maintain consistent plan version IDs.

## Definition of Done
- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested (legacy resume unaffected)
- [x] Code follows existing patterns and standards
- [x] Tests pass (integration/unit)
- [x] Documentation updated (endpoints + UI flag note)

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-routes.spec.ts

### Completion Notes List
- Added `POST /api/v1/flex/run.resume` handler with auth reuse, plan-version freshness checks, and SSE streaming backed by resume-aware audit logging.
- Extended `FlexRunCoordinator` resume flow to emit `policy_triggered`/`plan_updated` events and handle replanning safely when HITL feedback requires new plans.
- Delivered `GET /api/v1/flex/runs/:id` debug endpoint returning redacted run metadata, plan history, snapshot facets, and provenance for support tooling.
- Created Vitest route coverage for resume success, stale plan rejection, invalid state handling, and debug retrieval payloads.
- Updated `docs/architecture/flex-agents-server.md` with resume/debug examples, SSE lifecycle guidance, and curl snippets, and refreshed the flex sandbox UI to use the new resume stream when the feature flag is enabled.

### File List
- packages/flex-agents-server/routes/api/v1/flex/run.resume.post.ts
- packages/flex-agents-server/routes/api/v1/flex/runs/[id].get.ts
- packages/flex-agents-server/src/services/flex-run-coordinator.ts
- packages/flex-agents-server/src/services/orchestrator-persistence.ts
- packages/flex-agents-server/__tests__/flex-run-routes.spec.ts
- docs/architecture/flex-agents-server.md
- docs/stories/8.5.flex-run-interfaces.md
- src/lib/flex-sse.ts
- src/views/FlexSandboxView.vue

## Risk and Compatibility Check
- **Primary Risk:** Mishandled resume states causing duplicate execution or lost context.
- **Mitigation:** Leverage plan snapshots and status checks; add tests for error paths.
- **Rollback:** Disable endpoints (feature flag) and route operators back to legacy resume flow.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Operators resume flex runs through the same HITL UI controls.
2. Support staff can retrieve detailed run records via API for troubleshooting.
3. Legacy orchestrator resume behavior remains unchanged.

## Important Notes
- Coordinate with QA for regression coverage on HITL flows once flex resume is wired.
- Consider rate limiting debug endpoint to prevent abuse; future enhancement if needed.
