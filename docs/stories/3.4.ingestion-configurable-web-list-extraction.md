# Story 3.4: Configurable Web List Extraction - Brownfield Addition

## Status
Draft

## Story
**As the** ingestion operator,
**I want** to configure web list pages with per-source extraction rules,
**so that** each article on a list page becomes an individual discovery item without custom code changes.

## Acceptance Criteria
**Functional Requirements**
1. Source configuration supports an optional `webList` block with fields `list_container_selector`, `item_selector`, `fields`, and `pagination.next_page` (string CSS selectors or templated attributes).
2. Configuration schema validation enforces required selectors when `webList` is present and provides defaults aligning with current title/description extraction when omitted.
3. Configuration is persisted and made available to ingestion jobs via existing configuration retrieval APIs without breaking current clients.

**Integration Requirements**
4. Existing web source ingestion continues to use title/description defaults when `webList` is not set.
5. Ingestion job loader deserializes the `webList` configuration alongside existing settings and exposes it to the normalization path.
6. Telemetry for ingestion runs includes whether `webList` rules were applied for traceability without altering current payload consumers.

**Quality Requirements**
7. Unit tests cover configuration validation, serialization/deserialization, and fallback behaviour.
8. Source configuration documentation is updated to describe `webList` usage, selector expectations, and pagination handling.
9. A sample configuration is added to developer fixtures demonstrating multi-item extraction while ensuring existing fixtures still pass.

## Tasks / Subtasks
- [ ] Extend shared discovery configuration schema and TypeScript types to support the optional `webList` block while preserving current defaults (AC 1, AC 2, AC 3, AC 4).
  - [ ] Update `packages/shared/src/discovery` (create or extend a `config` module) so selectors and pagination options are strongly typed and validated via Zod; require selectors when `webList` is present and default to legacy title/description extraction when omitted (AC 1, AC 2, AC 4).
  - [ ] Adjust `server/utils/discovery-repository.ts` (config persistence) to serialize and deserialize the new `webList` block inside `configJson` without breaking existing records; ensure loader helpers expose the block to callers (AC 3, AC 4, AC 5).
- [ ] Propagate `webList` data to the ingestion job and adapters so list extraction can occur when configured (AC 4, AC 5).
  - [ ] Hydrate the configuration inside `server/jobs/discovery/ingest-sources.ts` and pass `webList` selectors to adapter input while retaining current single-item behavior when absent (AC 4, AC 5).
  - [ ] Update shared ingestion utilities (`packages/shared/src/discovery/ingestion.ts`) or new helpers to map configured selectors to normalized items, including pagination handling consistent with architecture guidance (AC 1, AC 5).
- [ ] Emit telemetry fields that indicate whether list extraction executed for a run (AC 6).
  - [ ] Extend ingestion telemetry payloads in `server/jobs/discovery/ingest-sources.ts` and `server/utils/discovery-telemetry.ts` to include flags such as `webListApplied`, `listItemCount`, and `paginationDepth` without breaking existing consumers (AC 6).
- [ ] Update documentation and developer fixtures to cover list extraction usage (AC 8, AC 9).
  - [ ] Document the `webList` configuration in `docs/architecture/discovery-agent-backend.md` (config schema section) and link selector expectations plus pagination behavior (AC 8).
  - [ ] Add or update a sample configuration under `docs/architecture/discovery-agent-backend` (e.g., `samples/web-list-config.json`) that demonstrates multi-item extraction and leaves existing fixtures intact (AC 9).
- [ ] Expand automated tests to verify validation, serialization, and fallback behavior (AC 2, AC 4, AC 7).
  - [ ] Add Vitest coverage for the shared configuration schema ensuring selectors are required when `webList` exists and defaults match legacy behavior when omitted (AC 2, AC 4, AC 7).
  - [ ] Extend `server/jobs/__tests__/discovery-ingest-sources.spec.ts` to cover both list extraction runs and the default path with `webList` absent, asserting telemetry flags and normalized items (AC 4, AC 6, AC 7).

## Dev Notes
- **Integration Points:** The ingestion job at `server/jobs/discovery/ingest-sources.ts` orchestrates adapter execution and already consumes source configuration from `configJson`; extend this workflow to hydrate the optional `webList` block while preserving current single-item defaults (docs/architecture/discovery-agent-backend.md#scheduled-jobs-serverjobsdiscovery, ingestion overview).
- **Persistence:** Source configuration is stored via `server/utils/discovery-repository.ts`, which reads and writes `discovery_sources.config_json` (packages/db/src/schema.ts); ensure serialization changes remain additive so existing clients load without errors (docs/architecture/discovery-agent-backend.md#configuration-schema--storage).
- **Shared Types & Validation:** Shared ingestion utilities under `packages/shared/src/discovery` provide adapter inputs and schemas; add a dedicated config schema that enforces selector presence when `webList` is defined and supports pagination metadata consistent with backend architecture guidance (docs/architecture/discovery-agent-backend.md#configuration-schema--storage). Invalid selector configurations must surface clear validation errors back to operators instead of failing silently.
- **Telemetry:** `server/utils/discovery-telemetry.ts` normalizes ingestion telemetry events; extend payloads to report `webListApplied`, per-run item counts, and pagination depth so downstream analytics can trace selector efficacy (docs/architecture/discovery-agent-backend.md#responsibilities-by-layer). Telemetry should also capture when selectors yielded zero items or pagination terminated early due to safety limits for observability.
- **Edge Cases:** When list extraction yields no items, adapters must log a warning, emit telemetry with `webListApplied=false`, and fall back to legacy single-item heuristics to avoid data loss. Pagination should stop once duplicate URLs are detected or the configured depth ceiling (default 5) is reached; record the stop reason in telemetry. If the `next_page` selector resolves to an invalid URL, flag the run as partial success but persist a diagnostic in ingestion run metrics for operator follow-up.
- **Risks & Rollback:** Misconfigured selectors can suppress list items; keep defaults to current heuristics when `webList` is absent and allow operators to remove the block to revert behavior. Pagination safeguards described above prevent infinite loops while retaining rollback by clearing the `webList` block.

### Testing
- Follow backend testing standards: colocate Vitest suites under the affected module paths (`packages/shared/src/discovery/__tests__`, `server/jobs/__tests__/discovery-ingest-sources.spec.ts`) and assert both validation failures and successful extraction flows.
- Cover the fallback scenario explicitlyâ€”when `webList` is not provided, adapters must continue emitting a single normalized item using existing heuristics (AC 4).
- Ensure telemetry assertions include the new fields without breaking schema versioning (`DISCOVERY_TELEMETRY_SCHEMA_VERSION`).

## Dev Agent Record

### Agent Model Used
- _To be completed by the development agent._

### Debug Log References
- _To be completed by the development agent._

### Completion Notes List
- _To be completed by the development agent._

### File List
- _To be completed by the development agent._

## QA Results
- _To be completed by the QA agent._

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Drafted brownfield story extending Epic 3 for configurable web list extraction. | John |
