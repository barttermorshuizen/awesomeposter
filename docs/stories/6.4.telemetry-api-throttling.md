# Story 6.4: Telemetry API Throttling

## Status
Draft

## Story
**As a** platform engineer,
**I want** to enforce configurable rate limits on the discovery API endpoints,
**so that** we can prevent abuse and protect ingestion/scoring while we expand pilot access.

## Acceptance Criteria
1. Configure per-client (feature flag group) and per-IP request limits for all `/api/discovery/*` routes, using shared middleware in Nitro.
2. Limits, window size, and burst allowance are driven by environment configuration (default values documented and safe for dev environments).
3. When throttling occurs, an info-level log entry includes client identifier, IP, limit metadata, and the route; response returns HTTP 429 with JSON body (`status: 'rate_limited'`, `retryAfter` seconds).
4. Integration tests cover limit enforcement and confirm non-discovery routes remain unaffected.

## Tasks / Subtasks
- [ ] Implement `rateLimitDiscoveryRoutes` middleware in Nitro, configurable via env (`DISCOVERY_RATE_LIMIT`, `DISCOVERY_RATE_BURST`, `DISCOVERY_RATE_WINDOW_SEC`).
- [ ] Wire middleware into `/api/discovery/*` handlers without touching unrelated routes.
- [ ] Emit structured info logs when a request is throttled (include clientId/IP/route/limit).
- [ ] Add integration tests under `tests/api/discovery` for allowed vs. throttled scenarios.
- [ ] Document configuration knobs in backend architecture decisions & ops runbook.

## Dev Notes
- Reuse or adapt any existing HITL/backlog rate limiting utilities before adding new dependencies.
- Keep UI changes minimal: no new surfaces; front-end can surface the 429 message via existing error handling.

### Testing
- Integration: repeat requests to a discovery endpoint until limit is hit; assert 429 + log output.
- Unit (optional): middleware logic with stubbed counters.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-30 | 0.1 | Initial draft scoped to Nitro rate limiting. | Winston (Architect) |

## Dev Agent Record
_Not yet worked._
