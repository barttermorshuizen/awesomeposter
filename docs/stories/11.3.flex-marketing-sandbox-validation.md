# Story 11.3: Marketing Capability Sandbox Validation

## Status
Ready for dev

## Story
**As a** flex QA lead,  
**I want** to validate the marketing capability catalog end-to-end through the flex sandbox and runtime telemetry,  
**so that** we can confirm the six-capability set executes reliably, surfaces accurate planner events, and documents any defects before launch.

**Dependencies:** Story 11.1 (capability taxonomy) and Story 11.2 (catalog rip & replace) completed. (`docs/stories/11.1.flex-marketing-capability-taxonomy.md`, `docs/stories/11.2.flex-marketing-capability-catalog.md`)

## References
- `docs/prd/epic-flex-marketing-agency-capabilities.md`
- `docs/stories/11.1.flex-marketing-capability-taxonomy.md`
- `docs/stories/11.2.flex-marketing-capability-catalog.md`
- `docs/architecture/flex-agents-server.md#developer-sandbox`
- `docs/architecture/flex-agents-server.md#10-1-flex-run-debugging`
- `docs/architecture/flex-agents-server.md#10-1-sample-taskenvelope`
- `docs/architecture/flex-agents-server.md#5-9-2-planner-validation-and-feedback-loop`
- `docs/architecture/flex-agents-server.md#13-verification`
- `docs/architecture/flex-agents-server.md#14-risks--open-questions`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/source-tree.md#4-agents-server`

## Acceptance Criteria
1. Execute representative sandbox runs for each of the six marketing capabilities (alone and in composed campaign flows), capturing SSE transcripts and planner diagnostics that demonstrate facet-aligned plans, successful execution, and HITL readiness where applicable; archive the evidence in a validation log under `docs/qa/`. (`docs/architecture/flex-agents-server.md#developer-sandbox`, `docs/architecture/flex-agents-server.md#5-9-2-planner-validation-and-feedback-loop`)
2. For every run, collect run snapshots via the debugging endpoint and confirm registry metadata (capability IDs, facet coverage, heartbeat) matches Story 11.2 definitions; document any mismatches or runtime defects with reproduction steps and severity. (`docs/architecture/flex-agents-server.md#10-1-flex-run-debugging`, `docs/stories/11.2.flex-marketing-capability-catalog.md`)
3. Execute the flex verification test suites plus targeted Vitest scenarios covering marketing task envelopes, ensuring automated coverage passes and logging results alongside manual findings. (`docs/architecture/flex-agents-server.md#13-verification`)
4. Summarize validation outcomes, open defects, rollback readiness, and residual risks in the architecture marketing capabilities section, highlighting any blockers tied to the epic risk of undiscovered bugs. (`docs/architecture/flex-agents-server.md#14-risks--open-questions`, `docs/prd/epic-flex-marketing-agency-capabilities.md`)

## Tasks / Subtasks
- [ ] Prepare marketing-focused TaskEnvelope scenarios (single-node capability checks and multi-node campaign flows) aligned with Story 11.1 facet definitions. (AC 1) (`docs/stories/11.1.flex-marketing-capability-taxonomy.md`)
- [ ] Run sandbox sessions for each capability, export SSE transcripts, and record planner diagnostics/plan graphs per run. (AC 1) (`docs/architecture/flex-agents-server.md#developer-sandbox`)
- [ ] Use the flex run debugging endpoint to capture snapshots, verifying capability metadata, facet coverage, and plan versions; log discrepancies with reproduction steps. (AC 2) (`docs/architecture/flex-agents-server.md#10-1-flex-run-debugging`)
- [ ] Execute automated verification suites and add focused Vitest specs for marketing envelopes if gaps are identified. (AC 3) (`docs/architecture/flex-agents-server.md#13-verification`)
- [ ] Compile a validation report in `docs/qa/marketing-capabilities-validation.md` summarizing coverage, defects, and rollback recommendations. (AC 4) (`docs/prd/epic-flex-marketing-agency-capabilities.md`)
- [ ] Update the architecture marketing capabilities subsection with validation status, documented risks, and links to the QA report. (AC 4) (`docs/architecture/flex-agents-server.md#14-risks--open-questions`)

## Story Context
- Epic requires end-to-end validation of the marketing capability set to surface latent sandbox or registry bugs prior to rollout. (`docs/prd/epic-flex-marketing-agency-capabilities.md`)
- Sandbox tooling streams planner and execution events over SSE while relying on shared capability metadata and facet contracts. (`docs/architecture/flex-agents-server.md#developer-sandbox`)
- Debugging endpoints provide persisted snapshots for diagnosing plan revisions, operator metadata, and node outcomes. (`docs/architecture/flex-agents-server.md#10-1-flex-run-debugging`)

## Dev Notes
- Sandbox validation should honor existing feature flags and authentication flows; reuse `postFlexEventStream` helpers for transcript capture. [Source: architecture/flex-agents-server.md#developer-sandbox]
- Planner diagnostics and node snapshots include facet provenance and capability metadata crucial for confirming taxonomy alignment. [Source: architecture/flex-agents-server.md#5-9-2-planner-validation-and-feedback-loop]
- When defects arise, log precise reproduction details (TaskEnvelope payload, planner diagnostics, run snapshot) to streamline remediation in follow-up stories. [Source: architecture/flex-agents-server.md#14-risks--open-questions]
- Maintain TypeScript, Nitro, and testing standards for any helper scripts or spec additions produced during validation. [Source: architecture/tech-stack.md#1-core-runtime-components] [Source: architecture/coding-standards.md#4-agents-server-standards]
- Store validation artifacts and QA documentation under `docs/qa/` consistent with project structure guidance. [Source: architecture/source-tree.md#4-agents-server]

## Project Structure Notes
- Validation scripts or helper utilities should live under `packages/flex-agents-server/tests` or `packages/flex-agents-server/__tests__/` as appropriate, while QA documentation belongs in `docs/qa/marketing-capabilities-validation.md`. [Source: architecture/source-tree.md#4-agents-server]

## Testing
- Execute `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/facets/facet-contracts.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts` and include any new marketing envelope specs. [Source: architecture/flex-agents-server.md#13-verification]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 0.1 | Draft outlining validation scope and reporting requirements for marketing capabilities. | Scrum Master |
