# Story 8.6: Flex Telemetry & Logging Parity

## Status
Draft

## Story
**As a** reliability engineer,  
**I want** flex runs to emit structured telemetry and logs aligned with the legacy orchestrator,  
**so that** monitoring dashboards and alerting continue to function when flex flows are enabled.

## Acceptance Criteria
1. Flex server emits `FlexEvent` frames and structured logs for planner lifecycle, node execution, policy triggers, HITL, validation, and completion, including correlation IDs, plan version, and facet provenance fields. (`docs/architecture/flex-agents-server.md:198`)
2. Metrics counters and histograms capture planner requests, plan rejections, policy triggers, HITL actions, validation retries, node duration, and completion status, feeding the existing telemetry pipeline. (`docs/architecture/flex-agents-server.md:210`)
3. Telemetry service exposes an in-memory event stream (or queue) that surfaces planner lifecycle and policy-triggered events for future dashboards while maintaining legacy naming conventions. (`docs/architecture/flex-agents-server.md:217`)
4. Documentation lists new event types, log fields (including facet provenance), metric names, and dashboard guidance for observability teams. (`docs/architecture/flex-agents-server.md:220`)

## Tasks / Subtasks
- [ ] Instrument planner, execution engine, policy engine, and HITL flows to log lifecycle events with correlation IDs, plan version, capability ID, and facet provenance (AC 1).
- [ ] Emit metrics counters/histograms for planner requests/rejections, policy triggers, HITL actions, validation retries, node durations, and run completion (AC 2).
- [ ] Extend `TelemetryService` to broadcast planner/policy events over an in-memory stream while keeping SSE payloads backward compatible (AC 1, AC 3).
- [ ] Update documentation/runbooks with event schemas, metric names, and dashboard guidance for observability teams (AC 4).
- [ ] Add snapshot/unit tests verifying log schemas and metric emission, including facet provenance fields (AC 1, AC 2).
- [ ] Coordinate with observability team to validate ingestion and update dashboards/alerts (AC 2, AC 4).

## Story Context

**Existing System Integration:**
- Integrates with: Planner lifecycle (Story 8.14), policy engine (Story 8.9), execution engine, HITL gateway, persistence signals, Winston logging, telemetry pipeline, SSE consumers.
- Technology: TypeScript, Winston, metrics emitters, existing logging middlewares.
- Follows pattern: Legacy agents server log structure/metrics naming extended with planner events.
- Touch points: PlannerService, ExecutionEngine, PolicyNormalizer, TelemetryService, SSE emission, logging configuration.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Each `FlexEvent` (planner lifecycle, node execution, policy trigger, HITL, validation, completion) has a corresponding structured log entry with `eventType`, `runId`, `planVersion`, `nodeId`, `capabilityId`, `facetProvenance`, `status`, and `durationMs`.
2. Metrics include counters/histograms for planner requests/rejections, policy triggers, HITL actions, validation retries, node durations, and run completion outcomes.
3. Telemetry service aggregates events – including planner lifecycle and policy triggers – for optional dashboard streaming (in-memory bus/queue).

### Integration Requirements
4. Logging configuration respects existing env vars (`LOG_LEVEL`, `JSON_LOGS`) and writes to the same sinks while adding facet provenance fields.
5. Documentation references new metric/event names and any required dashboard updates.
6. No regression to legacy logging when flex server is disabled; metrics remain namespaced (`flex.*`).

### Quality Requirements
7. Snapshot/unit tests ensure log format (including facet provenance) doesn’t drift (use test logger).
8. SSE frames remain backward compatible (type/id/timestamp/payload) while carrying new planner lifecycle events.
9. Observability checklist completed with ops confirmation / updated dashboards.

## Technical Notes
- **Integration Approach:** Extend existing logging middleware and telemetry utilities to include planner lifecycle, policy triggers, and facet provenance while sharing logic with legacy server when possible.
- **Existing Pattern Reference:** Legacy orchestrator telemetry plus hybrid planner sequence (`docs/architecture/flex-agents-server.md:217`).
- **Key Constraints:** Avoid double-counting metrics when flex and legacy servers run concurrently; namespace metrics (`flex.*`) and ensure facet provenance doesn’t leak sensitive data.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested (legacy logging unaffected)
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (unit/snapshot)
- [ ] Documentation updated (telemetry spec + runbook)

## Risk and Compatibility Check
- **Primary Risk:** Inconsistent log schema confusing dashboards.
- **Mitigation:** Mirror legacy schema, add tests, involve observability team early.
- **Rollback:** Disable flex logging via feature flag or revert instrumentation; legacy monitoring unaffected.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Flex logs/metrics show up in existing dashboards with minimal configuration changes.
2. Operators can trace runs using correlation IDs across logs and SSE streams.
3. Legacy logging behavior remains stable.

## Important Notes
- Coordinate with SRE to schedule dashboard updates once metric names are finalized.
- Consider shipping sample queries (e.g., Loki/Grafana) to expedite observability adoption.
