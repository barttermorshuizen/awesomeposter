# Story 8.6: Flex Telemetry & Logging Parity

## Status
Ready for Review

## Story
**As a** reliability engineer,  
**I want** flex runs to emit structured telemetry and logs aligned with the legacy orchestrator,  
**so that** monitoring dashboards and alerting continue to function when flex flows are enabled.

## Acceptance Criteria
1. Flex server emits `FlexEvent` frames and structured logs for planner lifecycle, node execution, policy triggers, HITL, validation, and completion, including correlation IDs, plan version, and facet provenance fields. (`docs/architecture/flex-agents-server.md:198`)
2. Metrics counters and histograms capture planner requests, plan rejections, policy triggers, HITL actions, validation retries, node duration, and completion status, feeding the existing telemetry pipeline. (`docs/architecture/flex-agents-server.md:210`)
3. Telemetry service exposes an in-memory event stream (or queue) that surfaces planner lifecycle and policy-triggered events for future dashboards while maintaining legacy naming conventions. (`docs/architecture/flex-agents-server.md:217`)
4. Documentation lists new event types, log fields (including facet provenance), metric names, and dashboard guidance for observability teams. (`docs/architecture/flex-agents-server.md:220`)

## Tasks / Subtasks
- [x] Instrument planner, execution engine, policy engine, and HITL flows to log lifecycle events with correlation IDs, plan version, capability ID, and facet provenance (AC 1).
- [x] Emit metrics counters/histograms for planner requests/rejections, policy triggers, HITL actions, validation retries, node durations, and run completion (AC 2).
- [x] Extend `TelemetryService` to broadcast planner/policy events over an in-memory stream while keeping SSE payloads backward compatible (AC 1, AC 3).
- [x] Update documentation/runbooks with event schemas, metric names, and dashboard guidance for observability teams (AC 4).
- [x] Add snapshot/unit tests verifying log schemas and metric emission, including facet provenance fields (AC 1, AC 2).
- [ ] Coordinate with observability team to validate ingestion and update dashboards/alerts (AC 2, AC 4).

## Story Context

**Existing System Integration:**
- Integrates with: Planner lifecycle (Story 8.14), policy engine (Story 8.9), execution engine, HITL gateway, persistence signals, Winston logging, telemetry pipeline, SSE consumers.
- Technology: TypeScript, Winston, metrics emitters, existing logging middlewares.
- Follows pattern: Legacy agents server log structure/metrics naming extended with planner events.
- Touch points: PlannerService, ExecutionEngine, PolicyNormalizer, TelemetryService, SSE emission, logging configuration.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Each `FlexEvent` (planner lifecycle, node execution, policy trigger, HITL, validation, completion) has a corresponding structured log entry with `eventType`, `runId`, `planVersion`, `nodeId`, `capabilityId`, `facetProvenance`, `status`, and `durationMs`.
2. Metrics include counters/histograms for planner requests/rejections, policy triggers, HITL actions, validation retries, node durations, and run completion outcomes.
3. Telemetry service aggregates events – including planner lifecycle and policy triggers – for optional dashboard streaming (in-memory bus/queue).

### Integration Requirements
4. Logging configuration respects existing env vars (`LOG_LEVEL`, `JSON_LOGS`) and writes to the same sinks while adding facet provenance fields.
5. Documentation references new metric/event names and any required dashboard updates.
6. No regression to legacy logging when flex server is disabled; metrics remain namespaced (`flex.*`).

### Quality Requirements
7. Snapshot/unit tests ensure log format (including facet provenance) doesn’t drift (use test logger).
8. SSE frames remain backward compatible (type/id/timestamp/payload) while carrying new planner lifecycle events.
9. Observability checklist completed with ops confirmation / updated dashboards.

## Technical Notes
- **Integration Approach:** Extend existing logging middleware and telemetry utilities to include planner lifecycle, policy triggers, and facet provenance while sharing logic with legacy server when possible.
- **Existing Pattern Reference:** Legacy orchestrator telemetry plus hybrid planner sequence (`docs/architecture/flex-agents-server.md:217`).
- **Key Constraints:** Avoid double-counting metrics when flex and legacy servers run concurrently; namespace metrics (`flex.*`) and ensure facet provenance doesn’t leak sensitive data.

## Definition of Done
- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested (legacy logging unaffected)
- [x] Code follows existing patterns and standards
- [x] Tests pass (unit/snapshot)
- [x] Documentation updated (telemetry spec + runbook)

## Risk and Compatibility Check
- **Primary Risk:** Inconsistent log schema confusing dashboards.
- **Mitigation:** Mirror legacy schema, add tests, involve observability team early.
- **Rollback:** Disable flex logging via feature flag or revert instrumentation; legacy monitoring unaffected.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Flex logs/metrics show up in existing dashboards with minimal configuration changes.
2. Operators can trace runs using correlation IDs across logs and SSE streams.
3. Legacy logging behavior remains stable.

## Important Notes
- Coordinate with SRE to schedule dashboard updates once metric names are finalized.
- Consider shipping sample queries (e.g., Loki/Grafana) to expedite observability adoption.

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts

### Completion Notes List
- Introduced `TelemetryService` to enrich Flex events with correlation IDs, plan versions, facet provenance, structured logging parity, and lifecycle subscriptions while capturing counters/histograms.
- Instrumented `FlexRunCoordinator` and `FlexExecutionEngine` to route all telemetry through the new service, emit duration metrics, and attach provenance/planner metadata to HITL, policy, validation, and completion events.
- Extended shared Flex schema to carry optional `planVersion` and `facetProvenance` fields and updated documentation with metric names plus dashboard guidance for observability teams.
- Added dedicated telemetry Vitest coverage and refreshed coordinator tests to assert provenance fields and metrics without regressing resume/HITL flows.
- Pending SRE sign-off: prepared guidance but coordination remains outstanding for dashboard updates.
- Restored HITL telemetry parity by enriching request/resolution events with plan version + facet provenance (including normalized node ID matching) so dashboards retain provenance context.
- Hardened coordinator specs to cover HITL pause/resume provenance expectations.

### File List
- packages/shared/src/flex/types.ts
- packages/flex-agents-server/src/services/telemetry-service.ts
- packages/flex-agents-server/src/services/flex-run-coordinator.ts
- packages/flex-agents-server/src/services/flex-execution-engine.ts
- packages/flex-agents-server/__tests__/telemetry-service.spec.ts
- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts
- docs/architecture/flex-agents-server.md
- docs/stories/8.6.flex-telemetry.md

## QA Results
- **Decision:** PASS
- **Findings:** Telemetry emits facet provenance and plan version for HITL request/resolution events, and failure paths now stream explicit completion status so dashboards exit gracefully.
- **Notes:** SSE consumers observe a final `complete` frame with status metadata for both success and failure states.

### Review Date: 2025-10-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Telemetry service centralizes logging, metrics, and SSE emission with shared enrichment, keeping node/policy events consistent with legacy naming.
- Flex execution engine now emits duration metrics and includes provenance for planner, node, policy, validation, and completion frames, matching the updated schema contracts.
- HITL request/resolution events reuse normalized node IDs to attach facet provenance and plan version metadata, restoring observability parity.

### Refactoring Performed
- None (review-only).

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ – `npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`
- All ACs Met: ✓

### Requirements Traceability
- AC1 → HITL request/resolution events include facet provenance, plan version, and completion status across SSE/log pipelines.
- AC2 → Metrics counters/histograms cover planner, policy, HITL, validation, and run status flows.
- AC3 → `TelemetryService.subscribeToLifecycle` exposes planner/policy stream; unit test verifies filtering.
- AC4 → Architecture doc enumerates new events/metrics and dashboard guidance.

### Improvements Checklist
- [x] Attach facet provenance (and reuse plan version metadata) when emitting HITL request/resolution events so dashboards remain parity-complete.
- [x] Add a regression test that exercises a HITL pause to assert the enriched telemetry payload.

### Security Review
- PASS – Logging/metrics additions reuse existing Winston logger without exposing new secrets.

### Performance Considerations
- PASS – In-memory metrics counters/histograms have constant-time updates and reset hooks for tests.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/8.6-flex-telemetry.yml

### Recommended Status
✗ Changes Required
