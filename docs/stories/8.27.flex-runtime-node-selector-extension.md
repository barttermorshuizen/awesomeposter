# Story 8.27: Flex Runtime Node Selector Extension

## Status
Ready for dev

## Story
**As a** flex orchestrator maintainer,  
**I want** runtime policies to target plan nodes by agent traits and graph relations instead of brittle planner-generated IDs,  
**so that** TaskEnvelopes can express resilient control flow (e.g., “retry the previous QA agent output”) even when the planner regenerates node identifiers.

**Dependencies:** Coordinate with Story 8.26 (variant count policy removal) to avoid conflicting updates in shared policy types. Upcoming Node Selector stories will build on the relation primitives defined here.

## Acceptance Criteria
1. `@awesomeposter/shared` extends the canonical `NodeSelector` schema to support `agent`, `kind`, `capabilityId`, and a nested `relation.direction` + `relation.filter` object while keeping `nodeId` optional for backwards compatibility; updated Zod validators and documentation reflect the new selector grammar. (`docs/architecture/flex-agents-server.md#53-taskpolicies`, `docs/architecture/source-tree.md#5-shared-libraries`)
2. Flex runtime selector resolution locates target nodes using the new relation hints (`previous`, `next`, `nearest`) and filter features so runtime policies no longer depend on planner-stable node IDs; planner, execution engine, and telemetry continue to agree on selected nodes. (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#54-plangraph`)
3. Runtime `Action` handling supports `goto` fallbacks by honoring optional `onEmpty` and `maxAttempts` fields, ensuring policies define deterministic behavior when a selector yields no node. (`docs/architecture/flex-agents-server.md#53-taskpolicies`, `docs/architecture/flex-agents-server.md#7-execution-flow`)
4. Vitest suites cover selector expansion (relation traversal, agent filters) and fallback behavior, preventing regressions in planner/runtime coordination. (`docs/architecture/coding-standards.md#7-testing-expectations`)
5. Architecture documentation in `docs/architecture/flex-agents-server.md` (and any linked selector references) is updated to describe the expanded `NodeSelector` schema and `goto` fallback behavior, keeping contract readers aligned with the implementation. (`docs/architecture/flex-agents-server.md#53-taskpolicies`)

## Tasks / Subtasks
- [ ] Update `packages/shared/src/flex/types.ts` (and related Zod schemas) to encode the extended `NodeSelector` structure and new `goto` fields, refreshing architecture snippets accordingly. (AC 1, AC 3) (`docs/architecture/source-tree.md#5-shared-libraries`, `docs/architecture/flex-agents-server.md#53-taskpolicies`)
- [ ] Implement selector resolution utilities in `packages/flex-agents-server/src/services` (or shared helpers) that evaluate relation directions and filters against the active `PlanGraph`, falling back gracefully when no node matches. (AC 2) (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/flex-agents-server.md#54-plangraph`)
- [ ] Wire the updated helpers into runtime policy evaluation and telemetry so planner/execution flows honor relation-based `goto` navigation and emit consistent frames. (AC 2) (`docs/architecture/flex-agents-server.md#7-execution-flow`)
- [ ] Expand Vitest coverage for policy validation, selector resolution, and `goto` fallback decisions (including `onEmpty` chains and `maxAttempts` stop conditions). (AC 4) (`docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Refresh `docs/architecture/flex-agents-server.md` (and related references) so the documented `NodeSelector` and `Action` definitions match the new schema and fallback semantics. (AC 5) (`docs/architecture/flex-agents-server.md#53-taskpolicies`)

## Story Context
- **Existing System Integration:** Runtime policies and planner actions operate inside `packages/flex-agents-server`, consuming shared TaskEnvelope and PlanGraph types. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- **Current Limitation:** `NodeSelector` presently only exposes `nodeId`, `kind`, and `capabilityId`, making policies brittle when planner-regenerated IDs change between attempts. `[Source: docs/architecture/flex-agents-server.md#53-taskpolicies]`
- **Planner Collaboration:** Plan graph traversal and runtime execution must remain aligned so selector relations map onto the documented node metadata lifecycle. `[Source: docs/architecture/flex-agents-server.md#7-execution-flow]`

## Dev Notes
- **Previous Story Insights:** No Dev Agent Record updates are available from Story 8.26.  
- **Data Models:** Plan graphs and runtime policy persistence already capture node metadata; extending selectors must respect the documented PlanGraph shape. `[Source: docs/architecture/flex-agents-server.md#54-plangraph]`
- **API Specifications:** Clients continue to POST TaskEnvelopes to `/api/v1/flex/run.stream`; schema validation must accept the richer selector structure without breaking existing payloads. `[Source: docs/architecture/flex-agents-server.md#4-high-level-architecture]`
- **Component Specifications:** Selector resolution touches planner/runtime services and shared type validators; ensure helpers stay colocated per the agents server source tree guide. `[Source: docs/architecture/source-tree.md#4-agents-server]`
- **File Locations:** Shared contract updates live under `packages/shared/src/flex/`; runtime behavior updates belong in `packages/flex-agents-server/src/services` or adjacent utilities. `[Source: docs/architecture/source-tree.md#5-shared-libraries]` `[Source: docs/architecture/source-tree.md#4-agents-server]`
- **Testing Requirements:** Follow Vitest test strategy for backend logic, asserting relation selectors resolve intended nodes and fallback actions trigger as defined. `[Source: docs/architecture/coding-standards.md#7-testing-expectations]`
- **Technical Constraints:** Maintain the documented TypeScript + Nitro stack while enhancing shared schemas and runtime services. `[Source: docs/architecture/tech-stack.md#1-core-runtime-components]`

## Project Structure Notes
- Keep shared selector schema updates in `packages/shared/src/flex`, runtime service logic in `packages/flex-agents-server/src/services`, and architecture documentation synchronized so consumers understand the richer selector grammar. `[Source: docs/architecture/source-tree.md#5-shared-libraries]` `[Source: docs/architecture/source-tree.md#4-agents-server]`
