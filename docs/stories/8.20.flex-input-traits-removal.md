# Story 8.20: Flex Capability Input Traits Removal

## Status
Approved

## Story
**As a** flex capability registry maintainer,  
**I want** to remove the unused `inputTraits` metadata from capability registrations,  
**so that** the planner, registry, and documentation rely solely on facet contracts and supported scenarios without redundant trait hints.

## Acceptance Criteria
1. `CapabilityRegistrationSchema` and related shared types drop the `inputTraits` field, rejecting registrations that still send the field and ensuring the documented payload lists only required capability metadata. (`docs/architecture/flex-agents-server.md#5-6-2-registration-payload`)
2. Flex capability registry services, repository mappings, and Drizzle schema remove persistence of `inputTraits`, including a migration that deletes the `input_traits_json` column while keeping registry upserts and snapshots aligned with the documented data model. (`docs/architecture/flex-agents-server.md#9-data-model--persistence`, `docs/architecture/flex-agents-server.md#9-1-capability-registration-flow`)
3. Planner, execution, and scoring flows operate with facet contracts, scenarios, and cost metadata only; automated tests confirm no code paths read `inputTraits` and capability selection still follows the documented facet-based plan assembly. (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`, `docs/architecture/flex-agents-server.md#6-component-responsibilities`)
4. Agent capability exports, architecture documentation, and registry samples eliminate `inputTraits`, replacing references with facet/scenario guidance so published documentation matches live payloads. (`docs/architecture/flex-agents-server.md#5-6-2-registration-payload`, `docs/architecture/flex-agents-server.md#9-1-capability-registration-flow`)

## Tasks / Subtasks
- [ ] Update `@awesomeposter/shared` capability registration schemas/types to remove `inputTraits` and tighten Zod validation so lingering payloads surface descriptive errors. (AC 1) (`docs/architecture/flex-agents-server.md#5-6-2-registration-payload`)
- [ ] Create a Drizzle migration and update `packages/db` schema plus flex capability repository to eliminate the `input_traits_json` column and related serialization logic. (AC 2) (`docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- [ ] Sweep flex agents server services, planner helpers, and tests to remove `inputTraits` usage while asserting facet/scenario metadata still drive capability selection. (AC 3) (`docs/architecture/flex-agents-server.md#5-7-facet-based-plan-assembly`)
- [ ] Prune `inputTraits` from agent capability registration exports, shared samples, and architecture docs, adding documentation updates that clarify how scenarios and facets replace trait hints. (AC 4) (`docs/architecture/flex-agents-server.md#9-1-capability-registration-flow`)

## Dev Notes
- **Previous Story Insights**: The architectureâ€™s registration payload currently lists `inputTraits` as optional locale/format hints, which becomes redundant once facet contracts and scenario metadata cover capability discovery. `[Source: architecture/flex-agents-server.md#5-6-2-registration-payload]`
- **Data Models**: Capability metadata persists in the `flex_capabilities` table; dropping `inputTraits` requires keeping the table aligned with the documented data model. `[Source: architecture/flex-agents-server.md#9-data-model--persistence]`
- **API Specifications**: Agents register through `POST /api/v1/flex/capabilities/register`; the flow must validate payloads without `inputTraits` while maintaining upsert behavior. `[Source: architecture/flex-agents-server.md#9-1-capability-registration-flow]`
- **Component Specifications**: Capability registry caching, planner selection, and execution orchestration consume facet contracts and scenario metadata owned by these services. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`
- **File Locations**: Shared capability contracts live under `packages/shared/src/`, while registry and planner services reside in `packages/flex-agents-server/src/` per the source tree guide. `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#4-agents-server]`
- **Testing Requirements**: Follow the documented Vitest strategy when updating registry, planner, and agents server suites to ensure coverage for the removal. `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`
- **Technical Constraints**: Maintain TypeScript-first implementation with strict typing and Zod validation consistent with coding standards. `[Source: architecture/coding-standards.md#1-language--module-conventions]`

## Project Structure Notes
- Keep shared schema changes in `packages/shared`, Drizzle updates in `packages/db`, and server logic in `packages/flex-agents-server` to stay aligned with the documented workspace layout. `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#4-agents-server]`

## Testing
- `npm run test:unit -- packages/shared/__tests__/flex/capability-registration.spec.ts packages/flex-agents-server/__tests__/flex-capability-registry.spec.ts packages/flex-agents-server/__tests__/flex-planner.spec.ts` `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-27 | 0.1 | Initial draft scoping removal of flex capability `inputTraits`. | Scrum Master |
