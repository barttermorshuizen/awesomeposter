# Story 3.2: Normalize Ingested Content

## Status
Done

## Story
**As the** discovery pipeline,
**I want** to normalize fetched items into a consistent schema,
**so that** downstream scoring and dashboards can rely on clean data.

### Dependencies
- Story 3.1 must be complete so `server/jobs/discovery/ingest-sources.ts` emits raw fetch payloads into the ingestion job queue.
- Postgres migrations for `discovery_items` and `discovery_ingest_runs` from the architecture baseline must be applied.

## Acceptance Criteria
1. Normalized record includes `id`, `clientId`, `sourceId`, `title`, `url`, `publishedAt`, `fetchedAt`, `extractedBody`, `rawHash`.
2. Source metadata captures content type (`article`, `rss`, `youtube`) and stores structured fields such as `channelId` or `feedUrl` when applicable.
3. When publication date is missing, default to fetch timestamp and mark `publishedAtSource="fallback"`.
4. HTML/markup boilerplate (nav, ads) stripped; body or description truncated to 5,000 characters max while retaining sentences.
5. YouTube video entries map description and (when available) transcript into `extractedBody`; RSS entries map feed summary/body using consistent sanitization.
6. Normalized entities persisted to `discovery_items` (status `pending_scoring`) with `raw_payload_json`, `normalized_json`, and `source_metadata_json` populated, and available to the scoring service within 5 minutes of fetch completion.
7. Adapter failures log an entry in `discovery_ingest_runs.metrics_json` and emit an `ingest.error` telemetry frame while skipping only the faulty item.

## Tasks / Subtasks
- [x] Implement normalization adapters in `packages/shared/src/discovery/ingestion.ts`, wiring shared helpers (Readability, RSS parser, YouTube API) so each returns `{ rawPayload, normalized, sourceMetadata }` per architecture spec (AC 4, AC 5, AC 7).
- [x] Extend Drizzle models/repositories under `packages/db/src/discovery/` to persist `discovery_items` and link to `discovery_sources`; include hashing utility that stores `rawHash` for change detection (AC 1, AC 2, AC 6).
- [x] Update `server/jobs/discovery/ingest-sources.ts` to call adapters, write to `discovery_items` with `pending_scoring` status, and upsert ingestion run metrics/telemetry (AC 3, AC 6, AC 7).
- [x] Surface normalized items to scoring by reusing the existing repository read that polls `discovery_items` (`pending_scoring`) so no new queue is required (AC 6).
- [x] Create fixtures and unit tests covering HTML boilerplate stripping (smart quotes sanitization), RSS entries missing publish dates, YouTube transcripts absent/present, and hash change detection (AC 4, AC 5, AC 7).

## Dev Notes
- Keep extraction deterministic; avoid locale-specific features since English-only.
- Align with repo ASCII guidelines; sanitize smart quotes if needed.
- HTML extraction should rely on the Readability helper outlined in `docs/architecture/discovery-agent-backend.md#responsibilities-by-layer` and fall back to cheerio sanitization when Readability fails.
- RSS adapter should normalize summaries via the sanitizer rules described in `docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#adapter-matrix`.
- YouTube adapter must request transcripts through the shared YouTube service; when unavailable, rely on description text and tag the metadata with `transcriptAvailable=false`.

### Edge Cases & Assumptions
- Missing `publishedAt` should set `publishedAtSource="fallback"` and derive the timestamp from `fetchedAt` while preserving nullability in the raw payload for analytics.
- Malformed HTML or RSS that fails parsing should emit an adapter failure with reason `parser_error` without halting the batch; retry logic is handled by Story 3.3.
- Duplicate detections compare `rawHash`; identical hashes should short-circuit persistence and update the ingestion run metrics with `skippedDuplicate` counts.

### Testing
- Unit: parse sample articles with and without metadata, ensuring 5,000 character truncation preserves sentence boundaries.
- Unit: RSS fixtures covering missing publish date, summary-only feeds, and non-ASCII characters sanitized to ASCII.
- Unit: YouTube fixtures covering description-only, transcript-present, and transcript-unavailable paths with metadata flags asserted.
- Integration: pipeline test from fetch stub → normalized record persisted in `discovery_items` and visible to scoring repository within latency budget.
- Integration: verify `ingest.error` telemetry fired for failed adapter while other items succeed.

## References
- `docs/architecture/discovery-agent-backend.md#responsibilities-by-layer`
- `docs/architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#adapter-matrix`
- `docs/architecture/discovery_agent_backend/data-model-additions.md`
- `packages/shared/src/discovery/ingestion.ts`
- `packages/shared/src/discovery.ts`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 0.2 | Added dependencies, detailed implementation guidance, and expanded testing notes. | SM |
| 2025-03-29 | 0.1 | Draft for Epic: Ingestion & Normalization. | PM |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit

### Completion Notes List
- Replaced the Unicode ellipsis emitted by `createExcerpt` with an ASCII `'...'` suffix to satisfy QA guidance and reran the unit test suite.
- Wired the YouTube ingestion adapter to translate public channel/playlist URLs into Data API calls using the shared helper and `YOUTUBE_API_KEY`, including handle resolution coverage.

### File List
- packages/shared/src/discovery/normalization.ts
- packages/shared/src/discovery/adapters/youtube.ts
- packages/shared/src/discovery/youtube.ts
- packages/shared/src/discovery/__tests__/normalization.spec.ts
- packages/shared/src/discovery/__tests__/youtube-api.spec.ts
- packages/shared/src/discovery/ingestion.ts
- packages/shared/src/index.ts
- server/jobs/discovery/ingest-sources.ts
- docs/stories/3.2.ingestion-normalize-schema.md

## QA Results

### Review Date: 2025-10-05
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ Concern resolved: `packages/shared/src/discovery/normalization.ts:128` now emits an ASCII `'...'` suffix, keeping normalized payloads compliant with repository guidelines.

### Test Coverage
- `npm run test:unit` (rerun post-fix)
- Adapters retain focused unit coverage; persistence integration tests remain a deferred improvement (accepted risk).

### NFR Evaluation
- **Maintainability**: PASS – helper change is targeted and keeps sanitization consistent across adapters.
- **Reliability**: PASS – no behavioral regressions observed; hashing and telemetry flows unaffected.

### Recommendation
- Gate: PASS – story cleared for Ready for Done.
