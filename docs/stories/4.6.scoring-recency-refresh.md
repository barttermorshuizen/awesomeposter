# Story 4.6: Recency Score Refresh Scheduler

## Status
Draft

## Story
**As the** discovery scoring maintainer,  
**I want** stale discovery items to have their recency component recomputed on a schedule,  
**so that** relevance scores continue to reflect how fresh each item is long after ingestion.

## Context & Rationale
- Story 4.1 established a reusable scoring utility, yet its recency decay component is only evaluated when ingestion first records an item, causing freshness to remain static as time passes.
- Story 4.5 wired ingestion to call the scoring utility immediately after new content arrives, but no follow-up job updates the recency component later, leading to inflated scores for aging items.
- This story creates a scheduled refresh workflow that reuses the existing scoring utility so operators can trust that stale items naturally drift down in priority.

## Acceptance Criteria
1. A new Nitro job (e.g., `server/jobs/discovery/refresh-recency.ts`) runs on a configurable cadence via the cron pipeline, selects discovery items whose `discovery_scores.scored_at` exceeds the defined recency refresh window, and re-invokes `scoreDiscoveryItems` so the persisted `score`, `components.recency`, and `scored_at` values reflect current freshness. [Source: architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput] [Source: architecture/discovery_agent_backend/api-contracts-services.md#scoring-utility] [Source: architecture/discovery_agent_backend/data-model-additions.md#data-model-additions]
2. The refresh job honors existing feature-flag gating (`isFeatureEnabled(clientId, "discovery-agent")`) before re-scoring any client batch, records skipped batches when the feature is off, and avoids mutating suppressed or pending items outside of score metadata updates. [Source: architecture/config-management.md#feature-flags] [Source: architecture/discovery_agent_backend/responsibilities-by-layer.md#scheduled-jobs]
3. Each refresh sweep emits structured logs and discovery telemetry summaries (`discovery.score.refreshed`, `discovery.score.failed`) consistent with current ingestion logging conventions so operators can trace updated scores and retry behavior. [Source: architecture/discovery_agent_backend/observability-logging.md#observability-logging]
4. Re-scoring updates persist through the existing repository layer, ensuring downstream SSE frames and API consumers observe the revised score/recency breakdown without violating current transaction boundaries or introducing new persistence paths. [Source: architecture/discovery_agent_backend/responsibilities-by-layer.md#processing-modules]
5. Automated tests cover window selection, feature-flag gating, telemetry/log emission, and persistence of updated scores; docs/runbooks capture configuration knobs (refresh interval, batch size), operational validation steps, and rollback guidance. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy] [Source: architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]

## Tasks / Subtasks
- [ ] Implement repository helper(s) to fetch item IDs whose `discovery_scores.scored_at` pre-dates the configured refresh window while excluding suppressed items. (AC 1, AC 4) [Source: architecture/discovery_agent_backend/data-model-additions.md#data-model-additions]
- [ ] Create `server/jobs/discovery/refresh-recency.ts` to batch stale item IDs, gate by feature flag, reuse `scoreDiscoveryItems`, and persist refreshed scores/recency metadata. (AC 1, AC 2, AC 4) [Source: architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput] [Source: architecture/discovery_agent_backend/api-contracts-services.md#scoring-utility]
- [ ] Integrate structured logging, telemetry emission, and SSE updates for refresh successes/failures following existing ingestion patterns. (AC 3, AC 4) [Source: architecture/discovery_agent_backend/observability-logging.md#observability-logging]
- [ ] Register the cron entry and configuration knobs (refresh cadence, batch size) and document rollout/rollback steps in the scoring implementation notes/runbooks. (AC 1, AC 5) [Source: architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]
- [ ] Add unit/integration tests that exercise stale selection, feature-flag short-circuiting, score persistence, and telemetry/log assertions. (AC 5) [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Dev Notes
- **Previous Story Insights**: Story 4.5 confirmed ingestion already calls the scoring utility and persists results; the refresh job must reuse the same utility/reporting paths rather than duplicating scoring math. [Source: docs/stories/4.5.scoring-ingestion-trigger.md]
- **Data Models**: `discovery_scores` stores `score`, `rationale_json`, and `scored_at`; refresh logic should update these fields in the same transaction scope used during ingestion scoring. [Source: architecture/discovery_agent_backend/data-model-additions.md#data-model-additions]
- **Processing Modules**: Maintain scoring/dedup responsibilities inside the existing utilities and repository wrapper so refreshes stay consistent with ingestion flows. [Source: architecture/discovery_agent_backend/responsibilities-by-layer.md#processing-modules]
- **Scheduled Jobs**: Refresh job should follow the ingestion worker conventions (`withConcurrencyLimit`, per-client batching) to stay within resource bounds and align with existing cron infrastructure. [Source: architecture/discovery_agent_backend/jobs-scheduling-and-throughput.md#jobs-scheduling-and-throughput]
- **Feature Flags**: Use `isFeatureEnabled` to guard per-client refreshes, defaulting to a safe skip when flags are disabled or lookups fail. [Source: architecture/config-management.md#feature-flags]
- **Observability**: Emit logs/events using the same structured logger and SSE hooks employed by ingestion so operators receive consistent telemetry for refresh cycles. [Source: architecture/discovery_agent_backend/observability-logging.md#observability-logging]
- **Project Structure Notes**: Place new job and helpers within `server/jobs/discovery` and shared utilities under `server/utils/discovery` to comply with the source tree guidance. [Source: architecture/source-tree.md#source-tree-guide]
- **Testing Requirements**: Add Vitest coverage for both repository selection logic and job orchestration; reuse the in-memory Drizzle harness for DB assertions. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

### Testing
- Unit: validate repository helpers return the correct stale item sets, respect suppression filters, and honor configurable windows.
- Integration: execute the refresh job against seeded in-memory data to verify feature-flag gating, score updates, telemetry/log emission, and cron batching behavior. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
- Regression: rerun existing ingestion + scoring suites (`server/jobs/__tests__/discovery-ingest-sources.spec.ts`) to ensure refresh additions do not break synchronous scoring paths. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-04-09 | 0.1 | Draft for Epic: Scoring & Deduplication â€“ adds recency refresh scheduler requirements. | SM |

## Dev Agent Record

### Agent Model Used
- _Not yet assigned_

### Debug Log References
- _Not yet run_

### Completion Notes List
- _Not yet started_

### File List
- _None_

## QA Results
_Not yet reviewed._
