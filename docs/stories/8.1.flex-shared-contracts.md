# Story 8.1: Flex Shared Contract Foundations

## Status
Done

## Story
**As a** flex orchestrator integrator,  
**I want** canonical TypeScript definitions for TaskEnvelope, node contracts, capability registration, and flex events in the shared package,  
**so that** planners, agents, and UI components can exchange runtime data without schema drift.

## Acceptance Criteria
1. Shared package exposes `TaskEnvelope`, `NodeContract`, `ContextBundle`, `OutputContract`, and `FlexEvent` types (with Zod schemas) via `@awesomeposter/shared`.
2. Capability registration payload and persisted record types are defined in the same module, covering metadata, cost, heartbeat, and default contracts.
3. New flex exports are re-exported from the package root and compiled successfully (tsc passes once existing unrelated lint issues are ignored).
4. Architecture spec references the shared types and links to the module path so future stories know where to import contracts.

## Tasks / Subtasks
- [x] Add `packages/shared/src/flex/types.ts` defining envelopes, contracts, context bundles, events, and capability registration schemas (AC 1, AC 2).
- [x] Update package index exports and ensure type compilation via `npm --prefix packages/shared run build` (AC 3).
- [x] Cross-reference the flex spec with module path (`docs/architecture/flex-agents-server.md`) to align documentation and types (AC 4).
- [x] Notify agents/orchestrator teams about the new shared contract module (release note or README update) (AC 4).

## Story Context

**Existing System Integration:**
- Integrates with: `@awesomeposter/shared` package consumed by SPA, Nitro API, and existing agents server.
- Technology: TypeScript, Zod, Node ES modules.
- Follows pattern: Shared type definitions co-located with Zod schemas, exported through `index.ts`.
- Touch points: `packages/agents-server`, future `packages/flex-agents-server`, Vue stores that parse SSE events.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Module exports both TypeScript types and Zod validators for TaskEnvelope, OutputContract variants, NodeContract, ContextBundle, FlexEvent, and CapabilityRegistration.
2. OutputContract supports JSON Schema mode and free-form instruction mode with optional hints/examples.
3. CapabilityRegistration includes identifiers, traits, default contract, cost/heartbeat metadata; CapabilityRecord extends it with status timestamps.

### Integration Requirements
4. Shared package build succeeds locally after adding the new module (acknowledging existing unrelated test issues).
5. `docs/architecture/flex-agents-server.md` references the shared module path and stays synchronized with the type names.

### Quality Requirements
6. Types are documented via inline comments or README update explaining usage boundaries.
7. No breaking change to existing exports; adding the new module is additive.
8. Tests or type checks cover the new schemas (tsc run covers shape validation).

## Technical Notes
- **Integration Approach:** Add new module under `packages/shared/src/flex`, re-export from root to keep tree-shaking manageable; run targeted `tsc` compile to ensure definitions emit.
- **Existing Pattern Reference:** Follows existing shared modules like `agent-run.ts` for combined type + schema exports.
- **Key Constraints:** Must remain compatible with ES module resolution (`.js` extensions on imports when necessary); avoid introducing dependencies beyond Zod.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested (shared package build)
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing `tsc` check)
- [ ] Documentation updated (architecture spec and release note)

## Risk and Compatibility Check
- **Primary Risk:** Misaligned schema definitions could mislead orchestrator planning.
- **Mitigation:** Validate shapes with Zod schemas and cross-reference spec; solicit review from orchestrator dev.
- **Rollback:** Revert module addition and index export; no database/app changes.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [ ] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Shared types compile and export without affecting existing consumers.
2. Flex architecture spec points to the shared type module.
3. Teams understand where to import flex contracts for runtime planning.

## Important Notes
- Keep module path stable; future tickets will rely on `@awesomeposter/shared/flex`.
- Ensure JSON Schema contract type allows downstream Ajv integration.

## Dev Agent Record

### Agent Model Used
- Local coding session (no external LLM execution)

### Debug Log References
- None

### Completion Notes List
- Rebuilt `packages/shared/src/flex/types.ts` with documented Zod schemas covering envelopes, node contracts, capability registration, and flex events.
- Confirmed package exports remain additive and compile cleanly via `npm --prefix packages/shared run build`.
- Updated `docs/architecture/flex-agents-server.md` and the repo `README.md` to point agents/orchestrator teams at `@awesomeposter/shared/flex`.

### File List
- packages/shared/src/flex/types.ts
- docs/architecture/flex-agents-server.md
- README.md
- docs/stories/8.1.flex-shared-contracts.md

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-02 | 1.0 | Implemented shared flex contracts, updated documentation references, and notified teams via README. | Dev |

## QA Results

### Review Date: 2025-03-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
#### Strengths
- New flex contract module follows existing shared-package patterns with Zod schemas paired to TypeScript types and clear inline documentation.
- Exports remain additive through `@awesomeposter/shared/flex`, keeping downstream consumers on a single canonical entrypoint.

#### Findings
- JSON Schema support relies on object-based schemas; consider acknowledging boolean-form schemas (`true`/`false`) if future clients depend on the full JSON Schema spec. (Low risk today because current envelopes require structured objects.)

### Requirements Traceability
| AC | Result | Notes |
|----|--------|-------|
| 1 | ✅ | `packages/shared/src/flex/types.ts` defines TaskEnvelope, NodeContract, ContextBundle, OutputContract (including JSON Schema + freeform variants), and FlexEvent Zod schemas/types. |
| 2 | ✅ | CapabilityRegistration and CapabilityRecord schemas cover metadata, cost, heartbeat, preferred models, and persisted status fields. |
| 3 | ✅ | Root index re-exports `./flex/types.js`; `npm --prefix packages/shared run build` succeeds. |
| 4 | ✅ | `docs/architecture/flex-agents-server.md` now references `@awesomeposter/shared/flex`; README highlights the shared module for orchestrator teams. |

### Test Coverage & Evidence
- `npm --prefix packages/shared run build`

### NFR Validation
| Attribute | Status | Notes |
|-----------|--------|-------|
| Security | PASS | No sensitive data paths; schemas remain validation-only helpers. |
| Performance | PASS | Pure schema definitions; no runtime hot path impact. |
| Reliability | PASS | Zod schemas enforce required fields; optional metadata stays typed. |
| Maintainability | PASS | Inline comments and consolidated exports improve discoverability. |

### Risk Summary
- Overall risk: Low. Additive types with minimal runtime surface. Track boolean-schema support as future enhancement if planners encounter such payloads.

### Recommendations
- Monitor incoming envelopes for boolean JSON Schema usage; if encountered, extend `JsonSchemaShapeSchema` to accept boolean literals.

### Gate Recommendation
- PASS – Story meets acceptance criteria; ready for Done once stakeholders acknowledge the low-risk schema note.
