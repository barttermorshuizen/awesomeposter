# Story 12.4: Social Strategist Prompt Synthesis

## Status
Draft

## Story
**As a** flex marketing orchestration lead,  
**I want** the social strategist agentâ€™s prompt scaffold to synthesize retrieval knowledge, analytics insights, and asset inventory context,  
**so that** every strategist brief is grounded in the latest intelligence while preserving existing planner and execution contracts.

**Dependencies:** Requires completion of Story 12.3 to ensure asset inventory helpers and telemetry exist before merging all strategist context streams. (`docs/stories/12.3.flex-social-strategist-asset-inventory-alignment.md`)

## References
- `docs/prd/epic-flex-social-strategist-enhancement.md`
- `docs/stories/12.1.flex-social-strategist-rag-foundation.md`
- `docs/stories/12.2.flex-social-strategist-analytics-integration.md`
- `docs/stories/12.3.flex-social-strategist-asset-inventory-alignment.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`
- `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`
- `docs/architecture/flex-agents-server/13-verification.md`
- `docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`
- `docs/architecture/flex-agents-server/index.md#16-retrieval-knowledge-stores`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/source-tree.md#4-agents-server`

## Acceptance Criteria
1. `ContextBuilder` composes a consolidated strategist context payload that labels retrieval knowledge, analytics insights, and asset inventory data, aligning with the prompt blueprint structure and keeping contracts consistent with existing planner/execution flows. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`, `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
2. Update the `strategist.SocialPosting` prompt assets and capability metadata so merged context renders deterministic sections (knowledge, analytics, assets) while respecting compatibility requirements and facet-driven contracts. (`docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
3. Ensure each context stream offers deterministic fallback copy and telemetry markers when disabled or unavailable, mirroring prior strategist resilience patterns without altering SSE contracts. (`docs/prd/epic-flex-social-strategist-enhancement.md#risk-mitigation`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
4. Extend Vitest coverage to validate prompt synthesis across enabled, partially-disabled, and full-fallback scenarios, asserting telemetry frames and prompt content remain in sync with configured toggles. (`docs/prd/epic-flex-social-strategist-enhancement.md#success-criteria`, `docs/architecture/flex-agents-server/13-verification.md`)
5. Document the strategist prompt synthesis pattern within the flex agents architecture specification, outlining section ordering, configuration hooks, and troubleshooting expectations. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/index.md`)

## Tasks / Subtasks
- [ ] Define the prompt synthesis structure (section labels, ordering, fallback copy) that aligns with the planner prompt blueprint and strategist capability contracts. (AC 1, AC 2, AC 3) (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`)
- [ ] Implement context aggregation within `ContextBuilder` (or supporting helpers) to merge retrieval, analytics, and asset data into a consolidated strategist context payload with deterministic metadata. (AC 1, AC 3) (`docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`, `docs/architecture/source-tree.md#4-agents-server`)
- [ ] Update `packages/flex-agents-server/src/agents/marketing/strategist-social-posting.ts` (and related prompt assets) to render merged context sections and advertise configuration hooks via capability metadata. (AC 2) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
- [ ] Harmonize telemetry and fallback markers so retrieval, analytics, and asset toggles emit consistent status signals over SSE and logs. (AC 3, AC 4) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
- [ ] Add or extend Vitest suites covering prompt synthesis permutations (all enabled, partial disable, full fallback) and confirm prompt content plus telemetry expectations. (AC 4) (`docs/architecture/flex-agents-server/13-verification.md`)
- [ ] Update flex agents architecture documentation with a prompt synthesis section, detailing runtime toggles, fallback semantics, and troubleshooting workflows. (AC 5) (`docs/architecture/flex-agents-server/index.md`)

## Story Context
- Epic goal blends retrieval knowledge, analytics insights, and asset awareness into strategist planning without changing orchestrator contracts. (`docs/prd/epic-flex-social-strategist-enhancement.md`)
- Prompt scaffold updates must leverage existing helper toggles and telemetry patterns introduced in prior stories to avoid regressions. (`docs/prd/epic-flex-social-strategist-enhancement.md#success-criteria`)
- Strategist enhancements stay confined to `packages/flex-agents-server` to honour compatibility requirements across downstream consumers. (`docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements`)

## Dev Notes
- **Previous Story Insights:** Asset integration (Story 12.3) provides deterministic payloads and telemetry markers; reuse these conventions when adding prompt synthesis to prevent drift. [Source: docs/stories/12.3.flex-social-strategist-asset-inventory-alignment.md]
- **Data Models:** Context payloads remain transient in `ContextBundle`, so merged prompt sections should avoid introducing new persisted schema until future stories request it. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle] [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md]
- **API Specifications:** Strategist runs continue to stream over `/api/v1/flex/run.stream`; prompt synthesis telemetry must align with existing SSE frame contracts. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
- **Component Specifications:** `ContextBuilder`, `PlannerService`, and `TelemetryService` coordinate strategist execution; ensure prompt synthesis wiring preserves their responsibilities and existing control flow. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- **File Locations:** Strategist agent modules and helpers live under `packages/flex-agents-server/src/agents/marketing/`; shared utilities or context builders reside alongside `packages/flex-agents-server/src/utils/`. [Source: docs/architecture/source-tree.md#4-agents-server]
- **Testing Requirements:** Extend Vitest coverage in `packages/flex-agents-server/__tests__/` to capture prompt synthesis permutations and regression guardrails. [Source: docs/architecture/flex-agents-server/13-verification.md]
- **Technical Constraints:** Maintain TypeScript strictness, follow agents server standards, and avoid cross-service API changes while introducing prompt synthesis. [Source: docs/architecture/tech-stack.md#1-core-runtime-components] [Source: docs/architecture/coding-standards.md#4-agents-server-standards] [Source: docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements]
- **Documentation Requirements:** Record prompt synthesis behaviour, toggles, and fallback semantics in architecture docs for future strategist enhancements. [Source: docs/architecture/flex-agents-server/index.md]
- **Runtime Practices:** Align retrieval (`FLEX_SOCIAL_STRATEGIST_RETRIEVAL_ENABLED`), analytics, and asset toggles with consistent fallback copy and status markers so operators can diagnose issues quickly. [Source: docs/architecture/flex-agents-server/index.md#16-retrieval-knowledge-stores] [Source: docs/prd/epic-flex-social-strategist-enhancement.md#risk-mitigation] [Source: docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md]

## Project Structure Notes
- Keep prompt synthesis helpers, strategist updates, and tests within the agents server workspace; introduce shared abstractions only when other capabilities need them. [Source: docs/architecture/source-tree.md#4-agents-server]

## Testing
- `npm run test:unit -- packages/flex-agents-server/__tests__/marketing-strategist-retrieval.spec.ts packages/flex-agents-server/__tests__/marketing-strategist-analytics.spec.ts packages/flex-agents-server/__tests__/marketing-strategist-assets.spec.ts packages/flex-agents-server/__tests__/marketing-strategist-prompt-synthesis.spec.ts` (add or extend suites covering prompt synthesis permutations). [Source: docs/architecture/flex-agents-server/13-verification.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 0.1 | Draft story outlining strategist prompt synthesis, telemetry, testing, and documentation updates. | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
