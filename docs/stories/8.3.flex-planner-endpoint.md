# Story 8.3: Flex Run Endpoint & Planner Skeleton

## Status
Approved

## Story
**As a** marketing operator,  
**I want** the flex agents server to accept TaskEnvelopes and stream runtime events,  
**so that** I can trigger dynamic multi-agent plans that respect caller-defined contracts without touching legacy workflows.

## Acceptance Criteria
1. `/api/v1/flex/run.stream` accepts `TaskEnvelope`, validates it with shared schemas, and persists a `flex_runs` record.
2. Planner skeleton builds a `PlanGraph` with context bundles and supports at least one happy-path scenario (LinkedIn post variants) using stub capabilities.
3. SSE stream emits `FlexEvent` frames with the existing envelope signature (`type`, `id`, `timestamp`, `payload`) and new event types (`plan_generated`, `node_start`, `node_complete`, etc.).
4. HITL/resume hooks integrate with existing tables; runs can be paused and resumed using current operator UI.
5. On completion, orchestrator composes artifacts into the caller’s output schema and validates via Ajv before sending the final frame.

## Tasks / Subtasks
- [ ] Implement run controller that validates TaskEnvelope, seeds run IDs, and persists initial state (AC 1).
- [ ] Build planner skeleton that maps envelope objective/policies to mock capability selections and generates `PlanGraph` nodes with contracts (AC 2).
- [ ] Extend execution engine to walk the plan, dispatch context bundles, handle node retries, and emit `FlexEvent` SSE frames (AC 3).
- [ ] Integrate existing HITL persistence with flex run IDs and ensure resume flows rebuild plan context (AC 4).
- [ ] Add Ajv validation step before completion and return structured errors for schema mismatches (AC 5).
- [ ] Provide feature-flagged UI wiring for “Create Post (Flex)” popup to call the new endpoint (AC 3, AC 4).
- [ ] Write integration tests covering happy path, validation failure, and HITL pause/resume edge cases (AC 1-5).

## Story Context

**Existing System Integration:**
- Integrates with: Shared contracts from Story 8.1, capability registry from Story 8.2, HITL tables, Vue `useHitlStore`, Ajv validation utilities.
- Technology: Nitro SSE (H3), TypeScript, Ajv, Winston logging.
- Follows pattern: Legacy orchestrator streaming & persistence, extended for dynamic planning.
- Touch points: Database (`flex_runs`, `flex_plan_nodes`), SSE client store, HITL API.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Endpoint streams a correlation ID and plan metadata at start, then node-level frames until completion; failure events carry actionable messages.
2. Planner supports runtime policy injection from TaskEnvelope and schedules structuring nodes when output contracts require transformation.
3. Execution engine writes plan node state to `flex_plan_nodes` for resumption and telemetry.
4. Output validator retries node execution up to specified attempts before escalating to HITL.

### Integration Requirements
5. HITL resume endpoint works for flex runs without breaking legacy flows; UI recognizes new event types.
6. Feature flag (env var) gates flex popup; turning it off routes back to legacy endpoint.
7. Logging includes run ID, capability IDs, and node status for observability dashboards.

### Quality Requirements
8. Integration tests simulate a full run and assert SSE frame order/content.
9. Error handling covers malformed envelopes, missing capabilities, and schema validation failures.
10. Documentation (README or spec) updated with endpoint usage, curl example, and expected event flow.

## Technical Notes
- **Integration Approach:** Reuse existing orchestrator infrastructure but inject flexible plan builder; use in-memory stubs for capabilities until real agents register.
- **Existing Pattern Reference:** `/api/v1/agent/run.stream` implementation for SSE streaming; HITL resume handlers in current server.
- **Key Constraints:** Maintain existing SSE envelope signature; ensure Ajv schema compilation is cached per run to avoid perf issues.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested (legacy runs unaffected)
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (integration & unit)
- [ ] Documentation updated (endpoint + planner overview)

## Risk and Compatibility Check
- **Primary Risk:** Planner or validation bugs causing inconsistent runs or blocking operators.
- **Mitigation:** Start with controlled happy-path scenario, feature flag UI, and thorough integration tests.
- **Rollback:** Disable flex popup and revert to legacy endpoint; flex runs can be marked aborted in DB.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [ ] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [ ] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Flex endpoint streams a complete happy-path run that aligns with caller schema.
2. HITL/resume flows stay operational for both legacy and flex runs.
3. Operators can toggle flex popup via env flag and observe new planner telemetry.

## Important Notes
- Real specialist agents may not be ready yet; use mocks or minimal capability adapters to validate planning loop.
- Coordinate with QA to plan regression coverage for SSE parsing in the SPA.
