# Story 8.2: Flex Agents Server Scaffold & Capability Registry

## Status
Approved

## Story
**As a** platform engineer,  
**I want** a cloned `flex-agents-server` package with capability registration endpoints and persistence,  
**so that** the new orchestrator can run independently while discovering live agent capabilities at runtime.

## Acceptance Criteria
1. `packages/flex-agents-server` exists as a clone of the current agents server baseline with updated package name, scripts, and build configuration.
2. Capability registry API (`POST /api/v1/flex/capabilities/register`) accepts payloads defined in shared types, validates them, and upserts records in a new `flex_capabilities` table.
3. Registry service caches active capabilities in memory and exposes lookup/filter functions for planner use.
4. Health/logging endpoints and basic Nitro configuration work in dev mode (`npm run dev:flex` or equivalent).

## Tasks / Subtasks
- [ ] Copy `packages/agents-server` to `packages/flex-agents-server`, adjust `package.json`, `nitro.config.ts`, and scripts to avoid namespace clashes (AC 1).
- [ ] Create database migration or Drizzle schema additions for `flex_capabilities` table; wire repository and service layer (AC 2, AC 3).
- [ ] Implement registration route, binding schema validation to `CapabilityRegistrationSchema` and returning registry status (AC 2).
- [ ] Add unit/integration tests covering registration, dedupe, and inactive heartbeat handling (AC 2, AC 3).
- [ ] Update root `package.json` scripts and `docs/architecture/flex-agents-server.md` (capability registration section) to include flex server commands (AC 1, AC 4).
- [ ] Ensure server health route (`/api/v1/health`) and logging align with legacy server patterns (AC 4).

## Story Context

**Existing System Integration:**
- Integrates with: Monorepo shared packages (`@awesomeposter/shared`, `@awesomeposter/db`), Postgres database, existing infrastructure scripts.
- Technology: Nitro (H3), TypeScript, Drizzle ORM, Winston.
- Follows pattern: Legacy agents server file layout and logging conventions.
- Touch points: Database migrations, root npm scripts, future planner modules.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Flex server package builds and runs locally using distinct `npm run dev:flex` command without interfering with legacy agents server.
2. Registration endpoint persists capabilities with timestamps and status flags; repeated registrations update `lastSeenAt`.
3. Registry service exposes API for listing active capabilities and marking entries inactive after heartbeat timeout.
4. Root `npm run dev:all` script runs SPA, API, legacy agents server, and the new flex server concurrently without regression.

### Integration Requirements
4. Database schema addition is additive and shared across services (`@awesomeposter/db` updated accordingly).
5. Root scripts/CI updated to include flex server lint/build commands without breaking existing tasks.
6. Health checks and logging mirror legacy structure so observability tooling requires minimal changes.

### Quality Requirements
7. Unit/integration tests cover registration validation, dedupe, and inactive marking.
8. Swagger/README (or architecture doc) updated with registration endpoint usage.
9. No console warnings or TypeScript errors when running `npm run dev:flex`.

## Technical Notes
- **Integration Approach:** Use Drizzle migration to add `flex_capabilities` with JSON column for metadata; share driver config via `@awesomeposter/db`.
- **Existing Pattern Reference:** `packages/agents-server` service layout; reuse Nitro plugin architecture for request context.
- **Key Constraints:** Avoid hard-coded agent lists; rely solely on registration data. Ensure environment variables are separate (e.g., `FLEX_SERVER_PORT`).

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested (legacy server unaffected)
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (unit/integration for registry)
- [ ] Documentation updated (architecture spec + README)

## Risk and Compatibility Check
- **Primary Risk:** Diverging server code could drift from shared utilities or cause migration conflicts.
- **Mitigation:** Keep shared logic in packages; run DB migrations in dry-run mode before deploy.
- **Rollback:** Remove flex server package and DB table (drop migration) if needed; legacy server remains intact.

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Flex server package runs locally with independent scripts.
2. Capability registry endpoint stores and exposes capability metadata.
3. Legacy agents server continues to function unchanged.

## Important Notes
- Coordinate with infra to provision separate deployment target/port before rollout.
- Ensure registry service is safe for concurrent registrations (idempotent upsert).
