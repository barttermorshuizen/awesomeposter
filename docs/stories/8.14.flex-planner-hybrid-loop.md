# Story 8.14: LLM Planner & Orchestrator Hybrid Loop

## Status
Draft

## Story
**As a** flex orchestration lead,  
**I want** to integrate the LLM planner handshake with the deterministic orchestration components,  
**so that** flex runs can leverage probabilistic planning while retaining enforcement, validation, and replanning guardrails.

## Acceptance Criteria
1. Implement a planning request flow where `FlexRunController` invokes `PlannerService` with normalized policies and capability metadata, receiving a draft plan with facet arrays, system instructions, and rationale. (`docs/architecture/flex-agents-server.md:178`)
2. Add plan validation that checks facet coverage, capability availability, and schema compilation; invalid plans return structured diagnostics to the planner for revision. (`docs/architecture/flex-agents-server.md:183`)
3. Stream planner lifecycle events (`plan_requested`, `plan_generated`, `plan_rejected`) via SSE, aligned with the sequence diagram and telemetry expectations. (`docs/architecture/flex-agents-server.md:217`)
4. Support replanning triggers from execution signals (policy violations, HITL responses) by requesting planner deltas, merging them immutably into the active `PlanGraph`, and persisting new versions. (`docs/architecture/flex-agents-server.md:205`)
5. Ensure `ExecutionEngine` pauses node dispatch while replanning occurs and resumes with updated nodes, emitting `plan_updated` / `policy_triggered` events. (`docs/architecture/flex-agents-server.md:198`)
6. Provide integration tests simulating (a) initial plan acceptance, (b) plan rejection with replan, and (c) mid-run policy-triggered replanning, verifying SSE sequence and persistence state. (`docs/architecture/flex-agents-server.md:210`)
7. Update architecture documentation with the finalized handshake details and any new SSE event definitions. (`docs/architecture/flex-agents-server.md:168`)

## Tasks / Subtasks
- [ ] Implement planner request/response objects (`PlannerDraft`, `PlannerDiagnostics`) shared between controller and planner service (AC 1, AC 2).
- [ ] Extend `FlexRunController` to orchestrate plan requests, handle rejections, and emit SSE events (`plan_requested`, `plan_generated`, `plan_rejected`) (AC 1, AC 3).
- [ ] Add validation pipeline leveraging facet catalog/compiler to approve or reject planner drafts with detailed diagnostics (AC 2).
- [ ] Introduce replanning workflow in `ExecutionEngine` / `PolicyNormalizer` that pauses execution, requests planner deltas, applies plan diffs, and resumes (AC 4, AC 5).
- [ ] Persist plan versions and emit `plan_updated`/`policy_triggered` events through `TelemetryService` and SSE (AC 4, AC 5).
- [ ] Write integration tests covering acceptance/rejection/replanning flows, including SSE verification and persistence assertions (AC 6).
- [ ] Refresh architecture docs (hybrid collaboration section + SSE contract) to reflect new event types and state transitions (AC 7).

## Dev Notes
- **Architecture references:** Sections 5.8 (Planner vs Orchestrator: Hybrid Collaboration) and the Mermaid sequence provide the required handshake and event flow (`docs/architecture/flex-agents-server.md:168-232`).
- **Policy integration:** Coordinate with Story 8.9 modules (`PolicyNormalizer`, `PolicyEngine`) so replanning triggers align with policy evaluations.
- **Persistence:** Use existing plan snapshot infrastructure (Story 8.4) for storing new plan versions; ensure idempotent replay on resume.
- **Telemetry:** `TelemetryService` should emit new planner lifecycle events; align naming with SSE contract (`plan_requested`, `plan_generated`, `plan_rejected`, `plan_updated`, `policy_triggered`).
- **LLM interface:** Planner requests should encapsulate objective, context, normalized policies, and capability metadata; consider including facet catalog references for future prompt tuning.
- **Feature flag:** Keep hybrid planning behind existing flex feature flag until end-to-end behavior is verified.

### Testing
- Integration tests under `packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts` should mock planner responses (success/failure) and assert SSE sequences.
- Extend `flex-run-coordinator.spec.ts` to cover replanning mid-run with policy-triggered deltas.
- Validate persistence using in-memory DB or test doubles to ensure plan versions are recorded and resumes consume the latest version.
- Run `npm run test:unit -- packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-10 | 0.1 | Initial draft for planner/orchestrator hybrid loop integration and replanning workflow. | Scrum Master |
