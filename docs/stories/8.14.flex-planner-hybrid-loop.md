# Story 8.14: LLM Planner & Orchestrator Hybrid Loop

## Status
Done

## Story
**As a** flex orchestration lead,  
**I want** to integrate the LLM planner handshake with the deterministic orchestration components,  
**so that** flex runs can leverage probabilistic planning while retaining enforcement, validation, and replanning guardrails.

## Acceptance Criteria
1. Implement a planning request flow where `FlexRunController` invokes `PlannerService` with normalized policies and capability metadata, receiving a draft plan with facet arrays, system instructions, and rationale. (`docs/architecture/flex-agents-server.md:178`)
2. Add plan validation that checks facet coverage, capability availability, and schema compilation; invalid plans return structured diagnostics to the planner for revision. (`docs/architecture/flex-agents-server.md:183`)
3. Stream planner lifecycle events (`plan_requested`, `plan_generated`, `plan_rejected`) via SSE, aligned with the sequence diagram and telemetry expectations. (`docs/architecture/flex-agents-server.md:217`)
4. Support replanning triggers from execution signals (policy violations, HITL responses) by requesting planner deltas, merging them immutably into the active `PlanGraph`, and persisting new versions. (`docs/architecture/flex-agents-server.md:205`)
5. Ensure `ExecutionEngine` pauses node dispatch while replanning occurs and resumes with updated nodes, emitting `plan_updated` / `policy_triggered` events. (`docs/architecture/flex-agents-server.md:198`)
6. Provide integration tests simulating (a) initial plan acceptance, (b) plan rejection with replan, and (c) mid-run policy-triggered replanning, verifying SSE sequence and persistence state. (`docs/architecture/flex-agents-server.md:210`)
7. Update architecture documentation with the finalized handshake details and any new SSE event definitions. (`docs/architecture/flex-agents-server.md:168`)

### Dependencies
- Story 8.4 (Flex run persistence) for plan snapshot/version storage interfaces.
- Story 8.5 (Flex run interfaces) for resume flows and SSE contracts.
- Story 8.8 (Dynamic plan assembly) for capability registry hydration and planner taxonomy.
- Story 8.9 (Planner policies) for policy trigger semantics and normalized policy inputs.
- Story 8.12 (Facet catalog / contract compiler) for facet validation and schema compilation.

## Tasks / Subtasks
- [x] Implement planner request/response objects (`PlannerDraft`, `PlannerDiagnostics`) shared between controller and planner service (`packages/flex-agents-server/src/planner/planner-types.ts`) (AC 1, AC 2).
- [x] Extend `FlexRunController` to orchestrate plan requests, handle rejections, and emit SSE events (`plan_requested`, `plan_generated`, `plan_rejected`) (`packages/flex-agents-server/src/services/flex-run-coordinator.ts`) (AC 1, AC 3).
- [x] Add validation pipeline leveraging facet catalog/compiler to approve or reject planner drafts with detailed diagnostics (`packages/flex-agents-server/src/services/planner-validation-service.ts`) (AC 2).
- [x] Introduce replanning workflow in `ExecutionEngine` / `PolicyNormalizer` that pauses execution, requests planner deltas, applies plan diffs, and resumes (`packages/flex-agents-server/src/services/flex-execution-engine.ts`, `packages/flex-agents-server/src/services/policy-normalizer.ts`) (AC 4, AC 5).
- [x] Persist plan versions and emit `plan_updated`/`policy_triggered` events through `TelemetryService` and SSE (`packages/flex-agents-server/src/services/flex-run-coordinator.ts`) (AC 4, AC 5).
- [x] Write integration tests covering acceptance/rejection/replanning flows, including SSE verification and persistence assertions (`packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts`, `packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`) (AC 6).
- [x] Refresh architecture docs (hybrid collaboration section + SSE contract) to reflect new event types and state transitions (`docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration`, `docs/architecture/flex-agents-server.md#planner-↔-orchestrator-sequence-mermaid`) (AC 7).

## Dev Notes
- **Architecture references:** Sections 5.8 (Planner vs Orchestrator: Hybrid Collaboration) and the Mermaid sequence provide the required handshake and event flow (`docs/architecture/flex-agents-server.md:168-232`).
- **Policy integration:** Coordinate with Story 8.9 modules (`PolicyNormalizer`, `PolicyEngine`) so replanning triggers align with policy evaluations.
- **Persistence:** Use existing plan snapshot infrastructure (Story 8.4) for storing new plan versions; ensure idempotent replay on resume.
- **Telemetry:** `TelemetryService` should emit new planner lifecycle events; align naming with SSE contract (`plan_requested`, `plan_generated`, `plan_rejected`, `plan_updated`, `policy_triggered`).
- **LLM interface:** Planner requests should encapsulate objective, context, normalized policies, and capability metadata; consider including facet catalog references for future prompt tuning.
- **Feature flag:** Keep hybrid planning behind existing flex feature flag until end-to-end behavior is verified.

### Testing
- Integration tests under `packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts` should mock planner responses (success/failure) and assert SSE sequences.
- Extend `flex-run-coordinator.spec.ts` to cover replanning mid-run with policy-triggered deltas.
- Validate persistence using in-memory DB or test doubles to ensure plan versions are recorded and resumes consume the latest version.
- Run `npm run test:unit -- packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-10 | 0.1 | Initial draft for planner/orchestrator hybrid loop integration and replanning workflow. | Scrum Master |
| 2025-10-17 | 0.2 | Implemented planner validation pipeline, lifecycle SSE events, replanning workflow, and updated documentation/tests. | Dev Agent |
| 2025-10-17 | 0.3 | Added facet value graph context to LLM replanning prompts and extended coverage in coordinator spec. | Dev Agent |
| 2025-10-18 | 0.4 | Introduced shared RunContext facet state, refactored replanning to preserve prior outputs, and routed planner context through persisted facets. | Dev Agent |
| 2025-10-18 | 0.5 | Kept generic capability execution while surfacing input/output contracts in prompts and refreshed coordinator tests to cover the new context. | Dev Agent |

## QA Results

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ❌ `packages/flex-agents-server/src/services/flex-execution-engine.ts:192` treats every non-`execution` node as a virtual step, so `structuring`/`validation` nodes never invoke their declared capabilities. Planner-produced QA nodes therefore never run, breaching AC2/AC5 and leaving policy validation inoperative.

### Test Coverage
- Existing integration suite exercises replanning signals but never asserts execution of non-`execution` node capabilities. Add coverage that expects QA/strategy capabilities to run (and produce outputs) to catch this regression.

### Gate Recommendation
- FAIL – Hybrid loop breaks because validation nodes are skipped; planner diagnostics cannot compensate for missing execution.

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ❌ `packages/flex-agents-server/src/services/flex-execution-engine.ts:615` now routes every capability through a generic `executeCapability` flow that never loads the Strategy/QA agent instruction sets defined in `packages/flex-agents-server/src/agents/strategy-manager.ts` and `packages/flex-agents-server/src/agents/quality-assurance.ts`. The newly built prompts (`packages/flex-agents-server/src/services/flex-execution-engine.ts:670`) only contain planner metadata, so the orchestrator no longer provides the domain-specific guidance or tool wiring those agents require. Real runs will therefore emit under-specified prompts and skip the QA toolchain, violating AC2/AC5.

### Test Coverage
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`

### Gate Recommendation
- FAIL – Capability execution lost the specialized Strategy/QA instruction set; planner guardrails remain ineffective until the engine invokes the registered agents again.

## Dev Agent Record

### Debug Log References
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`

### Completion Notes
- Injected capability input/output contracts into the generic executeCapability prompt so agents receive contract context even without specialized instructions.
- Hardened coordination tests to assert contract metadata is present in the runtime call.
- Resolved capability prompts via registry so executeCapability stays generic while still injecting agent-specific instructions and tool allowlists.

### File List
- packages/flex-agents-server/src/services/flex-execution-engine.ts
- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ⚠️ `packages/flex-agents-server/src/services/flex-execution-engine.ts:615-668` now surfaces capability contracts in the planner-built prompt, but execution still bypasses the real Strategy/QA agents (`packages/flex-agents-server/src/agents/strategy-manager.ts`, `packages/flex-agents-server/src/agents/quality-assurance.ts`). Without their instruction sets and tool bindings, the orchestrator sends only generic guidance, so QA guardrails remain non-functional in production.

### Test Coverage
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`

### Gate Recommendation
- FAIL – Capability contracts are exposed, yet specialist agents are still not instantiated; planner handshake continues to violate AC2/AC5.

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ `packages/flex-agents-server/src/services/flex-execution-engine.ts:620-670` now sources capability prompts and tool allowlists via the registry, so Strategy/Content/QA agents execute with their intended instructions and wiring. Planner guardrails are restored.

### Test Coverage
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-planner-hybrid.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`

### Gate Recommendation
- PASS – Execution engine stays generic while correctly instantiating capability agents; AC2/AC5 satisfied.
