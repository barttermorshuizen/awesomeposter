# Story 8.24: Flex Conditional Action Node

## Status
Needs Refinement

## Story
**As a** flex orchestrator maintainer,  
**I want** plan graphs to include conditional action nodes that evaluate JSON-logic predicates and dispatch standardized policy actions,  
**so that** runtime decisions like replanning, routing, or escalation happen deterministically without bespoke imperative code.

**Dependencies:** Story 8.22 (policy conditional triggers) and Story 8.23 (policy action execution) must land first so predicates and action handling are available in the runtime.

## Acceptance Criteria
1. `@awesomeposter/shared` exposes `ActionSchema`, `Action`, `ConditionalActionNodeSchema`, and `ConditionalActionNode` definitions mirroring the provided informal schema while aligning with documented plan node structure and TypeScript/Zod conventions. (`docs/architecture/flex-agents-server.md#54-plangraph`, `docs/architecture/tech-stack.md#1-core-runtime-components`, `docs/architecture/coding-standards.md#1-language--module-conventions`)
2. Flex planner, plan snapshots, and persistence accept a new `FlexPlanNodeKind` for conditional actions (`kind: 'action'` or `'routing'`), storing condition arrays, fallbacks, and metadata so rehydration and downstream consumers preserve the node contract. (`docs/architecture/flex-agents-server.md#54-plangraph`, `docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
3. `FlexExecutionEngine` evaluates conditional action nodes before advancing the run: it executes JSON-logic predicates against the current `RunContext`, applies the first matching `then` action, and reuses documented orchestrator behaviors for `goto`, `replan`, `hitl_pause`, `fail_run`, `pause`, and `log_only` outcomes (including fallback action when no conditions match). (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`)
4. Telemetry and policy signaling include conditional action evaluations: SSE `policy_triggered` or `log` frames annotate the selected action and predicate result, persistence records the outcome, and HITL/pause flows remain resumable per the documented streaming contract. (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#10-001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`)
5. Automated tests cover schema validation edge cases, planner/persistence round-trips, and execution outcomes for each action type (match, no match with fallback, malformed predicate guarded) following the projectâ€™s testing standards. (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Tasks / Subtasks
- [ ] Add `Action` and `ConditionalActionNode` schemas/types to `@awesomeposter/shared`, ensuring Zod validation mirrors the informal schema and exports stay tree-shakable. (AC 1) (`docs/architecture/flex-agents-server.md#54-plangraph`)
- [ ] Extend `FlexPlanNodeKind`, planner compilation, and snapshot serialization to persist conditional action metadata while keeping rehydration deterministic. (AC 2) (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- [ ] Implement conditional action evaluation in `FlexExecutionEngine`, wiring `goto`, `replan`, `hitl_pause`, `fail_run`, `pause`, and `log_only` behaviors to existing orchestrator services and run context updates. (AC 3) (`docs/architecture/flex-agents-server.md#6-component-responsibilities`)
- [ ] Update telemetry emitters and persistence hooks so conditional action decisions surface via SSE and stored run metadata without regressing resume or HITL flows. (AC 4) (`docs/architecture/flex-agents-server.md#10-001-flex-run-streaming-contract`)
- [ ] Author Vitest suites covering schema validation, planner/persistence round-trips, and execution flows for conditional actions. (AC 5) (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Story Context

**Existing System Integration:**
- Integrates with: `@awesomeposter/shared` flex contracts, `packages/flex-agents-server` planner, execution engine, telemetry, persistence, and HITL resume pipeline. `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#4-agents-server]`
- Technology: TypeScript, Zod, JSON-logic evaluation, Nitro-based orchestrator services. `[Source: architecture/tech-stack.md#1-core-runtime-components]`
- Follows pattern: Planner emits PlanGraph nodes validated and executed by orchestrator services with SSE telemetry. `[Source: architecture/flex-agents-server.md#7-execution-flow]`
- Touch points: Shared schema module, planner compile step, execution engine routing, run context updates, telemetry service, persistence snapshots. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`

**Open Design Considerations:**
- Runtime policies already let callers express conditional branching; introducing planner-injected conditional nodes risks duplicate triggers and user confusion.
- Need to decide whether branching logic should remain solely in `policies.runtime`, migrate into planner-specific policy surfaces, or be split cleanly before implementing this story.
- Alignment with forthcoming agent instruction templates must avoid embedding process context inside individual agents while keeping orchestrator behaviour transparent.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Conditional action nodes declare `kind` (`'action'` or `'routing'`), an `id`, optional `title`/`description`, `conditions[]` of `{ if, then }`, optional `fallback`, and optional `metadata`. `[Source: architecture/flex-agents-server.md#54-plangraph]`
2. `ActionSchema` covers `goto`, `replan`, `hitl_pause`, `fail_run`, `pause`, and `log_only`, enforcing required fields (`next`, `rationale`, `message`, `reason`, `event`, `payload`). `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`
3. Planner includes conditional action nodes in PlanGraph edges without violating DAG requirements; persistence captures them for resume. `[Source: architecture/flex-agents-server.md#9-data-model--persistence]`
4. Execution engine short-circuits on the first matching condition, applies the corresponding action, and records the outcome before continuing along plan edges. `[Source: architecture/flex-agents-server.md#7-execution-flow]`
5. Fallback action executes when no predicate matches; absence of fallback continues without side effects. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`

### Integration Requirements
6. JSON-logic evaluator operates on `RunContext` facet snapshots so predicates can inspect prior outputs or policy state. `[Source: architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy]`
7. `goto` actions switch orchestration to the referenced node ID by updating the scheduler selection without mutating the persisted plan topology. `[Source: architecture/flex-agents-server.md#7-execution-flow]`
8. `replan` actions trigger the documented planner handshake, emitting `plan_requested`/`plan_updated` frames. `[Source: architecture/flex-agents-server.md#10-001-flex-run-streaming-contract]`
9. `hitl_pause`/`pause` actions persist snapshots and surface HITL requests consistent with existing resume workflow. `[Source: architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy]`
10. `log_only` actions send telemetry frames (`log` or domain event) without altering plan execution state. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`

### Quality Requirements
11. Validation errors for malformed conditions or unsupported actions surface descriptive messages and prevent plan execution. `[Source: architecture/coding-standards.md#1-language--module-conventions]`
12. Tests cover match/miss/fallback paths plus error handling when predicates throw or return non-boolean values. `[Source: architecture/coding-standards.md#7-testing-expectations]`
13. Telemetry payloads include action type and predicate result fields to aid sandbox debugging. `[Source: architecture/flex-agents-server.md#10-001-flex-run-streaming-contract]`

## Dev Notes
- **Previous Story Insights**: Runtime policy enforcement already relies on `PolicyNormalizer` and `FlexExecutionEngine` to raise `replan`, `retry_node`, `hitl_pause`, `fail_run`, and `log_only` actions; conditional nodes must reuse those pathways instead of bespoke logic while adding the new `goto` routing behavior. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`
- **Data Models**: Conditional nodes must serialize into `flex_plan_nodes` and snapshots so resume/HITL flows rehydrate predicates and metadata. `[Source: architecture/flex-agents-server.md#9-data-model--persistence]`
- **API Specifications**: SSE `run.stream` contract needs to surface action outcomes alongside existing planner and node events. `[Source: architecture/flex-agents-server.md#10-001-flex-run-streaming-contract]`
- **Component Specifications**: Updates target the planner compiler, execution engine, telemetry service, and persistence layer documented for flex orchestration. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`
- **File Locations**: Place shared contracts in `packages/shared/src/flex`, planner/execution updates in `packages/flex-agents-server/src/services`, and related tests alongside each package per workspace structure. `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#4-agents-server]`
- **Testing Requirements**: Follow Vitest-based coverage expectations for new schemas and orchestration logic. `[Source: architecture/coding-standards.md#7-testing-expectations]`
- **Technical Constraints**: Maintain strict TypeScript + Zod patterns and avoid introducing non-standard runtimes. `[Source: architecture/coding-standards.md#1-language--module-conventions]`

## Project Structure Notes
- Keep shared schema additions in `packages/shared`, orchestration logic in `packages/flex-agents-server`, and ensure any helper utilities live under existing service directories to align with the documented source tree. `[Source: architecture/source-tree.md#5-shared-libraries]` `[Source: architecture/source-tree.md#4-agents-server]`

## Testing
- `npm run test:unit -- packages/shared/__tests__/flex/conditional-action-node.spec.ts packages/flex-agents-server/__tests__/conditional-action-node.spec.ts packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts` `[Source: architecture/coding-standards.md#7-testing-expectations]`

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (unit/integration as applicable)
- [ ] Documentation updated

## Risk and Compatibility Check
- **Primary Risk:** Incorrect predicate evaluation could route runs to stale nodes or trigger unnecessary replans, leading to user-visible failures.  
  **Mitigation:** Validate JSON-logic expressions, add telemetry for outcomes, and fallback gracefully when predicates fail. `[Source: architecture/flex-agents-server.md#7-execution-flow]`
- **Rollback:** Disable conditional action emission in planner output and revert schema exports; existing policy triggers continue to rely on prior stories. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 0.1 | Initial draft for conditional action nodes in flex plan graphs. | Scrum Master |
