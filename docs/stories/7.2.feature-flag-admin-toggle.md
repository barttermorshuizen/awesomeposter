# Story 7.2: Admin Flag Toggle Workflow

## Status
Ready for Review

## Story
**As an** internal admin,
**I want** to enable or disable the discovery agent per client via a controlled workflow,
**so that** pilots can be started or stopped with auditability.

## Acceptance Criteria
1. Admin UI or CLI lists clients with current discovery flag state and allows toggling with confirmation.
2. Each toggle logs actor, timestamp, client, previous state, new state.
3. Toggle propagates to all services within 5 minutes; progress visible in log or UI.
4. Failed toggle operations surface actionable error messages and leave system in previous state.

## Tasks / Subtasks
- [x] Build admin page or CLI command `discovery:toggle --client <id> --enable/--disable` (AC 1).
- [x] Write audit logging integration storing change history (AC 2).
- [x] Emit notification/telemetry `discovery.flagChanged` for monitoring (AC 3).
- [x] Implement rollback mechanism on failure (AC 4).
- [x] Add integration tests verifying propagation and error handling (AC 3, AC 4).

## Dev Notes
- If using CLI, ensure it authenticates and respects least privilege.
- Provide instructions in runbook referencing toggle workflow.

### Testing
- Automated tests toggling flag and confirming ingestion respects update.
- Manual QA with pilot sandbox client.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Implemented discovery admin toggle CLI, audit logging, telemetry publishing, and regression coverage. | Dev |
| 2025-03-29 | 0.1 | Draft for Epic: Feature Flag & Pilot Enablement. | PM |

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Developer persona)

### Debug Log References
- None

### Completion Notes List
- Added `scripts/feature-flags.mjs` CLI to list and toggle per-client discovery flags with confirmation prompts and actor attribution.
- Created `client_feature_toggle_audits` table (+ migration) to capture previous/new states, operator, reason, and timestamps for every toggle.
- Broadcast telemetry via `discovery.flagChanged` alongside Redis pub/sub so downstream services invalidate caches and observability pipelines record changes.
- Hardened feature flag helpers with discovery-specific emitters and race-safe cache invalidation, plus integration-style unit coverage for telemetry propagation.
- Replaced `/settings` placeholder with a Feature Flags admin panel that lists clients, shows current discovery status, and applies toggles after collecting actor/reason metadata.
- Added a dedicated API + service layer (`setDiscoveryFlag`) so UI, CLI, and future tooling share audit logging, telemetry, and cache invalidation logic.

### File List
- scripts/feature-flags.mjs
- package.json
- packages/db/src/schema.ts
- packages/db/migrations/20250331_add_client_feature_toggle_audits.sql
- packages/shared/src/feature-flags.ts
- server/utils/client-config/feature-flags.ts
- packages/agents-server/src/utils/feature-flags.ts
- server/utils/__tests__/feature-flags.spec.ts
- server/utils/client-config/feature-flag-admin.ts
- server/api/clients/[id]/feature-flags.patch.ts
- server/utils/__tests__/feature-flag-admin.spec.ts
- src/components/settings/FeatureFlagsPanel.vue
- src/views/SettingsView.vue
- src/router/index.ts

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Implemented discovery admin toggle CLI, audit logging, telemetry publishing, and regression coverage. | Dev |
| 2025-03-29 | 0.1 | Draft for Epic: Feature Flag & Pilot Enablement. | PM |
