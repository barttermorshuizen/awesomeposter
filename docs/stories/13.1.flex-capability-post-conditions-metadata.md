# Story 13.1: Capability Post-Condition Metadata & Persistence

## Status
Done

## Story
**As a** flex orchestrator platform engineer,  
**I want** capability registrations to declare and persist optional post-condition predicates alongside their facet contracts,  
**so that** downstream planner, runtime, and operator tooling can trust every capability’s advertised exit criteria before execution logic begins enforcing them.

**Dependencies:** None; first story in Epic FLEX-CAP-PC-1 and prerequisites for the runtime/UI enforcement stories. (`docs/prd/epic-flex-capability-post-conditions.md#stories`)

## References
- `docs/prd/epic-flex-capability-post-conditions.md#stories`
- `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`
- `docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`
- `docs/architecture/flex-agents-server/7-execution-flow.md`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`
- `docs/architecture/flex-agents-server/91-capability-registration-flow.md`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/source-tree.md#6-documentation-assets`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/coding-standards.md#7-testing-expectations`

## Acceptance Criteria
1. `CapabilityRegistration`/`CapabilityRecord` definitions in `@awesomeposter/shared` expose an optional `postConditions: FacetCondition[]` that reuses the existing `TaskEnvelope.goal_condition` contract, normalizes DSL → canonical JSON-Logic at registration time, and rejects malformed facet/path combinations with descriptive errors. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
2. `flex_capabilities` gains additive JSONB columns for raw and compiled post-condition metadata, and the registry repository/service persists, caches, and returns those structures (including guarded facet lists) without breaking registrations that omit the field. (`docs/architecture/flex-agents-server/9-data-model-persistence.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`)
3. Capability summaries (`CapabilityRegistry.listActive/getCapabilityById`, CRCS snapshots, SSE payload scaffolds) surface the compiled post-condition metadata so planner prompts and operator tooling can state which facets each predicate guards, matching the epic requirement for provenance tables. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/flex-agents-server/7-execution-flow.md`)
4. Architecture documentation for the capability registry explicitly explains the new `postConditions` field, how DSL validation works, and how provenance output enumerates the guarded facets so future stories can rely on the contract. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)

## Tasks / Subtasks
- [x] Extend `packages/shared/src/flex/types.ts` (and related Zod schemas) with the optional `postConditions` array, wire it to the Condition DSL compiler, and add unit coverage for valid/invalid registrations. (AC1) (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
- [x] Create additive Drizzle migration + schema updates for `flex_capabilities` to store both submitted DSL payloads and compiled JSON-Logic metadata, and persist those fields via `DatabaseFlexCapabilityRepository`. (AC2) (`docs/architecture/flex-agents-server/9-data-model-persistence.md`, `docs/architecture/source-tree.md#5-shared-libraries`)
- [x] Update `FlexCapabilityRegistryService` (and any SSE/CRCS helpers it feeds) to cache, expose, and summarize post-condition metadata, including provenance hints for planner prompts. Add regression tests covering list/get flows. (AC2, AC3) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/flex-agents-server/7-execution-flow.md`)
- [x] Refresh `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md` (and linked registry docs) to describe the new field, DSL validation, provenance output, and compatibility guarantees. (AC4) (`docs/architecture/source-tree.md#6-documentation-assets`)
- [x] Verify lint + unit suites (`@awesomeposter/shared`, `packages/flex-agents-server`, and DB schema migrations) to satisfy coding-standard gates. (AC1–AC3) (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Story Context
- Epic FLEX-CAP-PC-1 requires every capability to publish machine-verifiable post conditions before runtime enforcement and UI surfacing can occur. (`docs/prd/epic-flex-capability-post-conditions.md#stories`)
- The orchestrator already relies on `FacetCondition` arrays for `TaskEnvelope.goal_condition`, making them the canonical predicate contract to reuse for capability-level metadata. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`)
- Capability registrations self-post to `/api/v1/flex/capabilities/register` and are cached in the registry service, so compiling/storing post conditions at registration time keeps downstream services consistent without separate mutation workflows. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/flex-agents-server/91-capability-registration-flow.md`)
- Planner/runtime SSE frames depend on registry metadata, so surfacing post-condition provenance early enables later stories to decorate prompts and operator tooling without schema churn. (`docs/architecture/flex-agents-server/7-execution-flow.md`)

## Dev Notes
- `FacetCondition` payloads already include facet names, JSON-pointer paths, and DSL metadata; reuse that structure and compiler to prevent divergence between task-level and capability-level predicates. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope]
- Capability records must continue to flow through the registry cache/heartbeat logic; treat `postConditions` as optional so existing registrations (including marketing catalog entries) remain valid. [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md]
- Condition DSL parsing should happen through the shared helper so we persist canonical JSON-Logic, DSL strings, referenced variables, and warnings for each predicate. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
- `flex_capabilities` is the canonical persistence table for registry metadata; add columns via forward-only migrations and keep Drizzle schema + repository helpers synchronized. [Source: docs/architecture/flex-agents-server/9-data-model-persistence.md]
- Follow existing TypeScript, logging, and validation standards for the agents server and shared packages. [Source: docs/architecture/coding-standards.md#4-agents-server-standards]

## Testing
- `npm run test:unit -- packages/shared packages/flex-agents-server` – shared contract + registry service coverage. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run lint` – ensure schema/TypeScript updates meet repo lint gates. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- `npm run db:gen && npm run db:push` (against local dev DB) – validate Drizzle schema/migration consistency for the new columns. (`docs/architecture/source-tree.md#5-shared-libraries`)

## Project Structure Notes
- Shared contract updates belong in `packages/shared/src/flex/**` per the shared-libraries guidance. (`docs/architecture/source-tree.md#5-shared-libraries`)
- Registry service/repository updates stay within `packages/flex-agents-server/src/services/**`. (`docs/architecture/source-tree.md#4-agents-server`)
- Drizzle schema + migrations live under `packages/db/src/**` and `packages/db/migrations/**`; keep both shards in sync. (`docs/architecture/source-tree.md#5-shared-libraries`)
- Documentation edits stay within `docs/architecture/**` to preserve the architecture shard structure. (`docs/architecture/source-tree.md#6-documentation-assets`)

## Change Log
- Added `postConditions` compilation + fallback DSL normalization in `packages/shared/src/flex/types.ts` with new unit coverage (`packages/shared/__tests__/flex/capability-registration.spec.ts`).
- Introduced `post_conditions_dsl_json`/`post_conditions_compiled_json` columns, Drizzle schema, and migration `20251024_add_flex_capability_post_conditions.sql`, wiring them through `DatabaseFlexCapabilityRepository`.
- Surfaced compiled metadata, guard summaries, and CRCS provenance in `FlexCapabilityRegistryService`, including new planner/CRCS tests and doc-linked registry updates.
- Documented capability inventory changes (`docs/architecture/flex-agents-server.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`) and ran `npm run test:unit -- packages/shared packages/flex-agents-server` (pass), `npm run lint` (fails on existing `packages/agents-server/__tests__` `any` warnings), `npm run db:gen` (pass), `npm run db:push` (fails: cannot connect to local Postgres).
- Streamed CRCS row snapshots (including post-condition provenance) through plan metadata and SSE scaffolds, updated the capability registry docs, and added regression coverage in `flex-goal-condition-replan.spec.ts` + `flex-sandbox-run.spec.ts`.

## QA Results

- **Reviewer:** Quinn (Test Architect) on 2025-11-14
- **Decision:** PASS – CRCS payloads now stream full `{ facet, path, expression }` rows through plan metadata and every `plan_requested` / `plan_generated` SSE frame (`packages/flex-agents-server/src/services/flex-planner.ts:560-613`, `packages/flex-agents-server/src/services/flex-run-coordinator.ts:204-330`, `packages/flex-agents-server/src/services/flex-run-coordinator.ts:913-951`, `packages/flex-agents-server/src/services/flex-run-coordinator.ts:1815-1865`), satisfying AC3.
- **Coverage:** AC1–AC3 traced via shared schema compilation, registry persistence, CRCS summarisation, and SSE scaffolds; AC4 verified through the architecture doc update (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md:1-16`).
- **Tests:** `npm run test:unit -- packages/flex-agents-server` (pass; includes updated `flex-goal-condition-replan.spec.ts` + `flex-sandbox-run.spec.ts`). Lint and DB commands retain previously noted outcomes (`npm run lint` still failing on pre-existing `packages/agents-server/__tests__` `any` warnings, `npm run db:push` unable to reach local Postgres).
