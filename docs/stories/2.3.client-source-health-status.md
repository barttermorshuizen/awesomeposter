# Story 2.3: Source Health Status

## Status
Done

## Story
**As a** marketing operator,
**I want** to see the last fetch status for each configured source,
**so that** I can diagnose ingestion issues quickly and adjust sources if needed.

## Acceptance Criteria
1. Source list displays last fetch timestamp and status badge (`Success`, `Warning`, `Error`) sourced from ingestion telemetry.
2. Status `Warning` appears when last fetch occurred >24 hours ago; `Error` appears after 3 consecutive failures.
3. Hover or details panel shows last failure reason message when available.
4. Data refreshes automatically via SSE `source.health` events without manual reload.

## Context
- Depends on Story 2.1 client source CRUD being live so the list/grid shell and discovery store are in place (`docs/stories/2.1.client-source-add-http-source.md`).
- Ingestion scheduler + telemetry from Stories 3.1 and 3.3 already persist run metadata and publish failure events; reuse their repository helpers for streak tracking and SSE envelopes (`docs/stories/3.1.ingestion-scheduled-fetch.md`, `docs/stories/3.3.ingestion-retry-health.md`).
- SSE transport from Story 6.1 provides `/api/discovery/events.stream`; the UI should subscribe via `subscribeDiscoveryEvents` per `docs/architecture/discovery_agent_frontend/realtime-telemetry-sse.md#realtime-telemetry-sse`.

## Tasks / Subtasks
- [x] Extend ingestion service (`server/jobs/discovery/ingest-sources.ts`) and repository (`server/utils/discovery-repository.ts`) so each run updates `discovery_sources` with `last_fetch_status`, `last_fetch_completed_at`, `last_failure_reason`, and a new persisted `consecutive_failure_count` (Drizzle schema + migration under `packages/db`); emit `publishSourceHealthStatus` with streak metadata on success/failure (AC 1, AC 2).
- [x] Ensure `packages/shared/src/discovery-events.ts` exposes the `source.health` contract `{ clientId, sourceId, status, lastFetchedAt, failureReason?, consecutiveFailures?, observedAt }` and persist the same envelope in telemetry logs (AC 4).
- [x] Update the discovery sources panel (`src/components/clients/ClientDiscoverySourcesPanel.vue`) and supporting composables/stores to render status badges/tooltips using Vuetify status pills and surface failure reason hover text (AC 1, AC 3).
- [x] Add a Nitro scheduled task (e.g., `server/jobs/discovery/mark-stale-sources.ts`) wired in `nitro.config.ts` that scans for sources with no successful fetch in >24h, marks them `warning`, updates `consecutive_failure_count`, and emits matching `source.health` events (AC 2).
- [x] Write integration + component tests covering success → warning → error transitions, SSE-driven UI updates, and stale-source job behaviour (Vitest for backend specs, UI spec in `src/__tests__/ClientDiscoverySourcesPanel.spec.ts`) (AC 1, AC 2).

## Dev Notes
- Align status badges with existing Vuetify theme tokens per `docs/architecture/discovery_agent_frontend/styling-guidelines.md#styling-guidelines`; reuse `v-chip` variations already used in telemetry cards.
- Persist health history alongside existing ingestion telemetry so retention meets the 180-day requirement in `docs/prd/epic-discovery-telemetry-reporting.md#non-functional-requirements`.
- Repository helpers should default `consecutive_failure_count` back to 0 on success and include `last_success_at` plus streak metadata inside `health_json` so telemetry exports stay consistent (see `docs/architecture/discovery-agent-backend.md#configuration-schema--storage`).
- Document any new env toggles (e.g., stale sweep frequency) in `docs/discovery-agent-dev-setup.md` under the telemetry section.

### Testing
- Backend: extend `server/jobs/__tests__/discovery-ingest-sources.spec.ts` (or new `discovery-health-status.spec.ts`) to cover consecutive failure tracking, stale warning job, and SSE payload assertions; run via `pnpm test:unit --filter ingestion-health`.
- Frontend: add a Vitest component spec (e.g., expand `src/__tests__/ClientDiscoverySourcesPanel.spec.ts`) that injects mocked EventSource frames to assert badges flip states and tooltips show failure reasons without reload.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Drafted for Epic: Client Source Configuration. | PM |
| 2025-10-05 | 1.0 | Implemented source health persistence, stale sweep job, UI badges/tooltips, and regression coverage. | Dev |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit

### Completion Notes List
- Added `last_success_at`, `consecutive_failure_count`, and `health_json` columns plus a migration for `discovery_sources`, updating repository helpers to compute streak metadata and persist health payloads.
- Enhanced ingestion job to consume repository health snapshots, publish `source.health` events for success/failure paths, and surface attempt/stale metadata consistently.
- Introduced scheduled stale sweep (`server/jobs/discovery/mark-stale-sources.ts`) with Nitro wiring and repository support to flag idle sources as `warning` while emitting SSE updates.
- Extended shared discovery event schema and Vue panel to render Success/Warning/Error chips, hover messaging, and live updates via SSE envelopes.
- Expanded Vitest coverage for ingestion health states, the stale sweep job, and the Vue panel’s SSE-driven badge transitions; documented the new `DISCOVERY_STALE_WARNING_HOURS` toggle in the developer setup guide.

### File List
- docs/discovery-agent-dev-setup.md
- docs/stories/2.3.client-source-health-status.md
- nitro.config.ts
- packages/db/migrations/20250402_add_discovery_source_health.sql
- packages/db/src/schema.ts
- packages/shared/src/discovery-events.ts
- server/jobs/discovery/ingest-sources.ts
- server/jobs/discovery/mark-stale-sources.ts
- server/jobs/__tests__/discovery-ingest-sources.spec.ts
- server/jobs/__tests__/mark-stale-sources.spec.ts
- server/utils/discovery-repository.ts
- src/components/clients/ClientDiscoverySourcesPanel.vue
- src/__tests__/ClientDiscoverySourcesPanel.spec.ts
## QA Results

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Reviewed the ingestion service persistence changes, health snapshot builder, SSE publishing, and Vue panel rendering. The new `health_json` + `consecutive_failure_count` schema keeps state consistent with the emitted `source.health` envelopes, and the stale sweep task cleanly reuses the same publisher so UI badges stay in sync without reloads.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ – Backend/job specs, API stream tests, and the Vue component test cover healthy, failure, and stale transitions.
- All ACs Met: ✓ – Status fields persist, SSE updates drive the UI, and stale sources escalate to `Warning`/`Error` appropriately.

### Improvements Checklist
- [x] Persist health metadata (`last_success_at`, `consecutive_failure_count`, `health_json`) during ingest runs.
- [x] Publish `source.health` envelopes and validate SSE delivery to the client panel.
- [x] Hourly stale sweep marks dormant sources and emits matching telemetry.

### Security Review
No new auth surfaces; SSE endpoint retains existing session + feature flag enforcement.

### Performance Considerations
Stale sweep iterates only qualifying sources hourly and the ingestion workers reuse bounded retry logic, so workload growth stays controlled.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/2.3-client-source-health-status.yml
Risk profile: Not updated this review
NFR assessment: Inline in gate decision

### Recommended Status
✓ Ready for Done – Implementation and tests cover success, failure, and stale health states.
