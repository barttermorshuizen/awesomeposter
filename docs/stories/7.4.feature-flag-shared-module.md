# Story 7.4: Unify Feature Flag Helper Module

## Status
Draft

## Story
**As a** platform maintainer,
**I want** the Nitro API and agents server to share a single feature flag helper implementation,
**so that** cache invalidation, telemetry, and error handling stay consistent across runtimes.

## Acceptance Criteria
1. Feature flag helpers live in one shared module that both Nitro (`server/utils/...`) and the agents server import without code duplication.
2. Cached lookups, Redis publishing, telemetry emission, and fail-safe behaviour remain functionally identical after consolidation.
3. Unit tests cover the shared module and both runtimes stub/mount it successfully during testing.
4. Developer documentation notes the ownership location and usage pattern for feature flag helpers.

## Tasks / Subtasks
- [ ] Audit current helper APIs (`isFeatureEnabled`, `publishFeatureFlagUpdate`, etc.) and confirm the shared API surface.
- [ ] Create shared implementation (e.g., in `packages/shared` or a new package) with dependency-safe exports for both runtimes.
- [ ] Update Nitro server imports to reference the shared module.
- [ ] Update agents server imports to reference the shared module.
- [ ] Adjust existing unit tests/mocks to use the new shared module; add coverage if gaps appear.
- [ ] Document the shared ownership and migration guidance for future feature flags.

## Dev Notes
- Preserve existing cache TTL constants (`CACHE_TTL_MS`, `FAILSAFE_TTL_MS`) and Redis client initialisation semantics.
- Ensure the shared module remains tree-shake-friendly to avoid bundler regressions.
- Consider exposing factory helpers if runtime-specific wiring (e.g., logger) is needed.

### Testing
- Update and run unit tests that cover flag checks in both runtimes (e.g., `pnpm test:unit`).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 0.1 | Draft story created to consolidate feature flag helper modules. | QA |
