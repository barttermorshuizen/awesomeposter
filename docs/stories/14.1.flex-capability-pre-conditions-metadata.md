# Story 14.1: Capability Pre-Condition Metadata & Persistence

## Status
Ready for Dev

## Story
**As a** flex orchestrator platform engineer,  
**I want** capability registrations to declare and persist optional pre-condition predicates alongside their facet contracts,  
**so that** planners, runtime gating, and operator tooling can block node dispatch when prerequisites are unmet instead of failing downstream.

**Dependencies:** None; first story in Epic FLEX-CAP-PRE-1 and prerequisite for the runtime, UI, and catalog adoption stories. (`docs/prd/epic-flex-capability-pre-conditions.md#stories`)

## References
- `docs/prd/epic-flex-capability-pre-conditions.md#stories`
- `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`
- `docs/architecture/flex-agents-server/5-core-concepts.md#56-agentcapability`
- `docs/architecture/flex-agents-server/7-execution-flow.md`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`
- `docs/architecture/flex-agents-server/91-capability-registration-flow.md`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/source-tree.md#6-documentation-assets`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/coding-standards.md#7-testing-expectations`

## Acceptance Criteria
1. `CapabilityRegistration`/`CapabilityRecord` definitions in `@awesomeposter/shared` expose an optional `preConditions: FacetCondition[]` that reuses the existing `TaskEnvelope.goal_condition` contract, normalizes DSL → canonical JSON-Logic at registration time, and rejects malformed facet/path combinations with descriptive errors. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
2. `flex_capabilities` gains additive JSONB columns for raw and compiled pre-condition metadata, and the registry repository/service persists, caches, and returns those structures (including guarded facet lists) without breaking registrations that omit the field. (Sources: `docs/architecture/flex-agents-server/9-data-model-persistence.md`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`)
3. Capability summaries (`CapabilityRegistry.listActive/getCapabilityById`, CRCS snapshots, SSE payload scaffolds) surface the compiled pre-condition metadata so planner prompts and operator tooling can state which facets each predicate guards, matching the epic requirement for provenance tables. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/flex-agents-server/7-execution-flow.md`)
4. Architecture documentation for the capability registry explicitly explains the new `preConditions` field, how DSL validation works, and how provenance output enumerates the guarded facets so downstream stories can rely on the contract. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)

## Tasks / Subtasks
- [ ] Extend `packages/shared/src/flex/types.ts` (and related Zod schemas) with the optional `preConditions` array, wire it to the Condition DSL compiler, and add unit coverage for valid/invalid registrations. (AC1) (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
- [ ] Create additive Drizzle migration + schema updates for `flex_capabilities` to store both submitted DSL payloads and compiled JSON-Logic metadata, and persist those fields via `DatabaseFlexCapabilityRepository`. (AC2) (`docs/architecture/flex-agents-server/9-data-model-persistence.md`, `docs/architecture/source-tree.md#5-shared-libraries`)
- [ ] Update `FlexCapabilityRegistryService` (and any SSE/CRCS helpers it feeds) to cache, expose, and summarize pre-condition metadata, including provenance hints for planner prompts. Add regression tests covering list/get flows. (AC2, AC3) (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md`, `docs/architecture/flex-agents-server/7-execution-flow.md`)
- [ ] Refresh `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md` (and linked registry docs) to describe the new field, DSL validation, provenance output, and compatibility guarantees. (AC4) (`docs/architecture/source-tree.md#6-documentation-assets`)
- [ ] Verify lint + unit suites (`@awesomeposter/shared`, `packages/flex-agents-server`, and DB schema migrations) to satisfy coding-standard gates. (AC1–AC3) (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Edge Cases & Behavior Contracts
- Treat `preConditions: undefined` as “no pre-conditions declared” (legacy behavior) and `preConditions: []` as an explicit empty set that should not block registrations; both must round-trip without errors.
- Reject malformed DSL/pointer combinations with descriptive errors; include which facet/path failed validation.
- Provenance output must enumerate the facets guarded by each predicate so planners/operators can see which parts of a capability are gated.

## Testing Guidance
- Condition compiler: valid DSL → canonical JSON-Logic + guarded facet list; malformed DSL/path combos are rejected with clear errors.
- Optional field compatibility: omit `preConditions` and empty array cases both register successfully and do not break legacy capabilities.
- Persistence: raw + compiled metadata columns persist and hydrate through `DatabaseFlexCapabilityRepository` without regressions.
- Registry outputs: `listActive`/`getCapabilityById`/CRCS/SSE payload scaffolds surface compiled pre-conditions and guarded facets.
- Migration: additive Drizzle migration applies cleanly and preserves existing rows.
- Lint + unit suites: cover shared type/Zod schema wiring, registry service caching/exposure, and list/get regressions.

## Story Context
- Epic FLEX-CAP-PRE-1 requires every capability to publish machine-verifiable pre-conditions before runtime gating and UI surfacing can occur. (`docs/prd/epic-flex-capability-pre-conditions.md#stories`)
- The orchestrator’s planner/runtime layers depend on registry metadata; the first story must land the additive contract and storage without breaking legacy capabilities.
