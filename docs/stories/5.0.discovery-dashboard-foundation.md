# Story 5.0: Discovery Dashboard Foundation

## Status
Done

## Story
**As a** frontend platform engineer,
**I want** to scaffold the Discovery dashboard shell with routing, stores, and feature guards,
**so that** later UX stories can plug in filters, list rendering, and detail flows without reworking the application skeleton.

## Context & Rationale
- Epic 5 (Brief Management Dashboard) currently points the dashboard route at `PlaceholderView.vue` and lacks the discovery-specific Pinia store/services expected by downstream stories.
- Story 5.1 was blocked because the SPA, feature-flag hooks, and virtualization dependency were never provisioned.
- This foundation story creates the minimal but production-safe shell so that Story 5.1 (listing) and Story 5.2 (detail & promotion) can focus on UX behavior instead of plumbing.

## Acceptance Criteria
1. `/` dashboard route lazy-loads a new `DiscoveryDashboardView` living in `src/views/discovery/` when a client is selected and the `discovery.filters.v1` flag is enabled; no client selected or feature-flag off states continue to show the existing placeholder.
2. A `useDiscoveryListStore` Pinia module exposes state for filters, pagination, loading/error flags, and integrates with vue-router query params (read + write) without yet calling any backend API.
3. Virtual-scroll dependency or agreed alternative is installed/configured, and the view renders a placeholder virtualized list component (empty state) with responsive layout scaffolding for desktop/tablet/mobile breakpoints.
4. Telemetry/observability hooks emit no-ops today but the view/stores include documented extension points for search latency + SSE degrade metrics referenced by future stories.
5. `discovery.filters.v1` flag is surfaced in the existing Settings feature-flag management UI with enable/disable controls that persist per client.
6. Discovery dashboard shell renders a client selector dropdown (defaulting to current session client) and persists the selection so all subsequent list activity occurs in the context of that client.
7. Feature flag gating is documented in runbooks (`docs/prd/epic-discovery-feature-flag-pilot.md` appendix update) and the rollout toggle path is rehearsed in development (QA notes).

## Tasks / Subtasks
- [x] Add discovery dashboard route guard: update `src/router/index.ts` to conditionally load `DiscoveryDashboardView.vue` when `discovery.filters.v1` is enabled; fallback continues to point at `PlaceholderView.vue` when disabled (AC 1).
- [x] Create `src/views/discovery/DiscoveryDashboardView.vue` with layout scaffolding (filters pane placeholder + list area) and responsive Vuetify grid definitions (AC 1, AC 3).
- [x] Implement `src/stores/discoveryList.ts` (name `useDiscoveryListStore`) with default filter state, pagination metadata, loading/error flags, and query param sync composable (AC 2).
- [x] Install and configure virtualization dependency (e.g., `@vuetify/labs/VVirtualScroll` or `vue-virtual-scroller` after approval) and render stub list using the component with mock data structure (AC 3).
- [x] Wire feature flag helper from `@awesomeposter/shared` to gate view rendering and expose a utility composable for later stories (AC 1, AC 4).
- [x] Extend the existing Settings feature-flag interface (client picker → per-client toggles) to include `discovery.filters.v1`, persisting changes via the shared feature-flag API and reflecting current server state (AC 5).
- [x] Add client selector dropdown to the dashboard shell reusing the existing clients store/API (same data used by Settings + new brief UI), persist the selection in store/router state, and ensure flag evaluation respects the chosen client (AC 6).
- [x] Document extension points for telemetry hooks (latency timer, SSE degrade counter) inline and in `docs/architecture/discovery-agent-frontend.md` (AC 4).
- [x] Update pilot runbook / feature-flag documentation with instructions for enabling the dashboard shell, client targeting, and safe rollback (AC 7).

## Dependencies
- Requires feature flag contract defined in Epic 7 (discovery feature flag), including CRUD exposure for `discovery.filters.v1`.
- Requires client metadata endpoint already provided by admin shell to populate dropdown (fallback: reuse existing clients store component).
- No backend dependency for listing data; the store will mock data until Story 5.5 (Discovery Search API) lands.

## Open Questions
- Preferred virtualization library (`@vuetify/labs` vs `vue-virtual-scroller`). **Resolved:** use Vuetify `VVirtualScroll` labs component for the scaffold.
- Naming convention for discovery-specific routes (keep `/` for discovery by default or introduce `/discovery`). Decision impacts analytics URLs.

## Testing
- Component tests for `DiscoveryDashboardView` verifying feature-flag gating and responsive layout snapshot across breakpoints.
- Pinia store unit tests confirming default filter state, query param sync, and that toggling filters updates router state without backend access.
- E2E/Playwright smoke (future) to ensure route loads gated content when flag enabled.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-31 | 0.1 | Draft foundation story created after sprint change proposal. | SM |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit
- npm run test:unit -- src/__tests__/loadDiscoveryDashboard.spec.ts

### Completion Notes List
- Updated `loadDiscoveryDashboard` to render the discovery shell when no persisted client context exists so new sessions can pick a client while still falling back to the placeholder when the feature flag is disabled or lookups fail.
- Hid the filter scaffolding and virtualized list placeholder when the discovery flag is disabled so flagged-off clients only see the onboarding alert.
- Hardened `loadDiscoveryDashboard` to fail closed by returning `DiscoveryDashboardFallbackView` when the discovery flag is disabled or the flag lookup errors, ensuring AC1 is enforced.
- Replaced the dashboard route loader with a flag-aware async resolver (`src/views/discovery/loadDiscoveryDashboard.ts`) so `/` now lazy-loads the discovery shell only when `discovery.filters.v1` is enabled for the current client, otherwise falling back to the existing placeholder view.
- Scaffolded `DiscoveryDashboardView.vue` under `src/views/discovery/` with responsive Vuetify layout, client selector, telemetry stubs, and a virtualized list powered by Vuetify’s `VVirtualScroll`, plus a dedicated fallback wrapper component.
- Added `useDiscoveryListStore` (`src/stores/discoveryList.ts`) to manage filters, pagination, router query sync, and no-op telemetry hooks that downstream stories can extend.
- Introduced `src/lib/feature-flags.ts` for reusable client-flag fetching and updated Settings’ `FeatureFlagsPanel.vue` to manage both `discovery-agent` and `discovery.filters.v1`, including sequential PATCH handling and aggregated success messaging.
- Generalized server feature-flag utilities (`setClientFeatureFlag`, supported features list) and API handlers to support the new flag; refreshed the CLI script and runbook documentation accordingly.
- Documented the virtualization and telemetry extension points in `docs/architecture/discovery-agent-frontend.md` and expanded the pilot enablement runbook with dual-flag rollout instructions.

### File List
- docs/architecture/discovery-agent-frontend.md
- docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md
- packages/shared/src/feature-flags.ts
- scripts/feature-flags.mjs
- server/api/clients/[id]/feature-flags.get.ts
- server/api/clients/[id]/feature-flags.patch.ts
- server/utils/client-config/feature-flag-admin.ts
- server/utils/client-config/feature-flags.ts
- server/utils/__tests__/feature-flag-admin.spec.ts
- src/components/settings/FeatureFlagsPanel.vue
- src/lib/feature-flags.ts
- src/plugins/vuetify.ts
- src/router/index.ts
- src/stores/discoveryList.ts
- src/views/discovery/DiscoveryDashboardFallbackView.vue
- src/views/discovery/DiscoveryDashboardView.vue
- src/views/discovery/loadDiscoveryDashboard.ts
- src/__tests__/loadDiscoveryDashboard.spec.ts
- src/__tests__/discoveryListStore.spec.ts

## QA Results

### Review Date: 2025-10-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Feature-flag gating is broken: the async loader always returns `DiscoveryDashboardView` even when `discovery.filters.v1` is disabled or no client is selected, so AC1 fails and downstream users can see the new shell without the flag (`src/views/discovery/loadDiscoveryDashboard.ts#L25-L46`). The fallback view (`src/views/discovery/DiscoveryDashboardFallbackView.vue`) is never used.
- Unit suite (`npm run test:unit -- --run`) executes successfully (123 tests) but the CLI process exceeded the harness timeout; no failing tests observed in the vitest output.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✗ – Flag gating logic contradicts AC1.
- Project Structure: ✓ – New files live under the documented discovery folders.
- Testing Strategy: ✗ – No automated coverage for the flag/fallback behaviour; regression slipped through.
- All ACs Met: ✗ – AC1 unmet due to missing fallback when the flag/client is unavailable.

### Improvements Checklist
- [x] Enforce fallback to `DiscoveryDashboardFallbackView` when `discovery.filters.v1` is off or no client is selected so the route honours AC1 (`src/views/discovery/loadDiscoveryDashboard.ts`).
- [x] Add component/unit coverage for the loader/flag gating path to prevent future regressions (`src/views/discovery/loadDiscoveryDashboard.ts`, `src/views/discovery/DiscoveryDashboardView.vue`).

### Security Review
- No new security issues observed; gating defect tracked separately.

### Performance Considerations
- No performance regressions noted; virtualization remains placeholder-only.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/5.0-discovery-dashboard-foundation.yml

### Recommended Status
[✗ Changes Required - See unchecked items above]

---

### Review Date: 2025-10-07 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Flag gating now fails closed: the async loader returns `DiscoveryDashboardFallbackView` when the client is missing, the flag is disabled, or lookup throws, satisfying AC1 (`src/views/discovery/loadDiscoveryDashboard.ts:14`).
- Added targeted Vitest coverage that exercises enabled/disabled/error paths to prevent regressions (`src/__tests__/loadDiscoveryDashboard.spec.ts:6`).

### Compliance Check
- Coding Standards: ✓ – Lazy-loader guard follows project pattern.
- Testing Strategy: ✓ – Loader behaviour verified by unit tests.
- All ACs Met: ✓ – AC1 confirmed; no outstanding issues observed.

### Validations
- `npm run test:unit -- src/__tests__/loadDiscoveryDashboard.spec.ts`

### Gate Status
Gate: PASS → docs/qa/gates/5.0-discovery-dashboard-foundation.yml
