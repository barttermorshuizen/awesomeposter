# Story 8.37: Flex GoalCondition Replan Orchestration

## Status
Done

## Story
**As a** flex orchestrator maintainer,  
**I want** the runtime to replan automatically when any `goal_condition` entry fails and feed the full goal-condition structures (facet, path, unevaluated predicate) into the planner prompt,  
**so that** the planner can generate corrective steps that explicitly satisfy the caller’s goal conditions without manual intervention.

**Dependencies:** Story 8.36 delivers deterministic `goal_condition_results` persistence/SSE exposure that this story must consume. (`docs/stories/8.36.flex-goal-condition-evaluation-sse.md`)

## References
- `docs/prd/epic-flex-agents-server.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`
- `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`
- `docs/architecture/flex-agents-server/5-core-concepts.md#interaction-sequence`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/discovery-agent-backend.md#testing-strategy`

## Acceptance Criteria
1. Runs with any `goal_condition_results` entry marked `satisfied === false` or `error` must trigger a standard planner replan (LLM-driven) before a `complete` SSE frame is sent, skipping the existing completion payload until the replan succeeds and capping automatic retries to prevent infinite loops. `plan_requested` / `plan_generated` frames must indicate the `goal_condition_failed` rationale in their metadata. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/flex-agents-server/5-core-concepts.md#interaction-sequence`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
2. Failed goal-condition context (facet, JSON-pointer path, unevaluated predicate payload including canonical DSL/JSON-Logic, and the last observed value/outcome) is persisted with the run and streamed on `plan_requested`, `plan_generated`, and `plan_updated` payloads so clients and operators can see what is driving the replan. Successful runs omit the metadata. (`docs/architecture/flex-agents-server/9-data-model-persistence.md`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)
3. `PlannerService` extends the prompt blueprint with a `GOAL CONDITION REPAIR` section that lists each failed goal-condition structure (facet, path, unevaluated predicate) in human-friendly text plus the underlying Condition DSL pointer/value so the LLM understands the expectation it must satisfy. (`docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
4. Automated coverage proves (a) a failed predicate results in a fresh `plan_requested` → `plan_generated` cycle without prematurely emitting `complete`, (b) planner prompt builders include failed predicate context, and (c) successful replans stream `complete` only after all predicates pass. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)
5. Architecture docs (TaskEnvelope, planner prompt blueprint, SSE contract) describe automatic goal-condition replans, the new metadata fields, and how the planner prompt uses them. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`, `docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)

## Tasks / Subtasks
- [x] Detect failed goal conditions and request a capped `replan` before emitting `complete`, wiring the evaluator output through `FlexExecutionEngine`/`FlexRunCoordinator`. (AC 1) (`packages/flex-agents-server/src/services/flex-execution-engine.ts`, `packages/flex-agents-server/src/services/flex-run-coordinator.ts`)
- [x] Persist and expose a `failedGoalConditions` payload derived from `goal_condition_results` via persistence and SSE telemetry so every planner lifecycle frame includes rationale metadata. (AC 1, AC 2) (`packages/flex-agents-server/src/services/orchestrator-persistence.ts`, `packages/flex-agents-server/src/services/telemetry-service.ts`, `packages/shared/src/flex/types.ts`)
- [x] Extend `PlannerService` prompt builders to accept the failure context and render a `GOAL CONDITION REPAIR` section describing each predicate, expected state, and suggested remedy language. (AC 3) (`packages/flex-agents-server/src/services/planner-service.ts`, `packages/flex-agents-server/src/services/flex-planner.ts`)
- [x] Update architecture shards (TaskEnvelope semantics, planner prompt blueprint, SSE contract examples) to capture the new replan workflow and metadata. (AC 5) (`docs/architecture/flex-agents-server/5-core-concepts.md`, `docs/architecture/flex-agents-server/10-api-surface-initial.md`)
- [x] Expand Vitest coverage (unit + integration) to assert the new planner prompt content, SSE contract changes, and the automatic replan path end-to-end. (AC 4) (`packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts`, `packages/flex-agents-server/__tests__/flex-run-persistence.spec.ts`, `packages/flex-agents-server/__tests__/planner-service.spec.ts`)

## Dev Notes

### Previous Story Insights
- Story 8.36 already evaluates every `goal_condition`, emits the results on `complete`, and persists them inside `flex_run_outputs.goal_condition_results_json`, which this story reuses for replanning context. (`docs/stories/8.36.flex-goal-condition-evaluation-sse.md`)

### Data Models
- `flex_runs`, `flex_plan_snapshots`, and `flex_run_outputs` store envelope metadata, plan history, and final outputs; goal-condition results already live alongside these rows and must now include failure context for replans. (`docs/architecture/flex-agents-server/9-data-model-persistence.md`)
- The shared `GoalConditionResult` type resides in `@awesomeposter/shared` so any new metadata added for `failedGoalConditions` must remain backward compatible. (`docs/architecture/source-tree.md#5-shared-libraries`)

### Runtime & Replan Flow
- The execution flow explicitly allows replanning after validation or runtime failures; inserting the goal-condition check occurs between evaluation and completion to stay within the orchestrator’s guardrails. (`docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`, `docs/architecture/flex-agents-server/5-core-concepts.md#interaction-sequence`)
- Runtime policies already support `action: { type: "replan" }`, so surfacing `goal_condition_failed` as a rationale keeps telemetry aligned with existing policy semantics. (`docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`)

### Planner Prompt Blueprint & Responsibilities
- `PlannerService` renders a structured prompt with schema/context tables plus checklist reminders; adding a `GOAL CONDITION REPAIR` section should follow the same blueprint and emphasize facet expectations. (`docs/architecture/flex-agents-server/5-core-concepts.md#planner-prompt-blueprint-v2`)
- Component responsibilities state the planner prompt must include capability contract schemas and contextual guidance; injecting failed predicate details keeps the planner grounded in caller constraints. (`docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`)

### API & SSE Contract
- The `/api/v1/flex/run.stream` SSE frames (`plan_requested`, `plan_updated`, `complete`) must surface new metadata without breaking existing consumers; extend the payload shape documented in the API shard to describe `failedGoalConditions`. (`docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)

### Condition DSL Guidance
- Failed predicate context should reuse the canonical Condition DSL envelope so the planner sees the same DSL strings/pointers callers provided, aligning with the shared parser semantics. (`docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
- Goal predicates follow AND semantics per TaskEnvelope; the planner should be instructed that every listed predicate must become true before a run can finish. (`docs/architecture/flex-agents-server/5-core-concepts.md#51-taskenvelope`)

### Project Structure Notes
- Implementation lives in `packages/flex-agents-server/src/services/**` for runtime changes and `packages/shared/src/flex/**` for shared contracts; no new packages or directories are required per the source tree guide. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#5-shared-libraries`)

### Testing Standards
- Follow the repository’s Vitest expectations (unit + integration) and reuse the existing in-memory Drizzle harness for persistence specs. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/discovery-agent-backend.md#testing-strategy`)

## Testing
- Add unit specs for the replan trigger logic (goal-condition failure → `goal_condition_failed` frame then replan) and for the planner prompt builder rendering the new section. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- Extend integration specs (e.g., `marketing-flex-run.integration.spec.ts`) to cover an end-to-end run where the first attempt fails a goal predicate, a replan occurs, and the second attempt passes before emitting `complete`. (`docs/architecture/discovery-agent-backend.md#testing-strategy`)
- Update UI/parser tests only if SSE contract changes require them; otherwise document manual validation expectations in the story handoff.

## Future Considerations
- Evaluate whether subsequent stories should let callers configure the maximum automatic goal-condition replans or attach custom remediation prompts for each predicate.
- Consider surfacing failed predicate context in operator tooling (Flex Sandbox, HITL views) for easier debugging once this backend work ships.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-??-?? | v0.1 | Initial draft describing goal-condition replanning workflow. | Bob (Scrum Master) |
| 2025-11-13 | v0.2 | HITL resume flow now re-checks goal predicates, raises replans, and adds regression coverage. | James (Dev) |

## Dev Agent Record

### Agent Model Used
- gpt-5 (Codex CLI)

### Debug Log References
- `npx vitest run packages/flex-agents-server/__tests__/goal-condition-evaluator.spec.ts packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts packages/flex-agents-server/__tests__/flex-goal-condition-replan.spec.ts`
- `npx vitest run packages/flex-agents-server/__tests__/goal-condition-evaluator.spec.ts packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts packages/flex-agents-server/__tests__/flex-goal-condition-replan.spec.ts` (post-resume fix)

### Completion Notes List
- Added automatic goal-condition failure detection that throws `GoalConditionFailedError`, persists failed predicates, and drives capped replans with enriched SSE metadata.
- Extended planner prompt blueprint with `GOAL CONDITION REPAIR`, updated shared types/docs, and added targeted Vitest coverage plus a replan integration harness.
- Ensured HITL resumes re-evaluate goal predicates, throw `GoalConditionFailedError` when necessary, and added a Vitest to lock the behavior.

### File List
- packages/flex-agents-server/src/services/goal-condition-evaluator.ts
- packages/shared/src/flex/types.ts
- packages/flex-agents-server/src/services/flex-execution-engine.ts
- packages/flex-agents-server/src/services/flex-run-coordinator.ts
- packages/flex-agents-server/src/services/orchestrator-persistence.ts
- packages/flex-agents-server/src/services/planner-service.ts
- packages/flex-agents-server/src/services/flex-planner.ts
- packages/flex-agents-server/__tests__/flex-goal-condition-replan.spec.ts
- packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts
- packages/flex-agents-server/__tests__/goal-condition-evaluator.spec.ts
- packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts
- docs/architecture/flex-agents-server/5-core-concepts.md
- docs/architecture/flex-agents-server/10-api-surface-initial.md

## QA Results
- 2025-11-13 – **PASS**: HITL resumes now re-evaluate goal predicates and throw `GoalConditionFailedError` when they fail (`packages/flex-agents-server/src/services/flex-execution-engine.ts:3492`), ensuring AC1 applies both before and after operator intervention. Tests executed: `npx vitest run packages/flex-agents-server/__tests__/goal-condition-evaluator.spec.ts packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts packages/flex-agents-server/__tests__/flex-goal-condition-replan.spec.ts`.
- 2025-11-13 – **FAIL**: `resumePending` never throws `GoalConditionFailedError`, so any HITL-resumed run that still violates a predicate emits `complete` instead of triggering the required planner replan (packages/flex-agents-server/src/services/flex-execution-engine.ts:3348). This leaves operators without automatic recovery and violates AC1.
