# Story 8.16: Capability System Prompt Contract

## Status
Approved

## Story
**As a** flex orchestration maintainer,  
**I want** every registered capability to publish a standardized system prompt that reflects its contracts and responsibilities,  
**so that** the planner and execution services can hand agents consistent, contract-aware instructions without bespoke glue code.

## Acceptance Criteria
1. Extend `CapabilityRegistrationSchema` in `@awesomeposter/shared` to require a `systemPrompt` string (and optional metadata structure) that describes the capability’s job, expected inputs, and required outputs, aligning with the facet-driven contract model. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
2. Persist the `systemPrompt` alongside capability metadata in `flex_capabilities`, expose it through `CapabilityRegistry.listActive/getCapabilityById`, and return it from `POST /api/v1/flex/capabilities/register` responses so orchestration layers can hydrate prompts together with contracts. (`docs/architecture/flex-agents-server.md#9-data-model--persistence`, `docs/architecture/flex-agents-server.md#10-api-surface-initial`)
3. When a capability self-registers, synthesize or validate the `systemPrompt` so it: (a) references each resolved `inputContract` and `outputContract` facet by its catalog key, and (b) embeds the compiled output JSON Schema (or a deterministic excerpt) under an instruction such as “Finalize according to this schema: …”, rejecting registrations that omit any of these elements. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`, `docs/architecture/flex-agents-server.md#facet-catalog`)
4. Update the Strategy Manager, Content Generator, and Quality Assurance capability modules to supply the new prompt field, ensuring their prompts embed the facet coverage, schema excerpt, and execution responsibilities documented for each capability. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
5. Provide automated tests covering: (a) schema/validation failure when `systemPrompt` is missing facet references or the schema excerpt, and (b) successful registry retrieval and serialization of the prompt for active capabilities. (`docs/architecture/flex-agents-server.md#maintenance-checklist`, `docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
6. Refresh architecture documentation (capability inventory tables and related narrative) to describe the new prompt metadata expectations, including facet shout-outs and schema embedding. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)

## Tasks / Subtasks
- [ ] Update shared capability types and Zod schema to include `systemPrompt` (and any supporting metadata) and export the type for downstream services. (AC 1) (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- [ ] Extend `CapabilityRegistry` persistence and DTO mapping so prompts are stored, cached, and returned with active capability snapshots. (AC 2) (`docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- [ ] Add registration validation that ensures prompts mention the job role, each resolved input/output facet key, and include a serialized output schema excerpt, failing fast on missing language. (AC 3) (`docs/architecture/flex-agents-server.md#facet-catalog`)
- [ ] Update capability modules under `packages/flex-agents-server/src/agents/**` to publish the new prompt field with facet-aware copy and schema excerpts. (AC 4) (`docs/architecture/source-tree.md#source-tree-guide`)
- [ ] Write unit/integration tests for schema validation and registry retrieval, following existing capability registry test suites, with assertions on facet references and schema snippets. (AC 5) (`docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
- [ ] Revise architecture docs (capability inventory + prompt expectations) to capture the new metadata requirement, highlighting facet references and schema embedding. (AC 6) (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)

## Dev Notes
- **Previous Story Insights**: Story 8.15 removed `defaultContract` fallbacks, so capability metadata must remain the single source for facet-backed `inputContract` / `outputContract` and any supplemental instructions. `[Source: architecture/flex-agents-server.md#11-capability-registry--agent-contracts]`
- **Data Models**: `flex_capabilities` persists capability metadata (ID, heartbeat, facets, status); extend the record to store prompt text while keeping backward-compatible migrations. `[Source: architecture/flex-agents-server.md#9-data-model--persistence]`
- **API Specifications**: `POST /api/v1/flex/capabilities/register` manages capability onboarding and should echo the stored metadata (now including prompts). `[Source: architecture/flex-agents-server.md#10-api-surface-initial]`
- **Component Specifications**: `CapabilityRegistry` caches active capabilities for planner/execution consumers, while `ContextBuilder` bundles metadata into node payloads; both now require access to the prompt field (including schema excerpts) so planner/execution can forward deterministic instructions. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`
- **File Locations**: Capability modules live under `packages/flex-agents-server/src/agents/`; shared types and facets stay in `packages/shared/src/flex/`. `[Source: architecture/source-tree.md#source-tree-guide]`
- **Testing Requirements**: Reuse the capability registry test suites (`packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts`, etc.) per the maintenance checklist and Vitest strategy. `[Source: architecture/flex-agents-server.md#maintenance-checklist]`, `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`
- **Technical Constraints**: Maintain strict TypeScript/Zod validation, leverage Ajv-compiled facet contracts, and keep prompts in sync with capability metadata to prevent drift. `[Source: architecture/coding-standards.md#language--module-conventions]`, `[Source: architecture/flex-agents-server.md#14-risks--open-questions]`

## Project Structure Notes
- Store prompt-aware capability metadata within the existing agents server package (`packages/flex-agents-server`) and shared types (`packages/shared/src/flex`), aligning with the documented workspace layout. `[Source: architecture/source-tree.md#source-tree-guide]`

## Testing
- `npm run test:unit -- packages/shared/__tests__/flex/capability-registration.spec.ts packages/flex-agents-server/__tests__/capability-registry.spec.ts` (extend existing suites with prompt coverage). `[Source: architecture/flex-agents-server.md#maintenance-checklist]`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 0.1 | Initial draft introducing capability system prompt metadata. | Scrum Master |
