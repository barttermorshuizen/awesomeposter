# Story 9.5: DSL Quantifier Syntax Support

## Status
Done

## Story
**As a** policy author using the condition DSL,  
**I want** to express `some` / `all` quantifiers directly in DSL expressions,  
**so that** I can write readable array predicates without dropping to raw JSON-Logic.  

**Dependencies:** Story 9.4 (runtime quantifier support) must be complete so JSON-Logic generated by the DSL executes correctly. (`docs/stories/9.4.runtime-condition-quantifiers.md`)

## Acceptance Criteria
1. The DSL grammar accepts `some(<collection>, <predicate>)` and `all(<collection>, <predicate>)` expressions, producing AST nodes that transpile to the corresponding JSON-Logic payloads. (`packages/shared/src/condition-dsl/engine.ts`)
2. `parseDsl` validates that `<collection>` resolves to an array-capable variable from the catalog and that the predicate references the current item via `item` (default alias) or an explicit alias when provided. (`docs/architecture/condition-dsl.md`)
3. `toDsl` renders JSON-Logic `some`/`all` expressions back into the canonical DSL form, preserving predicate parentheses where required. (`packages/shared/src/condition-dsl/engine.ts`)
4. Autocomplete/help metadata in the DSL editor documents the new syntax, including examples such as `some(feedback, item.resolution == "open")`. (`src/views/FlexSandboxView.vue`, `docs/prd/epic-9-condition-management.md:12`)
5. Unit and integration tests cover successful parsing/rendering, malformed syntax (missing predicate, non-array collection), and round-trip conversion for representative policies. (`packages/shared/__tests__/condition-dsl.spec.ts`, `tests/fixtures/condition-dsl`)

## Tasks / Subtasks
- [x] Extend tokenizer/parser to recognise quantifier keywords, optional aliases (e.g., `some(feedback as f, f.score >= 0.9)`), and predicate blocks. (AC 1,2)
- [x] Update AST → JSON-Logic transpiler and inverse renderer to handle quantifier nodes. (AC 1,3)
- [x] Add catalog validation ensuring quantifiers only apply to array variables and error when used elsewhere. (AC 2)
- [x] Enhance DSL editor UI hints/autocomplete to list quantifier snippets and documentation links. (AC 4)
- [x] Create fixture-backed tests covering positive/negative round-trips and alias handling. (AC 5)

## Story Context

**Existing System Integration:**
- Integrates with: Shared DSL parser/transpiler (`@awesomeposter/shared/condition-dsl`), Flex Sandbox DSL editor (`src/views/FlexSandboxView.vue`), Nitro validation helper.
- Technology: TypeScript, Pratt-parser extensions, Vue DSL editor components.
- Patterns: Follow existing DSL function-style constructs for future extensibility.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Default alias inside predicates is `item`; users may provide `as <alias>` to override (e.g., `all(results as r, r.status == "ready")`).
2. Predicates may include logical operators and nested comparisons referencing the alias paths (e.g., `item.details.score`).
3. Parser emits clear errors for missing alias keywords, empty predicates, or attempts to access alias outside predicate scope.

### Integration Requirements
4. `toDsl` omits redundant parentheses but retains grouping necessary to preserve predicate semantics.
5. Nitro validation helper maps quantifier-related parse errors to HTTP responses matching existing DSL error contract.
6. DSL editor tooltip links to updated documentation enumerating quantifier usage and limitations.

### Quality Requirements
7. Test coverage for new grammar branches meets or exceeds existing parser thresholds (>95% for quantifier code paths).
8. Golden JSON fixtures include quantifier cases to detect regression in future updates.
9. Type-checking and linting remain green across shared packages and UI.

## Technical Notes
- Consider extending the AST with a dedicated `quantifier` node storing operator, collection path, alias, and predicate expression.
- Reuse existing scope-handling utilities to ensure predicates interpret alias references correctly.
- When rendering back to DSL, normalise whitespace to `some(collection as alias, predicate)` for consistency.

## Definition of Done
- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Tests updated and passing
- [x] DSL editor documentation/tooltips refreshed
- [x] No regressions detected in existing DSL expressions

## Risk and Compatibility Check
- **Primary Risk:** Syntax drift between DSL and JSON-Logic leading to incorrect policy execution.
- **Mitigation:** Round-trip tests, shared fixtures, manual verification in sandbox.
- **Rollback:** Revert parser changes; quantifier support remains usable via raw JSON-Logic thanks to Story 9.4.

**Compatibility Verification**
- [x] No breaking API changes
- [x] Database unaffected
- [x] DSL syntax additive; legacy expressions continue to parse
- [x] Performance impact negligible

## Validation Checklist
- [x] Scope limited to DSL layer
- [x] Dependencies identified (runtime support first)
- [x] Acceptance criteria objectively testable
- [x] Rollback straightforward

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Developer persona)

### Debug Log References
- 2025-11-05: `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts` (pass)

### Completion Notes List
- Added an `all` quantifier DSL/JSON fixture to mirror the existing `some` coverage and keep documentation references accurate.
- Extended quantifier round-trip Vitest cases to exercise the new fixture across parsing and rendering paths.

### File List
- tests/fixtures/condition-dsl/quantifier-all-roundtrip.dsl
- tests/fixtures/condition-dsl/quantifier-all-roundtrip.json
- packages/shared/__tests__/condition-dsl.spec.ts

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 0.3 | Added `all` quantifier round-trip fixture and updated parser/renderer tests per QA follow-up. | Dev |

## QA Results
- `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts`

### Review Date: 2025-11-05
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Quantifier tokens now parse into dedicated AST nodes with alias metadata for round-trip rendering (`packages/shared/src/condition-dsl/engine.ts:462`, `packages/shared/src/condition-dsl/engine.ts:513`).
- Catalog-driven validation enforces array-only collections and alias usage, producing clear `invalid_quantifier` diagnostics when predicates ignore the current item context (`packages/shared/src/condition-dsl/engine.ts:924`, `packages/shared/src/condition-dsl/engine.ts:964`).
- JSON-Logic conversion normalises legacy payloads by rebuilding alias-scoped paths and evaluation scopes so predicates can read default or explicit aliases safely (`packages/shared/src/condition-dsl/engine.ts:1101`, `packages/shared/src/condition-dsl/engine.ts:1638`, `packages/shared/src/condition-dsl/engine.ts:1703`).
- Flex Sandbox now surfaces a quantifier quick-reference card with alias examples to guide policy authors (`src/views/FlexSandboxView.vue:2211`).

### Test Coverage
- Fixtures and round-trip assertions cover quantifier parsing, rendering, and legacy alias inference paths (`packages/shared/__tests__/condition-dsl.spec.ts:104`, `packages/shared/__tests__/condition-dsl.spec.ts:165`, `packages/shared/__tests__/condition-dsl.spec.ts:186`).
- Evaluator specs exercise `some`/`all` semantics, empty collections, array type enforcement, and nested predicate scopes to lock runtime behaviour (`packages/shared/__tests__/condition-dsl.spec.ts:222`, `packages/shared/__tests__/condition-dsl.spec.ts:249`, `packages/shared/__tests__/condition-dsl.spec.ts:290`).

### Acceptance Criteria Traceability
- AC1–AC3 satisfied via parser, renderer, and evaluator updates plus catalog-backed alias validation (`packages/shared/src/condition-dsl/engine.ts:462`, `packages/shared/src/condition-dsl/engine.ts:924`).
- AC4 met through UI quick-reference content and updated architecture notes documenting quantifier syntax and error codes (`src/views/FlexSandboxView.vue:2211`, `docs/architecture/condition-dsl.md:23`).
- AC5 covered with quantifier-specific unit fixtures and negative validations in the Vitest suite (`packages/shared/__tests__/condition-dsl.spec.ts:115`, `packages/shared/__tests__/condition-dsl.spec.ts:123`).

### Risks & Mitigations
- **Coverage gap:** add a dedicated `all(...)` round-trip fixture to mirror the `some` cases and guard alias rendering regressions.

### Recommended Status
- Pass — quantifier syntax, validation, and documentation satisfy the story goals.

### Validation Command(s) Executed
- `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts`

### Review Date: 2025-11-05
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Quantifier parsing builds dedicated AST nodes with alias metadata and range tracking so downstream tooling can enforce scope rules (`packages/shared/src/condition-dsl/engine.ts:462`, `packages/shared/src/condition-dsl/engine.ts:513`).
- Validation ensures quantifiers target catalog arrays and predicates actually reference the in-scope alias, preventing silent misuse (`packages/shared/src/condition-dsl/engine.ts:924`, `packages/shared/src/condition-dsl/engine.ts:964`).
- JSON-Logic conversion keeps alias semantics symmetric in both directions, including optional alias operands for backwards compatibility (`packages/shared/src/condition-dsl/engine.ts:1011`, `packages/shared/src/condition-dsl/engine.ts:1110`).
- DSL evaluator introduces scoped resolution so quantifier predicates read aliased fields without leaking into the global catalog (`packages/shared/src/condition-dsl/engine.ts:1638`, `packages/shared/src/condition-dsl/engine.ts:1676`).
- Flex Sandbox help content now spotlights quantifier usage with explicit alias examples for authors (`src/views/FlexSandboxView.vue:180`).

### Test Coverage
- `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts` (22 tests) — covers quantifier parsing, rendering, negative validation, and evaluator semantics.
- Fixtures exercise `some` round-trips and alias formatting; missing a companion `all` fixture despite being called out in docs (`tests/fixtures/condition-dsl/quantifier-some-roundtrip.dsl`, `docs/architecture/condition-dsl.md:44`).

### Acceptance Criteria Traceability
- AC1 & AC3: Parser and renderer accept/emit quantifier syntax with canonical formatting (`packages/shared/src/condition-dsl/engine.ts:462`, `packages/shared/src/condition-dsl/engine.ts:1229`).
- AC2: Catalog validation blocks non-array collections and enforces alias usage inside predicates (`packages/shared/src/condition-dsl/engine.ts:924`, `packages/shared/src/condition-dsl/engine.ts:964`).
- AC4: UI documentation highlights new syntax with concrete examples (`src/views/FlexSandboxView.vue:180`, `docs/architecture/condition-dsl.md:23`).
- AC5: Vitest suite asserts positive, negative, and evaluator flows for quantifiers (`packages/shared/__tests__/condition-dsl.spec.ts:104`, `packages/shared/__tests__/condition-dsl.spec.ts:222`).

### Risks & Mitigations
- **Fixture gap:** Add a `quantifier-all-roundtrip` DSL/JSON pair so docs stay accurate and round-trip coverage matches `some`. Mitigate by mirroring the existing `some` fixture.

### Recommended Status
- Pass — functionality meets ACs; follow up on `all` fixture to align tests with documentation.

### Validation Command(s) Executed
- `pnpm vitest run packages/shared/__tests__/condition-dsl.spec.ts`
