# Story 9.5: DSL Quantifier Syntax Support

## Status
Draft

## Story
**As a** policy author using the condition DSL,  
**I want** to express `some` / `all` quantifiers directly in DSL expressions,  
**so that** I can write readable array predicates without dropping to raw JSON-Logic.  

**Dependencies:** Story 9.4 (runtime quantifier support) must be complete so JSON-Logic generated by the DSL executes correctly. (`docs/stories/9.4.runtime-condition-quantifiers.md`)

## Acceptance Criteria
1. The DSL grammar accepts `some(<collection>, <predicate>)` and `all(<collection>, <predicate>)` expressions, producing AST nodes that transpile to the corresponding JSON-Logic payloads. (`packages/shared/src/condition-dsl/engine.ts`)
2. `parseDsl` validates that `<collection>` resolves to an array-capable variable from the catalog and that the predicate references the current item via `item` (default alias) or an explicit alias when provided. (`docs/architecture/condition-dsl.md`)
3. `toDsl` renders JSON-Logic `some`/`all` expressions back into the canonical DSL form, preserving predicate parentheses where required. (`packages/shared/src/condition-dsl/engine.ts`)
4. Autocomplete/help metadata in the DSL editor documents the new syntax, including examples such as `some(feedback, item.resolution == "open")`. (`src/views/FlexSandboxView.vue`, `docs/prd/epic-9-condition-management.md:12`)
5. Unit and integration tests cover successful parsing/rendering, malformed syntax (missing predicate, non-array collection), and round-trip conversion for representative policies. (`packages/shared/__tests__/condition-dsl.spec.ts`, `tests/fixtures/condition-dsl`)

## Tasks / Subtasks
- [ ] Extend tokenizer/parser to recognise quantifier keywords, optional aliases (e.g., `some(feedback as f, f.score >= 0.9)`), and predicate blocks. (AC 1,2)
- [ ] Update AST â†’ JSON-Logic transpiler and inverse renderer to handle quantifier nodes. (AC 1,3)
- [ ] Add catalog validation ensuring quantifiers only apply to array variables and error when used elsewhere. (AC 2)
- [ ] Enhance DSL editor UI hints/autocomplete to list quantifier snippets and documentation links. (AC 4)
- [ ] Create fixture-backed tests covering positive/negative round-trips and alias handling. (AC 5)

## Story Context

**Existing System Integration:**
- Integrates with: Shared DSL parser/transpiler (`@awesomeposter/shared/condition-dsl`), Flex Sandbox DSL editor (`src/views/FlexSandboxView.vue`), Nitro validation helper.
- Technology: TypeScript, Pratt-parser extensions, Vue DSL editor components.
- Patterns: Follow existing DSL function-style constructs for future extensibility.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Default alias inside predicates is `item`; users may provide `as <alias>` to override (e.g., `all(results as r, r.status == "ready")`).
2. Predicates may include logical operators and nested comparisons referencing the alias paths (e.g., `item.details.score`).
3. Parser emits clear errors for missing alias keywords, empty predicates, or attempts to access alias outside predicate scope.

### Integration Requirements
4. `toDsl` omits redundant parentheses but retains grouping necessary to preserve predicate semantics.
5. Nitro validation helper maps quantifier-related parse errors to HTTP responses matching existing DSL error contract.
6. DSL editor tooltip links to updated documentation enumerating quantifier usage and limitations.

### Quality Requirements
7. Test coverage for new grammar branches meets or exceeds existing parser thresholds (>95% for quantifier code paths).
8. Golden JSON fixtures include quantifier cases to detect regression in future updates.
9. Type-checking and linting remain green across shared packages and UI.

## Technical Notes
- Consider extending the AST with a dedicated `quantifier` node storing operator, collection path, alias, and predicate expression.
- Reuse existing scope-handling utilities to ensure predicates interpret alias references correctly.
- When rendering back to DSL, normalise whitespace to `some(collection as alias, predicate)` for consistency.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Tests updated and passing
- [ ] DSL editor documentation/tooltips refreshed
- [ ] No regressions detected in existing DSL expressions

## Risk and Compatibility Check
- **Primary Risk:** Syntax drift between DSL and JSON-Logic leading to incorrect policy execution.
- **Mitigation:** Round-trip tests, shared fixtures, manual verification in sandbox.
- **Rollback:** Revert parser changes; quantifier support remains usable via raw JSON-Logic thanks to Story 9.4.

**Compatibility Verification**
- [x] No breaking API changes
- [x] Database unaffected
- [x] DSL syntax additive; legacy expressions continue to parse
- [x] Performance impact negligible

## Validation Checklist
- [x] Scope limited to DSL layer
- [x] Dependencies identified (runtime support first)
- [x] Acceptance criteria objectively testable
- [x] Rollback straightforward
