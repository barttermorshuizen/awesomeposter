# Story 8.28: Flex HITL Multi-Turn Clarification Support

## Status
Ready for dev

## Story
**As a** HITL operator,  
**I want** my clarification answers to flow back into the paused plan node before execution resumes,  
**so that** the flex orchestrator matches legacy multi-turn behaviour and agents can act on operator guidance instead of only receiving approve/reject decisions.

## Acceptance Criteria
1. `/api/hitl/resume` (and the flex resume handler introduced in Story 8.5) accept `responses[]` payloads that include freeform or option responses, persist them, and surface the most recent response bundle when flex execution restarts, in line with `docs/architecture/epic-1-hitl-architecture.md#5-key-data-flows`.  
2. `FlexExecutionEngine` and `FlexRunCoordinator` ingest non-approval HITL responses when resuming a paused node, injecting operator-provided clarifications back into the node’s `ContextBundle` (or planner delta) before dispatch, matching the expectations in `docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`.  
3. SSE telemetry exposes `hitl_update` / `hitl_resolved` frames that include the appended responses so UI stores can render operator dialogue, and the resume stream reflects the clarified payloads (`docs/architecture/epic-1-hitl-architecture.md#5-key-data-flows`, `docs/architecture/flex-agents-server.md#10-0-1-flex-run-streaming-contract`).  
4. Tests cover: (a) recording multiple clarification responses, (b) resuming execution with the clarified payload injected, and (c) rejecting stale resume attempts that omit the latest responses (`docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`).  
5. Documentation updates capture the clarified payload contract in `flex-agents-server.md` and front-end HITL runbooks, noting that operator guidance is replayed into planner/execution prompts (`docs/architecture/flex-agents-server.md#8-hitl-and-rehydration-strategy`, `docs/architecture/hitl/4-target-component-architecture.md`).

## Tasks / Subtasks
- [ ] Extend HITL repositories/services to persist and return clarification responses with the resume payload (AC 1-2).  
- [ ] Update `FlexRunCoordinator` / `FlexExecutionEngine` to hydrate node context with operator responses prior to re-dispatch, including planner re-request flows (AC 2).  
- [ ] Emit enriched HITL SSE frames and ensure front-end stores display the dialogue history (AC 3).  
- [ ] Add Vitest coverage for multi-turn resume flows and stale state protection (AC 4).  
- [ ] Refresh architecture and operator documentation to describe the updated resume payloads and UI expectations (AC 5).

## Story Context

**Dependencies**
- Builds on Story 8.5 (Flex Run Resume & Debug Interfaces) which introduces the resume controller and debug endpoint this work must extend (`docs/stories/8.5.flex-run-interfaces.md`).
- Relies on Story 8.21 (Flex HITL Operator Prompt Payloads) to provide enriched HITL metadata alongside the clarifications (`docs/stories/8.21.flex-hitl-operator-prompts.md`).

**Non-Goals**
- Introducing new HITL request types beyond clarification/approval workflows.
- Rewriting the existing operator UI—only the data contract and rendered dialogue need updates.

## Definition of Done
- [ ] Acceptance Criteria satisfied.  
- [ ] Tests pass and cover multi-turn resume scenarios.  
- [ ] Documentation updated and reviewed with operator enablement.  
- [ ] QA review requested once implementation completes.

## Risk & Mitigation
- **Risk:** Replay logic could regress existing approve/reject flows.  
  **Mitigation:** Add regression tests ensuring approvals continue to trigger existing policy actions.

## Validation Checklist
- [ ] Story can be completed in one development session.  
- [x] Integration points are clearly specified.  
- [x] Success criteria are testable.  
- [x] Rollback approach is simple (fall back to approval-only flow).
