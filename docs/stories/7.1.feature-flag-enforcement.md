# Story 7.1: Feature Flag Enforcement

## Status
Done

## Story
**As the** platform,
**I want** discovery services to honor client-level feature flags,
**so that** only approved pilots use the discovery agent.

## Acceptance Criteria
1. Backend services (ingestion, scoring, dashboard APIs) check feature flag before processing client data and short-circuit when disabled.
2. Disabled clients receive clear messaging in UI explaining discovery agent is not enabled.
3. Default state for new clients is disabled; enabling requires explicit flag toggle.
4. Flag state cached for performance but refreshed within 2 minutes of change.

## Tasks / Subtasks
- [x] Integrate with existing feature flag provider or implement new table keyed by client (AC 1, AC 3).
- [x] Add middleware/guards to backend services to enforce flag (AC 1).
- [x] Update frontend routes to hide dashboard and display disabled banner (AC 2).
- [x] Implement cache invalidation strategy and tests to ensure refresh within SLA (AC 4).
- [x] Document enforcement behavior and default state (AC 3).

## Dev Notes
- Fail safe: if flag lookup errors, treat as disabled.
- Ensure telemetry does not record data for disabled clients.

### Testing
- Unit tests for middleware guard logic.
- End-to-end test toggling flag and verifying UI/ingestion behavior.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Feature Flag & Pilot Enablement. | PM |

## Dev Agent Record
- **Agent**: James (GPT-5 / Full Stack Developer)
- **Summary**: Added the `client_features` schema/migration, implemented Redis-backed + in-process caching helpers for feature flags on both Nitro and agents server, enforced gating across discovery APIs/SSE/scoring plus new `/api/clients/:id/feature-flags`, and refreshed the client edit UI/documentation/tests to surface disabled-state messaging.
- **Validations**: `npm run test:unit` (passes with stubbed `@upstash/redis`).
- **Follow-ups / Notes**: Network restrictions blocked installing `@upstash/redis`; run `npm install` locally to fetch the real package. Full end-to-end toggle verification depends on Story 7.2 admin UI.

## QA Results

### Review Date: 2025-10-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Feature flag helpers fail closed, share a single cache invalidation path, and surface consistent `FeatureFlagDisabledError` messaging (`server/utils/client-config/feature-flags.ts`).
- Discovery repositories, API handlers, and agents server all assert the flag before mutating or reading discovery data, preventing leakage for disabled clients (`server/utils/discovery-repository.ts`, `server/api/events/discovery.get.ts`, `packages/agents-server/src/tools/io.ts`).

### Issues
- None.

### Test Coverage
- Reviewed: `server/utils/__tests__/feature-flags.spec.ts`, `server/utils/__tests__/feature-flag-admin.spec.ts`, `tests/api/discovery/events-stream.spec.ts`, `src/__tests__/ClientDiscoverySourcesPanel.spec.ts`, `src/__tests__/ClientDiscoveryKeywordsPanel.spec.ts`.
- Trace: AC1–AC4 covered through unit, component, and API tests.

### NFR Assessment
- Security: PASS – Flag checks guard every discovery entry point and default to disabled on lookup errors.
- Performance: PASS – Cache TTL is 2 minutes with immediate invalidation on toggles; no excessive lookups observed.
- Reliability: PASS – SSE `feature_disabled` events close clients promptly and UI tests confirm rollback of state.
- Maintainability: PASS – Shared helpers and audit logging keep flag logic centralized with regression coverage.

### Gate Status
Gate: PASS → docs/qa/gates/7.1-feature-flag-enforcement.yml

### Review Date: 2025-10-03

### Reviewed By: Quinn (Test Architect)

### Scope & Observations
- Backend handlers gate discovery features with `requireDiscoveryFeatureEnabled` before performing I/O or scoring, preventing disabled tenants from reading/writing discovery data (`server/api/events/discovery.get.ts:88`, `server/api/rank-variants.post.ts:23`, `server/utils/discovery-repository.ts:101`, `packages/agents-server/src/tools/io.ts:16`).
- Cache TTL meets the 2-minute refresh SLA and invalidation flushes Redis plus in-process caches on toggles while failures fail closed for 30 seconds (`server/utils/client-config/feature-flags.ts:107`, `server/utils/client-config/feature-flags.ts:118`).
- Front-end hides discovery tooling and surfaces actionable messaging when disabled; SSE listeners roll back local state on `feature_disabled` events (`src/views/ClientsEditView.vue:588`, `src/components/clients/ClientDiscoverySourcesPanel.vue:33`, `src/__tests__/ClientDiscoverySourcesPanel.spec.ts:108`).

### Issues
- None.

### Test Coverage
- Exercised `npm run test:unit`; reviewed `tests/api/discovery/events-stream.spec.ts`, `server/utils/__tests__/feature-flags.spec.ts`, `src/__tests__/ClientDiscoverySourcesPanel.spec.ts`, `src/__tests__/ClientDiscoveryKeywordsPanel.spec.ts` – AC1–AC4 covered.

### NFR Assessment
- Security: PASS – Flag guards enforce 403s across API, repositories, and agents server while defaulting to disabled on lookup errors.
- Performance: PASS – Redis-backed cache invalidates on toggles and falls back to a 30s fail-safe entry; TTL satisfies the 2-minute refresh SLA.
- Reliability: PASS – SSE cleanup on disable events and shared cache invalidation prevent stale consumers from continuing.
- Maintainability: PASS – Shared helpers centralize flag logic for Nitro and agents server with targeted unit coverage.

### Gate Status
Gate: PASS → docs/qa/gates/7.1-feature-flag-enforcement.yml
