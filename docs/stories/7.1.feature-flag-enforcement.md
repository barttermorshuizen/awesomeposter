# Story 7.1: Feature Flag Enforcement

## Status
Ready for Review

## Story
**As the** platform,
**I want** discovery services to honor client-level feature flags,
**so that** only approved pilots use the discovery agent.

## Acceptance Criteria
1. Backend services (ingestion, scoring, dashboard APIs) check feature flag before processing client data and short-circuit when disabled.
2. Disabled clients receive clear messaging in UI explaining discovery agent is not enabled.
3. Default state for new clients is disabled; enabling requires explicit flag toggle.
4. Flag state cached for performance but refreshed within 2 minutes of change.

## Tasks / Subtasks
- [x] Integrate with existing feature flag provider or implement new table keyed by client (AC 1, AC 3).
- [x] Add middleware/guards to backend services to enforce flag (AC 1).
- [x] Update frontend routes to hide dashboard and display disabled banner (AC 2).
- [x] Implement cache invalidation strategy and tests to ensure refresh within SLA (AC 4).
- [x] Document enforcement behavior and default state (AC 3).

## Dev Notes
- Fail safe: if flag lookup errors, treat as disabled.
- Ensure telemetry does not record data for disabled clients.

### Testing
- Unit tests for middleware guard logic.
- End-to-end test toggling flag and verifying UI/ingestion behavior.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Feature Flag & Pilot Enablement. | PM |

## Dev Agent Record
- **Agent**: James (GPT-5 / Full Stack Developer)
- **Summary**: Added the `client_features` schema/migration, implemented Redis-backed + in-process caching helpers for feature flags on both Nitro and agents server, enforced gating across discovery APIs/SSE/scoring plus new `/api/clients/:id/feature-flags`, and refreshed the client edit UI/documentation/tests to surface disabled-state messaging.
- **Validations**: `npm run test:unit` (passes with stubbed `@upstash/redis`).
- **Follow-ups / Notes**: Network restrictions blocked installing `@upstash/redis`; run `npm install` locally to fetch the real package. Full end-to-end toggle verification depends on Story 7.2 admin UI.
