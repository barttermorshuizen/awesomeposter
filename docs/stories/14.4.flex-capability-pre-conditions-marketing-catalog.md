# Story 14.4: Capability Pre-Conditions – Marketing Catalog Adoption

## Status
Ready for Dev

## Story
**As a** flex capability catalog maintainer,  
**I want** every curated marketing capability to publish the same `preConditions` metadata introduced in Stories 14.1–14.3,  
**so that** planner/runtime gating covers production-ready strategist, copywriter, and designer agents and operators can trust prerequisites are satisfied before invocation.

**Dependencies:**  
- Story 14.1 – Capability Pre-Condition Metadata & Persistence (`docs/stories/14.1.flex-capability-pre-conditions-metadata.md`)  
- Story 14.2 – Capability Pre-Condition Runtime Gating & Policies (`docs/stories/14.2.flex-capability-pre-conditions-runtime.md`)  
- Story 14.3 – Capability Pre-Condition Tooling, Telemetry & Pilot Adoption (`docs/stories/14.3.flex-capability-pre-conditions-tooling.md`)

## References
- `docs/prd/epic-flex-capability-pre-conditions.md#stories`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`
- `docs/architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry`
- `docs/architecture/flex-agents-server/5-core-concepts.md#561-capability-registration`
- `docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#5-shared-libraries`
- `docs/architecture/source-tree.md#6-documentation-assets`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/condition-dsl.md#dsl-shape-and-operators`
- `docs/architecture/flex-agents-server/511-reference-capability-registry.md#preconditions-payload-shape`

## Acceptance Criteria
Pre-condition schema (recap): `FacetCondition { id, description, facets: string[], dsl: ConditionNode, compiled: JsonLogicRules, rationale?: string }`. DSL root operators: `and`, `or`, `not`; atoms: `equal`, `exists`, `in`, `gte`, `lte`, `string_contains`, `length_gte`. Compiled JSON-Logic mirrors the DSL.
1. **Marketing catalog publishes canonical pre-conditions.** `packages/shared/src/flex/marketing-catalog.ts` (and any mirrored fixtures) define `preConditions: FacetCondition[]` for every curated capability, covering `strategist.SocialPosting`, `strategist.Positioning`, `copywriter.SocialpostDrafting`, `copywriter.Messaging`, `designer.VisualDesign`, `director.SocialPostingReview`, and `director.PositioningReview`. Each predicate aligns with a documented input/output facet/path (e.g., required brief completeness, asset availability) and includes DSL + compiled JSON-Logic metadata; capabilities that cannot express meaningful guards set `preConditions = []` with rationale. (Sources: `docs/architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
   - Example (`strategist.SocialPosting`): DSL `and([ exists("brief.id"), length_gte("brief.content", 200), exists("assets.heroImage") ])`; compiled JSON-Logic `{ "and": [ { "!!": { "var": "brief.id" } }, { ">=": [ { "var": "brief.content.length" }, 200 ] }, { "!!": { "var": "assets.heroImage" } } ] }`. Rationale: saved brief, minimum content length, and hero asset before dispatch.
2. **Agent modules self-register with the new guards.** Nitro bootstrap modules (`packages/flex-agents-server/src/agents/**`) import the updated catalog data (or explicitly set matching pre-conditions) so `/api/v1/flex/capabilities/register` receives the compiled predicates, and `listActive/getCapabilityById` returns them via the registry cache, ensuring planner CRCS rows and runtime gating reuse the shared metadata without divergence. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`, `docs/architecture/flex-agents-server/5-core-concepts.md#561-capability-registration`)
   - Rollout/rollback: clear or adjust `preConditions` entries to disable guards; rely on registry refresh/TTL or service restart to propagate removal without deleting other catalog metadata.
3. **Documentation enumerates marketing pre-condition guards.** `docs/architecture/flex-agents-server/511-reference-capability-registry.md` (and rollout notes) list each capability’s guarded facets, pointer, and predicate intent so downstream teams know how gating behaves. Rollback guidance explains how to disable guards (e.g., remove `preConditions` entries) without deleting the rest of the marketing catalog. (Sources: `docs/architecture/source-tree.md#6-documentation-assets`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#marketing-catalog-rollout--rollback`)
4. **Regression coverage locks the payload contract.** Existing suites that snapshot capability registrations (`packages/shared/__tests__/flex/capability-registration.spec.ts`, `packages/flex-agents-server/__tests__/flex-capability-register.route.spec.ts`, `packages/flex-agents-server/__tests__/flex-capability-registry.spec.ts`, `packages/flex-agents-server/__tests__/marketing-strategy-smoke.spec.ts`) assert the `preConditions` arrays, DSL canonicalisation, and summary metadata so future catalog edits can’t regress gating inadvertently. (Sources: `docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
5. **Planner/runtime consumers degrade gracefully.** When a marketing capability legitimately lacks a predicate, the catalog explicitly sets `preConditions = []` with rationale; acceptance includes verifying planner/runtime/telemetry treat such entries as no-op while still surfacing guard summaries in SSE payloads and UI without errors. (Sources: `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)

## Tasks / Subtasks
- [ ] Add `preConditions` to curated marketing capability records (and supporting fixtures) with DSL + compiled JSON-Logic aligned to facets. (AC1) (`docs/architecture/flex-agents-server/511-reference-capability-registry.md#reference-capability-registry`)
- [ ] Ensure agent bootstrap modules register the guards; verify registry list/get APIs return them. (AC2) (`docs/architecture/flex-agents-server/5-core-concepts.md#561-capability-registration`)
- [ ] Update reference/rollout docs for marketing capabilities, including rollback steps. (AC3) (`docs/architecture/source-tree.md#6-documentation-assets`)
- [ ] Extend registration/registry smoke tests to snapshot pre-condition payloads and metadata. (AC4) (`docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Validate planner/runtime/telemetry/UI paths handle empty-guard capabilities gracefully. (AC5) (`docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)

## Story Context
- Completes Epic FLEX-CAP-PRE-1 by applying the new guardrails to production catalog entries after runtime and UI support are proven in Stories 14.1–14.3. (`docs/prd/epic-flex-capability-pre-conditions.md#stories`)
- Mirrors Story 13.4 for post-conditions but focuses on pre-dispatch guardrails, default replan policies, and monitor-first rollout.
