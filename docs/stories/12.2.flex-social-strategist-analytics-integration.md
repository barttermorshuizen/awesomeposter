# Story 12.2: Social Strategist Analytics Signal Integration

## Status
Ready for Dev

## Story
**As a** flex marketing orchestration lead,  
**I want** the social strategist agent to ingest channel and company performance analytics during planning,  
**so that** generated briefs reflect data-backed guidance even when retrieval knowledge alone is insufficient.

**Dependencies:** Requires completion of Story 12.1 to ensure the strategist already consumes curated retrieval context before layering analytics signals. (`docs/stories/12.1.flex-social-strategist-rag-foundation.md`)

## References
- `docs/prd/epic-flex-social-strategist-enhancement.md`
- `docs/stories/12.1.flex-social-strategist-rag-foundation.md`
- `docs/architecture/flex-agents-server/4-high-level-architecture.md`
- `docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md`
- `docs/architecture/flex-agents-server/9.1-capability-registration-flow.md#91-capability-registration-flow`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`
- `docs/architecture/flex-agents-server/13-verification.md`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#4-agents-server-standards`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/flex-agents-server/index.md`

## Acceptance Criteria
1. `ContextBuilder` enriches `strategist.SocialPosting` runs with analytics summaries (e.g., channel benchmarks, recent campaign KPIs) sourced via a new analytics tool helper, merging the payload into the `ContextBundle` alongside retrieval knowledge while falling back cleanly when metrics are unavailable. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
2. The strategist capability registration advertises analytics readiness (configuration hints, health flags, telemetry metadata) without altering external API contracts, ensuring registry entries and SSE emissions expose analytics state for observability. (`docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/9.1-capability-registration-flow.md#91-capability-registration-flow`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
3. Analytics helper returns a deterministic “no data available” payload when upstream metrics are missing or external services fail, ensuring strategist runs continue with baseline context and explicit fallback messaging. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
4. Vitest coverage exercises strategist runs for analytics-hit and no-data fallback scenarios, asserting telemetry frames record analytics status and that fallback paths mirror baseline behaviour. (`docs/prd/epic-flex-social-strategist-enhancement.md#success-criteria`, `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/13-verification.md`)
5. Flex agents architecture documentation is updated with an analytics integration section outlining tool contracts, configuration hooks, telemetry expectations, and maintenance steps for future agents. (`docs/prd/epic-flex-social-strategist-enhancement.md`, `docs/architecture/flex-agents-server/index.md`)

## Tasks / Subtasks
- [ ] Define analytics insight scope (metrics, channels, data freshness), document dependencies, and specify the structured “no data available” fallback payload. (AC 1, AC 3) (`docs/prd/epic-flex-social-strategist-enhancement.md`)
- [ ] Implement analytics tool helpers within `packages/flex-agents-server/src/` that fetch performance signals and expose typed results for `ContextBuilder`, including graceful error handling and context merge logic. (AC 1) (`docs/architecture/flex-agents-server/5-core-concepts.md#55-contextbundle`, `docs/architecture/source-tree.md#4-agents-server`)
- [ ] Update the strategist capability module to register analytics configuration metadata, health indicators, and telemetry hooks while keeping contracts compatible. (AC 2) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
- [ ] Ensure analytics helpers emit the “no data available” payload on errors or empty responses and surface that state in strategist telemetry. (AC 3) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/flex-agents-server/7-execution-flow.md#7-execution-flow`)
- [ ] Extend Vitest suites covering strategist runs to assert analytics data appears in telemetry and that fallback executions emit the expected “no data available” context while matching retrieval-only outputs. (AC 4) (`docs/architecture/flex-agents-server/13-verification.md`, `docs/prd/epic-flex-social-strategist-enhancement.md#success-criteria`)
- [ ] Document analytics integration patterns in the flex agents architecture (tool contracts, telemetry, maintenance expectations) to satisfy knowledge-sharing requirements. (AC 5) (`docs/architecture/flex-agents-server/index.md`)

## Story Context
- Epic goal is to augment the strategist with data-driven insights, knowledge retrieval, and asset awareness without changing planner/orchestrator contracts. (`docs/prd/epic-flex-social-strategist-enhancement.md`)
- Current strategist capability relies on facet-driven contracts registered in the capability catalog; analytics wiring must respect the same schemas. (`docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory`)
- Flex agents execution continues to stream lifecycle events via the existing SSE API, so analytics telemetry should piggyback on established event structures. (`docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`)

## Dev Notes
- **Previous Story Insights:** Retrieval foundation (Story 12.1) already merges knowledge snippets into strategist context and emphasizes fallback behaviour; analytics should reuse that guardrail approach. [Source: docs/stories/12.1.flex-social-strategist-rag-foundation.md]
- **Data Models:** Persisted flex run tables (`flex_runs`, `flex_plan_nodes`) capture context state for auditing; analytics signals should remain contextual data unless persistence becomes necessary. [Source: architecture/flex-agents-server/9-data-model-persistence.md]
- **API Specifications:** Analytics-enhanced runs continue to flow through `/api/v1/flex/run.stream`, emitting standard `FlexEvent` telemetry for consumers. [Source: architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
- **Component Specifications:** `ContextBuilder` assembles invocation payloads, `ExecutionEngine` dispatches strategist nodes, and `TelemetryService` reports lifecycle frames; analytics helpers must integrate with these components without altering control flow. [Source: architecture/flex-agents-server/6-component-responsibilities.md#6-component-responsibilities] [Source: architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity] [Source: architecture/flex-agents-server/7-execution-flow.md#7-execution-flow]
- **File Locations:** Strategist agent code and utilities live under `packages/flex-agents-server/src/agents/marketing/` with shared helpers in `packages/shared/`; place analytics modules alongside existing strategist assets. [Source: architecture/source-tree.md#4-agents-server] [Source: architecture/flex-agents-server/11-capability-registry-agent-contracts.md#current-inventory]
- **Testing Requirements:** Extend Vitest coverage within `packages/flex-agents-server/__tests__/` to assert analytics paths and fallbacks, aligning with existing verification suites. [Source: architecture/flex-agents-server/13-verification.md]
- **Technical Constraints:** Implement changes in TypeScript, honour strict typing, follow agents-server coding standards, and keep compatibility boundaries intact. [Source: architecture/tech-stack.md#1-core-runtime-components] [Source: architecture/coding-standards.md#4-agents-server-standards] [Source: docs/prd/epic-flex-social-strategist-enhancement.md#compatibility-requirements]
- **Documentation Requirements:** Update the flex agents architecture specification with analytics tooling guidance for future teams. [Source: architecture/flex-agents-server/index.md]
- **Runtime Practices:** Maintain resilient analytics calls that fall back to deterministic “no data available” messaging so strategist behaviour remains stable during outages.

## Project Structure Notes
- Keep analytics helpers, strategist updates, and related tests inside the agents server workspace, adding shared types only if multiple capabilities will reuse them. [Source: architecture/source-tree.md#4-agents-server]

## Testing
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts` (extend with analytics scenarios). [Source: architecture/flex-agents-server/13-verification.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 0.1 | Draft story defining strategist analytics integration scope, fallback handling, telemetry, and verification tasks. | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
