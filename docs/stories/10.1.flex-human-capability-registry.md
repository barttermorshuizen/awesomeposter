# Story 10.1: Flex Human Capability Registry Contracts

## Status
Done

## Story
**As a** flex orchestrator architect,  
**I want** human-operated capabilities registered with facet-backed contracts and instruction templates,  
**so that** the planner and execution engine can schedule human nodes with the same determinism and auditability used for AI agents.

**Dependencies:** Completion of Epic Flex Agents Server foundations (Stories 8.x) that established the capability registry and facet catalog. (`docs/prd/epic-flex-agents-server.md:18`)

## Acceptance Criteria
1. Capability registry accepts and persists `HumanAgent.*` entries that declare `agentType: "human"` alongside compiled `inputContract` / `outputContract` derived from existing facets. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
2. Each registered human capability includes instruction templates and assignment metadata defaults so downstream tooling can render structured task guidance without ad-hoc configuration. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
3. Planner-facing catalog (`packages/shared/src/flex/facets/catalog.ts`) and capability inventory tables document the new human capabilities, keeping facet coverage synchronized with registry payloads. (`docs/architecture/flex-agents-server.md#facet-catalog`, `docs/architecture/flex-agents-server.md#current-inventory`)
4. Automated tests cover capability registration, heartbeat refresh, and schema compilation for human entries, ensuring parity with existing AI capability suites. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/flex-agents-server.md#13-verification`)

## Tasks / Subtasks
- [x] Extend capability registry models and self-registration helpers to support `agentType: "human"` with facet-derived contracts and instruction templates. (AC 1,2) (`docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- [x] Author initial human capability modules (e.g., `HumanAgent.clarifyBrief`) under `packages/flex-agents-server/src/agents/`, exporting registry payloads with compiled `inputFacets` / `outputFacets`, instruction strings, and assignment defaults. (AC 1,2) (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- [x] Update shared facet catalog and documentation tables to include human-facing facets and ensure registry inventory stays consistent. (AC 3) (`docs/architecture/flex-agents-server.md#facet-catalog`, `docs/architecture/flex-agents-server.md#current-inventory`)
- [x] Add Vitest coverage validating human capability registration, compiled schema output, and heartbeat refresh behavior; ensure suites run via `npm run test:unit`. (AC 4) (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
- [x] Document human capability registration process in architecture/operations notes to aid operator onboarding and governance reviews. (AC 2,3) (`docs/architecture/flex-agents-server.md#157-benefits-and-alignment`)

## Story Context

**Existing System Integration**
- Capability Registry registers AI agent payloads via Nitro startup plugins and self-registration schedules; same path must now handle human entries. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- Planner and execution engine consume facet-backed contracts from the registry to build plan graphs; consistent metadata is required for new human nodes. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- Operator tooling (SPA, notification services) relies on assignment metadata surfaced through registry payloads. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- Human operators can decline assignments; orchestrator should fail the affected run and avoid retrying. Decline timeout respects `.env` value `FLEX_HUMAN_ASSIGNMENT_TIMEOUT_SECONDS`, and notification services send a single assignment notice before falling back to failure handling.

## Dev Notes

- **Previous Story Insights:** No prior stories completed for Epic 10; no historical implementation notes available.
- **Data Models:** `flex_capabilities` table stores capability metadata, including `capability_id`, timestamps, and status; registry persists compiled JSON Schemas and facet coverage. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- **API Specifications:** Registry service exposes `listActive` / `getCapabilityById` for planner consumers and requires facet validation during registration. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`)
- **Component Specifications:** Human capabilities live beside existing agent modules under `packages/flex-agents-server/src/agents/`, carrying instruction templates and heartbeat registration logic. (`docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- **File Locations:** Follow source tree guidance—agents server code in `packages/flex-agents-server/src`, shared facet catalog in `packages/shared/src/flex/facets/catalog.ts`, documentation under `docs/architecture/`. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#5-shared-libraries`)
- **Testing Requirements:** Use Vitest suites highlighted in architecture verification (`packages/shared/__tests__/flex/facet-contract-compiler.spec.ts`, `packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts`) and extend them for human capabilities. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
- **Technical Constraints:** Maintain TypeScript-first implementation with strict typing, reuse Zod validation, and comply with repo coding standards. (`docs/architecture/coding-standards.md#1-language--module-conventions`)
- **Project Structure Notes:** Alignment confirmed with source tree guidance; no deviations required. (`docs/architecture/source-tree.md#4-agents-server`)

## Testing
- `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts packages/flex-agents-server/__tests__/human-capabilities.spec.ts`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-31 | 0.1 | Initial draft defining human capability registry scope. | Scrum Master |
| 2025-10-25 | 0.2 | Implemented human capability registry support, facets, documentation, and coverage. | James (Dev Agent) |

## QA Results

- **Decision:** PASS – capability registry surfaces `HumanAgent.clarifyBrief` with facet-backed contracts, instructions, and assignment defaults, and documentation stays synchronized.
- **Validation:** `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts packages/flex-agents-server/__tests__/human-capabilities.spec.ts`
- **Risks:** `FLEX_HUMAN_ASSIGNMENT_TIMEOUT_SECONDS` values between 0 and 1 second floor to `0`, which would violate the positive timeout expectation; treat such overrides as misconfiguration until follow-up validation lands.
