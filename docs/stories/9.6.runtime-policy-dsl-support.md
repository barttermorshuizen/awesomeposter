# Story 9.6: Runtime Policy DSL Condition Support

## Status
Draft

## Story
**As a** Flex orchestrator engineer,  
**I want** runtime policy triggers to accept the condition DSL directly,  
**so that** operators can author and maintain policy guardrails without translating expressions into raw JSON-Logic.  

**Dependencies:** Story 9.3 (DSL editor integration), Story 9.4 (runtime quantifier evaluation), Story 9.5 (DSL quantifier syntax). (`docs/stories/9.3.flex-sandbox-dsl-integration.md`, `docs/stories/9.4.runtime-condition-quantifiers.md`, `docs/stories/9.5.dsl-quantifier-syntax.md`)

## Acceptance Criteria
1. TaskEnvelope runtime policies may supply a DSL string for `trigger.condition`; normalization compiles it with `parseDsl` against the shared catalog, stores canonical JSON-Logic, and preserves the DSL text for round-trip editing. (`docs/architecture/condition-dsl.md#api-surface`, `docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`)
2. Nitro policy validation accepts either DSL or JSON-Logic inputs, emits `invalid_condition_dsl` diagnostics via `validateConditionInput`, and returns the same structured errors used elsewhere. (`docs/architecture/condition-dsl.md#server-helper`)
3. Flex runtime execution evaluates DSL-derived policies through the existing JSON-Logic path so telemetry (`policy_triggered`) and action dispatch remain unchanged. (`docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`)
4. Flex Sandbox UI supports loading, editing, and saving DSL-backed runtime policies, including JSON preview parity and gated rollout through the existing DSL feature flag. (`docs/prd/epic-9-condition-management.md:18`)
5. Automated tests cover DSL policy normalization, error handling, runtime trigger evaluation, and UI save flows with representative quantifier predicates. (`docs/architecture/condition-dsl.md#tests-fixtures`, `docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy`)

## Tasks / Subtasks
- [ ] Extend policy normalization to detect DSL strings, compile them with the shared parser, and persist JSON-Logic plus DSL metadata. (AC 1,3)
- [ ] Update Nitro validation endpoints to invoke `validateConditionInput` for DSL submissions and surface consistent error payloads. (AC 2)
- [ ] Wire Flex Sandbox policy forms to persist DSL + JSON, migrate legacy policies on load, and respect the DSL feature flag. (AC 4)
- [ ] Add regression tests covering DSL normalization, runtime trigger execution, and representative quantifier expressions. (AC 5)
- [ ] Refresh architecture and authoring docs to describe DSL usage in runtime policies. (AC 1,2,4)

## Story Context

**Existing System Integration:**
- Shared condition DSL engine (`@awesomeposter/shared/condition-dsl`) used by UI and server validation. [Source: architecture/condition-dsl.md#api-surface]
- Runtime policy evaluation inside the Flex orchestrator (`packages/flex-agents-server`) that triggers actions deterministically. [Source: architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]
- Flex Sandbox policy authoring surfaces that already expose DSL editing with JSON preview. [Source: prd/epic-9-condition-management.md:18]

## Acceptance Criteria (Detailed)

### Functional Requirements
1. DSL strings compile to JSON-Logic during policy normalization, preserving canonical JSON for execution while storing DSL text for editing. [Source: architecture/condition-dsl.md#api-surface]
2. Legacy JSON-only policies continue to validate without DSL metadata, ensuring backward compatibility. [Source: architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]
3. Quantifier predicates (`some`, `all`) behave identically when authored through DSL or JSON-Logic. [Source: architecture/condition-dsl.md#quantifier-support]

### Integration Requirements
4. Nitro validation helper surfaces `invalid_condition_dsl` responses with line/column ranges when parsing fails. [Source: architecture/condition-dsl.md#server-helper]
5. Flex Sandbox saves both DSL and JSON representations under the existing feature flag to maintain rollout control. [Source: prd/epic-9-condition-management.md:32]
6. Policy telemetry continues to emit `policy_triggered` events with the original action metadata when DSL-backed conditions fire. [Source: architecture/flex-agents-server/4-high-level-architecture.md#policy-triggered--plan-updated]

### Quality Requirements
7. Vitest suites cover normalization fallbacks, DSL error propagation, and runtime trigger execution with quantifier predicates. [Source: architecture/condition-dsl.md#tests-fixtures]
8. UI integration tests confirm DSL editor save/load flows and feature-flag fallback. [Source: prd/epic-9-condition-management.md:32]
9. Documentation updates clarify runtime policy DSL support for operators and developers. [Source: architecture/condition-dsl.md#keep-this-document-in-sync]

## Technical Notes
- Reuse `parseDsl` / `toDsl` and `conditionVariableCatalog` to avoid divergence between UI and runtime validation. [Source: architecture/condition-dsl.md#api-surface]
- Runtime policies remain deterministic guardrails; ensure DSL support does not introduce new action types or selector semantics. [Source: architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]
- Quantifier semantics require array paths; validation must surface `invalid_quantifier` diagnostics when misuse occurs. [Source: architecture/condition-dsl.md#quantifier-support]

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Tests added and passing (unit, integration, UI as applicable)
- [ ] Documentation updated for runtime policy DSL usage
- [ ] Feature flag strategy validated for rollout/fallback

## Risk and Compatibility Check
- **Primary Risk:** Miscompiled DSL expressions could desync runtime policies from operator intent, leading to missed guardrails or false triggers.
- **Mitigation:** Shared parser usage, comprehensive regression tests, and feature-flag controlled rollout. [Source: architecture/condition-dsl.md#tests-fixtures]
- **Rollback:** Disable DSL acceptance in policy normalization and rely on existing JSON-Logic paths while retaining stored DSL text for editors. [Source: architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]

**Compatibility Verification**
- [x] No breaking API changes (DSL support additive to existing JSON field)
- [x] Database untouched (metadata stored alongside existing policy payloads)
- [x] Runtime evaluation path preserved (JSON-Logic still canonical)
- [x] Performance impact minimal (parsing occurs at policy submission time)

## Validation Checklist
- [x] Story scoped to integrating DSL into runtime policies
- [x] Dependencies identified and satisfied before implementation
- [x] Acceptance criteria testable end-to-end
- [x] Rollback strategy documented

## Dev Notes

### Previous Story Insights
- Quantifier semantics (`some`/`all`, alias handling, array validation) were documented during Story 9.5 and must remain intact when compiling DSL for runtime policies. [Source: architecture/condition-dsl.md#quantifier-support]

### Data Models
- Runtime policies consist of deterministic triggers plus canonical action enums; DSL support must respect this structure and continue to gate execution through `PolicyTrigger`. [Source: architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]

### API Specifications
- `validateConditionInput` accepts DSL or JSON-Logic payloads, returning structured diagnostics with `invalid_condition_dsl` codes for invalid expressions. [Source: architecture/condition-dsl.md#server-helper]

### Component Specifications
- No specific guidance found in architecture docs.

### File Locations
- Runtime policy logic lives under `packages/flex-agents-server/src/services`, while shared DSL utilities reside in `packages/shared/src/condition-dsl/`. [Source: architecture/source-tree.md#4-agents-server-packagesflex-agents-server]

### Testing Requirements
- Golden fixtures and Vitest suites cover DSL parsing/evaluation; new tests must align with existing fixtures for regression coverage. [Source: architecture/condition-dsl.md#tests-fixtures]

### Technical Constraints
- Runtime policy evaluation supports logical operators and quantifiers only; DSL compilation must not introduce unsupported constructs. [Source: architecture/flex-agents-server/5-core-concepts.md#runtime-condition-evaluation]

## Project Structure Notes
- Place shared parser updates under `packages/shared/src/condition-dsl/`, orchestrator normalization under `packages/flex-agents-server/src/services`, and UI adjustments within `src/views/FlexSandboxView.vue`, matching the documented source tree. [Source: architecture/source-tree.md#source-tree-guide]
