# Story 8.13: Flex Capability Metadata Facet Migration

## Status
Done

## Story
**As a** capability registry steward,  
**I want** all capability registrations to publish facet-based contracts sourced from the shared catalog,  
**so that** the planner and execution engine can rely on consistent facet coverage when selecting and validating capabilities.

## Acceptance Criteria
1. Refactor capability registration payloads to reference facet arrays (`inputContract`, `outputContract`) sourced from the shared catalog rather than inline JSON schemas. (`docs/architecture/flex-agents-server.md:449`)
2. Extend `FlexCapabilityRegistry` persistence to store facet coverage hints and reject registrations that reference unknown facets. (`docs/architecture/flex-agents-server.md:303`)
3. Update the capability inventory table to stay in sync automatically (tests or lint) with the registration metadata, ensuring facets listed in docs match code. (`docs/architecture/flex-agents-server.md:476`)
4. Provide validation tooling (build-time or unit tests) that loads the facet catalog and verifies every registered capability references valid facets with allowed directionality. (`docs/architecture/flex-agents-server.md:460`)
5. Add migration scripts or bootstrap hooks to ensure existing dev-time capability exports load facet definitions from the shared catalog, eliminating duplicate metadata. (`docs/architecture/flex-agents-server.md:449`)
6. Document the facet-backed registration workflow, including guidance for adding new capabilities and updating the architecture tables. (`docs/architecture/flex-agents-server.md:484`)

## Tasks / Subtasks
- [x] Update capability metadata exports in `packages/flex-agents-server/src/agents/**` to import facet definitions from the shared catalog and emit facet arrays (AC 1, AC 5).
- [x] Enhance registration validators in `packages/flex-agents-server/src/services/flex-capability-registry.ts` to verify facet existence/directionality, rejecting invalid payloads with descriptive errors (AC 2, AC 4).
- [x] Persist facet coverage in `flex_capabilities` records (Drizzle schema + migrations or in-memory until persistence lands) aligning with architecture spec (AC 2).
- [x] Add unit tests verifying capability registration failures on unknown facets, direction mismatches, and successful cases (`strategy`, `writer`, `qa`). (AC 4)
- [x] Implement a docs verification script/test that compares capability exports against the inventory table to ensure consistency (AC 3, AC 6).
- [x] Update `docs/architecture/flex-agents-server.md` maintenance checklist and capability table notes to reflect the facet-backed workflow (AC 6).

## Dev Notes
- **Architecture references:** See `docs/architecture/flex-agents-server.md` sections 11 (Facet Catalog, Current Inventory) and 5.6 (Facet definition) for authoritative metadata.
- **Registry service:** `packages/flex-agents-server/src/services/flex-capability-registry.ts` holds registration validation and caching logic; extend to cross-check facets.
- **Agent exports:** Strategy, content, and QA agents currently define metadata inline; transplant to shared facet catalog to eliminate duplication.
- **Persistence:** While production migration isn’t required, design registry updates assuming the future Drizzle schema includes facet arrays for auditing.
- **Tooling:** Consider a simple `npm run lint:facets` script (Vitest or custom check) to load both the shared catalog and capability exports to validate alignment.

### Testing
- Add unit tests in `packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts` covering valid/invalid facet registrations.
- Ensure planner integration tests (`packages/flex-agents-server/__tests__/flex-planner.spec.ts`) still resolve capabilities using updated facet arrays.
- Include docs consistency tests under `packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts` to compare registry metadata with the architecture table.
- Run `npm run test:unit -- packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/flex-planner.spec.ts`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-10 | 0.1 | Initial draft for migrating capability metadata to facet-based registrations aligned with architecture updates. | Scrum Master |
| 2025-10-14 | 1.0 | Implemented facet-backed capability contracts, registry validation, documentation checks, and supporting tests. | Dev |

## Dev Agent Record

### Agent Model Used
- Local coding session (no remote model execution)

### Debug Log References
- None

### Completion Notes List
- Converted strategy, content, and QA capability exports to shared-catalog facet arrays so registration payloads no longer embed inline JSON schemas.
- Enhanced `FlexCapabilityRegistryService` to compile facet contracts, persist coverage columns, and reject unknown or directionally invalid facets with descriptive errors.
- Added Vitest suites for facet validation and documentation parity, plus updated the architecture maintenance checklist to call out the new workflow.
- Ran `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/facets/facet-contracts.spec.ts packages/flex-agents-server/__tests__/capability-registry.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/capability-registration.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts`.

### File List
- packages/shared/src/flex/types.ts
- packages/shared/src/flex/facets/catalog.ts
- packages/db/src/schema.ts
- packages/db/migrations/20250410_add_flex_capability_facets.sql
- packages/flex-agents-server/src/services/flex-capability-repository.ts
- packages/flex-agents-server/src/services/flex-capability-registry.ts
- packages/flex-agents-server/src/agents/strategy-manager.ts
- packages/flex-agents-server/src/agents/content-generator.ts
- packages/flex-agents-server/src/agents/quality-assurance.ts
- packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts
- packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts
- docs/architecture/flex-agents-server.md

## QA Results

### Review Date: 2025-10-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Facet catalog and registry plumbing generally align with acceptance criteria, but the strategy capability exports `strategicRationale` while architecture docs and new parity tests expect `rationaleSummary`, leaving code and documentation out of sync.
- Shared facet compiler now builds JSON-schema contracts; however, validation for `toneOfVoice` rejects the documented enum value `friendly`, pointing to a schema merge or Ajv configuration defect that will surface at runtime.

### Requirements Traceability
- AC1/AC2/AC5 satisfied through facet-backed contracts, persistence, and shared catalog usage.
- AC3/AC6 not met: documentation parity test fails because of the `strategicRationale` vs `rationaleSummary` mismatch.
- AC4 unmet: facet compiler regression test fails, so we lack proof that all registered facets validate successfully.

### Test Coverage & Results
- Command: `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/facets/facet-contracts.spec.ts packages/flex-agents-server/__tests__/capability-registry.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/capability-registration.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts`
- Failures:
  - `packages/shared/__tests__/flex/facet-contract-compiler.spec.ts` (facet validator rejects valid enum value).
  - `packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts` (strategy output facet expectation mismatch).
  - `packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts` (documentation inventory mismatch).

### NFR Evaluation
- **Maintainability:** CONCERNS – naming divergence between code and documentation will create confusion for future updates.
- **Reliability:** FAIL – compiler rejecting valid facet payloads will bubble up as runtime validation failures.
- **Security / Performance:** Not affected by current changes.

### Risk Summary
- High risk of runtime registration/validation failures due to facet schema defect.
- Documentation drift increases onboarding risk and undermines automated parity checks.

### Recommendations
- Align strategy capability output facet naming across code, catalog, and documentation (`rationaleSummary` vs `strategicRationale`).
- Investigate `FacetContractCompiler` Ajv schema merge to ensure documented enum values pass validation.
- Re-run the targeted Vitest suite after fixes; consider adding end-to-end registration coverage once the compiler issue is resolved.
- Post-update check (2025-10-14 late afternoon) confirmed the same two failures remain when rerunning the targeted test command.

### Review Date: 2025-10-14 (Evening)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Strategy capability, catalog, and documentation now consistently advertise the `strategicRationale` facet. Registry/service code compiles facet contracts without drift.
- Facet contract compiler accepts valid `toneOfVoice` enum values; no further validation anomalies observed.

### Requirements Traceability
- AC1–AC6 satisfied. Docs, code, and tests all reflect facet-backed registration workflow.

### Test Coverage & Results
- Command: `npm run test:unit -- packages/shared/__tests__/flex/facet-contract-compiler.spec.ts packages/flex-agents-server/__tests__/facets/facet-contracts.spec.ts packages/flex-agents-server/__tests__/capability-registry.spec.ts packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/capability-registration.spec.ts packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts`
- Result: PASS (13 assertions).

### NFR Evaluation
- **Maintainability:** PASS – facet catalog alignment removes documentation drift risk.
- **Reliability:** PASS – facet compiler now validates canonical inputs; parity tests ensure regression coverage.
- **Security / Performance:** Not impacted.

### Risk Summary
- Residual risk low; automated parity coverage reduces future drift probability.

### Recommendations
- Consider extending parity suite to cover additional capabilities when catalog grows (future hardening).

### Suggested Status
- Ready for Done

### Suggested Status
- Changes Required (block release until facet validation and documentation parity issues are fixed).
