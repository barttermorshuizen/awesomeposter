# Story 8.13: Flex Capability Metadata Facet Migration

## Status
Draft

## Story
**As a** capability registry steward,  
**I want** all capability registrations to publish facet-based contracts sourced from the shared catalog,  
**so that** the planner and execution engine can rely on consistent facet coverage when selecting and validating capabilities.

## Acceptance Criteria
1. Refactor capability registration payloads to reference facet arrays (`inputContract`, `outputContract`) sourced from the shared catalog rather than inline JSON schemas. (`docs/architecture/flex-agents-server.md:449`)
2. Extend `FlexCapabilityRegistry` persistence to store facet coverage hints and reject registrations that reference unknown facets. (`docs/architecture/flex-agents-server.md:303`)
3. Update the capability inventory table to stay in sync automatically (tests or lint) with the registration metadata, ensuring facets listed in docs match code. (`docs/architecture/flex-agents-server.md:476`)
4. Provide validation tooling (build-time or unit tests) that loads the facet catalog and verifies every registered capability references valid facets with allowed directionality. (`docs/architecture/flex-agents-server.md:460`)
5. Add migration scripts or bootstrap hooks to ensure existing dev-time capability exports load facet definitions from the shared catalog, eliminating duplicate metadata. (`docs/architecture/flex-agents-server.md:449`)
6. Document the facet-backed registration workflow, including guidance for adding new capabilities and updating the architecture tables. (`docs/architecture/flex-agents-server.md:484`)

## Tasks / Subtasks
- [ ] Update capability metadata exports in `packages/flex-agents-server/src/agents/**` to import facet definitions from the shared catalog and emit facet arrays (AC 1, AC 5).
- [ ] Enhance registration validators in `packages/flex-agents-server/src/services/flex-capability-registry.ts` to verify facet existence/directionality, rejecting invalid payloads with descriptive errors (AC 2, AC 4).
- [ ] Persist facet coverage in `flex_capabilities` records (Drizzle schema + migrations or in-memory until persistence lands) aligning with architecture spec (AC 2).
- [ ] Add unit tests verifying capability registration failures on unknown facets, direction mismatches, and successful cases (`strategy`, `writer`, `qa`). (AC 4)
- [ ] Implement a docs verification script/test that compares capability exports against the inventory table to ensure consistency (AC 3, AC 6).
- [ ] Update `docs/architecture/flex-agents-server.md` maintenance checklist and capability table notes to reflect the facet-backed workflow (AC 6).

## Dev Notes
- **Architecture references:** See `docs/architecture/flex-agents-server.md` sections 11 (Facet Catalog, Current Inventory) and 5.6 (Facet definition) for authoritative metadata.
- **Registry service:** `packages/flex-agents-server/src/services/flex-capability-registry.ts` holds registration validation and caching logic; extend to cross-check facets.
- **Agent exports:** Strategy, content, and QA agents currently define metadata inline; transplant to shared facet catalog to eliminate duplication.
- **Persistence:** While production migration isnâ€™t required, design registry updates assuming the future Drizzle schema includes facet arrays for auditing.
- **Tooling:** Consider a simple `npm run lint:facets` script (Vitest or custom check) to load both the shared catalog and capability exports to validate alignment.

### Testing
- Add unit tests in `packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts` covering valid/invalid facet registrations.
- Ensure planner integration tests (`packages/flex-agents-server/__tests__/flex-planner.spec.ts`) still resolve capabilities using updated facet arrays.
- Include docs consistency tests under `packages/flex-agents-server/__tests__/docs/facet-inventory.spec.ts` to compare registry metadata with the architecture table.
- Run `npm run test:unit -- packages/flex-agents-server/__tests__/capability-registry-facets.spec.ts packages/flex-agents-server/__tests__/flex-planner.spec.ts`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-10 | 0.1 | Initial draft for migrating capability metadata to facet-based registrations aligned with architecture updates. | Scrum Master |
