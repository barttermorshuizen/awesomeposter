# Story 9.7: DSL Existence Guards

## Status
Ready for Dev

## Story
**As a** Flex runtime policy author,  
**I want** to use an `exists(<variablePath>)` helper inside the condition DSL,  
**so that** guardrails can safely reference optional signals without failing evaluation when a value is missing.  

**Dependencies:** Depends on Story 9.6 (runtime policy DSL acceptance) and Story 9.5 (quantifier syntax) so the shared parser, Nitro validation helper, and runtime policy normalization already understand DSL payloads. (`docs/stories/9.6.runtime-policy-dsl-support.md`, `docs/stories/9.5.dsl-quantifier-syntax.md`)

## Acceptance Criteria
1. The shared DSL grammar accepts `exists(<catalogPath>)` expressions, returns canonical DSL + JSON-Logic payloads (e.g., `{"!": [{"missing": ["metadata.runContextSnapshot.facets.postCopy.value.summary"]}]}`), and surfaces the referenced variables in `parseDsl` responses. (`docs/architecture/condition-dsl.md#api-surface`)
2. `exists()` only allows catalog-backed identifiers; invalid operands or nested expressions emit structured diagnostics (`invalid_condition_exists`) through `validateConditionInput`, including line/column ranges and catalog suggestions. (`docs/architecture/condition-dsl.md#server-helper`)
3. Runtime policy normalization (Nitro + Flex agents server) preserves `exists` metadata, ensures policies that guard optional values evaluate to `false` instead of throwing, and telemetry/`policy_triggered` flows remain unchanged. (`docs/architecture/flex-agents-server/5-core-concepts.md#taskpolicies`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#policy_triggered`)
4. Flex Sandbox DSL editor documents and autocompletes `exists`, shows JSON preview parity, and keeps the existing DSL feature flag so legacy JSON-only authors are unaffected. (`docs/prd/epic-9-condition-management.md:18`)
5. Regression coverage adds fixture-backed tests for parsing/rendering/evaluation plus Nitro helper specs and UI integration tests; architecture docs mention the new helper per the “keep in sync” directive. (`docs/architecture/condition-dsl.md#tests-fixtures`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)

## Tasks / Subtasks
- [ ] Extend tokenizer/parser to recognise `exists` as a unary function, emit canonical JSON-Logic during transpile, and update documentation to describe the helper. (AC 1,5)
- [ ] Add validation to block non-catalog operands, produce `invalid_condition_exists` diagnostics, and propagate them through `validateConditionInput` for Nitro/Flex surfaces. (AC 2,3)
- [ ] Update runtime policy normalization + Flex agents evaluation so compiled expressions with `exists` short-circuit missing variables without throwing while preserving DSL/JSON metadata. (AC 3)
- [ ] Enhance Flex Sandbox DSL editor autocomplete/help text plus JSON preview to highlight `exists`, ensuring the existing feature flag still gates DSL editing. (AC 4)
- [ ] Expand Vitest + fixture coverage across shared parser, Nitro helper, agents server policies, and Vue UI to pin parsing, error cases, and authoring flows. (AC 5)

## Story Context

**Existing System Integration**
- Shared Condition DSL utilities (`@awesomeposter/shared/condition-dsl`) drive parsing, rendering, validation, and evaluation across UI + servers; `parseDsl` already returns canonical DSL/JSON metadata used when normalizing runtime policies. [Source: docs/architecture/condition-dsl.md#api-surface]
- Runtime policies live under `TaskEnvelope.policies.runtime[]`, and normalization occurs before planner execution + telemetry emission so changes must remain additive. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]
- Flex Sandbox policy forms already rely on the DSL editor shipped in earlier stories and are feature-gated for safe rollout. [Source: docs/prd/epic-9-condition-management.md:18]

**Problem Statement**
- Optional metadata (e.g., facets that only appear after certain nodes) currently cause DSL expressions to fail as soon as a missing variable is dereferenced. Authors need a first-class way to guard presence without resorting to raw JSON-Logic `missing` helpers, keeping the DSL approachable. [Source: docs/architecture/condition-dsl.md#api-surface]

**Motivation & Benefits**
- `exists()` lets authors compose checks such as `exists(facets.goalBrief) && facets.goalBrief.summary != ""`, preventing premature policy activation and better aligning with the epic goal of human-friendly condition authoring. [Source: docs/prd/epic-9-condition-management.md:4]

**Constraints**
- JSON-Logic remains canonical for execution so the helper must compile to supported operators and keep telemetry unchanged. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#policy_triggered]
- Feature gating must remain intact so admins can roll out DSL enhancements gradually. [Source: docs/prd/epic-9-condition-management.md:32]

## Acceptance Criteria (Detailed)

### Functional Requirements
1. `exists(<catalogPath>)` returns `boolean`, may participate inside composite expressions (`exists(foo) && foo.value > 10`), and compiles to the JSON-Logic `missing`/`!` pattern. [Source: docs/architecture/condition-dsl.md#api-surface]
2. Canonical DSL rendering preserves the helper name and underlying alias (if any) so round-tripping `toDsl` reproduces the original expression. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]

### Integration Requirements
3. Nitro helper + Flex runtime evaluation path convert validation failures into `invalid_condition_exists` structures without changing HTTP status contracts. [Source: docs/architecture/condition-dsl.md#server-helper]
4. Runtime policy telemetry (`policy_triggered`, `goal_condition_failed`) still emits canonical DSL + JSON payloads so observers can audit guard conditions. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#policy_triggered]
5. Flex Sandbox editor updates respect the existing DSL feature flag and store both DSL + JSON fields per policy for round-trip editing. [Source: docs/prd/epic-9-condition-management.md:18]

### Quality Requirements
6. Fixture-backed tests cover positive, negative, and round-trip cases for the new helper; Nitro helper + runtime normalization tests assert missing-variable handling. [Source: docs/architecture/condition-dsl.md#tests-fixtures]
7. Documentation (`docs/architecture/condition-dsl.md`) explicitly lists `exists` usage, keeping architecture guidance current. [Source: docs/architecture/condition-dsl.md#keep-this-document-in-sync]

## Technical Notes
- Implement `exists` as a first-class AST node so future helpers (e.g., `coalesce`) can follow the same structure without overloading binary operators. [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
- Leverage the catalog’s `dslPath` to resolve aliases and feed canonical run-context paths into JSON-Logic, matching existing `facets.*` handling. [Source: docs/architecture/condition-dsl.md#registry]
- Keep Nitro + Flex runtime validation inside the shared `validateConditionInput` helper to avoid drift between server surfaces. [Source: docs/architecture/condition-dsl.md#server-helper]

## Definition of Done
- [ ] Functional requirements met (parser, validation, runtime normalization, UI helper).
- [ ] Tests updated and passing (`packages/shared`, `server/utils`, `packages/flex-agents-server`, `src/views` suites).
- [ ] Documentation refreshed (`docs/architecture/condition-dsl.md`, DSL editor help copy).
- [ ] Feature flag verified to keep DSL tooling optional.
- [ ] Regression suite + lint/type-check remain green.

## Risk and Compatibility Check
- **Primary Risk:** Divergent handling of `exists` between parser, Nitro helper, and runtime evaluation could reintroduce brittle conditions. **Mitigation:** Add shared fixtures and ensure `validateConditionInput` returns uniform payloads so normalization + runtime share the same outputs. [Source: docs/architecture/condition-dsl.md#tests-fixtures]
- **Compatibility:** Helper is additive; JSON-Logic payload structure remains canonical, DB schema untouched, and DSL feature flag continues to gate UI exposure. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#taskpolicies]

## Validation Checklist
- [ ] Scope limited to adding `exists` helper without unrelated parser work.
- [ ] Dependencies (Stories 9.5/9.6) satisfied to guarantee DSL infrastructure is ready.
- [ ] Acceptance criteria are objective and testable.
- [ ] Rollback straightforward (disable helper + revert parser change).

## Dev Notes

### Previous Story Insights
- Story 9.6 already normalizes runtime policy DSL inputs and stores canonical DSL + JSON so extending the grammar with `exists` must reuse the same metadata pipeline. [Source: docs/stories/9.6.runtime-policy-dsl-support.md:1]

### Data Models
- Runtime policies remain declarative objects embedded inside `TaskEnvelope.policies.runtime[]`, so new DSL helpers cannot alter action schemas or telemetry payloads. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#runtimepolicy]

### API Specifications
- `validateConditionInput({ dsl, jsonLogic? })` is the single entry point for Nitro + Flex runtime validation, returning `invalid_condition_dsl` payloads with ranges; add `invalid_condition_exists` alongside existing codes. [Source: docs/architecture/condition-dsl.md#server-helper]

### Component Specifications
- Flex Sandbox DSL editor (Vue + Vuetify) provides autocomplete/help metadata for DSL features and is feature-gated; add the `exists` helper to the same catalog + tooltip system. [Source: docs/prd/epic-9-condition-management.md:18]

### File Locations
- Parser + catalog live under `packages/shared/src/condition-dsl/`; Nitro helpers live in `server/utils/condition-dsl.ts`; runtime policy normalization/evaluation belongs in `packages/flex-agents-server/src`. [Source: docs/architecture/source-tree.md#4-agents-server-packagesflex-agents-server]

### Testing Requirements
- Maintain golden fixtures in `tests/fixtures/condition-dsl/` and Vitest specs under `packages/shared/__tests__/condition-dsl.spec.ts`, `server/utils/__tests__/condition-dsl-helper.spec.ts`, and any policy normalization suites so `exists` stays regression-tested. [Source: docs/architecture/condition-dsl.md#tests-fixtures]
- Follow repo-wide commands (`npm run test:unit`, `npm run lint`, `npm run type-check`) to ensure the helper integrates cleanly with existing quality gates. [Source: docs/architecture/tech-stack.md#3-tooling--quality-gates]

### Technical Constraints
- Repo mandates strict TypeScript, ES modules, and Vitest-based unit tests across shared packages + Vue UI; follow coding standards for consistent imports/await handling. [Source: docs/architecture/coding-standards.md]

## Project Structure Notes
- Shared DSL updates stay under `packages/shared/src/condition-dsl/`, runtime normalization inside `packages/flex-agents-server/src/services`, Nitro helper adjustments under `server/utils/`, and Flex Sandbox UI changes within `src/views/FlexSandboxView.vue`, aligning with the documented source tree. [Source: docs/architecture/source-tree.md#source-tree-guide]

## Change Log
| Date       | Version | Description        | Author |
| ---------- | ------- | ------------------ | ------ |
| 2025-02-21 | 1.0     | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- _To be completed during implementation._

### Debug Log References
- _To be completed during implementation._

### Completion Notes List
- _To be completed during implementation._

### File List
- _To be completed during implementation._

## QA Results
- Not applicable (story is in Draft status).
