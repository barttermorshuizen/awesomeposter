# Story 8.10: Flex Planner Execution Phase 2

## Status
Approved

## Story
**As a** platform orchestrator,  
**I want** the flex planner to execute real capabilities with robust validation and resume handling,  
**so that** operators can rely on flex runs for production workflows without leaving the HITL guardrails.

## Acceptance Criteria
1. `/api/v1/flex/run.stream` dispatches real capabilities by calling the capability registry/resolver and streams their live results (no stubbed execution paths remain).
2. HITL pause/resume flow works end to end for flex runs: planner snapshots persist necessary node state, resume endpoints/handlers reload the plan, and the UI can resume execution without manual intervention.
3. Ajv schemas validate TaskEnvelope inputs, capability payloads, and final outputs; any validation failure surfaces actionable SSE error frames and structured logs.
4. Planner execution paths run behind the existing feature flag and include telemetry/logging parity with legacy orchestrator for capability dispatch, HITL transitions, and validation failures.

## Tasks / Subtasks
- [ ] Replace mock capability execution with real capability dispatch through `FlexExecutionEngine` and capability registry contracts (AC 1, AC 4).
- [ ] Persist planner snapshots required for resume and ensure hitl resume handlers replay the saved plan graph (AC 2).
- [ ] Wire UI/HITL services so flex runs can pause, display pending approval, and resume automatically on operator approval (AC 2).
- [ ] Integrate Ajv validation for inbound envelopes, capability outputs, and final response assembly with clear error surfacing (AC 3).
- [ ] Extend telemetry/logging to capture capability dispatch events, resume transitions, and validation outcomes under `flex.*` metrics (AC 4).
- [ ] Add integration tests covering happy path with real capability stubs, validation failure, and HITL resume scenarios (AC 1-4).
- [ ] Update sprint documentation and planner README with real capability execution flow, validation contract, and HITL resume expectations (AC 1-4).

## Story Context

**Dependencies**
- Builds on shared flex contracts delivered in Story 8.1 (`docs/stories/8.1.flex-shared-contracts.md`), which added `@awesomeposter/shared/flex` TaskEnvelope/CapabilityRegistration types and Zod schemas the planner must import.
- Requires capability registry service and `/api/v1/flex/capabilities/register` endpoint from Story 8.2 (`docs/stories/8.2.flex-server-scaffold.md`); planner dispatch should call into the in-memory registry backed by the `flex_capabilities` table.
- Assumes persistence work from Story 8.4 (`docs/stories/8.4.flex-run-persistence.md`) that writes to `flex_run_outputs` and `flex_plan_snapshot` tables and exposes repository accessors for run outputs and snapshots.
- Coordinates with resume/debug endpoints landed in Story 8.5 (`docs/stories/8.5.flex-run-interfaces.md`) so HITL UI pause/resume uses `/api/v1/flex/run.resume` and support tooling can read `/api/v1/flex/runs/:id`.

**Non-Goals**
- Persisting final outputs or plan snapshots beyond what is required for resume (handled in Story 8.4).
- Telemetry dashboards or long-term analytics beyond parity (addressed in Story 8.6).

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Planner selects registered capabilities, orchestrates their execution order, and handles retries/fallbacks defined in policies.
2. SSE stream emits node-level events using real capability payloads, including failure events when validation blocks progression.
3. Resume requests rebuild the plan graph from persisted state and continue execution without dispatching completed nodes again.

### Integration Requirements
4. HITL UI updates in Vue reflect flex run pause/resume states and display validation errors coming from flex runs.
5. Capability registry errors return descriptive SSE frames and structured logs for investigation.
6. Ajv schema compilation is cached per capability invocation to avoid repeated compilation overhead.

### Quality Requirements
7. Integration tests simulate capability dispatch, HITL pause/resume, and validation failure scenarios.
8. Logging parity with legacy orchestrator is confirmed via snapshot/unit tests.
9. Documentation includes examples for capability registration expectations and HITL resume workflow.

## Technical Notes
- Leverage `FlexExecutionEngine` and `FlexRunCoordinator` as the primary extension points for real capability dispatch.
- Ajv schemas should be sourced from shared contracts; consider pre-compiling them during server bootstrap to minimize runtime cost.
- Resume handling should use plan snapshots persisted by Story 8.4, ensuring idempotent replay across server restarts.

## Definition of Done
- [ ] Functional requirements satisfied with feature flag guard in place.
- [ ] Integration with capability registry, HITL resume, and Ajv validation verified in staging.
- [ ] Tests (unit & integration) cover execution, validation failure, and resume paths.
- [ ] Documentation updated (planner README / sprint notes).
- [ ] QA review requested.

## Risk and Compatibility Check
- **Primary Risk:** Real capability dispatch introduces variability and latency differences versus stubbed executions.
- **Mitigation:** Start with a controlled capability set, monitor metrics, and keep feature flag in place for gradual rollout.
- **Rollback Plan:** Toggle feature flag to revert to legacy planner; pause flex runs by disabling capability dispatch.

**Compatibility Verification**
- [ ] No breaking changes to existing APIs.
- [ ] Database changes (if any) are additive only.
- [ ] UI changes follow existing design patterns.
- [ ] Performance impact is negligible (Ajv caching and capability dispatch monitored).

## Validation Checklist
- [ ] Story can be completed in one development session.
- [ ] Integration approach is straightforward.
- [ ] Follows existing patterns exactly.
- [ ] No design or architecture work required.
- [ ] Story requirements are unambiguous.
- [ ] QA review ready upon completion.
