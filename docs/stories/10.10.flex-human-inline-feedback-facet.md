# Story 10.10: Flex Human Inline Feedback Facet Decorator

## Status
Ready for Dev

## Story
**As a** human capability working inside the Flex Human task panel with a feedback output facet
**I want** a context-aware feedback icon beside every rendered input facet field that opens a lightweight comment form,  
**so that** I can leave in-place guidance that is persisted through the existing `feedback` facet without leaking domain knowledge into generic UI code.

**Dependencies:** Requires completion of Story 10.3 (task surfaces shell) so facet widgets already register metadata about their fields, and Story 8.12 (facet schema library) so the `feedback` facet contract is centrally defined. (`docs/stories/10.3.flex-human-task-surfaces.md`, `docs/stories/8.12.flex-facet-schema-library.md`)

## Acceptance Criteria
1. When a capability advertises the `feedback` facet (direction: output) in its run context, the facet widget registry automatically loads a `feedback.inline` decorator that wraps each rendered input facet widget and adds a comment icon aligned to the field label. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)
2. Clicking the icon opens an inline composer that is pre-populated with the facet key and JSON pointer path for the targeted field and allows the user to enter message text plus severity (`info|minor|major|critical`). Submitting the form appends a new entry to the `feedback` facet via the existing capability mutation pipeline; no other generic UI layer needs to know about feedback semantics. (`docs/architecture/flex-agents-server/151-capability-contracts.md`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)
3. Fields with open feedback entries display a badge showing the count of unresolved items (resolution != `addressed`/`dismissed`) and show their latest message in a tooltip so operators can see context without opening the composer.
4. The decorator component is registered purely through the facet metadata (no hard-coded references inside shared form controls), ensuring it only initializes when the capability exposes the `feedback` facet. Removing the facet from the contract fully disables the UI affordance.
5. Unit tests cover the decorator wrapper, form submission payload (facet, path, message, severity, timestamp stub), and indicator badge states, and documentation is updated to describe how inline feedback hooks into the facet catalog and capability outputs. (`src/components/flex-tasks/widgets/__tests__/FeedbackInlineDecorator.spec.ts`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)

## Tasks / Subtasks
- [ ] Extend the facet widget registry so that capabilities advertising the `feedback` facet automatically mount the `feedback.inline` decorator around each input facet widget. (`src/components/flex-tasks/widgets/registry.ts`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)
- [ ] Implement `FeedbackInlineDecorator.vue` (or equivalent) that renders the icon/button, launches the inline composer, submits payloads to the existing run-context mutation endpoint, and surfaces unresolved-count badges. (`src/components/flex-tasks/widgets/FeedbackInlineDecorator.vue`, `src/components/flex-tasks/FlexTaskPanel.vue`)
- [ ] Add Vitest coverage for the decorator behavior, including submission payload shape, badge rendering, and disabling when the capability omits the `feedback` facet. (`src/components/flex-tasks/widgets/__tests__/FeedbackInlineDecorator.spec.ts`)
- [ ] Update architecture documentation to capture the decorator, the requirement for field-level `path` metadata, and how the `feedback` facet enables UI plugins. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)

## Story Context
- `feedback` is already defined as a bidirectional facet that pins comments to a `facet` key plus optional JSON pointer `path`; this story exposes that mechanism directly in the operator UI. (`docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)
- Flex Human task surfaces already tag each field with `facetKey` and `path` metadata used for persistence; the decorator can reuse this instrumentation without altering core form components. (`docs/stories/10.3.flex-human-task-surfaces.md`)
- Capability manifests dictate which facets are present, so gating the decorator off the manifest prevents cross-domain leakage and keeps the UI pluggable. (`docs/architecture/flex-agents-server/151-capability-contracts.md`)

## Dev Notes
- Keep the composer intentionally lightweight (message + severity + optional resolution state stub) to avoid scope creep; follow the `feedback` schema exactly so planner automation can reason over new entries. (`docs/architecture/flex-agents-server/512-reference-facet-catalog.md#facet-feedback`)
- Use existing run-context mutation utilities used by other facet writers (e.g., `post_copy` edits) so that submission behavior stays consistent. (`src/services/flexRuns.ts`)
- Badge calculations should be memoized per field to avoid recomputing counts on every render of large forms.

## Testing
- `npm run test:unit -- FeedbackInlineDecorator`
- `npm run lint`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-05-09 | 0.1 | Initial draft describing inline feedback facet decorator. | Scrum Master |

## QA Results

_Not yet reviewed. QA to update this section only._
