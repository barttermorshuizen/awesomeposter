# Story 8.7: Capability Inventory & Registration Coverage

## Status
Done

## Story
**As a** orchestrator agent,  
**I want** an up-to-date inventory of existing agents and their capability metadata,  
**so that** the capability registry contains accurate entries and the orchestrator agent can plan and replan at runtime.

**References**
- `docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts` for schema details and registry behaviors to mirror.
- `docs/architecture/flex-agents-server.md#15-next-steps` for current inventory expectations and gaps to close as part of this story.
- Story 8.2 capability bootstrap pattern (documented in `packages/flex-agents-server/src/server/plugins/capability-registry.ts`) — summarize deviations in this story if new hooks are required.

## Acceptance Criteria
1. Document current specialist agents (strategy, writer variants, QA, utilities) with capability IDs, descriptions, input/output expectations, and limitations.
2. Each agent registers with the flex capability endpoint during startup, using metadata aligned with the shared `CapabilityRegistration` schema.
3. Planner seed configuration references registered capability IDs (no hard-coded prompts).
4. Architecture spec cross-links the inventory so future teams can update capabilities consistently.

## Tasks / Subtasks
- [x] Survey existing agents/tools in `packages/agents-server` and note purpose, prompts, IO expectations (AC 1); document findings inline with references back to source files.
- [x] Create capability inventory doc/table in `docs/architecture/flex-agents-server.md#11-capability-registry--agent-contracts` (or adjacent file linked from that section) including capability IDs, IO traits, limitations, and maintenance guidance (AC 1, AC 4).
- [x] Update each agent’s bootstrap code (or registration adapter) to call `/api/v1/flex/capabilities/register` with accurate metadata (AC 2).
- [x] Ensure registration includes versioning, preferred models, strengths, limitations per schema (AC 2).
- [x] Seed planner config or tests (snapshot of registry-fed plan assembly backed by Story 8.8 harness) to confirm capabilities are discoverable by ID and selected correctly (AC 3).
- [x] Add release note/README section instructing developers how to update capability metadata and referencing the architecture section for future edits (AC 4).
- [x] Author automated tests covering: successful registration payload validation, retry/logging on registration failure, and planner lookup from registry cache (AC 2, AC 3, AC 6).

## Story Context

**Existing System Integration:**
- Integrates with: Legacy agents implementations, new flex capability registry service, planner heuristics.
- Technology: TypeScript, OpenAI Agents SDK, Nitro server startup hooks.
- Follows pattern: Self-registration at boot (introduced in Story 8.2).
- Touch points: Agent constructors/plugins, documentation, planner tests.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Every agent invoked in legacy flows has a corresponding capability record with accurate metadata.
2. Registration occurs automatically on flex server startup (or orchestrator boot), with retries on failure.
3. Planner has access to capability list and uses traits (language, format) to select matches.

### Integration Requirements
4. Inventory document links to agent source files and is referenced from architecture spec.
5. Registration errors surface in logs with actionable messages; fallback to defaults if necessary.
6. Unit tests validate at least one capability registration payload for schema compliance.

### Quality Requirements
7. No manual step required beyond maintaining metadata; developer guide documents update process.
8. Inventory stays in sync with default contracts referenced in shared types.
9. Code review checklist updated to include capability metadata updates when agents change.

## Technical Notes
- **Integration Approach:** Agent modules export capability metadata and invoke HTTP self-registration (`POST /api/v1/flex/capabilities/register`) with retries/backoff.
- **Existing Pattern Reference:** Agent constructors under `packages/flex-agents-server/src/agents` each call `scheduleCapabilitySelfRegistration` during module load.
- **Key Constraints:** Avoid blocking server startup if registration fails; log and retry asynchronously, ensuring the registry endpoint is reachable.

## Definition of Done
- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested (legacy orchestrator unaffected)
- [x] Code follows existing patterns and standards
- [x] Tests pass (unit/contract tests)
- [x] Documentation updated (inventory + developer guide)

## Risk and Compatibility Check
- **Primary Risk:** Inventory drift if teams forget to update metadata.
- **Mitigation:** Add documentation, tests, and review checklist; consider future automation to validate prompts vs. metadata.
- **Rollback:** Revert registration hooks; flex planner falls back to static list (temporary).

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Capability registry accurately represents available agents and their strengths.
2. Planner relies on dynamic registry data instead of hard-coded lists.
3. Documentation keeps future agent updates aligned with runtime metadata.

## Important Notes
- Consider future automation (e.g., lint rule) to flag capability metadata mismatches.
- Inventory doc should include placeholder for new agents to keep layout consistent.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 0.1 | Established capability inventory metadata, automated flex capability registration, documentation cross-links, and registry-driven planner tests. | Dev |

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Developer persona)

### Debug Log References
- None

### Completion Notes List
- Embedded structured metadata, heartbeat settings, and JSON Schema contracts directly inside the strategy, copywriter, and QA agent modules.
- Implemented a Nitro plugin that loads capability exports, POSTs them to `/api/v1/flex/capabilities/register`, and relies on `capability-registration.ts` helpers for retry + refresh behavior.
- Updated planner and execution engine to consume shared capability IDs, and expanded tests to cover registry retries plus scenario-based plan selection.
- Documented the live inventory in `docs/architecture/flex-agents-server.md` and appended a README maintenance checklist for future metadata updates.
- Verified new behavior through targeted Vitest suites (`capability-registration.spec.ts`, `flex-planner.spec.ts`) to confirm registry coverage.

### File List
- packages/flex-agents-server/src/agents/strategy-manager.ts
- packages/flex-agents-server/src/agents/content-generator.ts
- packages/flex-agents-server/src/agents/quality-assurance.ts
- packages/flex-agents-server/server/plugins/capability-registration.ts
- packages/flex-agents-server/src/services/capability-registration.ts
- packages/flex-agents-server/src/services/flex-planner.ts
- packages/flex-agents-server/src/services/flex-execution-engine.ts
- packages/flex-agents-server/__tests__/capability-registration.spec.ts
- packages/flex-agents-server/__tests__/flex-planner.spec.ts
- packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts
- docs/architecture/flex-agents-server.md
- README.md

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 0.1 | Initial developer implementation for capability inventory & flex registration coverage. | Dev |

## QA Results
- **Decision:** PASS
- **Findings:** All acceptance criteria satisfied. Agents POST their capability metadata to `/api/v1/flex/capabilities/register`, tests cover retry/refresh behavior, and documentation reflects the new flow.
- **Notes:** Keep an eye on refresh interval configuration (`FLEX_CAPABILITY_SELF_REGISTER_REFRESH_MS`) during deployment rollouts.

### Review Date: 2025-10-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Capability metadata is centrally exported per agent and aligns with the schema expectations (IDs, contracts, heartbeat, and model hints).
- Nitro plugin registers all capabilities with configurable retry/refresh logic; retry logging and failure handling are consistent with logger conventions.
- Planner now queries the registry by scenario metadata, eliminating static prompt coupling and providing active/inactive fallback logic.
- Execution engine validates capability input/output contracts against registry metadata before final envelope validation, preserving schema guarantees.
- Documentation (architecture + README) cross-links source modules, keeping inventory discoverable for future updates.

### Refactoring Performed
- None (review-only).

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ – `npm run test:unit -- packages/flex-agents-server/__tests__/capability-registration.spec.ts packages/flex-agents-server/__tests__/flex-planner.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts`
- All ACs Met: ✓

### Requirements Traceability
- AC1 → architecture inventory table (`docs/architecture/flex-agents-server.md#current-inventory`) documents capability metadata with source references.
- AC2 → `capability-registration.spec.ts` verifies successful POST + retry loops; plugin ensures startup registration for all exports.
- AC3 → `flex-planner.spec.ts` selects registered capability IDs via scenario metadata; failure path covered when no match exists.
- AC4 → README guidance mirrors architecture spec, giving maintainer workflow for keeping registry/doc in sync.

### Improvements Checklist
- [x] Verified retry + refresh behavior through targeted unit tests.
- [ ] Consider guarding the fallback timer in `server/plugins/capability-registration.ts` to avoid starting multiple refresh loops when `listen` fires promptly.
- [ ] Add an integration-style test that boots Nitro plugin wiring to assert registrations occur during server startup.

### Security Review
- PASS – Registration calls use in-process `localFetch`/`fetch` with structured logging; no secrets exposed in payloads or logs. For remote registration targets, ensure TLS (`FLEX_CAPABILITY_REGISTER_URL`) is configured.

### Performance Considerations
- PASS – Registration payloads are tiny and retried with backoff; planner/engine lookups remain cached via `FlexCapabilityRegistryService` to avoid repeated DB hits.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/8.7-flex-capability-inventory.yml

### Recommended Status
✓ Ready for Done
