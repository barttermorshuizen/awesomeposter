# Story 8.7: Capability Inventory & Registration Coverage

## Status
Draft

## Story
**As a** flex planner engineer,  
**I want** an up-to-date inventory of existing agents and their capability metadata,  
**so that** the capability registry contains accurate entries and the planner can select agents reliably at runtime.

## Acceptance Criteria
1. Document current specialist agents (strategy, writer variants, QA, utilities) with capability IDs, descriptions, input/output expectations, and limitations.
2. Each agent registers with the flex capability endpoint during startup, using metadata aligned with the shared `CapabilityRegistration` schema.
3. Planner seed configuration references registered capability IDs (no hard-coded prompts).
4. Architecture spec cross-links the inventory so future teams can update capabilities consistently.

## Tasks / Subtasks
- [ ] Survey existing agents/tools in `packages/agents-server` and note purpose, prompts, IO expectations (AC 1).
- [ ] Create capability inventory doc/table in `docs/architecture/flex-agents-server.md` or adjacent file (AC 1, AC 4).
- [ ] Update each agentâ€™s bootstrap code (or registration adapter) to call `/api/v1/flex/capabilities/register` with accurate metadata (AC 2).
- [ ] Ensure registration includes versioning, preferred models, strengths, limitations per schema (AC 2).
- [ ] Seed planner config or tests to confirm capabilities are discoverable by ID (AC 3).
- [ ] Add release note/README section instructing developers how to update capability metadata (AC 4).

## Story Context

**Existing System Integration:**
- Integrates with: Legacy agents implementations, new flex capability registry service, planner heuristics.
- Technology: TypeScript, OpenAI Agents SDK, Nitro server startup hooks.
- Follows pattern: Self-registration at boot (introduced in Story 8.2).
- Touch points: Agent constructors/plugins, documentation, planner tests.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Every agent invoked in legacy flows has a corresponding capability record with accurate metadata.
2. Registration occurs automatically on flex server startup (or orchestrator boot), with retries on failure.
3. Planner has access to capability list and uses traits (language, format) to select matches.

### Integration Requirements
4. Inventory document links to agent source files and is referenced from architecture spec.
5. Registration errors surface in logs with actionable messages; fallback to defaults if necessary.
6. Unit tests validate at least one capability registration payload for schema compliance.

### Quality Requirements
7. No manual step required beyond maintaining metadata; developer guide documents update process.
8. Inventory stays in sync with default contracts referenced in shared types.
9. Code review checklist updated to include capability metadata updates when agents change.

## Technical Notes
- **Integration Approach:** Use Nitro plugin to trigger registrations; share helper util for POST call with retries/backoff.
- **Existing Pattern Reference:** Agent container initialization in `packages/agents-server/src/server/plugins`.
- **Key Constraints:** Avoid blocking server startup if registration fails; log and retry asynchronously.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested (legacy orchestrator unaffected)
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (unit/contract tests)
- [ ] Documentation updated (inventory + developer guide)

## Risk and Compatibility Check
- **Primary Risk:** Inventory drift if teams forget to update metadata.
- **Mitigation:** Add documentation, tests, and review checklist; consider future automation to validate prompts vs. metadata.
- **Rollback:** Revert registration hooks; flex planner falls back to static list (temporary).

**Compatibility Verification**
- [x] No breaking changes to existing APIs
- [x] Database changes (if any) are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly
- [x] No design or architecture work required
- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

## Success Criteria
1. Capability registry accurately represents available agents and their strengths.
2. Planner relies on dynamic registry data instead of hard-coded lists.
3. Documentation keeps future agent updates aligned with runtime metadata.

## Important Notes
- Consider future automation (e.g., lint rule) to flag capability metadata mismatches.
- Inventory doc should include placeholder for new agents to keep layout consistent.
