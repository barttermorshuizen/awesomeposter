# Story 8.23: Flex Policy Action Execution

## Status
Draft

## Story
**As a** flex orchestrator maintainer,  
**I want** policy directives to support multiple action types beyond replanning and have those actions fully wired into execution,  
**so that** runtime policies can deterministically retry nodes, escalate to HITL, cancel runs, or log-only without brittle bespoke code.

**Dependencies:** Story 8.9 (policy normalization), Story 8.14 (hybrid planner loop), and Story 8.22 (policy conditional triggers) must be complete so directives and predicates are in place prior to expanding action handling.

## Acceptance Criteria
1. Policy schema accepts an `action` field with supported values `replan` (default), `retry_node`, `hitl_pause`, `fail_run`, and `log_only`, validating unknown actions with descriptive errors. (`docs/architecture/flex-agents-server.md:205`)
2. Execution engine dispatches the configured action after a directive matches (and optional `when` predicate passes):
   - `replan`: existing behavior (planner handshake).
   - `retry_node`: reruns the triggering nodeâ€™s capability with updated inputs/facets before continuing.
   - `hitl_pause`: issues a HITL pause with the directive reason and halts execution.
   - `fail_run`: marks run failed with policy metadata.
   - `log_only`: emits telemetry/log entry and continues without plan mutation. (`docs/architecture/flex-agents-server.md:210`)
3. Actions integrate with telemetry/SSE so `policy_triggered` payloads include `action` and resulting state (e.g., `retry_started`, `hitl_requested`). (`docs/architecture/flex-agents-server.md:220`)
4. Automated tests cover each action path (happy path + guard rails) ensuring retries respect backoff, HITL pauses persist state, failures stop execution, and log-only keeps flow untouched. (`docs/architecture/flex-agents-server.md:352`)
5. Documentation updated with action reference, expected side effects, and authoring examples. (`docs/architecture/flex-agents-server.md:535`)

## Tasks / Subtasks
- [ ] Extend policy schema/normalizer to parse `action`, set defaults, and surface validation errors. (AC 1)
- [ ] Implement action dispatcher in execution engine/coordinator for all supported actions, including state transitions and persistence updates. (AC 2)
- [ ] Update telemetry/SSE payloads to include `action` metadata plus any action-specific event (retry attempt, HITL pause reason). (AC 3)
- [ ] Add unit/integration tests covering each action scenario and regression tests for default `replan`. (AC 4)
- [ ] Refresh architecture docs and story references describing policy actions and usage guidance. (AC 5)

## Story Context

**Existing System Integration:**
- Integrates with: `PolicyNormalizer`, `flex-run-coordinator.ts`, `flex-execution-engine.ts`, HITL service, persistence, telemetry emitter.
- Technology: TypeScript, Nitro, existing SSE contract, HITL workflow.
- Follows pattern: Policy-driven orchestration established in Stories 8.9, 8.14, 8.22.
- Touch points: Policy schema, execution action dispatcher, retry handling, HITL pause flow, telemetry/logging, documentation.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. `retry_node` retrieves previous node inputs/output facets and re-executes the capability with updated context; retry count obeys per-policy max (default 1).  
2. `hitl_pause` calls existing HITL escalation path with directive metadata, persists pause status, and skips planner handshake.  
3. `fail_run` sets run status `failed`, records directive reason, and emits terminal telemetry.  
4. `log_only` emits structured log + telemetry indicating policy observation but allows execution to continue.  
5. Multiple directives can map to different actions without interfering (e.g., QA policy retries while cost policy fails run).

### Integration Requirements
6. Action dispatcher executes prior to planner handshake to avoid double-processing.  
7. Persistence updates (plan snapshots, run status, retry counters) remain consistent with resume/replay flows.  
8. Telemetry clients (sandbox, operator UI) can display action + outcome without schema changes beyond additional fields.

### Quality Requirements
9. Tests cover concurrency/guard rails (e.g., prevent infinite retry loops, ensure single HITL pause per directive).  
10. Logging includes run ID, node ID, directive metadata, chosen action, and outcome for auditability.  
11. Documentation includes troubleshooting tips (e.g., how to configure max retries, disable actions via flags).

## Technical Notes
- **Integration Approach:** Extend directive model to include `action`, route through a centralized dispatcher invoked when directives match; reuse existing retry/HITL/fail pathways where possible.  
- **Existing Pattern Reference:** HITL pause flow from Story 8.1, retry hooks in execution engine, telemetry updates from Story 8.6.  
- **Key Constraints:** Ensure retry actions respect idempotency and do not reissue nodes already completed; guard against recursive planner triggers.

## Definition of Done
- [ ] Functional requirements met  
- [ ] Integration requirements verified  
- [ ] Existing functionality regression tested  
- [ ] Code follows existing patterns and standards  
- [ ] Tests pass (unit/integration)  
- [ ] Documentation updated

## Risk and Compatibility Check
- **Primary Risk:** Misconfigured actions causing loops or premature failures.  
- **Mitigation:** Enforce retry caps, debounce HITL triggers, exhaustive tests, clear logging.  
- **Rollback:** Feature-flag action dispatcher to fallback on `replan` only.

**Compatibility Verification**
- [x] No breaking changes to existing APIs  
- [x] Database changes (if any) are additive only  
- [x] UI changes follow existing design patterns  
- [x] Performance impact is negligible

## Validation Checklist
- [x] Story can be completed in one development session  
- [x] Integration approach is straightforward  
- [x] Follows existing patterns exactly  
- [x] No design or architecture work required  
- [x] Story requirements are unambiguous  
- [x] Integration points are clearly specified  
- [x] Success criteria are testable  
- [x] Rollback approach is simple

