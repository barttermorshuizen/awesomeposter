# Story 8.23: Flex Policy Action Execution

## Status
Draft

## Story
**As a** flex orchestrator maintainer,  
**I want** policy directives to support multiple action types beyond replanning and have those actions fully wired into execution,  
**so that** runtime policies can deterministically retry nodes, escalate to HITL, cancel runs, or log-only without brittle bespoke code.

**Dependencies:** Story 8.9 (TaskPolicies schema foundation), Story 8.14 (hybrid planner loop), and Story 8.22 (policy conditional triggers) must be complete so directives and predicates are in place prior to expanding action handling. Coordinate with Story 8.24 to reuse the canonical action dispatcher.

## Acceptance Criteria
1. `RuntimePolicy.action` supports the canonical union defined in `@awesomeposter/shared/flex` (`goto`, `replan`, `hitl`, `fail`, `pause`, `emit`), validating unknown actions with descriptive errors and providing migration guidance for legacy names. (`docs/architecture/flex-agents-server.md#5.3-taskpolicies`)
2. Execution engine dispatches the configured action after a directive matches (and optional trigger conditions pass):
   - `replan`: existing planner handshake behavior.
   - `goto`: reruns the referenced node (supporting retry semantics when `next` points to the triggering node) before resuming normal flow.
   - `hitl`: issues a HITL pause with the directive rationale.
   - `fail`: marks the run failed with policy metadata.
   - `pause`: suspends execution without failure, awaiting external resume.
   - `emit`: publishes a policy-triggered telemetry/log event without mutating the plan. (`docs/architecture/flex-agents-server.md:210`)
3. Telemetry/SSE payloads include canonical `action.type` values and any action-specific metadata (e.g., `goto.next`, `hitl.rationale`), with regression tests proving backward compatibility for clients already parsing `policy_triggered`. (`docs/architecture/flex-agents-server.md:220`)
4. Automated tests cover each action path (happy path + guard rails) ensuring `goto` retries respect backoff, `hitl` persists pause state, `fail` stops execution, `pause` resumes cleanly, and `emit` keeps execution untouched. (`docs/architecture/flex-agents-server.md:352`)
5. Documentation updated with canonical action references, expected side effects, example payloads, and migration notes for renamed actions. (`docs/architecture/flex-agents-server.md:535`)

## Tasks / Subtasks
- [ ] Extend runtime policy schema validation to enforce canonical action types and map legacy names to helpful errors. (AC 1)
- [ ] Implement a centralized action dispatcher that routes `RuntimePolicy.action` objects to execution handlers (planner handshake, goto/retry, HITL, fail, pause, emit). (AC 2)
- [ ] Update telemetry/SSE payloads and resume metadata to include canonical action data and maintain backwards compatibility. (AC 3)
- [ ] Add unit/integration tests for each action scenario, plus guard-rail tests for backoff, double HITL prevention, and pause/resume flows. (AC 4)
- [ ] Refresh architecture docs and runbook references describing canonical actions, examples, and migration steps for renamed actions. (AC 5)

## Story Context

**Existing System Integration:**
- Integrates with: `PolicyNormalizer`, `flex-run-coordinator.ts`, `flex-execution-engine.ts`, HITL service, persistence, telemetry emitter.
- Technology: TypeScript, Nitro, existing SSE contract, HITL workflow.
- Follows pattern: Policy-driven orchestration established in Stories 8.9, 8.14, 8.22.
- Touch points: Policy schema, execution action dispatcher, retry handling, HITL pause flow, telemetry/logging, documentation.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. `goto` actions retrieve previous node inputs/output facets and re-execute the referenced node; retry count obeys per-policy max (default 1).  
2. `hitl` actions call the existing HITL escalation path with directive metadata, persist pause status, and skip planner handshake.  
3. `fail` actions set run status `failed`, record directive reason, and emit terminal telemetry.  
4. `pause` actions persist run state and await resume without planner deltas.  
5. `emit` actions emit structured log + telemetry indicating policy observation but allow execution to continue.  
6. Multiple directives can map to different canonical actions without interfering (e.g., QA policy triggers `goto` while cost policy triggers `fail`).

### Integration Requirements
7. Action dispatcher executes prior to planner handshake to avoid double-processing.  
8. Persistence updates (plan snapshots, run status, retry counters) remain consistent with resume/replay flows.  
9. Telemetry clients (sandbox, operator UI) can display canonical action metadata without schema changes beyond additional fields.

### Quality Requirements
10. Tests cover concurrency/guard rails (e.g., prevent infinite retry loops, ensure single HITL pause per directive).  
11. Logging includes run ID, node ID, directive metadata, canonical action type, and outcome for auditability.  
12. Documentation includes troubleshooting tips (e.g., how to configure max retries, disable actions via flags) using canonical naming.

## Technical Notes
- **Integration Approach:** Extend directive model to include `action`, route through a centralized dispatcher invoked when directives match; reuse existing retry/HITL/fail pathways where possible.  
- **Existing Pattern Reference:** HITL pause flow from Story 8.1, retry hooks in execution engine, telemetry updates from Story 8.6.  
- **Key Constraints:** Ensure retry actions respect idempotency and do not reissue nodes already completed; guard against recursive planner triggers.

## Definition of Done
- [ ] Functional requirements met  
- [ ] Integration requirements verified  
- [ ] Existing functionality regression tested  
- [ ] Code follows existing patterns and standards  
- [ ] Tests pass (unit/integration)  
- [ ] Documentation updated

## Risk and Compatibility Check
- **Primary Risk:** Misconfigured actions causing loops or premature failures.  
- **Mitigation:** Enforce retry caps, debounce HITL triggers, exhaustive tests, clear logging.  
- **Rollback:** Feature-flag action dispatcher to fallback on `replan` only.

**Compatibility Verification**
- [x] No breaking changes to existing APIs  
- [x] Database changes (if any) are additive only  
- [x] UI changes follow existing design patterns  
- [x] Performance impact is negligible

## Validation Checklist
- [x] Story can be completed in one development session  
- [x] Integration approach is straightforward  
- [x] Follows existing patterns exactly  
- [x] No design or architecture work required  
- [x] Story requirements are unambiguous  
- [x] Integration points are clearly specified  
- [x] Success criteria are testable  
- [x] Rollback approach is simple
