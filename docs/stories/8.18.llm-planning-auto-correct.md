# Story 8.18: LLM Planner Auto-Correct Loop

## Status
Draft

## Story
**As a** flex orchestration maintainer,  
**I want** the planner to consume validator diagnostics and repair invalid drafts automatically,  
**so that** rejected plans converge quickly without relying on random retry behavior or manual operator intervention.

## Acceptance Criteria
1. Expose a deterministic `validate_plan` tool from `PlannerService` that wraps `PlannerValidationService`, returning the same structured diagnostics currently surfaced with `plan_rejected` events so planner attempts can fetch validation results directly. (`docs/architecture/flex-agents-server.md#planner-lifecycle-events`, `docs/architecture/flex-agents-server.md#7-execution-flow`)
2. Update the planner system prompt and coordinator handshake so every plan draft calls `validate_plan`; when the tool response reports errors, the planner must revise the graph using the diagnostics before responding, only emitting `plan_generated` after a clean validator check. (`docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration`, `docs/architecture/flex-agents-server.md#7-execution-flow`)
3. Ensure `FlexRunController` tracks planner attempt metadata (count, last diagnostics), enforces a configurable retry budget, and escalates with the existing deterministic fallback when the validator keeps failing. (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#14-risks--open-questions`)
4. Emit planner telemetry (`plan_requested`, `plan_rejected`, `plan_generated`) that includes the attempt number and validator diagnostics payload so operators and UI retain visibility into each correction cycle. (`docs/architecture/flex-agents-server.md#planner-lifecycle-events`, `docs/architecture/flex-agents-server.md#1001-flex-run-streaming-contract`)
5. Provide automated tests covering successful self-correction, repeated failure exhaustion, and telemetry payload assertions, and update architecture documentation to describe the new tool-driven loop and guardrails. (`docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`, `docs/architecture/flex-agents-server.md#planner-lifecycle-events`)

## Tasks / Subtasks
- [ ] Add a `validate_plan` tool wrapper that calls `PlannerValidationService` and serializes diagnostics/status for LLM consumption within `PlannerService`. (AC 1) (`docs/architecture/flex-agents-server.md#planner-lifecycle-events`)
- [ ] Modify planner prompt scaffolding and response handling so drafts must invoke `validate_plan`, retrying with the returned diagnostics before finalizing a plan. (AC 2) (`docs/architecture/flex-agents-server.md#58-planner-vs-orchestrator-hybrid-collaboration`)
- [ ] Extend `FlexRunController` (and related coordinator state) to store attempt diagnostics, enforce the configured retry cap, and fall back to deterministic plans when the limit is reached. (AC 3) (`docs/architecture/flex-agents-server.md#7-execution-flow`, `docs/architecture/flex-agents-server.md#14-risks--open-questions`)
- [ ] Include attempt counters and validator diagnostics in emitted planner telemetry/SSE frames and structured logs for observability. (AC 4) (`docs/architecture/flex-agents-server.md#1001-flex-run-streaming-contract`)
- [ ] Implement Vitest coverage for auto-correct success/failure and telemetry payloads, plus documentation updates describing the loop and guardrails. (AC 5) (`docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`, `docs/architecture/flex-agents-server.md#planner-lifecycle-events`)

## Dev Notes
- **Previous Story Insights**: Planner validation already emits `plan_rejected` diagnostics, but the LLM currently retries blindly; this story feeds those diagnostics back to the planner for deterministic corrections. `[Source: architecture/flex-agents-server.md#planner-lifecycle-events]`
- **Data Models**: No specific guidance found in architecture docs.
- **API Specifications**: Planner SSE frames must continue to align with the documented streaming contract while adding attempt metadata. `[Source: architecture/flex-agents-server.md#1001-flex-run-streaming-contract]`
- **Component Specifications**: `PlannerService`, `PlannerValidationService`, and `FlexRunController` coordinate planning, validation, and telemetry updates; enhancements belong within these components. `[Source: architecture/flex-agents-server.md#6-component-responsibilities]`
- **File Locations**: Planner orchestration logic resides under `packages/flex-agents-server/src` alongside validator services and telemetry emitters. `[Source: architecture/source-tree.md#4-agents-server]`
- **Testing Requirements**: Follow the documented Vitest strategy for agents server suites when adding auto-correct coverage. `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`
- **Technical Constraints**: Maintain TypeScript-first implementation with strict typing and Zod-based validation consistent with coding standards. `[Source: architecture/coding-standards.md#1-language--module-conventions]`

## Project Structure Notes
- Update planner tooling and coordinator logic within the existing flex agents server package hierarchy to stay aligned with the documented source tree. `[Source: architecture/source-tree.md#4-agents-server]`

## Testing
- `npm run test:unit -- packages/flex-agents-server/__tests__/planner-autocorrect.spec.ts packages/flex-agents-server/__tests__/flex-run-coordinator.spec.ts` `[Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]`
