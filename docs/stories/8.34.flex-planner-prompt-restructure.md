# Story 8.34: Flex Planner Prompt Restructure & Efficiency

## Status
Ready for Review

## Story
**As a** flex planner platform engineer,  
**I want** the PlannerService prompt rebuilt around the new JSON-first specification,  
**so that** the LLM returns higher-quality minimal PlanGraphs with lower token overhead and better facet coverage.

## Acceptance Criteria
1. Planner system prompt follows the new layout (SYSTEM header, schema definition block, context walkthrough, planner rules, internal checklist, output instructions) exactly as documented in the `Prompt Blueprint` section while keeping the requirement to emit a JSON object compliant with the PlanGraph contract. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#component-responsibilities] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#58-planner-vs-orchestrator-hybrid-collaboration]
2. User prompt renders `Facet Catalog Summary` and `Capability Registry Summary` tables populated from the live catalog and registry snapshot so facet names, directions, and capability IDs exactly mirror authoritative metadata, matching the table structure in the `Prompt Blueprint`. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition] [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry-agent-contracts]
3. Planner rules and checklist enforce facet coverage, valid capability selection, derived node signalling, and diagnostic behavior consistent with hybrid planner/orchestrator validation, aligned word-for-word with the rules in the `Prompt Blueprint`. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph] [Source: docs/architecture/flex-agents-server/59-output-contracts-planner-validation-and-policy-semantics.md#592-planner-validation-and-feedback-loop]
4. Prompt assembly trims tables to relevant entries, preserves facet ordering, and keeps telemetry of prompt size so the orchestrator maintains efficient LLM calls without losing plan context. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#57-facet-based-plan-assembly] [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity]
5. Vitest coverage asserts the system and user prompts match the redesigned structure, including JSON-only guidance and critical rule sections from the `Prompt Blueprint`, and documentation reflects the new format. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#58-planner-vs-orchestrator-hybrid-collaboration]

## Tasks / Subtasks
- [x] Refactor `composeSystemPrompt` in `packages/flex-agents-server/src/services/planner-service.ts` to emit the new system message layout and preserved JSON compliance instructions exactly as outlined in the `Prompt Blueprint`. (AC 1, AC 3) [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#component-responsibilities]
- [x] Rework `composeUserPrompt` to build the facet and capability tables, truncate irrelevant entries, and append the checklist instructions while keeping context sections compact, following the structures in the `Prompt Blueprint`. (AC 2, AC 4) [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition] [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry-agent-contracts]
- [x] Update flex planner documentation to describe the new prompt structure, tables, and planner rules for orchestrator collaboration. (AC 1, AC 3) [Source: docs/architecture/flex-agents-server/5-core-concepts.md#58-planner-vs-orchestrator-hybrid-collaboration]
- [x] Add or extend Vitest suites covering prompt assembly output and telemetry helpers to guard regression. (AC 4, AC 5) [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Dev Notes

### Previous Story Insights
- Planner prompts already hydrate facet and capability context so dynamic assembly works without extra controller passes; the new layout must preserve that contract. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#story-88-dynamic-assembly-details]

### Data Models
- PlanGraph nodes remain the contract the planner must emit, including stage metadata, capability IDs, and facet mappings. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph]
- Facets and capability contracts come from the shared catalog/registry and must stay authoritative for planner reasoning. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-definition] [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry-agent-contracts]

### API Specifications
- `POST /api/v1/flex/run.stream` continues to trigger planner drafts whose prompts should now follow the updated format before `plan_requested` telemetry fires. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]

### Component Responsibilities
- `PlannerService` composes prompts, calls the LLM, and hands results to validation while reusing the capability registry snapshot. [Source: docs/architecture/flex-agents-server/6-component-responsibilities.md#component-responsibilities]
- `CapabilityRegistry` and facet catalog helpers provide the authoritative metadata that the prompt must surface. [Source: docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry-agent-contracts]

### File Locations
- Planner prompt logic lives in `packages/flex-agents-server/src/services/planner-service.ts`; documentation updates belong under `docs/architecture/flex-agents-server/*.md`. [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/source-tree.md#6-documentation-assets]

### Technical Constraints
- Planner validation depends on deterministic diagnostics when requirements are unmet, so the prompt must continue to drive coverage of all required facets and capabilities. [Source: docs/architecture/flex-agents-server/59-output-contracts-planner-validation-and-policy-semantics.md#592-planner-validation-and-feedback-loop]

### Project Structure Notes
- Work stays inside the existing flex agents server package and documentation shards; no new packages or directories are required. [Source: docs/architecture/source-tree.md#4-agents-server] [Source: docs/architecture/source-tree.md#6-documentation-assets]

### Testing
- Add or update Vitest specs under the flex agents server tree to snapshot or assert prompt sections and telemetry outputs. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Prompt Blueprint

```markdown
SYSTEM:

You are the **Flex PlannerService**.  
Your job is to produce a **valid JSON plan** that exactly matches the following Zod schema.  
Do not include markdown, explanations, or comments—only the JSON object.

---

### SCHEMA DEFINITION

PlannerDraft = {
  nodes: Array<{
    stage: string
    label?: string
    capabilityId?: string
    derived?: boolean
    kind?: "structuring" | "execution" | "transformation" | "validation"
    inputFacets?: string[] | string | Record<string, unknown>
    outputFacets?: string[] | string | Record<string, unknown>
    rationale?: string | string[]
    instructions?: string | string[]
  }>
  metadata?: { provider?: string; model?: string }
}

---

### CONTEXT

You receive:
1. **Task Envelope:** `[TASK_ENVELOPE]`  
   - Contains the user’s objective, inputs, policies, special instructions, and output contract.
2. **Facet Catalog Summary:** semantic reference for all known facets.  
3. **Capability Registry Table:** listing of all available capabilities and their facet coverage.

Your goal:  
Create a **minimal PlanGraph** that uses the fewest capabilities necessary to produce all required **output facets** from the envelope, chaining input → output facet flows correctly.

---

### FACET CATALOG SUMMARY

| Facet | Direction | Description |
|--------|------------|-------------|
| [FACET_NAME] | [input|output|bidirectional] | [One-sentence semantic description.] |
| ... (add all relevant facets here) |

---

### CAPABILITY REGISTRY SUMMARY

| Capability ID | Display Name | Kind | Input Facets | Output Facets | Summary |
|----------------|--------------|------|---------------|----------------|----------|
| [CAPABILITY_ID] | [Human-readable name] | [structuring/execution/validation] | [facet1, facet2] | [facet3, facet4] | [1-sentence summary of what it does] |
| ... (include all active capabilities) |

---

### PLANNER RULES

1. **Facet coverage:**  
   - Every required output facet in the caller’s output contract must be produced by at least one node.  
   - Every node’s input facets must be either provided by the envelope or produced by an earlier node.  

2. **Capability selection:**  
   - Use only `capabilityId` values listed in the capability table.  
   - If no capability can satisfy the needed facets, return a diagnostic JSON object explaining the missing facet(s); do not invent placeholder capabilities.  

3. **Facet naming:**  
   - Use facet names *exactly* as listed in the facet catalog.  
   - Never invent new facet keys or rename existing ones.  

4. **Stages:**  
   - Set `stage` to the pipeline phase the node occupies (e.g., `structuring`, `generation`, `validation`).  
   - Respect policy directives such as `disallowStages` and `replanAfter`; never leave `stage` blank.  

5. **Kinds:**  
   - Use `structuring` for strategy or brief creation,  
     `execution` for content or design generation,  
     `validation` for QA or review  

6. **Derived capabilities:**  
   - If a node uses a capability not explicitly registered but still valid by facet coverage, mark `"derived": true`.  
   - Otherwise, omit the field.  

7. **Human-operated nodes:**  
   - Capabilities starting with `"HumanAgent."` should not have automated structuring or transformation nodes upstream solely to fill optional context; rely on provided inputs.  

8. **Controller-managed transforms:**  
   - Do **not** include normalization or controller helper nodes like `"normalize_input_facets"` or `"shape_clarification_request"`.  
   - The orchestrator automatically handles input normalization and tone mapping.  

9. **Diagnostics instead of invention:**  
   - If required inputs are missing and no upstream producer exists, return a minimal JSON with a `"diagnostics"` field describing the gap rather than inserting fake stages.  

10. **Rationale & instructions:**  
   - Each node should include a short `"rationale"` explaining *why* it was selected, referencing the facets it consumes and produces.  
   - Optionally include `"instructions"` (1–2 short imperative sentences) describing how the node should act.  

11. **Output requirements:**  
   - Emit only one top-level JSON object compliant with the schema above.  
   - No markdown, no explanations, no extra keys.

---

### INTERNAL CHECKLIST (for the model)

Before producing the JSON:
1. Are all required output facets from the output contract covered?  
2. Are all input facets of each node available from the envelope or previous outputs?  
3. Are all capability IDs valid from the registry?  
4. Did you avoid invented facets, stages, or helper nodes?  
5. Does each node include a rationale?  

---

### EXAMPLE REASONING (inline for guidance, not output)

> Example:  
> If the objective is to “draft social post copy for LinkedIn” and the envelope already includes a strategist brief (`creative_brief`), then the node `copywriter.SocialpostDrafting` can directly generate `post_copy` from `creative_brief`, `handoff_summary`, and `feedback`.  
> No strategist or normalization node is needed.

---

### OUTPUT INSTRUCTIONS

After reasoning internally, output only the final JSON object for `PlannerDraft`.  
Do not include any explanations, commentary, or reasoning text—only valid JSON.
```

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-30 | v1 | Implemented planner prompt restructure, telemetry logging, docs, and tests | James |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- None

### Completion Notes List
- Replaced PlannerService system prompt with exported blueprint-aligned builder and added prompt assembly helpers.
- Reworked user prompt generation to render trimmed facet/capability tables, context sections, and checklist reminder plus telemetry capture.
- Updated architecture documentation and added Vitest coverage for prompt builders and telemetry integration.

### File List
- packages/flex-agents-server/src/services/planner-service.ts
- packages/flex-agents-server/src/services/telemetry-service.ts
- packages/flex-agents-server/__tests__/planner-service.prompts.spec.ts
- docs/architecture/flex-agents-server/5-core-concepts.md

## QA Results
