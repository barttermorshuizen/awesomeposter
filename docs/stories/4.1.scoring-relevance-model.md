# Story 4.1: Relevance Scoring Utility

## Status
Ready for Review

## Story
**As the** scoring pipeling
**I want** to score a discovery item on relevancy,
**so that** reviewers can focus on the most relevant nuggets.

## Acceptance Criteria
1. Export `scoreDiscoveryItem(itemId: string)` and `scoreDiscoveryItems(itemIds: string[])` from the API layer (e.g. `server/utils/discovery/scoring.ts`) so any discovery workflow can invoke them without additional orchestration.
2. Each function returns normalized relevance scores between 0 and 1 along with the component breakdown (keyword match, recency decay, source weighting) and applies the default weight configuration already defined for discovery scoring.
3. Scoring calls must execute with no side effects: they may read discovery item data but must not mutate database state, emit events, or enqueue work.
4. Before fetching or scoring, each function must gate execution through the shared `isFeatureEnabled(clientId, feature)` helper (as defined in `server/utils/client-config/feature-flags.ts`), defaulting to a disabled response when the feature flag is off or the lookup fails.
5. Missing or malformed item data results in a structured error that explains the failure, returns the standard `{ error: { code, message, details } }` envelope, and prevents partial batch commits in `scoreDiscoveryItems`.
6. The module includes inline documentation (JSDoc or README excerpt) covering usage examples and expected result shape, published under `docs/architecture/discovery_agent_backend/api-contracts-services.md#scoring-utility` so discovery workflow owners can adopt it quickly.
7. Runbook notes document how to disable or roll back the scoring helper via the existing feature flag controls and list the regression validation expected after a rollback.

## Tasks / Subtasks
- [x] Add a dedicated scoring utility under the API codebase (e.g. `server/utils/discovery/scoring.ts`) that exposes `scoreDiscoveryItem` and `scoreDiscoveryItems`, reusing existing weighting formulas (AC 1, AC 2).
- [x] Ensure read-only data access for fetching discovery item context via existing server repositories/services, preventing accidental status transitions or event emission (AC 3).
- [x] Gate scoring execution through `isFeatureEnabled`, surfacing disabled-state responses and helper errors consistently (AC 4).
- [x] Implement consistent error handling for missing inputs or repository failures that surfaces clear messages while preventing partial batch results (AC 5).
- [x] Add lightweight documentation (inline JSDoc + README snippet) demonstrating single-item and batch calls and the returned score structure, and land the README excerpt at `docs/architecture/discovery_agent_backend/api-contracts-services.md#scoring-utility` (AC 6).
- [x] Write unit tests for both functions, covering happy paths, weight normalization, feature-flag gating behaviour, empty batch handling, and error scenarios (AC 2, AC 4, AC 5).
- [x] Capture regression validation expectations for existing ingestion scoring flows using the integration harness so we do not regress synchronous ingestion paths (AC 7).
- [x] Document the rollback/disablement procedure that toggles the discovery scoring feature flag and records the smoke validation checklist post-disablement (AC 4, AC 7).

## Dev Notes
- Reuse the same component math (keyword, recency, source weighting) documented in `docs/prd/epic-discovery-scoring-dedup.md`, but limit scope to pure scoring calculations.
- Fetch discovery item details through the existing API/server repositories; do not introduce new queues, migrations, or event contracts for this work.
- Use the shared feature-flag helper outlined in `docs/architecture/config-management.md` to gate scoring so configuration changes propagate correctly across services.
- Keep the batch helper efficient by reusing single-item scoring logic internally and short-circuiting on validation errors before doing unnecessary lookups.
- Consider exposing the weight configuration as an injectable dependency so discovery workflows can supply alternative weights during experiments without modifying the shared defaults.
- Rollback / disablement: operations can immediately toggle the `discovery-agent` client feature via `isFeatureEnabled`; document the toggle path and smoke list in the runbook to restore ingestion-only processing safely. [Source: architecture/config-management.md#feature-flags]
- Regression expectations: note that ingestion + scoring integration specs under `tests/api/discovery` and the `scripts/discovery-seed.mjs` smoke must stay green after enabling the shared utility. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]
- Error payloads must follow the shared admin contract `{ error: { code, message, details } }` when surfacing malformed input or repository failures so downstream consumers stay consistent. [Source: architecture/discovery-agent-backend.md#responsibilities-by-layer]
- Batch remediation: `scoreDiscoveryItems` should short-circuit on the first validation error, return a descriptive `details.invalidItems` payload, and avoid mixing successful and failed scores in the same response. No specific guidance found in architecture docsâ€”capture this contract explicitly in the README excerpt and tests to keep behaviour predictable.
- Environment configuration: discovery scoring relies on `DISCOVERY_SCORING_ENABLED`, threshold, and weight env vars documented alongside the pilot toggles. Make sure implementers reference the repo `README.md#optional-variables` table when wiring configuration. [Source: README.md#optional-variables]

### Testing
- Unit: verify `scoreDiscoveryItem` returns expected scores and component breakdown for representative discovery items.
- Unit: verify `scoreDiscoveryItems` handles empty arrays, mixed valid/invalid IDs, and propagates structured errors consistently.
- Regression: execute the ingestion + scoring integration suite (`tests/api/discovery/*.spec.ts`) and the `scripts/discovery-seed.mjs` smoke to confirm existing flows remain healthy. [Source: architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-30 | 0.3 | Updated location to API utilities and clarified repository usage. | SM |
| 2025-03-30 | 0.2 | Re-scoped to a reusable scoring utility with simple function signatures. | SM |
| 2025-03-29 | 0.1 | Draft for Epic: Scoring & Deduplication. | PM |

## Dev Agent Record

### Agent Model Used
GPT-5 (Codex)

### Debug Log References
None

### Completion Notes List
- Implemented `server/utils/discovery/scoring.ts` providing `scoreDiscoveryItem`/`scoreDiscoveryItems` with feature-flag gating, normalized component breakdown, and structured error envelopes.
- Added architecture doc excerpt and pilot runbook rollback steps documenting usage, disablement, and regression validations.
- Authored Vitest coverage for happy path, gating, missing records, invalid payloads, and empty batches; executed `npm run test:unit -- server/utils/__tests__/discovery-scoring-utility.spec.ts`.

### File List
- server/utils/discovery/scoring.ts
- server/utils/discovery-repository.ts
- server/utils/__tests__/discovery-scoring-utility.spec.ts
- docs/architecture/discovery_agent_backend/api-contracts-services.md
- docs/prd/epic-discovery-feature-flag-pilot/pilot-onboarding-runbook.md

## QA Results
_Not yet reviewed._
