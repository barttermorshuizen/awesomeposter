# Story 14.3: Capability Pre-Condition Tooling, Telemetry & Pilot Adoption

## Status
Ready for Dev

## Story
**As a** flex operator experience engineer,  
**I want** capability pre-condition guards and evaluation results streamed by the runtime to be visible in the Flex Sandbox UI and observability stack,  
**so that** operators can see why nodes were blocked, decide whether to replan/HITL, and validate guard health without replaying executions.

**Dependencies:** Story 14.2 – Capability Pre-Condition Runtime Gating & Policies (`docs/stories/14.2.flex-capability-pre-conditions-runtime.md`)

## References
- `docs/prd/epic-flex-capability-pre-conditions.md#stories`
- `docs/stories/14.2.flex-capability-pre-conditions-runtime.md`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`
- `docs/architecture/flex-agents-server/10-api-surface-initial.md#101-flex-run-debugging`
- `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`
- `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`
- `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`
- `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`
- `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`
- `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`
- `docs/architecture/source-tree.md#2-spa`
- `docs/architecture/source-tree.md#4-agents-server`
- `docs/architecture/source-tree.md#6-documentation-assets`
- `docs/architecture/tech-stack.md#1-core-runtime-components`
- `docs/architecture/coding-standards.md#7-testing-expectations`
- `docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy`
- `docs/architecture/flex-agents-server/13-verification.md#13-verification`

## Acceptance Criteria
1. **Plan inspector visualizes pre-condition guard status.** `FlexSandboxPlanInspector` (and Pinia stores) renders each node’s `preConditionGuards` plus streaming `preConditionResults`, showing pass/pending/fail chips, facet/path metadata, and tooltips sourced from SSE `plan_generated`, `plan_updated`, `node_status`, `policy_triggered`, and `complete` frames without mutating the event contract. (Sources: `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`, `docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#capability-registry--agent-contracts`)
2. **Run-level views highlight guard health for sandbox operators.** Flex Sandbox views gated by `USE_FLEX_DEV_SANDBOX` surface aggregated guard summaries (counts per status, latest failing facet, policy action taken) beside the existing run timeline and mirror the same state inside resume/HITL flows, degrading gracefully when no pre-conditions exist. (Sources: `docs/architecture/flex-agents-server/11-capability-registry-agent-contracts.md#developer-sandbox`, `docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`, `docs/architecture/flex-agents-server/5-core-concepts.md#54-plangraph`)
3. **Telemetry captures capability pre-condition failures.** `TelemetryService` emits structured logs plus counters `flex.capability_pre_condition_failed` and `flex.capability_pre_condition_error`, tagging each entry with `runId`, `nodeId`, `capabilityId`, `{ facet, path }`, policy action, and DSL canonicalization so Grafana dashboards and alerts can track failure/error rates without reprocessing raw SSE streams. (Sources: `docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`, `docs/architecture/condition-dsl.md#condition-dsl-parser--validation`)
4. **Debug endpoints expose guard summaries.** `GET /api/v1/flex/runs/:id` and related support logs include the persisted `preConditionResults` arrays and guard summaries pulled from `flex_plan_nodes`, `flex_plan_snapshots`, and `flex_run_outputs`, enabling operators to export failure evidence without replaying nodes. (Sources: `docs/architecture/flex-agents-server/10-api-surface-initial.md#101-flex-run-debugging`, `docs/architecture/flex-agents-server/9-data-model-persistence.md#9-data-model--persistence`)
5. **MVP rollout and documentation cover enforcement.** Architecture shards (UI integration, API surface, telemetry/runbook) describe the new UI indicators, counters, and operator workflows; rollout notes assume direct go-forward enforcement (no staged pilot/flip), with clear expectations for alert routing and monitoring. Vitest suites cover UI parsing plus telemetry/log serialization in line with repo testing standards. (Sources: `docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy`, `docs/architecture/flex-agents-server/13-verification.md#13-verification`, `docs/architecture/tech-stack.md#1-core-runtime-components`)

## Tasks / Subtasks
- [ ] Render `preConditionGuards` + `preConditionResults` in plan inspector and run-level summaries; add Pinia state/tests for SSE parsing. (AC1, AC2) (`docs/architecture/flex-agents-server/12-ui-client-integration.md#12-ui--client-integration`)
- [ ] Emit and document `flex.capability_pre_condition_failed` / `flex.capability_pre_condition_error` metrics with structured log context. (AC3) (`docs/architecture/flex-agents-server/6-component-responsibilities.md#telemetry-metrics-parity`)
- [ ] Expose guard summaries via debug APIs (`GET /api/v1/flex/runs/:id`) and ensure snapshots contain serialized results. (AC4) (`docs/architecture/flex-agents-server/10-api-surface-initial.md#101-flex-run-debugging`)
- [ ] Document MVP go-forward enforcement (no staged pilot/flip), including alert routing, dashboards, and operator workflows. (AC5) (`docs/architecture/flex-agents-server/13-migration-rollout-strategy.md#13-migration--rollout-strategy`)
- [ ] Expand UI + telemetry regression suites per coding standards. (AC1–AC5) (`docs/architecture/coding-standards.md#7-testing-expectations`)

## Edge Cases & Behavior Contracts
- No pre-conditions: UI/telemetry must degrade gracefully (hide chips/aggregates, emit no guard metrics).
- Partial data: missing `preConditionResults` while guards exist should show pending state without breaking SSE parsing.
- SSE schema stability: Do not mutate event contracts; UI must tolerate unexpected ordering/duplicates/retries from streaming.
- Errors from runtime: `preConditionResults` with `error` entries should surface as failures in UI and emit `flex.capability_pre_condition_error` with context.
- Aggregations: Run-level summaries must recompute correctly on replays or SSE reconnects.

## Testing Guidance
- UI parsing/rendering: SSE `plan_generated/plan_updated/node_status/policy_triggered/complete` frames populate Pinia stores and render guard chips (pass/pending/fail/error) with facet/path tooltips; empty/no-guard cases hide controls.
- Aggregates: Run-level summaries compute counts per status, latest failing facet, and policy action; verify replay/reconnect flows recompute correctly.
- Telemetry: Logs and counters `flex.capability_pre_condition_failed` and `flex.capability_pre_condition_error` emit with `runId/nodeId/capabilityId/{facet,path}` and policy action; assert no emission when no guards exist.
- Debug APIs: `GET /api/v1/flex/runs/:id` and related endpoints return persisted `preConditionResults` arrays and guard summaries; snapshots match SSE-viewed state.
- Event contract stability: Tests ensure UI tolerates unexpected field ordering/duplicates and does not mutate streaming contracts.
- Regression suites: Vitest coverage for UI stores/components and telemetry/log serialization per repo standards.

## Story Context
- Mirrors post-condition tooling story 13.3 but focused on pre-dispatch guardrails; must degrade cleanly for capabilities without pre-conditions. (`docs/prd/epic-flex-capability-pre-conditions.md#stories`)
- MVP stance: go-forward enforcement (no staged pilot); ensure monitoring, routing, and operator workflows are documented before enabling across capabilities.
