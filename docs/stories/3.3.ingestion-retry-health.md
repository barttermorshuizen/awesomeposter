# Story 3.3: Retry & Health Monitoring

## Status
Done

## Story
**As the** ingestion operator,
**I want** transient failures retried with backoff and surfaced in telemetry,
**so that** source issues are transparent without overwhelming the system.

## Acceptance Criteria
1. Transient errors (network timeouts, 5xx) retried up to 3 times with exponential backoff (base 2, max 15 minutes).
2. Permanent errors (4xx except 429) marked without retry and flagged to health status service.
3. Telemetry logs each attempt with result, retry count, and reason code.
4. SSE `ingestion.failed` event emitted on final failure, consumed by dashboard health indicators.

## Tasks / Subtasks
- [x] Extend scheduler (Story 3.1) to classify errors and apply retry policy (AC 1, AC 2).
- [x] Instrument telemetry emitter with attempt metadata (AC 3).
- [x] Publish SSE `ingestion.failed` with payload `{ clientId, sourceId, attempt, reason }` (AC 4).
- [x] Add unit tests for retry/backoff calculations and permanent error detection (AC 1, AC 2).
- [x] Update runbook with troubleshooting steps referencing telemetry dashboards (AC 3).

## Dev Notes
- For HTTP 429, respect `Retry-After` header when present.
- Coordinate with Source Health story for consistent status messaging.

### Testing
- Use mocked HTTP responses to simulate failure classes.
- Validate SSE payload via integration test harness.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Ingestion & Normalization. | PM |
| 2025-10-05 | 0.2 | Implemented retry telemetry, SSE failure events, and runbook updates; ready for review. | James |
| 2025-10-05 | 0.3 | Wired permanent failure health escalation, expanded tests, and updated runbook per QA feedback. | James |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit -- run server/jobs/__tests__/discovery-ingest-sources.spec.ts tests/api/discovery/events-stream.spec.ts
- npm run test:unit -- server/jobs/__tests__/discovery-ingest-sources.spec.ts tests/api/discovery/events-stream.spec.ts

### Completion Notes List
- Added bounded retry loop with exponential backoff, Retry-After overrides, and configurable attempt/ceiling env knobs inside `server/jobs/discovery/ingest-sources.ts`, capturing per-attempt telemetry.
- Extended discovery event schemas/telemetry to carry attempt metadata and introduced `ingestion.failed` envelopes alongside SSE propagation logic.
- Documented new telemetry signals and operator knobs in the scheduled ingestion runbook for quick troubleshooting alignment.
- Augmented Vitest coverage for retry paths, Retry-After handling, and SSE envelope streaming to guard regression risk.
- Routed permanent failure (`http_4xx` != 429 and other non-retryable errors) through a new `source.health` SSE publisher so Source Health dashboards surface hard outages.

### File List
- docs/discovery-agent-dev-setup.md
- packages/shared/src/discovery-events.ts
- server/jobs/discovery/ingest-sources.ts
- server/jobs/__tests__/discovery-ingest-sources.spec.ts
- server/utils/discovery-telemetry.ts
- server/utils/discovery-health.ts
- tests/api/discovery/events-stream.spec.ts
## QA Results

### Review Date: 2025-10-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Health escalation now triggers `publishSourceHealthStatus` whenever the classification marks a permanent failure, so AC2 is satisfied and operators regain observability. New unit coverage exercises the non-429 path and SSE stream assertions confirm the `source.health` envelopes, keeping telemetry and retry behaviour verifiable.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ – Permanent failure path and SSE health propagation covered.
- All ACs Met: ✓ – Acceptance criteria validated via code review and tests.

### Improvements Checklist
- [x] Wire permanent failure branch to the health status service (e.g., publish `source.health` or call existing health updater) so operators see the outage.
- [x] Add a unit test that exercises a non-429 `http_4xx` response to assert zero retries and verify the health notification pathway.
- [x] Document the health escalation flow once implemented so the runbook matches production behaviour.

### Security Review
No new security issues observed in the retry handling or telemetry surfaces.

### Performance Considerations
Backoff uses short sleeps per worker; monitor for worker starvation if max delay or attempt counts increase, but current limits look safe.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/3.3-ingestion-retry-health.yml
Risk profile: Not updated this review
NFR assessment: Inline in gate decision

### Recommended Status
✓ Ready for Done – implementation and tests meet the story requirements.
