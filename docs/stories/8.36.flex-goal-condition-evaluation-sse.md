# Story 8.36: Flex GoalCondition Evaluation in Final SSE Frame

## Status
Ready for Review

## Story
**As a** flex orchestrator maintainer,  
**I want** the runtime to evaluate every `goal_condition` entry and surface the pass/fail results in the final SSE frame,  
**so that** clients (and follow-on replans) can immediately see which facet predicates succeeded or failed without re-inspecting raw facet payloads.

**Dependencies:** Story 8.33 established the TaskEnvelope `goal_condition` schema but left evaluation unimplemented; this story activates runtime evaluation and telemetry ahead of the replan story that will act on failed predicates. [Source: docs/stories/8.33.flex-taskenvelope-goal-condition.md]

## Acceptance Criteria
1. When a run reaches the completion path, the execution engine/coordinator evaluates each `goal_condition` entry against the final facet snapshot using the shared Condition DSL utilities, producing a result record that includes the facet name, JSON-pointer path, and canonical DSL string for each predicate. The evaluation honors AND semantics from the envelope and records both boolean satisfaction and any runtime errors per entry. [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-goal-predicates] [Source: docs/architecture/condition-dsl.md#condition-dsl-parser--validation]
2. The `complete` SSE frame (`/api/v1/flex/run.stream`) gains a `payload.goal_condition_results` array that mirrors the evaluation records (facet, path, canonical DSL or alias, satisfied flag, optional error message). Frames omit the property when no goal conditions were supplied, and existing `payload.output` data remains unchanged for backwards compatibility. [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md#1001-flex-run-streaming-contract]
3. Goal-condition result records persist alongside the final output snapshot (`flex_run_outputs`) so that resume/replan flows and operator tooling can query which predicates failed after the stream ends. Persistence reuses the same structure emitted over SSE. [Source: docs/architecture/flex-agents-server.md#9-data-model--persistence]
4. Telemetry/logging (`flex_run_complete`, `flex_goal_condition_evaluated`) captures aggregate statistics (counts of passed/failed conditions) without duplicating evaluation work, and documentation for the streaming contract and TaskEnvelope goal predicates describes the new runtime behavior and payload fields. [Source: docs/architecture/flex-agents-server.md#telemetry--metrics-parity] [Source: docs/architecture/flex-agents-server/5-core-concepts.md#facet-goal-predicates]
5. Automated coverage includes unit tests for the evaluation helper (truthy, falsy, erroring predicates), integration tests that assert the `complete` SSE payload contains the expected `goal_condition_results`, and persistence tests verifying storage/retrieval of the results. [Source: docs/architecture/coding-standards.md#7-testing-expectations] [Source: docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [x] Add a shared evaluator (or extend the existing Condition DSL helper) that consumes `FacetCondition[]`, binds the final facet snapshot, and returns structured results with `satisfied | failed | error` states. Wire it into the completion path of `FlexRunCoordinator` / `FlexExecutionEngine`. (AC 1, AC 5) [Source: packages/flex-agents-server/src/services/flex-run-coordinator.ts] [Source: packages/flex-agents-server/src/services/flex-execution-engine.ts]
- [x] Update the shared `FlexEvent` typings and the SSE writer to include `payload.goal_condition_results` on `complete` frames, ensuring the SPA helpers (`postFlexEventStream`, sandbox log) can parse the new payload. (AC 2) [Source: packages/shared/src/flex/types.ts] [Source: src/lib/flex-sse.ts]
- [x] Persist the evaluation array with the final output snapshot and expose it via any run-inspection/debug endpoints so future replans can reference failed predicates. (AC 3) [Source: packages/flex-agents-server/src/services/orchestrator-persistence.ts] [Source: docs/architecture/flex-agents-server.md#9-data-model--persistence]
- [x] Emit structured telemetry/log entries summarizing goal-condition evaluation and document the new SSE payload + behavior in the API and TaskEnvelope sections. (AC 4) [Source: packages/flex-agents-server/src/services/telemetry-service.ts] [Source: docs/architecture/flex-agents-server/10-api-surface-initial.md] [Source: docs/architecture/flex-agents-server/5-core-concepts.md]
- [x] Expand the Vitest suites (unit + integration + sandbox parsing) to capture condition evaluation, SSE payload contents, and persistence round-trips. (AC 5) [Source: packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts] [Source: packages/flex-agents-server/__tests__/marketing-flex-run.integration.spec.ts] [Source: src/views/__tests__/FlexSandboxView.spec.ts]

## Future Considerations
- The follow-up story will initiate replans that target only the failed goal conditions using the persisted `goal_condition_results`. Keep the evaluator output deterministic so future automation can diff successive replans.

## Dev Agent Record

### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- `npm run test:unit -- packages/flex-agents-server/__tests__/goal-condition-evaluator.spec.ts`
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts`
- `npm run test:unit -- packages/flex-agents-server/__tests__/flex-run-persistence.spec.ts`
- `npm run test:unit -- packages/flex-agents-server/__tests__/telemetry-service.spec.ts`

### Completion Notes List
- Added a goal-condition evaluator that resolves facet snapshots, applies Condition DSL/JSON-Logic expressions, and returns structured results with satisfaction/error metadata.
- Extended the Flex execution engine to evaluate conditions on completion, emit `goal_condition_results` in `complete` SSE frames, and persist the evaluations alongside run outputs.
- Updated shared contracts (`GoalConditionResult`, `FlexCompleteEventPayload`) plus documentation to describe the new payloads and storage, and introduced telemetry counters/logs for aggregate condition stats.
- Added Vitest coverage for the evaluator helper, execution engine integration, persistence read helpers, and telemetry metrics to guard regressions.

### File List
- packages/flex-agents-server/src/services/goal-condition-evaluator.ts
- packages/flex-agents-server/src/services/flex-execution-engine.ts
- packages/flex-agents-server/src/services/orchestrator-persistence.ts
- packages/flex-agents-server/src/services/telemetry-service.ts
- packages/flex-agents-server/__tests__/goal-condition-evaluator.spec.ts
- packages/flex-agents-server/__tests__/flex-execution-engine.spec.ts
- packages/flex-agents-server/__tests__/flex-run-persistence.spec.ts
- packages/flex-agents-server/__tests__/telemetry-service.spec.ts
- packages/db/src/schema.ts
- packages/db/migrations/20251023_add_goal_condition_results.sql
- docs/architecture/flex-agents-server/5-core-concepts.md
- docs/architecture/flex-agents-server/10-api-surface-initial.md
- docs/architecture/flex-agents-server.md
- docs/stories/8.36.flex-goal-condition-evaluation-sse.md
- packages/shared/src/flex/types.ts

### QA Results
- _Pending QA review._
