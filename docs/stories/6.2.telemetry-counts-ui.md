# Story 6.2: Discovery Counts Reporting

## Status
Draft

## Story
**As a** marketing lead,
**I want** at-a-glance counts of source hits, nuggets considered, and promotions,
**so that** I can gauge discovery agent activity without leaving the app.

## Acceptance Criteria
1. Reporting view shows daily and weekly totals for source hits, nuggets considered, and promotions with date picker (default last 7 days).
2. Counts update live when SSE events for `ingestion.completed`, `discovery.score.complete`, and `brief.promoted` arrive; manual refresh available.
3. Users can export the current view to CSV containing date (UTC ISO-8601), metric, and count columns with ASCII-safe headers.
4. Metrics respect client scoping and only include data for enabled discovery agent clients.

## Context
- Story 6.1 (Telemetry SSE Endpoint) must land first so the UI can subscribe to `/api/events/discovery` using the shared `DiscoveryTelemetryEvent` contract (`packages/shared/src/discovery-events.ts`).
- Daily aggregates originate from the `discovery_metrics` materialized view and related telemetry tables documented in `docs/architecture/discovery-agent-backend.md#data-model-additions`; same-day deltas can be layered on top of these aggregates.
- `DiscoveryTelemetryView.vue` (see `docs/architecture/discovery_agent_frontend/component-architecture.md#telemetry-enhancements`) is the target surface for the count widgets and CSV export controls.

## Dependencies
- Story 6.1: SSE Event Stream – provides the discovery telemetry feed and schema consumed by this UI.

## Tasks / Subtasks
- [ ] Build `GET /api/discovery/metrics/counts` endpoint that aggregates `discovery_metrics` plus intra-day telemetry for the active client and date window (AC 1, AC 4).
- [ ] Create telemetry summary cards/table inside `DiscoveryTelemetryView.vue` using the shared design system and Pinia store wiring (AC 1).
- [ ] Wire `subscribeDiscoveryEvents` to increment counters for `ingestion.completed`, `discovery.score.complete`, and `brief.promoted` events scoped to the selected client (AC 2).
- [ ] Implement manual refresh that re-fetches aggregates and reconciles in-memory SSE deltas without double-counting (AC 2, AC 4).
- [ ] Implement CSV export from the current view state with ASCII headers, UTC timestamps, and metric identifiers matching acceptance criteria (AC 3).
- [ ] Add automated tests covering aggregation accuracy, SSE reconciliation, and export formatting (AC 1-3).

## Dev Notes
- Expose aggregation logic via `server/api/discovery/metrics/counts.get.ts`, delegating to a repository helper (e.g., `getDiscoveryMetricCounts`) that composes nightly aggregates with same-day telemetry events.
- Cache responses per `(clientId, dateFrom, dateTo)` for ≤5 minutes using Nitro cached handlers and bust the cache when SSE deltas are applied to keep the UI responsive.
- Maintain a Pinia store that tracks fetched aggregates and an in-memory delta map keyed by `metric+date`; reconcile deltas after manual refresh to avoid double-counting.
- Treat `ingestion.completed` as the source-hit increment, `discovery.score.complete` as nuggets considered, and `brief.promoted` as promotions. Ignore SSE events outside this set.
- Handle empty windows gracefully with zero-state messaging and ensure counts stay scoped to enabled clients.
- Stream CSV exports from the current client-side dataset; default filename to `discovery-telemetry-counts-YYYYMMDD.csv`.
- Surface SSE disconnects with the shared reconnect banner (reuse copy from Story 6.1 HITL-style guidance) and fall back to polling every 60 seconds while disconnected.

### Testing
- Unit tests for aggregation helpers validating date range filtering, client scoping, and combination of aggregate + delta data.
- Contract tests for `/api/discovery/metrics/counts` covering RBAC, empty datasets, caching headers, and CSV export trigger responses.
- Frontend tests (Vitest + Testing Library) for date picker interactions, SSE-driven counter updates (mock EventSource), manual refresh reconciliation, and CSV output formatting.
- Smoke test plan for QA to exercise large date windows and SSE reconnect flows against staging telemetry fixtures.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Telemetry & Reporting. | PM |

## Dev Agent Record
_Not yet worked._

## References
- `docs/prd/epic-discovery-telemetry-reporting.md`
- `docs/architecture/discovery-agent-backend.md#data-model-additions`
- `docs/architecture/discovery_agent_frontend/component-architecture.md#telemetry-enhancements`
- `docs/stories/6.1.telemetry-sse-endpoint.md`
