# Story 8.19: Flex Planner Sandbox UI

## Status
Draft

## Story
**As a** flex server maintainer,  
**I want** a developer-only sandbox UI to compose TaskEnvelope payloads, run flex plans, and watch live planner telemetry,  
**so that** I can rapidly tune facet mixes, agent prompts, and capability selection without poking at raw JSON files or the production operator tooling.

**Dependencies:** Requires Epic 8 foundations, specifically Story 8.2 (capability registry exposure) and Story 8.3 (Flex run streaming endpoint + SSE wiring) to be complete and deployed in the target environment.

## Acceptance Criteria
1. A gated `/flex/sandbox` workspace surfaces existing flex TaskEnvelope payloads (e.g., `tmp/flex-*.json`), allows creating/editing payloads with validation against known facet/capability metadata, and persists drafts locally so developers can iterate. (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/source-tree.md#4-agents-server`)
2. Running a payload posts to the existing `/api/v1/flex/run.stream` endpoint, streams the SSE feed in-place, and displays plan lifecycle events (`plan_requested`, `plan_generated`, `plan_updated`, node events, completion/error) with timestamps and payload snippets. (`docs/architecture/flex-agents-server.md#10.0.1-flex-run-streaming-contract`)
3. The workspace renders the generated plan graph and live updates (nodes, capabilities, facets, policies) so developers can inspect planner decisions, with clear status indicators for retries, derived capabilities, and HITL pauses. (`docs/architecture/flex-agents-server.md#planner-lifecycle-events`, `docs/architecture/flex-agents-server.md#8-plan-graph-structure`) Plan inspector lives under `src/components/FlexSandboxPlanInspector.vue` and routes through `src/views/FlexSandboxView.vue`.
4. Existing operator UI and external APIs remain unchanged; the sandbox is hidden behind a `USE_FLEX_DEV_SANDBOX` feature flag (or equivalent) and enforces existing auth so only internal roles access it. (`docs/architecture/flex-agents-server.md#14-risks--open-questions`)
5. SSE parsing and telemetry emission reuse the shared Flex event utilities, ensuring payload compatibility with the documented streaming contract and existing logging. (`docs/architecture/flex-agents-server.md#10.0.1-flex-run-streaming-contract`)
6. Facet, capability, and agent catalogs are exposed via a read-only API (or existing registry service) for the UI; responses stay consistent with orchestrator data models and do not mutate registry state. (`docs/architecture/flex-agents-server.md#facet-driven-contracts`, `docs/architecture/flex-agents-server.md#capability-registry`)
7. Add unit/integration coverage for the catalog API and sandbox run flow (mocked SSE) plus component tests that exercise payload validation and plan rendering. (`docs/architecture/discovery_agent_backend/testing-strategy.md#testing-strategy`)
8. Update developer documentation with sandbox usage, feature flag instructions, dependency sequencing, and safety notes about non-production scope. (`docs/architecture/flex-agents-server.md#developer-tooling`, `docs/architecture/coding-standards.md#documentation`)
9. Manual verification confirms the sandbox does not leak into production builds and that disabling the flag removes routes/menu entries (e.g., `src/router/dev-routes.ts`). (`docs/architecture/coding-standards.md#environment-configuration`)

## Tasks / Subtasks
- [ ] Expose read-only Flex metadata endpoint(s) returning facets, capabilities, agents, and discoverable payload templates for sandbox consumption. (AC 1, AC 6)
- [ ] Implement Vue sandbox workspace with payload editor, run launcher, live SSE console, and plan visualizer/breakdown panels. (AC 1-5)
- [ ] Add tests (API, Vitest component harness) and developer docs covering feature flag usage, payload iteration workflow, and safety constraints. (AC 7-9)

## Story Context

**Existing System Integration:**
- Integrates with: Flex capability registry, facet catalog (`packages/shared/src/flex/facets/catalog.ts`), `FlexRunController` SSE stream (`/api/v1/flex/run.stream`), existing feature flag infrastructure.
- Technology: Vue 3 + Vite front-end, Nitro server routes, TypeScript shared models, SSE utilities (`src/lib/flex-sse.ts`).
- Follows pattern: Feature-flagged developer tooling (e.g., Flex Create Post popup) and existing SSE client/store abstractions.
- Touch points: `packages/flex-agents-server` metadata services, `src/views/FlexSandboxView.vue`, `src/router/dev-routes.ts`, `src/components/FlexSandboxPlanInspector.vue`, `src/stores` for SSE state, `tmp/` task examples.

## Acceptance Criteria (Detailed)

### Functional Requirements
1. Sandbox lists available payload templates, validates edits against facet/capability metadata, and saves drafts (local storage or workspace directory) without breaking existing files.
2. Run execution streams telemetry inline with clear status indicators, exposes envelope request/response JSON, and surfaces planner retry diagnostics when present.
3. Plan inspector shows node sequence, linked capabilities, facet provenance, and policy flags, updating live as `plan_updated` events arrive.

### Integration Requirements
4. Feature flag or route guard isolates the sandbox from end-user flows; toggling it off removes UI entrypoints and server routes.
5. SSE handling reuses the shared Flex SSE utilities to avoid duplicate parsing logic and maintain compatibility with orchestrator contracts.
6. Metadata API pulls from the live registry/caches without mutating state, caches responses for the UI, and returns HTTP 503 when registry data is unavailable.

### Quality Requirements
7. Automated tests cover metadata API serialization, sandbox payload validation (happy path + failure), and mocked SSE rendering. Tests include `npm run test:unit -- packages/flex-agents-server/__tests__/flex-sandbox-metadata.spec.ts packages/flex-agents-server/__tests__/flex-sandbox-run.spec.ts` and component tests `npm run test:component -- src/components/FlexSandboxPlanInspector.spec.ts`.
8. Documentation in `docs/` (or existing README sections) explains enabling the feature, editing payloads safely, dependencies on Stories 8.2/8.3, and interpreting plan telemetry.
9. Manual QA checklist confirms production build excludes sandbox assets/routes and that disabling the flag leaves legacy flows untouched.

## Testing
- **Commands:** `npm run test:unit -- packages/flex-agents-server/__tests__/flex-sandbox-metadata.spec.ts packages/flex-agents-server/__tests__/flex-sandbox-run.spec.ts`, `npm run test:component -- src/components/FlexSandboxPlanInspector.spec.ts`
- **Scenarios:** Metadata API happy path + unavailable registry (expect HTTP 503), payload validation failure surfacing errors inline, mocked SSE stream producing plan updates, feature flag disabled ensuring no route/component exposure, and plan visualization rendering derived capabilities/retry states.

## Technical Notes
- **Integration Approach:** Reuse Nitro server modules to serve metadata, reuse `FlexRunController` SSE stream, and wire Vue components through existing store patterns (`useHitlStore`/`flex-sse`).  
- **Existing Pattern Reference:** Feature-flagged Flex Create Post dialog and SSE client utilities demonstrate how to guard dev-only UI and consume flex events.  
- **Key Constraints:** No mutations to capability registry; sandbox must never auto-execute plans without explicit developer action; ensure large payloads do not block UI thread (stream updates incrementally).

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check
- **Primary Risk:** Exposing internal metadata or run controls to unintended users.  
- **Mitigation:** Strict feature flag + auth guard, developer-only route, no write operations to registry, telemetry scrubbed for user data.  
- **Rollback:** Disable `USE_FLEX_DEV_SANDBOX` flag and remove route; revert metadata endpoint deployment.

**Compatibility Verification:**
- [ ] No breaking changes to existing APIs
- [ ] Database changes (if any) are additive only
- [ ] UI changes follow existing design patterns
- [ ] Performance impact is negligible

## Validation Checklist
- [ ] Story can be completed in one development session
- [ ] Integration approach is straightforward
- [ ] Follows existing patterns exactly
- [ ] No design or architecture work required
- [ ] Story requirements are unambiguous
- [ ] Integration points are clearly specified
- [ ] Success criteria are testable
- [ ] Rollback approach is simple
