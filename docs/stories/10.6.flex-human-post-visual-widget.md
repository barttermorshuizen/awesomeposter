# Story 10.6: Flex Human Post Visual Asset Widget

## Status
Ready for Review

## Story
**As a** flex visual designer working in the task panel,  
**I want** a dedicated post visual widget that lets me add, preview, reorder, and manage creative assets directly in the assignment,  
**so that** I can deliver publication-ready visuals without leaving the flex workflow.

**Dependencies:** Completion of Story 10.4 (flex human notification & assignment plumbing) and Story 10.3 (flex human task surfaces). (`docs/stories/10.4.flex-human-notification-plumbing.md`, `docs/stories/10.3.flex-human-task-surfaces.md`)

## Acceptance Criteria
1. The `post_visual` facet renders a specialized widget inside the flex task panel where designers can drag-and-drop or browse files, triggering Cloudflare R2 uploads and adding the resulting R2 URLs to the node’s output contract. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/tech-stack.md#1-core-runtime-components`, `docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)
2. Existing and newly uploaded assets display as thumbnail cards showing source details, with the widget clearly indicating the first asset as the featured visual consumed downstream. (`docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/flex-agents-server.md#152-design-principles`)
3. Designers can reorder assets via drag-and-drop (or accessible controls), and the widget persists the updated order in the outbound `post_visual` array before calling `/api/v1/flex/run.resume`. (`docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
4. Designers can remove assets from the list; the widget updates facet state, emits toast feedback on failures, and keeps `flexTasks` store data consistent with SSE/backlog refresh rules. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
5. Vitest coverage exercises add/upload, reorder, and delete flows for the widget and runs under `npm run test:unit` per coding standards. (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)

## Tasks / Subtasks
- [x] Map the `post_visual` facet to a dedicated widget component in the flex task registry that handles drag-and-drop ingestion, thumbnail rendering, and state binding. (AC 1,2) (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/source-tree.md#2-spa-src`)
- [x] Integrate Cloudflare R2 uploads (presigned request generation, progress, error handling) so successful uploads register R2 URLs in the widget’s facet state. (AC 1) (`docs/architecture/tech-stack.md#1-core-runtime-components`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)
- [x] Persist reorder and delete actions through the `flexTasks` store, ensuring telemetry-backed refresh keeps assignments in sync after `/api/v1/flex/run.resume` and backlog hydration. (AC 3,4) (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)
- [x] Apply accessibility patterns from the HITL panel (keyboard navigation, ARIA) to the new widget interactions, keeping shared toast handling consistent. (AC 2,4) (`docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)
- [x] Add Vitest suites for widget state reducers and user flows, and wire them into `npm run test:unit`. (AC 5) (`docs/architecture/coding-standards.md#7-testing-expectations`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)

## Story Context
- `post_visual` facet defines publication-ready visual arrays where the first URL is featured; the widget must respect this ordering while composing downstream-friendly output. (`docs/architecture/flex-agents-server.md#facet-post_visual`)
- Facet-driven task surfaces and the `flexTasks` module already compose widgets per facet, so this enhancement extends the existing registry rather than altering legacy HITL forms. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`, `docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)
- Notification plumbing keeps `/api/v1/flex/tasks` and SSE events synchronized, so widget updates must cooperate with those flows to avoid duplicate work or stale state. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)

## Dev Notes
- **Previous Story Insights:** Story 10.3 delivered the flex task panel, widget registry, and store hooks; extend those primitives to specialize the designer experience. Story 10.4 wired notification/backlog plumbing, so the widget must preserve those reconciliation paths. Story 10.5 scopes governance docs but introduces no new UX constraints. (`docs/stories/10.3.flex-human-task-surfaces.md`, `docs/stories/10.4.flex-human-notification-plumbing.md`, `docs/stories/10.5.flex-human-operations-governance.md`)
- **Data Models:** `post_visual` output is an ordered array of R2 URLs, with the first entry treated as primary by downstream systems. (`docs/architecture/flex-agents-server.md#facet-post_visual`)
- **API Specifications:** Resume flow remains `/api/v1/flex/run.resume`, with backlog hydration through `/api/v1/flex/tasks`; integrate uploads without bypassing these submission paths. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- **Component Specifications:** Widget composition runs inside `FlexTaskPanel.vue` using the facet registry and `flexTasks` store state machine; follow accessibility and toast patterns shared with HITL components. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- **File Locations:** SPA components and widgets live under `src/components/flex-tasks/` with supporting logic in `src/stores/flexTasks.ts`. (`docs/architecture/source-tree.md#2-spa-src`)
- **Testing Requirements:** Use Vitest with Vue Test Utils under `npm run test:unit`; add targeted specs for widget behaviors. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- **Technical Constraints:** Vue 3 + Vuetify stack with TypeScript, Pinia, and SSE-backed state management remain standard; keep human task UX isolated from legacy HITL panels. (`docs/architecture/tech-stack.md#1-core-runtime-components`, `docs/architecture/flex-agents-server.md#152-design-principles`)
- **Storage Patterns:** Follow `POST /api/flex/assets/upload` and related metadata rules documented in the post visual R2 endpoint blueprint. (`docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)
- **Project Structure Notes:** All changes stay within the SPA (`src/`); no backend schema or orchestration contract updates are required. (`docs/architecture/source-tree.md#2-spa-src`)
- **Open Questions / Gaps:** Thumbnail sizing remains unspecified; align with design once the widget’s layout is finalized. (`docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)

## Testing
- `npm run test:unit`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-04-10 | 1.1 | Wrapped the post visual facet in a collapsible panel within the flex task panel. | Dev |
| 2025-04-08 | 1.0 | Implemented post visual widget, flex task store helpers, and regression coverage. | Dev |
| 2025-04-03 | 0.1 | Initial draft defining the flex human post visual widget story. | Scrum Master |

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Full Stack Developer persona)

### Debug Log References
- npm run test:unit -- PostVisualWidget
- npm run test:unit -- FlexTaskPanel

### Completion Notes List
- Added `PostVisualWidget.vue` with drag-and-drop uploads, thumbnail previews, featured visual indicators, and keyboard-accessible reorder controls.
- Extended `useFlexTasksStore` with post visual asset upload, ordering, and deletion helpers that target the flex-specific asset endpoints.
- Registered the specialized widget in `widgets/registry.ts` so `post_visual` facets automatically render the new experience within `FlexTaskPanel`.
- Authored Vitest coverage that exercises upload, reorder, and delete flows, validating store interactions and emitted facet payloads.
- Enhanced thumbnail display logic to render real image previews with graceful fallbacks when assets are non-image or fail to load.
- Added `/api/flex/assets/:id/download` endpoint and switched the widget to its signed URLs so R2-hosted visuals show reliably in the assignment panel.
- Wrapped the `post_visual` output facet in the flex task panel with a collapsible header to align with other facet presentations.

### File List
- src/components/flex-tasks/widgets/PostVisualWidget.vue
- src/components/flex-tasks/widgets/__tests__/PostVisualWidget.spec.ts
- src/components/flex-tasks/widgets/registry.ts
- src/stores/flexTasks.ts
- src/components/flex-tasks/FlexTaskPanel.vue

## QA Results

_Not yet reviewed. QA to update this section only._
