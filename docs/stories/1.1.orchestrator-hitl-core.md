# Story 1.1: Orchestrator HITL Core

## Status
Draft

## Story
**As a** platform orchestrator,
**I want** to accept, validate, and manage HITL requests from specialist agents during plan execution,
**so that** human decisions can be injected into the plan without breaking automated flows.

## Acceptance Criteria
1. Orchestrator exposes an internal API for agents to raise HITL requests with payload metadata (question, options, urgency, origin agent).
2. Orchestrator enforces configurable per-run HITL limits and denies excess requests with reason "Too many HITL requests" while continuing execution.
3. Orchestrator rehydrates plan state with approved human responses and replans accordingly, including context updates for subsequent steps.
4. Orchestrator records denial reasons so agents can proceed automatically without resubmitting.

## Tasks / Subtasks
- [ ] Extend agents server orchestrator to register a HITL request handler that captures metadata and persists via repository (AC 1).
  - [ ] Define shared TypeScript interfaces for HITL request payloads and wire origin agent metadata through existing handoff pipeline (AC 1).
- [ ] Implement per-run HITL limiter with configurable default (3) and denial workflow that logs "Too many HITL requests" (AC 2, AC 4).
  - [ ] Add configuration surface (env/feature flag) and unit tests covering limit edge cases (AC 2).
- [ ] Emit monitoring metrics (e.g., HITL queue depth, denied count) via existing logging/telemetry pipeline for observability (Should-fix).
- [ ] Update orchestration plan rehydration to consume approved HITL responses and append them to plan context before replanning (AC 3).
  - [ ] Ensure denial responses propagate back to originating agents without re-triggering HITL (AC 4).
- [ ] Document new HITL request lifecycle in agents server README or orchestrator requirements appendix (supports AC 1-4).

## Dev Notes
- Focus area: `packages/agents-server/src/orchestrator/` (or equivalent orchestrator module) for plan management; leverage existing persistence adapters under `packages/agents-server/src/server`.
- Persist HITL requests/responses using repositories in `packages/shared` or new module that mirrors treatment of plan artifacts; coordinate with Story 1.2 for storage backing.
- Ensure SSE telemetry still emits valid frames: wrap HITL events in existing `handoff`/`plan_update` patterns from `docs/orchestrator_requirements.md`, and hook metrics into current monitoring sinks.
- When denying HITL due to limit, return structured payload so specialist agent can branch without retry.

### Testing
- Unit tests: use Vitest in `packages/agents-server/__tests__` to cover HITL request handling and limiter scenarios.
- Integration test: add orchestrator run fixture in `packages/agents-server/tests` that simulates agent emitting multiple HITLs and validates denial + replanning behavior.
- Regression: rerun existing orchestrator happy-path tests to confirm non-HITL flows remain unaffected.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | 0.1 | Initial draft of Story 1.1 based on Epic HITL-1. | PO |
