# Story 10.8: Flex Human Post Visual Input Gallery

## Status
Done

## Story
**As a** flex marketing reviewer working in the task panel,  
**I want** the `post_visual` input facet to render a read-only gallery with named thumbnails,  
**so that** I can evaluate designer deliverables without deciphering raw URL lists.

**Dependencies:** Completion of Story 10.6 (flex human post visual widget authoring). (`docs/stories/10.6.flex-human-post-visual-widget.md`)

## Acceptance Criteria
1. When a flex assignment includes the `post_visual` facet in its input contract, the facet widget registry resolves a `post_visual.input` component that renders a read-only gallery inside `FlexTaskPanel.vue`, replacing the default array viewer. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server.md#facet-post_visual`)
2. Each gallery card surfaces a human-readable name (prefer original asset metadata, fall back to filename), exposes a view/download action, highlights the first asset as “Featured”, and presents accessible captions/tooltips for screen readers. (`docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
3. Assets uploaded through the flex pipeline resolve image thumbnails via the flex asset APIs—including the `/api/flex/assets/:id/download` route for R2-backed objects—while external URLs remain clickable; failures gracefully render a placeholder state with toast feedback. (`docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`, `docs/architecture/tech-stack.md#1-core-runtime-components`)
4. Non-image assets (e.g., PDFs, videos) display type-aware badges or icons and retain working download links so reviewers can open them without thumbnail assumptions. (`docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
5. Vitest coverage exercises the widget’s rendering paths (featured asset, external URLs, R2 downloads, non-image fallbacks) and runs under `npm run test:unit`. (`docs/architecture/coding-standards.md#7-testing-expectations`)
6. Architecture documentation for facet-driven task surfaces notes the new `post_visual.input` registration so future stories can reference the pattern. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)

## Tasks / Subtasks
- [x] Extend the flex tasks store to normalize `post_visual` input facet data (asset IDs, names, MIME types) for gallery consumption. (`docs/architecture/flex-agents-server.md#facet-post_visual`, `src/stores/flexTasks.ts`)
- [x] Implement a dedicated `post_visual.input` widget that renders named thumbnails, featured-label styling, download controls, and non-image fallbacks using Vuetify components. (`docs/architecture/tech-stack.md#1-core-runtime-components`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)
- [x] Reuse the flex asset APIs to hydrate R2-backed assets (including `/api/flex/assets/:id/download`) and surface toast feedback on retrieval failures. (`docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`, `docs/stories/10.6.flex-human-post-visual-widget.md`)
- [x] Register the widget under `post_visual.input`, ensure `FlexTaskPanel.vue` loads it, and document the mapping in the facet widget section. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `src/components/flex-tasks/widgets/registry.ts`)
- [x] Add Vitest suites covering featured asset labelling, metadata fallbacks, R2 download usage, and non-image rendering paths; wire into the existing unit test command. (`docs/architecture/coding-standards.md#7-testing-expectations`, `src/components/flex-tasks/widgets/__tests__/`)
- [x] Update `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces` (or relevant sharded file) to list `post_visual.input` alongside existing widget mappings. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)

## Story Context
- `post_visual` is a bidirectional facet whose array of R2 URLs feeds designer output and reviewer inputs; reviewers currently see raw URLs in the default widget. (`docs/architecture/flex-agents-server.md#facet-post_visual`)
- The flex task panel composes facet widgets per registry entry, so adding `post_visual.input` enriches the reviewer experience without touching the authoring widget. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)
- Flex asset APIs already expose assignment-scoped metadata and R2 downloads, enabling consistent thumbnail display for stored assets. (`docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)

## Dev Notes
- **Previous Story Insights:** Story 10.6 introduced the editable `PostVisualWidget` and R2 download route patterns—mirror its asset hydration and thumbnail guards in read-only mode. (`docs/stories/10.6.flex-human-post-visual-widget.md`)
- **Data Models:** `post_visual` remains an ordered array where index 0 is featured; asset metadata (name, MIME type, IDs) lives in flex asset records and run context snapshots. (`docs/architecture/flex-agents-server.md#facet-post_visual`, `docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)
- **API Specifications:** Use `/api/flex/assets`, `/api/flex/assets/:id/download`, and existing resume flows to keep gallery previews consistent with the output widget. (`docs/architecture/flex-agents-server/1511-post-visual-r2-endpoint-patterns.md`)
- **Component Specifications:** Widget lives under `src/components/flex-tasks/widgets/`, leverages Vuetify cards/badges, and plugs into `FlexTaskPanel.vue` via the registry. (`docs/architecture/source-tree.md#2-spa`, `docs/architecture/tech-stack.md#1-core-runtime-components`)
- **Testing Requirements:** Add Vitest suites with Vue Test Utils mirroring other widget tests; ensure `npm run test:unit` stays green. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- **Technical Constraints:** Maintain separation between legacy HITL panels and flex task modules; keep new widget read-only and avoid mutating output state. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- **Project Structure Notes:** No new directories required; reuse existing flex widget/test folders and document updates under `docs/architecture/flex-agents-server/`. (`docs/architecture/source-tree.md#2-spa`, `docs/architecture/source-tree.md#6-documentation-assets`)

## Testing
- `npm run test:unit`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-03 | 1.1 | Corrected post visual facet widgets to use signed R2 download routes for thumbnails and actions. | Dev |
| 2025-04-14 | 0.1 | Initial draft defining the post visual input gallery story. | Scrum Master |
| 2025-04-14 | 0.1 | Initial draft defining the post visual input gallery story. | Scrum Master |

## Dev Agent Record

### Agent Model Used
- GPT-5 Codex (Full Stack Developer persona)

### Debug Log References
- npm run test:unit -- PostVisualWidget PostVisualInputGallery
- npm run test:unit -- PostVisualInputGallery

### Completion Notes List
- Normalized `post_visual` input facet payloads in `useFlexTasksStore` so gallery components receive typed asset metadata across URLs and managed flex assets.
- Delivered `PostVisualInputGallery.vue` with featured labeling, thumbnail fallbacks, download buttons, toast-backed error handling, and Vuetify styling consistent with flex task surfaces.
- Registered the new widget under `post_visual.input`, aligned both facets with the `/api/flex/assets/:id/download` route for signed previews (covering string URL fallbacks), and augmented the architecture documentation to mention the reviewer-facing gallery mapping.
- Authored dedicated Vitest coverage validating featured annotations, external URL fallbacks, download routes, and hydration error handling.
- Documented all supporting files in the File List following QA feedback.

### File List
- src/stores/flexTasks.ts
- src/components/flex-tasks/widgets/PostVisualInputGallery.vue
- src/components/flex-tasks/widgets/PostVisualWidget.vue
- src/components/flex-tasks/widgets/flexAssetUtils.ts
- src/components/flex-tasks/widgets/registry.ts
- src/components/flex-tasks/widgets/__tests__/PostVisualInputGallery.spec.ts
- docs/architecture/flex-agents-server.md
- docs/architecture/flex-agents-server/511-reference-capability-registry.md
- docs/stories/10.9.flex-human-social-post-preview.md

## QA Results

_Not yet reviewed. QA to update this section only._

### Review Date: 2025-05-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Widget renders type-aware thumbnails, featured chips, and download links sourced through the central resolver to honour R2-backed assets and external URLs (`src/components/flex-tasks/widgets/PostVisualInputGallery.vue:155`, `src/components/flex-tasks/widgets/flexAssetUtils.ts:50`).
- Store-level sanitizer now normalizes `post_visual` input facets so the gallery receives consistent metadata regardless of upstream shape (`src/stores/flexTasks.ts:231`).

### Findings
- File List omits several touched assets (`src/components/flex-tasks/widgets/PostVisualWidget.vue:1`, `src/components/flex-tasks/widgets/flexAssetUtils.ts:1`, `docs/architecture/flex-agents-server/511-reference-capability-registry.md:1`, `docs/stories/10.9.flex-human-social-post-preview.md:1`). Please add them for traceability before promotion.

### Test Results
- `npm run test:unit -- PostVisualInputGallery` ✅

### Risk Summary
- Medium – documentation/process mismatch around tracked files; functionality otherwise aligns with acceptance criteria.

### Recommended Status
- Changes Required (update File List, double-check scope of the extra story document)

### Review Date: 2025-05-22 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Story File List now records all touched assets, restoring audit traceability for the gallery rollout.
- Debug log includes the targeted unit suite invocation so future reviewers can confirm coverage.

### Findings
- None.

### Test Results
- `npm run test:unit -- PostVisualInputGallery` ✅

### Risk Summary
- Low – gallery behaves as-shipped and documentation/process gaps are closed.

### Recommended Status
- Ready for Done
