# Story 10.3: Flex Human Task Surfaces

## Status
Draft

## Story
**As a** flex operator experience lead,  
**I want** the SPA to render facet-driven task surfaces for human-executed flex nodes,  
**so that** human operators can fulfill planner-assigned work with deterministic resume and backlog support.

**Dependencies:** Completion of Story 10.2 (planner and execution lifecycle for human nodes). (`docs/stories/10.2.flex-human-planner-execution.md`)

## Acceptance Criteria
1. Flex Tasks Pinia store (`src/stores/flexTasks.ts`) reacts to `node_start` frames with `executorType: "human"` by registering pending assignments, composing facet-driven widgets, and exposing assignment metadata in the dedicated flex task panel. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
2. UI handles online/offline parity: SSE `hitl_request/hitl_update/hitl_resolved` events stay in sync with `GET /api/hitl/pending` for legacy approvals and `GET /api/v1/flex/tasks` for flex work, ensuring backlog recovery without duplicating assignments. (`docs/architecture/hitl/5-key-data-flows.md#51-specialist-raises-hitl-request`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)
3. Flex task submissions post facet-validated payloads to `/api/v1/flex/run.resume` (with declines routed through `/api/v1/flex/tasks/:taskId/decline` and reassignments via `/api/v1/flex/tasks/:taskId/reassign`), surface toast feedback, and refresh state once the orchestrator emits the corresponding flex telemetry; no `/api/hitl/*` endpoints are invoked from the flex task panel. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/hitl/6-api-surface.md#6-api-surface`)
4. Vitest suites cover the flex tasks store, widget composition, and flex resume/decline flows under `npm run test:unit`, ensuring regression guards for the new module. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/coding-standards.md#7-testing-expectations`)

## Tasks / Subtasks
- [ ] Introduce `src/stores/flexTasks.ts` to persist human node assignments, map `node_start`/`node_complete`/`node_error` frames, and trigger backlog reload on reconnect using flex task APIs. (AC 1,2) (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- [ ] Introduce a facet widget registry (e.g., `src/components/flex-tasks/widgets/`) that renders form controls per facet and composes them inside the task panel host. (AC 1) (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)
- [ ] Build `FlexTaskPanel.vue` (or equivalent) to display assignment metadata, embed facet widgets, enforce accessibility, and handle loading/empty states independently of the legacy HITL approval panel. (AC 1) (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- [ ] Implement resume/decline actions that post structured payloads to `/api/v1/flex/run.resume` and `/api/v1/flex/tasks/:taskId/decline`, validate responses, emit toasts, and reconcile store state after telemetry confirmations. (AC 3) (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- [ ] Wire backlog and assignment views to `GET /api/hitl/pending` and `GET /api/v1/flex/tasks`, ensuring offline recovery and filters for `assignedTo`. (AC 2) (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)
- [ ] Add Vitest coverage for store reducers, widget rendering helpers, and API flows, integrating with existing `npm run test:unit` suites. (AC 4) (`docs/architecture/coding-standards.md#7-testing-expectations`)
- [ ] Document feature flag toggles and operator workflow updates in `docs/architecture/hitl/` for rollout alignment. (AC 1,2,3) (`docs/architecture/hitl/8-configuration-feature-flagging.md#8-configuration--feature-flagging`)

## Story Context
- Human planner nodes now emit `node_start` events with facet contracts and assignment metadata; the SPA must leverage these details to build structured task experiences. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`)
- Legacy HITL panel components handle policy approvals (binary accept/reject) and remain untouched; flex human tasks require a dedicated store and panel so facet-driven execution does not bleed into approval UX. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/4-target-component-architecture.md#43-front-end-integration`)
- Operators rely on `/api/hitl/pending` today; flex human tasks add `/api/v1/flex/tasks` routing and assignment metadata that the backlog view must surface. (`docs/architecture/hitl/5-key-data-flows.md#51-specialist-raises-hitl-request`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- Offline recovery and eventual delivery are required so human nodes remain actionable even if the SPA disconnects. (`docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)

## Dev Notes
- **Previous Story Insights:** Story 10.2 established awaiting-human lifecycle states, SSE telemetry, and resume validation for human nodesâ€”UI flows must consume `executorType: "human"` events and respect deterministic resume semantics via the flex task module. (`docs/stories/10.2.flex-human-planner-execution.md`)
- **Data Models:** Human assignments draw from `flex_plan_nodes`, `flex_plan_snapshots`, and existing `hitl_requests` rows containing `contract_summary_json` and operator prompts; UI should display persistent metadata through the flex tasks store without mutating legacy HITL store structure. (`docs/architecture/flex-agents-server.md#9-data-model--persistence`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- **API Specifications:** Resume interactions call `/api/v1/flex/run.resume`; declines post to `/api/v1/flex/tasks/:taskId/decline`, reassignments to `/api/v1/flex/tasks/:taskId/reassign`, avoiding `/api/hitl/*`. Backlog queries rely on `/api/hitl/pending` for approvals and `/api/v1/flex/tasks` for flex work. SSE frames for human nodes arrive via `/api/v1/flex/run.stream`. (`docs/architecture/flex-agents-server.md#1001-flex-run-streaming-contract`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- **Component Specifications:** `FlexTaskPanel.vue`, facet widget registry, and `src/stores/flexTasks.ts` orchestrate flex task state, SSE handling, and submission; the legacy HITL panel/store remains focused on approval UX. (`docs/architecture/flex-agents-server.md#154-facet-driven-task-surfaces`, `docs/architecture/hitl/7-front-end-state-ux-contract.md#7-front-end-state--ux-contract`)
- **File Locations:** Follow SPA structure with `FlexTaskPanel.vue` under `src/components/flex-tasks`, views under `src/views`, stores in `src/stores`, and utilities in `src/lib`; facet widgets should live under `src/components/flex-tasks/widgets` (sharing registry utilities as needed). (`docs/architecture/source-tree.md#2-spa`, `docs/architecture/source-tree.md#1-top-level`)
- **Testing Requirements:** Use Vitest with Vue Test Utils for store/component suites and ensure coverage runs through `npm run test:unit`. (`docs/architecture/coding-standards.md#7-testing-expectations`)
- **Technical Constraints:** Implement using Vue 3 Composition API with TypeScript, adhere to coding standards, scoped styles, and ES module conventions; gate UI via existing feature flags. (`docs/architecture/coding-standards.md#1-language--module-conventions`, `docs/architecture/hitl/8-configuration-feature-flagging.md#8-configuration--feature-flagging`)
- **Project Structure Notes:** Planned updates align with existing SPA directories and require no structural deviations. (`docs/architecture/source-tree.md#2-spa`)

## Testing
- `npm run test:unit -- src/stores/__tests__/flexTasks.store.spec.ts src/components/flex-tasks/__tests__/FlexTaskPanel.spec.ts`
- `npm run test:unit -- src/components/flex-tasks/widgets/__tests__/facet-widgets.spec.ts`
- `npm run lint`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-04-01 | 0.1 | Initial draft defining flex human task surface scope. | Scrum Master |

## QA Results

_Not yet reviewed. QA to update this section only._
