# Story 6.1: SSE Event Stream

## Status
Ready for Review

## Story
**As** the front-end application,
**I want** a reliable SSE endpoint for discovery events,
**so that** users see pipeline activity in near real time.

## Acceptance Criteria
1. Authenticated clients can subscribe to `/api/events/discovery` and receive only their client-specific events.
2. SSE payload includes fields: `schemaVersion`, `eventType`, `clientId`, `entityId`, `timestamp`, `payload`.
3. Server automatically heartbeats every 30 seconds to keep connection alive; clients auto-reconnect within 5 seconds after drop.
4. Endpoint enforces rate limits (max 5 concurrent connections per user) and logs connections/disconnections for monitoring.

## Context
- Telemetry frames originate from discovery scoring and ingestion jobs via `signalAgentEvent`; Nitro subscribers fan them out through `/api/discovery/events.stream` as scoped SSE envelopes (`docs/architecture/discovery-agent-backend.md#responsibilities-by-layer`).
- Frontend consumers rely on `subscribeDiscoveryEvents` to parse `DiscoveryTelemetryEvent` contracts; keep schema versioning in sync with shared models (`docs/architecture/discovery_agent_frontend/realtime-telemetry-sse.md`).
- Apply the shared SSE transport pattern for envelopes, headers, and heartbeat timers so behaviour matches existing endpoints (`docs/hardening_agent_server.md#sse-transport-standardization`).
- Discovery Telemetry epic outlines dashboards that consume per-client event streams; reconnect guidance should mirror HITL banners for consistent operator UX (`docs/prd/epic-discovery-telemetry-reporting/index.md`).

## Tasks / Subtasks
- [x] Implement SSE controller in Nitro API with client scoping and auth checks (AC 1).
- [x] Define payload schema and version constant shared with frontend (AC 2).
- [x] Add heartbeat timer and reconnect guidelines (AC 3).
- [x] Integrate rate limiting and connection logging (AC 4).
- [x] Write integration tests simulating multiple clients and reconnection scenarios (AC 1-4).

## Dev Notes
- Reuse existing SSE infrastructure (check `src/lib/agent-sse.ts`) and align envelope fields with `packages/shared/src/discovery-events.ts` version constants.
- Guard tenant scoping by requiring both session user context and `clientId` query; deny mismatched access with 403 and document audit trail expectations.
- Enforce per-user connection caps by tracking active streams keyed by `userId`; return 429 when exceeding 5 concurrent connections and emit `discovery.sse.rate_limited` logs.
- Emit structured logs `discovery.sse.connected` and `discovery.sse.disconnected` including `clientId`, `userId`, `connectionId`, and connection duration; ship to Nitro logger plus StatsD counter if available.
- Heartbeat using the shared SSE helper but keep interval at 30 seconds to match acceptance criteria while reusing HITL retry copy (5-second reconnect guidance).
- Continue to ensure payload respects ASCII requirement where possible and call out any unavoidable binary data in schema notes.

### Testing
- Extend or add `tests/api/discovery/events-stream.spec.ts` to cover auth scoping, per-user connection limits, and heartbeat cadence assertions.
- Simulate >5 concurrent subscriptions for the same user to confirm 429 responses while allowing other users to connect; assert rate-limit logs are written.
- Manually verify via curl/EventSource that disconnect heartbeat cleanup occurs and clients auto-reconnect within 5 seconds per guidance.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Telemetry & Reporting. | PM |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit -- tests/api/discovery/events-stream.spec.ts

### Completion Notes List
- Added `/api/events/discovery` SSE handler with auth scoping, per-user rate limiting, structured logging, and 30-second heartbeats.
- Published shared discovery telemetry schema and schema version constant for coordinated frontend/server parsing.
- Updated Vue discovery SSE subscriber to consume the new endpoint and schema, keeping existing handlers intact.
- Implemented Vitest integration suite exercising auth failures, client isolation, rate limiting, heartbeat cadence, and feature-disabled signaling.

### File List
- packages/shared/src/discovery-events.ts
- server/api/discovery/events.stream.ts
- server/api/events/discovery.get.ts
- server/utils/discovery-telemetry.ts
- server/utils/session.ts
- src/lib/discovery-sse.ts
- tests/api/discovery/events-stream.spec.ts

## References
- `docs/architecture/discovery-agent-backend.md#responsibilities-by-layer`
- `docs/architecture/discovery_agent_frontend/realtime-telemetry-sse.md`
- `docs/hardening_agent_server.md#sse-transport-standardization`
- `docs/prd/epic-discovery-telemetry-reporting/index.md`
