# Story 10.2: Flex Human Planner & Execution Lifecycle

## Status
Done

## Story
**As a** flex orchestrator architect,  
**I want** the planner and execution engine to schedule, persist, and resume human-operated capability nodes deterministically,  
**so that** human participation follows the same audited lifecycle and contract guarantees as AI agents.

**Dependencies:** Completion of Story 10.1 (human capability registry entries). (`docs/stories/10.1.flex-human-capability-registry.md`)

## Acceptance Criteria
1. Planner emits `HumanAgent.*` nodes with `executorType: "human"`, compiled facet contracts, and assignment metadata persisted to `flex_plan_nodes` when human capabilities are selected. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
2. Execution engine dispatches human nodes, streams `node_start/node_complete/node_error` frames that include the human contract payload, and transitions runs into an `awaiting_human` state until `/api/v1/flex/run.resume` validates submitted output contracts. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`, `docs/architecture/flex-agents-server.md#156-planner-behavior`, `docs/architecture/flex-agents-server.md#10-api-surface-initial`)
3. Offline and backlog handling preserves deterministic resume: pending human work is discoverable via `GET /api/v1/flex/tasks`, survives disconnected UIs, and resuming a run rehydrates plan snapshots without graph divergence. (`docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`, `docs/architecture/flex-agents-server.md#9-data-model--persistence`)
4. Automated tests cover planner emission, persistence state transitions, resume validation, and SSE telemetry for human nodes, running under `npm run test:unit`. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)

## Tasks / Subtasks
- [x] Extend `PlannerService` and associated validators to recognize `agentType: "human"` capabilities, emitting nodes with executor metadata and persisted assignment fields. (AC 1) (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- [x] Update execution lifecycle to persist human node state (`awaiting_human`), stream enriched telemetry, and invoke assignment routing hooks when dispatching human capabilities. (AC 1,2) (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- [x] Implement deterministic resume handling: `/api/v1/flex/run.resume` validates human outputs, transitions state to complete/error, and rehydrates plan graphs without duplication. (AC 2,3) (`docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)
- [x] Ensure backlog discovery surfaces human tasks through `flex_plan_nodes` snapshots and existing task APIs, including long-idle escalation hooks. (AC 3) (`docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)
- [x] Add Vitest coverage for planner emission, awaiting/resume lifecycles, and telemetry assertions for human nodes; wire into `npm run test:unit`. (AC 4) (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)

## Story Context
- Planner and execution components already handle AI nodes; human entries must follow the same deterministic contract flow without introducing bespoke HITL events. (`docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- Pending human work should emit assignment metadata that downstream notification services consume, ensuring operators can pick up tasks even if the SPA is offline. (`docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- Runs entering an awaiting-human state rely on persisted plan snapshots and node state so resuming after operator submission does not re-plan or duplicate work. (`docs/architecture/flex-agents-server.md#159-offline-and-notification-semantics`)

## Dev Notes
- **Previous Story Insights:** Story 10.1 established `agentType: "human"` capability registry entries with facet-backed contracts and instruction templates; planner work must consume these registry payloads directly. (`docs/stories/10.1.flex-human-capability-registry.md`)
- **Data Models:** Use `flex_plan_nodes`, `flex_plan_snapshots`, and `hitl_requests` to persist awaiting-human state, node metadata, and operator prompts for deterministic resume. (`docs/architecture/flex-agents-server.md#9-data-model--persistence`)
- **API Specifications:** `/api/v1/flex/run.stream` streams lifecycle events and `/api/v1/flex/run.resume` accepts structured human outputs; task backlog discovery uses `/api/v1/flex/tasks`. (`docs/architecture/flex-agents-server.md#10-api-surface-initial`, `docs/architecture/flex-agents-server.md#155-notification-and-assignment-model`)
- **Component Specifications:** `PlannerService`, `ExecutionEngine`, and `TelemetryService` coordinate human node emission, execution, and event frames; resume flows depend on persistence and validation services. (`docs/architecture/flex-agents-server.md#6-component-responsibilities`, `docs/architecture/flex-agents-server.md#153-implementation-alignment`)
- **File Locations:** Planner/execution logic resides in `packages/flex-agents-server/src`, shared contracts in `packages/shared/src/flex`, and task APIs within Nitro handlers under `packages/flex-agents-server/src/server`. (`docs/architecture/source-tree.md#4-agents-server`, `docs/architecture/source-tree.md#5-shared-libraries`)
- **Testing Requirements:** Extend existing verification suites with human lifecycle tests executed via Vitest; adhere to repository testing expectations. (`docs/architecture/flex-agents-server.md#13-verification`, `docs/architecture/coding-standards.md#7-testing-expectations`)
- **Technical Constraints:** Follow coding standards for TypeScript modules, maintain strict typing, and reuse shared validation utilities. (`docs/architecture/coding-standards.md#1-language--module-conventions`)
- **Project Structure Notes:** Planned changes align with existing agents server and shared package layout; no deviations needed. (`docs/architecture/source-tree.md#4-agents-server`)

## Dev Agent Record
### Summary
- Added executor metadata and assignment propagation for `agentType: "human"` nodes across planner, execution engine, and persistence layers.
- Introduced human-aware resume handling in `FlexRunCoordinator`, REST surface (`run.resume`), and backlog endpoint (`tasks.get`).
- Landed Vitest suites covering human pause/resume lifecycle and SSE telemetry assertions.
- Hardened resume validation to keep human-operated runs awaiting resubmission and emit diagnostics on contract failures.

### File List
- packages/shared/src/flex/types.ts
- packages/flex-agents-server/src/services/flex-planner.ts
- packages/flex-agents-server/src/services/flex-execution-engine.ts
- packages/flex-agents-server/src/services/flex-run-coordinator.ts
- packages/flex-agents-server/src/services/orchestrator-persistence.ts
- packages/db/src/schema.ts
- packages/flex-agents-server/routes/api/v1/flex/run.resume.post.ts
- packages/flex-agents-server/routes/api/v1/flex/tasks.get.ts
- packages/flex-agents-server/__tests__/flex-human-lifecycle.spec.ts
- packages/flex-agents-server/__tests__/run-resume-human.spec.ts

### Validation
- Verified planner/emitter, execution engine, and human resume error handling via the Vitest suites listed below.

## Testing
- `npm run test:unit -- packages/flex-agents-server/__tests__/run-resume-human.spec.ts`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-31 | 0.1 | Initial draft defining planner and execution lifecycle for human capabilities. | Scrum Master |
| 2025-10-26 | 1.0 | Implemented human executor lifecycle, resume APIs, backlog queries, and regression tests. | Dev Agent |
| 2025-10-27 | 1.1 | Ensured failed human submissions leave runs in `awaiting_human` and added regression coverage for invalid payloads. | Dev Agent |

## QA Results

### Review Date: 2025-10-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ Fix confirmed: resume flow now validates human submissions before lifting the run out of `awaiting_human`, surfaces `node_error` telemetry when the payload fails schema checks, and leaves operators free to resubmit (`packages/flex-agents-server/src/services/flex-run-coordinator.ts:612-686`).
- ✅ Regression coverage added for the negative-path submission, guarding against future regressions (`packages/flex-agents-server/__tests__/run-resume-human.spec.ts`).

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ – targeted Vitest suite exercises both successful and invalid human resume paths.
- All ACs Met: ✓ – planner emits human nodes, execution/persistence maintain audited lifecycle, and deterministic resume is preserved.

### Gate Status
Gate: PASS → docs/qa/gates/10.2-flex-human-planner-execution.yml

### Suggested Status
Ready for Done
