# Story 5.2: Discovery Item Detail & Promotion

## Status
Ready for Review

## Story
**As a** reviewer,
**I want** to inspect an individual discovery item, leave notes, and promote it to an `Approved` brief,
**so that** downstream agents can act on curated nuggets.

## Acceptance Criteria
1. Detail view displays metadata retrieved from `GET /api/discovery/items/{id}`: title, source, score breakdown, extracted body, current status, status history entries, and `briefRef` when an item has already been promoted (duplicate references deferred; see scope note).
2. Promotion action submits `POST /api/discovery/items/{id}/promote` with `{ note: string (>=5 chars, ASCII-only) }`, captures actor + timestamp in persisted history, creates a new brief record, and returns the updated item payload including `briefRef`.
3. Status history renders newest-first with note text, actor display name, previous→next status, and ISO timestamps without requiring a page reload.
4. Successful promotion emits SSE event `brief.promoted` on channel `discovery.briefs` with payload `{ itemId, promotedAt, actorId, note, statusHistory, briefRef }`, and list/detail state rolls back if API persistence fails.
5. On SSE delivery failure or disconnected listener, the backend still persists the status change and enqueues a retry via existing SSE reconnect logic.
6. After promotion success, the UI navigates to the newly created brief in edit mode (e.g., route `#/briefs/{briefId}/edit`) while maintaining ability to return to the dashboard.
7. Discovery list rows with promoted items render a link/button that opens the associated brief in edit mode, using the `briefRef` provided on the discovery item.

## Tasks / Subtasks
- [x] Implement detail drawer/page using existing layout components (AC 1).
- [x] Add note input with validation and submission to backend (AC 2).
- [x] Update backend to persist status history entry with note + actor (AC 2, AC 3).
- [x] Emit SSE event and update list state optimistically with rollback if failure (AC 4, AC 5).
- [x] Update navigation flow to route to the created brief edit view after promotion (AC 6).
- [x] Surface promoted-item link in discovery list using returned `briefRef` (AC 7).
- [x] Write tests covering required note, SSE emission, history rendering, navigation, and list link (AC 2, AC 3, AC 4, AC 5, AC 6, AC 7).

## Dev Notes
- Use ASCII constraint for notes; sanitize to prevent HTML injection.
- Scope Note: duplicate reference linking is out-of-scope for this story; leave placeholders or empty state messaging.
- Dependencies: assumes Story 5.0 (dashboard foundation shell), Story 5.1 (discovery item listing), and Story 5.5 (`GET /api/discovery/search`) are completed and available.
- Backend contract:
  - `GET /api/discovery/items/{id}` returns `{ id, title, source, scoreDetails, body, status, statusHistory[], briefRef? }` where `briefRef` includes `{ briefId, editUrl }` when applicable.
  - `POST /api/discovery/items/{id}/promote` accepts `{ note }` (ASCII, trimmed) and uses authenticated user as actor; response mirrors GET schema with updated fields.
  - Promotion endpoint creates a brief record via Briefs service and stores `discoveryItemId` linkage; response `briefRef` surfaces the new brief identifier and canonical edit URL.
  - Status history entry format: `{ id, previousStatus, nextStatus, note, actorId, actorName, occurredAt }`.
- SSE delivery:
  - Event channel: `discovery.briefs`.
  - Event name: `brief.promoted`.
  - Payload: `{ itemId, promotedAt, actorId, note, statusHistory, briefRef }`.
  - Ensure retry/resubscription leverages existing SSE reconnect helper (see `docs/architecture/source-tree.md#sse-clients`).
- Frontend should optimistically mark item as `Approved` while POST request resolves; rollback to prior status on non-2xx response and surface toast error.
- After promotion response resolves, trigger navigation to `briefRef.editUrl` and show confirmation toast; provide in-brief breadcrumb or button to return to dashboard.
- Discovery list component should read `briefRef` and conditionally render an "Open Brief" link for promoted items; ensure accessibility semantics.
- Reference telemetry integration in follow-up (Telemetry epic) for promotion counts hook; no implementation change required here.
- References:
  - `docs/prd/epic-discovery-brief-dashboard.md#functional-requirements`
  - `docs/architecture/source-tree.md#dashboard-modules`
  - `docs/architecture/tech-stack.md#frontend`

### Testing
- Frontend:
  - Component test: note input validation blocks submission when <5 chars or non-ASCII.
  - Integration test: promotion success updates history list without reload, navigates to brief edit route, and reverts on simulated API failure.
  - SSE test: mock SSE event to ensure list/detail view consume payload and update history entry.
  - List behavior test: promoted row renders edit link using `briefRef`.
- API:
  - Unit test: promotion endpoint persists history record with actor attribution and note.
  - Integration test: promotion creates brief record, associates it to discovery item, and SSE payload includes `briefRef`.
  - Contract test: response matches documented schema (including ISO timestamp formats and brief linkage).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-03-29 | 0.1 | Draft for Epic: Brief Management Dashboard. | PM |
| 2025-03-30 | 0.2 | Clarified backend contract, SSE payload, dependencies, and scope. | SM |
| 2025-03-30 | 0.3 | Added brief creation, navigation, and linkage requirements. | SM |
| 2025-03-30 | 1.0 | Implemented discovery detail view, promotion flow, SSE integration, and automated tests. | Dev |

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5) via CLI session

### Debug Log References
- npm run test:unit

### Completion Notes List
- Added `/api/discovery/items/{id}` GET/POST endpoints plus repository support for status history, brief linkage, and SSE `brief.promoted` payloads.
- Extended the shared schemas and database schema/migrations to model discovery item details, promotion input validation, brief references, and history entries.
- Built `DiscoveryItemDetailDrawer` with promotion form, history timeline, score breakdown, and navigation hooks that push to the brief edit route after success.
- Enhanced the discovery list store to manage detail state, promotion workflow, SSE updates, and list/link synchronisation; wired new services for detail fetch/promote.
- Updated the dashboard view to open the detail drawer, surface “Edit brief” links for promoted items, and clear errors on note edits.
- Added Vitest coverage for promotion note validation, store detail/promotion flows, SSE handling, and adjusted component stubs to accommodate the new drawer.

### File List
- docs/stories/5.2.dashboard-discovery-item-detail.md
- packages/db/migrations/20250406_add_discovery_item_history.sql
- packages/db/src/discovery/index.ts
- packages/db/src/schema.ts
- packages/shared/src/discovery/item.ts
- packages/shared/src/discovery/search.ts
- packages/shared/src/discovery-events.ts
- packages/shared/src/discovery/__tests__/item.spec.ts
- packages/shared/src/index.ts
- server/api/discovery/items/[id]/index.get.ts
- server/api/discovery/items/[id]/promote.post.ts
- server/utils/discovery-repository.ts
- server/utils/discovery-telemetry.ts
- src/services/discovery/items.ts
- src/components/discovery/DiscoveryItemDetailDrawer.vue
- src/stores/discoveryList.ts
- src/views/discovery/DiscoveryDashboardView.vue
- src/__tests__/discoveryListStore.spec.ts
- src/__tests__/DiscoveryDashboardView.spec.ts
