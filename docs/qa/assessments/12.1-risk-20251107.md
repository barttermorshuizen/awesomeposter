# Story 12.1 Risk Profile — 2025-11-07

**Story**: Social Strategist Retrieval Foundation (`docs/stories/12.1.flex-social-strategist-rag-foundation.md`)

**Commit**: c8a8761 · **Reviewer**: Quinn (QA) · **Scope touched**: `packages/flex-agents-server/src/services/strategist-retrieval-service.ts`, `packages/flex-agents-server/src/tools/strategist.ts`, `packages/flex-agents-server/src/agents/marketing/strategist-social-posting.ts`, `packages/flex-agents-server/__tests__/marketing-strategist-retrieval.spec.ts`, `packages/db/*`

## Overall Risk Posture
- **Base score**: 100
- **Deductions**: Critical(−20) + High(−10 −10) + Medium(−5 −5 −5)
- **Residual score**: **55 / 100** → Indicates material risk remaining until mitigations land
- **Gate recommendation (per risk framework)**: **FAIL** (Critical risk present)

### Score Breakdown
| Risk ID | Score | Deduction |
| --- | --- | --- |
| TECH-001 | 9 (Critical) | −20 |
| SEC-001 | 6 (High) | −10 |
| OPS-001 | 4 (Medium) | −5 |
| PERF-001 | 4 (Medium) | −5 |
| OPS-002 | 6 (High) | −10 |
| OPS-003 | 4 (Medium) | −5 |

## Risk Matrix
| Risk ID | Category | Description | Probability | Impact | Score | Priority |
| --- | --- | --- | --- | --- | --- | --- |
| TECH-001 | Technical | ContextBuilder never consumes the retrieval bundle; only the manual strategist tool calls the service, so acceptance criteria for automatic corpus attachment are unmet. | High (3) | High (3) | **9** | Critical |
| SEC-001 | Security/Data | Embedding prompts include company, employee, and customer identifiers that are forwarded to OpenAI with no redaction or tenancy controls. | Medium (2) | High (3) | **6** | High |
| OPS-001 | Operational | Corpus refresh & quality workflow is undefined—DB schema exists but there is no ingestion job, monitoring, nor SLA for the "monthly" cadence advertised to callers. | Medium (2) | Medium (2) | **4** | Medium |
| PERF-001 | Performance | Every strategist tool call blocks on remote embeddings with no timeout, caching, or batching, so rate limits or latency spikes degrade the entire planner to fallback mode. | Medium (2) | Medium (2) | **4** | Medium |
| OPS-002 | Operational/Quality | Tests only cover the retrieval service in isolation; there is no integration test ensuring planner runs, telemetry signals, or fallback behaviour described in AC4. | High (3) | Medium (2) | **6** | High |
| OPS-003 | Operational | The new pgvector/ivfflat schema requires superuser privileges and REINDEX/ANALYZE steps that are undocumented, risking migration failures (esp. in managed Postgres). | Medium (2) | Medium (2) | **4** | Medium |

## Detailed Risk Register

### TECH-001 – Context bundle still lacks automatic retrieval
- **Evidence**: `StrategistRetrievalService.buildKnowledgeBundle` exists (`packages/flex-agents-server/src/services/strategist-retrieval-service.ts:49-61`), but the class is only instantiated from the `strategist_retrieve_knowledge` tool (`packages/flex-agents-server/src/tools/strategist.ts:6-25`). No planner/context builder code calls the bundle method, so strategist runs only see snippets if the agent remembers to trigger the tool.
- **Impact**: Violates AC2 and undermines the goal of blended briefs—runs triggered via automation will not carry curated snippets, reducing quality and wasting the corpus work.
- **Mitigation**: Wire `StrategistRetrievalService.buildKnowledgeBundle` into the ContextBuilder for `strategist.SocialPosting`, attach snippets automatically during run assembly, and add feature flags for rollout.
- **Testing focus**: Add planner-level tests that assert `ContextBundle.knowledge` contains vector results whenever envelope inputs are present and the corpus is enabled.

### SEC-001 – PII/brand data sent to OpenAI without minimisation
- **Evidence**: `composeQuery` forwards company names, tones, employee names, and customer names into the embedding prompt (`packages/flex-agents-server/src/services/strategist-retrieval-service.ts:147-169`) while `computeEmbedding` immediately calls OpenAI with that string (`packages/flex-agents-server/src/services/strategist-retrieval-service.ts:181-194`). No redaction, hashing, or opt-out is provided.
- **Impact**: High likelihood that regulated or embargoed campaign data leaves the boundary, creating privacy/compliance exposure and blocking customers who cannot share PII with third-party LLMs.
- **Mitigation**: Add configurable redaction (e.g., replace proper nouns with placeholders), allow first-party embedding providers, and gate external calls behind tenant-level consent.
- **Testing focus**: Unit-test sanitisation helpers and add audit logging that proves sensitive fields are masked before outbound requests.

### OPS-001 – Corpus refresh/quality lifecycle undefined
- **Evidence**: The migration creates `flex_capability_snippets` with monthly refresh expectations (`packages/db/migrations/20251022_add_flex_capability_snippets.sql:1-28`), and runtime metadata advertises `refreshCadence: 'monthly'` (`packages/flex-agents-server/src/agents/marketing/strategist-social-posting.ts:78-85`), yet no loader job, CLI, or monitoring hook exists.
- **Impact**: Without a refresh pipeline, snippets will rot, boosts will drift, and "monthly" claims become inaccurate, eroding trust and making fallback the norm.
- **Mitigation**: Deliver ingestion scripts plus a scheduled job that re-embeds curated content, record refresh timestamps per corpus, and alert when SLA is missed.
- **Testing focus**: Add contract tests for the loader plus health checks that assert `refreshCadence.lastRefreshedAt` is recent in staging data.

### PERF-001 – Retrieval path lacks resiliency
- **Evidence**: Every call constructs a fresh OpenAI client and awaits embeddings synchronously without timeout or caching (`packages/flex-agents-server/src/services/strategist-retrieval-service.ts:181-199`). The global tool singleton (`packages/flex-agents-server/src/tools/strategist.ts:8-25`) means bursts of concurrent queries all serialize through OpenAI.
- **Impact**: Latency spikes or rate limits will stall strategist runs for multiple seconds, forcing fallback bundles and making planners appear flaky.
- **Mitigation**: Introduce request-scoped caching, tune concurrency/timeout, and add circuit breakers that short-circuit to fallback once OpenAI degrades instead of hammering their API.
- **Testing focus**: Stress-test with mocked slow embeddings and assert the planner fails fast with telemetry + fallback instrumentation.

### OPS-002 – Verification gaps vs AC4
- **Evidence**: Story AC4 requires Vitest coverage for happy/fallback runs, yet only service-layer unit tests exist (`packages/flex-agents-server/__tests__/marketing-strategist-retrieval.spec.ts:49-105`). No integration tests hit `AgentRuntime`, `ContextBuilder`, telemetry emission, or registry metadata.
- **Impact**: Regressions (missing telemetry, schema drift, tool instruction regressions) will ship undetected, especially because the vital ContextBuilder path is untested.
- **Mitigation**: Add scenario tests that execute `createStrategistSocialPostingAgent` against mocked envelopes, assert knowledge injection, fallback signalling, and registry metadata. Extend CI to run these suites.
- **Testing focus**: - End-to-end Vitest covering planner pipelines
  - Contract tests ensuring registry payloads advertise retrieval health flags

### OPS-003 – Operational readiness for pgvector index
- **Evidence**: Migration enables the `vector` extension and builds an `ivfflat` index (`packages/db/migrations/20251022_add_flex_capability_snippets.sql:1-28`). Managed Postgres offerings often require the extension to be enabled via support ticket, and ivfflat indexes need a post-population `REINDEX`/`ANALYZE` step plus `SET ivfflat.probes` tuning—none of which is documented.
- **Impact**: Deployments can fail or degrade badly (sequential scans on a 1536-dim vector table), delaying rollout or producing timeouts that force fallback.
- **Mitigation**: Add runbook steps to provision pgvector, document index maintenance, and add boot-time checks that ensure the capability table exists before enabling the strategist feature flag.
- **Testing focus**: Infrastructure smoke tests verifying migrations succeed in staging + automated health checks for the `flex_capability_snippets` index size.

## Risk-Based Testing Strategy
- **Priority 1 (Critical/High)**
  - Simulate planner executions (automation + HITL) to prove knowledge bundles auto-attach and fallback telemetry fires; block release if ContextBuilder path is missing.
  - Privacy-focused tests verifying inputs are redacted when compliance mode is enabled and ensuring audit logs capture the raw vs sanitised payload hash.
- **Priority 2 (Medium)**
  - Load/perf tests that hammer the strategist tool with concurrent requests to measure embedding latency and fallback rates; ensure circuit breaker metrics exist.
  - Corpus refresh pipeline test harness that seeds outdated snippets and validates the job updates `refreshCadence` metadata.
- **Priority 3 (Low)**
  - Migration dry-runs against managed Postgres instances to confirm pgvector availability and document required privileges.

## Monitoring & Follow-ups
- Add dashboards for `strategist_retrieval_ready/fallback/unavailable` signal counts and alert when fallback exceeds 5% of runs.
- Track corpus refresh timestamps; warn when the newest snippet is older than 35 days.
- Ship SOC/privacy review for externalising campaign identifiers within embeddings and capture tenant consent in configuration.

Risk profile: docs/qa/assessments/12.1-risk-20251107.md
